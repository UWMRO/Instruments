var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(b){var c=0;return function(){return c<b.length?{done:!1,value:b[c++]}:{done:!0}}};$jscomp.arrayIterator=function(b){return{next:$jscomp.arrayIteratorImpl(b)}};$jscomp.makeIterator=function(b){var c="undefined"!=typeof Symbol&&Symbol.iterator&&b[Symbol.iterator];return c?c.call(b):$jscomp.arrayIterator(b)};$jscomp.arrayFromIterator=function(b){for(var c,a=[];!(c=b.next()).done;)a.push(c.value);return a};
$jscomp.arrayFromIterable=function(b){return b instanceof Array?b:$jscomp.arrayFromIterator($jscomp.makeIterator(b))};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,c,a){b!=Array.prototype&&b!=Object.prototype&&(b[c]=a.value)};
$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(b,c,a,d){if(c){a=$jscomp.global;b=b.split(".");for(d=0;d<b.length-1;d++){var e=b[d];e in a||(a[e]={});a=a[e]}b=b[b.length-1];d=a[b];c=c(d);c!=d&&null!=c&&$jscomp.defineProperty(a,b,{configurable:!0,writable:!0,value:c})}};
$jscomp.polyfill("Array.from",function(b){return b?b:function(b,a,d){a=null!=a?a:function(b){return b};var c=[],f="undefined"!=typeof Symbol&&Symbol.iterator&&b[Symbol.iterator];if("function"==typeof f){b=f.call(b);for(var g=0;!(f=b.next()).done;)c.push(a.call(d,f.value,g++))}else for(f=b.length,g=0;g<f;g++)c.push(a.call(d,b[g],g));return c}},"es6","es3");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(b,c){this.$jscomp$symbol$id_=b;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:c})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function b(a){if(this instanceof b)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(a||"")+"_"+c++,a)}var c=0;return b}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var b=$jscomp.global.Symbol.iterator;b||(b=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[b]&&$jscomp.defineProperty(Array.prototype,b,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var b=$jscomp.global.Symbol.asyncIterator;b||(b=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(b){$jscomp.initSymbolIterator();b={next:b};b[$jscomp.global.Symbol.iterator]=function(){return this};return b};
$jscomp.iteratorFromArray=function(b,c){$jscomp.initSymbolIterator();b instanceof String&&(b+="");var a=0,d={next:function(){if(a<b.length){var e=a++;return{value:c(e,b[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};$jscomp.polyfill("Array.prototype.keys",function(b){return b?b:function(){return $jscomp.iteratorFromArray(this,function(b){return b})}},"es6","es3");
$jscomp.polyfill("Math.asinh",function(b){return b?b:function(b){b=Number(b);if(0===b)return b;var a=Math.log(Math.abs(b)+Math.sqrt(b*b+1));return 0>b?-a:a}},"es6","es3");$jscomp.polyfill("Math.sinh",function(b){if(b)return b;var c=Math.exp;return function(b){b=Number(b);return 0===b?b:(c(b)-c(-b))/2}},"es6","es3");$jscomp.polyfill("Math.sign",function(b){return b?b:function(b){b=Number(b);return 0===b||isNaN(b)?b:0<b?1:-1}},"es6","es3");
$jscomp.polyfill("Object.is",function(b){return b?b:function(b,a){return b===a?0!==b||1/b===1/a:b!==b&&a!==a}},"es6","es3");$jscomp.polyfill("Array.prototype.includes",function(b){return b?b:function(b,a){var c=this;c instanceof String&&(c=String(c));var e=c.length;a=a||0;for(0>a&&(a=Math.max(a+e,0));a<e;a++){var f=c[a];if(f===b||Object.is(f,b))return!0}return!1}},"es7","es3");
$jscomp.checkStringArgs=function(b,c,a){if(null==b)throw new TypeError("The 'this' value for String.prototype."+a+" must not be null or undefined");if(c instanceof RegExp)throw new TypeError("First argument to String.prototype."+a+" must not be a regular expression");return b+""};$jscomp.polyfill("String.prototype.includes",function(b){return b?b:function(b,a){return-1!==$jscomp.checkStringArgs(this,b,"includes").indexOf(b,a||0)}},"es6","es3");
$jscomp.polyfill("Number.isNaN",function(b){return b?b:function(b){return"number"===typeof b&&isNaN(b)}},"es6","es3");$jscomp.polyfill("Number.isFinite",function(b){return b?b:function(b){return"number"!==typeof b?!1:!isNaN(b)&&Infinity!==b&&-Infinity!==b}},"es6","es3");$jscomp.findInternal=function(b,c,a){b instanceof String&&(b=String(b));for(var d=b.length,e=0;e<d;e++){var f=b[e];if(c.call(a,f,e,b))return{i:e,v:f}}return{i:-1,v:void 0}};
$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(b,a){return $jscomp.findInternal(this,b,a).v}},"es6","es3");$jscomp.polyfill("String.prototype.startsWith",function(b){return b?b:function(b,a){var c=$jscomp.checkStringArgs(this,b,"startsWith");b+="";var e=c.length,f=b.length;a=Math.max(0,Math.min(a|0,c.length));for(var g=0;g<f&&a<e;)if(c[a++]!=b[g++])return!1;return g>=f}},"es6","es3");$jscomp.polyfill("Number.parseFloat",function(b){return b||parseFloat},"es6","es3");
$jscomp.polyfill("Math.log10",function(b){return b?b:function(b){return Math.log(b)/Math.LN10}},"es6","es3");var Module;"object"!==typeof Module&&(Module={});
var JS9=function(){var b={NAME:"JS9",VERSION:"3.8",COPYRIGHT:"Copyright (c) 2012-2022 Smithsonian Institution"};b.ABOUT="JS9 "+b.VERSION+": astronomical image display everywhere\nEric Mandel, Alexey Vikhlinin\n"+b.COPYRIGHT;b.DEFID="JS9";b.WIDTH=512;b.HEIGHT=512;b.ANON="Anonymous";b.PREFSFILE="js9Prefs.json";b.WORKERFILE="js9worker.js";b.ZINDEX=0;b.SHAPEZINDEX=4;b.MESSZINDEX=80;b.BTNZINDEX=90;b.MENUZINDEX=1E3;b.COLORSIZE=1024;b.SCALESIZE=16384;b.INVSIZE=1024;b.HISTSIZE=16384;b.INSTALLDIR="";b.TOROOT=
"";b.PLUGINS="";b.LIGHTWIN="dhtml";b.ANTIALIAS=!1;b.SCALEIREG=!0;b.NOMOVE=3;b.DBLCLICK0=5;b.DBLCLICK=300;b.TIMEOUT=250;b.SPINOUT=250;b.WORKEROUT=2E3;b.SUPERMENU=/^SUPERMENU_/;b.RESIZEDIST=20;b.RESIZEFUDGE=5;b.RAWID0="raw0";b.RAWIDX="alt";b.IDFMT="  (%s)";b.MINZOOM=.125;b.MAXZOOM=32;b.ADDZOOM=.1;b.MODZOOM=2;b.DIRZOOM=1;b.CHROMEFILEWARNING=!0;b.CLIPBOARDERROR="the local clipboard (which only holds data copied from within JS9) does not contain any content. Were you trying to paste something copied outside JS9?";
b.CLIPBOARDERROR2="the local clipboard (which only holds data copied from within JS9) does not contain any regions";b.URLEXP=/^(https?|ftp):\/\//;b.WCSEXP=/^(fk4|fk5|icrs|galactic|ecliptic|image|physical|linear)$/;b.REGSIZE=0;b.TOUCHSUPPORTED={}.hasOwnProperty.call(window,"ontouchstart")||0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints;b.BROWSER=function(){var b=navigator.platform,a=navigator.appName,d=navigator.userAgent,e=d.match(/version\/([.\d]+)/i),f=d.match(/(opera|chrome|safari|firefox)\/?\s*(\.?\d+(\.\d+)*)/i);
f&&null!==e&&(f[2]=e[1]);f=f?[f[1],f[2],b]:[a,navigator.appVersion,"-?",b];f.push(/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(d)||"MacIntel"===navigator.platform&&1<navigator.maxTouchPoints);return f}();b.PIXEL_RATIO=function(){var b=document.createElement("canvas").getContext("2d");return(window.devicePixelRatio||1)/(b.webkitBackingStorePixelRatio||b.mozBackingStorePixelRatio||b.msBackingStorePixelRatio||b.oBackingStorePixelRatio||b.backingStorePixelRatio||1)}();b.globalOpts={helperType:"none",
helperPort:2718,requireHelper:!1,allinoneHelper:!1,processQueryParams:!0,quietReturn:!1,useWasm:!0,transforms:["flip","rot90","rotate"],rotateRelative:!1,clickToFocus:!1,winType:"light",sortPreloads:!0,defcolor:"#00FF00",fits2fits:"never",requireFits2Fits:!1,localAccess:!0,prependJS9Dir:!0,dataDir:null,alerts:!0,valposTarget:null,valposWidth:"medium",valposDCoords:!1,internalValPos:!0,internalContrastBias:!0,containContrastBias:!1,arrowIncrement:1,wcsCrosshair:!1,localLoadFormat:"image",remoteLoadMethod:"proxy",
csvIncludeWCS:!0,regWhichDefault:"auto",regIncludeJSON:!0,regIncludeComments:!0,regListDCoords:!1,regSaveDCoords:!1,regExpandDCoords:!1,regCopyDCoords:!0,regArrowCrosshair:!0,regSaveWCS:"",regSaveFormat:"reg",regSaveWhich1:"all",regSaveWhich2:"selected",regMenuCreate:!0,regMenuSelection:"circle",regToClipboard:!1,regGroupConflict:"skip",regConfigAddParens:!0,regSyncTextColor:!0,regDisplay:"lightwin",reConfigSize:"medium",htimeout:1E4,lhtimeout:1E4,ehtimeout:500,ehretries:20,xtimeout:6E5,extlist:"EVENTS STDEVT",
imopts:"IMOPTS",imcmap:"IMCMAP",table:{xdim:4096,ydim:4096,bin:1,bitpix:32},image:{xdim:4096,ydim:4096,bin:1},binMode:"s",reprojSwitches:"",reprojectLimits:!1,rotationCenter:"file",runOnCR:!0,clearImageMemory:"heap",helperProtocol:location.protocol,reloadRefresh:!1,reloadRefreshReg:!0,nextImageMask:!1,panMouseThreshold:1,panzoomRefreshLimit:500,panWithinDisplay:!1,pannerDirections:!0,magnifierRegions:!0,editRegions:!0,svgBorder:!0,unremoveReg:100,resetEmptyShapeId:!1,maxMemory:2E9,loadURL:"params/load.html",
corsURL:"params/loadcors.html",proxyURL:"params/loadproxy.html",loadProxy:!1,imsectionURL:"params/imsection.html",postMessage:!1,localStorage:!0,waitType:"spinner",spinColor:"#FF0000",spinOpacity:.35,resize:!0,resizeHandle:!0,resizeRedisplay:!0,logoDisplay:!1,logo:"images/js9logo.png",lightWinPos:"center=1",lightWinClose:"ask",fallbackDisplay:!0,refreshDragDrop:!0,reduceMosaic:"js9",internalRegcnts:!0,reduceRegcnts:!0,plot3d:{cube:"*:*:all",mode:"avg",areaunits:"pixels",color:"green"},imexamLineHeight:1,
copyWcsPosFormat:"$ra $dec $sys",floatPrecision:6,mouseActions:["display value/position","change contrast/bias","pan the image"],touchActions:["display value/position","change contrast/bias","pan the image"],keyboardActions:{a:"add last region selected in regions menu",b:"toggle selected region: source/background",c:"toggle crosshair",d:"send selected region to back",e:"toggle selected region: include/exclude","M-e":"edit selected region(s)",i:"refresh image",I:"display full image","M-i":"display selected cutouts",
"M-k":"toggle keyboard actions plugin",l:"toggle active shape layers","M-l":"new JS9 light window",m:"pan to mouse position","M-m":"toggle mouse/touch plugin","M-o":"open local file",P:"paste regions from local clipboard",p:"paste regions to current position","M-,":"toggle preferences plugin","M-p":"toggle preferences plugin",r:"copy region(s) to clipboard",s:"select region",S:"select all regions","M-s":"toggle shape layers plugin",u:"undo remove of region(s)",U:"unselect all regions",x:"flip image around x axis",
y:"flip image around y axis",9:"rotate image by 90 degrees","/":"copy wcs position to clipboard","?":"copy value and position to clipboard",0:"reset zoom","=":"zoom in","+":"zoom in","-":"zoom out","^":"raise region layer to top",">":"display next image","<":"display previous image","delete":"remove selected region",leftArrow:"move region/position left",upArrow:"move region/position up",rightArrow:"move region/position right",downArrow:"move region/position down"},mousetouchZoom:!1,mousetouchLimit:!0,
metaClickPan:!0,statusBar:"$colorbar; $colormap; $mag; $scale ($scalemin,$scalemax); $wcssys; $image0",toolbarTooltips:!1,updateTitlebar:!0,centerDivs:["JS9Menubar"],resizeDivs:["JS9Menubar","JS9Colorbar","JS9Toolbar","JS9Statusbar"],pinchWait:8,pinchThresh:6,xeqPlugins:!0,extendedPlugins:!0,intensivePlugins:!1,dynamicSelect:"click",dynamicHighlight:!0,corsProxy:"https://js9.si.edu/cgi-bin/CORS-proxy.cgi",simbadProxy:"https://js9.si.edu/cgi-bin/simbad-proxy.cgi",cgiProxy:"https://js9.si.edu/cgi-bin/FITS-proxy.cgi",
catalogs:{ras:["RA","_RAJ2000","RAJ2000"],decs:["Dec","_DEJ2000","DEJ2000"],shape:"circle",color:"yellow",width:7,height:7,radius:3.5,r1:5,r2:3.5,wcssys:"ICRS",skip:"#\n",save:!0,tooltip:"$data.ra $data.dec"},topColormaps:"grey heat cool turbo viridis magma sls red green blue".split(" "),infoBox:"file object wcsfov wcscen wcspos impos physpos value regions progress".split(" "),infoBoxResize:!0,menuBar:"file edit view zoom scale color region wcs analysis help".split(" "),menubarStyle:"classic",menuPosition:"right-5 bottom-5",
menuClickEvent:"mouseup",menuSelected:"check",menuImages:!0,userMenus:!1,userMenuDivider:"&nbsp;&nbsp;&nbsp;",imagesFileSubmenu:5,toolBar:"annulus box circle ellipse line polygon text zoom+ zoom- zoom1 zoomtofit".split(" "),syncOps:"alignment colormap contrastbias flip pan regions rotate rot90 scale wcs zoom".split(" "),syncReciprocate:!0,syncWCS:!0,hiddenPluginDivs:[],separate:{layout:"auto",leftMargin:10,topMargin:10},imageTemplates:".fits,.fts,.png,.jpg,.jpeg,.fz,.ftz,.gz",wcsUnits:{FK4:"sexagesimal",
FK5:"sexagesimal",ICRS:"sexagesimal",galactic:"degrees",ecliptic:"degrees",linear:"degrees",physical:"pixels",image:"pixels"},wcsSetUpdatesDef:!0,wcsHlength:256E3,regTemplates:".reg",sessionTemplates:".ses,.js9ses",colormapTemplates:".cmap",catalogTemplates:".cat,.tab",localTemplates:".fits,.fts",controlsMatchRegion:!1,internalColorPicker:!0,newWindowWidth:530,newWindowHeight:625,debug:0};b.favorites={scales:["linear","log","histeq"],colormaps:["cool","heat","viridis","magma"],regions:["annulus",
"box","circle","ellipse"],wcs:["FK5","ICRS","galactic:Galactic","physical","image"]};b.desktopOpts={currentPath:!0,sessionPath:!0};b.imageOpts={inherit:!1,contrast:1,bias:.5,invert:!1,exp:1E3,colormap:"grey",overlay:!0,scale:"linear",scaleclipping:"dataminmax",scalemin:Number.NaN,scalemax:Number.NaN,flip:"none",rot90:0,rotate:0,zscalecontrast:.25,zscalesamples:600,zscaleline:120,wcssys:"native",lcs:"physical",valpos:!0,sigma:"none",opacity:1,alpha:255,nancolor:"#000000",nocolor:{red:0,green:0,blue:0,
alpha:0},zoom:1,zooms:6,topZooms:2,wcsalign:!0,rotationMode:"relative",crosshair:!1,disable:[],ltvbug:!1,listonchange:!1,whichonchange:"selected"};b.regionOpts={};b.catalogOpts={};b.crosshairOpts={};b.gridOpts={};b.emscriptenOpts={};b.fabricOpts={};b.socketioOpts={reconnection:!0,reconnectionDelay:1E3,reconnectionDelayMax:1E4,reconnectionAttempts:100,timeout:b.globalOpts.htimeout};b.blendOpts={active:!0,mode:"screen",opacity:1};b.maskOpts={active:!1,mode:"overlay",opacity:1,vopacity:0,value:0,syncops:["flip",
"pan","rot90","zoom"],invert:!1};b.analOpts={epattern:/^(ERROR:[^\n]*)\n/,dpathURL:"params/datapath.html",fpathURL:"params/filepath.html"};b.lightOpts={nclick:0,dhtml:{topid:"#dhtmlwindowholder",top:".dhtmlwindow",drag:".drag-contentarea",dragBar:".drag-handle",format:"width=%spx,height=%spx,resize=%s,scrolling=0",textWin:"width=830px,height=400px,resize=1,scrolling=1",plotWin:"width=830px,height=420px,resize=1,scrolling=1",dpathWin:"width=830px,height=175px,resize=1,scrolling=1",lcloseWin:"width=512px,height=190px,resize=1,scrolling=1",
paramWin:"width=830px,height=235px,resize=1,scrolling=1",regWin0:"width=640px,height=130px,resize=1,scrolling=1",regWin1:"width=640px,height=200px,resize=1,scrolling=1",regWin:"width=640px,height=470px,resize=1,scrolling=1",imageWin:"width=512px,height=598px,resize=1,scrolling=1",lineWin:"width=400px,height=60px,resize=1,scrolling=1"},lcloseURL:"params/lightclose.html"};b.textColorOpts={regions:"#00FF00",info:"#00FF00",inimage:"#000000"};b.helpOpts={user:{heading:"JS9Help",type:"help",url:"user.html",
title:"User Manual"},install:{heading:"JS9Help",type:"help",url:"install.html",title:"Installing JS9"},webpage:{heading:"JS9Help",type:"help",url:"webpage.html",title:"Adding JS9 to a Web Page"},yourdata:{heading:"JS9Help",type:"help",url:"yourdata.html",title:"Adding Data to a Web Page"},localtasks:{heading:"JS9Help",type:"help",url:"localtasks.html",title:"Adding Local Analysis Tasks and Plugins"},helper:{heading:"JS9Help",type:"help",url:"helper.html",title:"Adding Server-side Analysis Tasks"},
serverside:{heading:"JS9Help",type:"help",url:"serverside.html",title:"Server-side Analysis with JS9"},publicapi:{heading:"JS9Help",type:"help",url:"publicapi.html",title:"The JS9 Public API"},extmsg:{heading:"JS9Help",type:"help",url:"extmsg.html",title:"External Messaging"},desktop:{heading:"JS9Help",type:"help",url:"desktop.html",title:"JS9 on the Desktop"},python:{heading:"JS9Help",type:"help",url:"python.html",title:"JS9 with Python and Jupyter"},archives:{heading:"JS9Help",type:"help",url:"archives.html",
title:"Accessing Data Archives"},preferences:{heading:"JS9Help",type:"help",url:"preferences.html",title:"Setting Site Preferences"},regions:{heading:"JS9Help",type:"help",url:"regions.html",title:"Regions Format"},changelog:{heading:"JS9Help",type:"help",url:"changelog.html",title:"ChangeLog"},repfile:{heading:"JS9Help",type:"help",url:"repfile.html",title:"Dealing with Large Files"},memory:{heading:"JS9Help",type:"help",url:"memory.html",title:"Dealing with Memory Limitations"},issues:{heading:"JS9Help",
type:"help",url:"knownissues.html",title:"Known Issues"},security:{heading:"JS9Help",type:"help",url:"securityissues.html",title:"Security Issues"}};b.images=[];b.displays=[];b.colormaps=[];b.commands=[];b.plugins=[];b.preloads=[];b.auxFiles=[];b.supermenus=[];b.preloadwaiting=[];b.publics={};b.helper={};b.fits={};b.userOpts={};b.tmp={};b.scales="linear log histeq power sqrt squared asinh sinh".split(" ");b.wcssyss="FK4 FK5 ICRS galactic ecliptic physical image native".split(" ");b.wcsunitss=["degrees",
"sexagesimal","pixels"];b.regions="annulus box circle cross ellipse line point polygon text".split(" ");b.bugs={};b.bugs.hide_menu=!1;"Firefox"===b.BROWSER[0]&&0<=b.BROWSER[2].search(/Linux/)&&(b.bugs.firefox_linux=!0);"Safari"===b.BROWSER[0]&&(b.bugs.webkit_resize=!0);/iPad|iPhone|iPod/.test(navigator.platform)&&/11_2_(?:[2-9])/.test(navigator.userAgent)&&(b.globalOpts.useWasm=!1);b.BROWSER[3]&&(b.globalOpts.maxMemory=Math.min(b.globalOpts.maxMemory,35E7),b.globalOpts.table.xdim=2048,b.globalOpts.table.ydim=
2048,b.globalOpts.image.xdim=2048,b.globalOpts.image.ydim=2048,b.imageOpts.crosshair=!1,b.globalOpts.reproj={xdim:2048,ydim:2048},b.lightOpts.dhtml.regWin0="width=660px,height=130px,resize=1,scrolling=1",b.lightOpts.dhtml.regWin1="width=660px,height=200px,resize=1,scrolling=1",b.lightOpts.dhtml.regWin="width=660px,height=470px,resize=1,scrolling=1");({}).hasOwnProperty.call(window,"Jupyter")&&(b.globalOpts.useWasm=!1);if(window.electron&&(window.electron.hostFS&&(b.hostFS=window.electron.hostFS),
window.electron.multiElectron&&(b.globalOpts.localStorage=!1),"function"===typeof window.eval&&(window.eval=function(){throw Error("For security reasons, Desktop JS9 does not support window.eval()");}),window.electron.cmdlineOpts))try{b.cmdlineOpts=JSON.parse(window.electron.cmdlineOpts)}catch(c){delete b.cmdlineOpts}b.Image=function(c,a,d){var e=this,f=null,g=0,h=0,k=function(a){a=a||{};b.isNull(a.scaleclipping)?"zscale"===e.params.scaleclipping?e.zscale(!0):"zmax"===e.params.scaleclipping&&e.zscale("zmax"):
"zscale"===a.scaleclipping?e.zscale(!0):"zmax"===a.scaleclipping&&e.zscale("zmax");b.notNull(a.scalemin)&&(e.params.scalemin=a.scalemin);b.notNull(a.scalemax)&&(e.params.scalemax=a.scalemax)},m=function(a){var c=b.globalOpts.imopts,d=b.globalOpts.imcmap,g=b.globalOpts.alerts;var h=/(annulus|box|circle|ellipse|line|polygon|point|text) *\(/;b.images.push(e);e.display.clearMessage();f&&(b.notNull(f.flip)||b.notNull(f.rotate)||b.notNull(f.rot90))&&e.setTransform();e.displayImage("all",f);e.notifyHelper();
e.showShapeLayer("regions",!0,{local:!0});f&&((b.notNull(f.x)&&b.notNull(f.y)||b.notNull(f.px)&&b.notNull(f.py)||b.notNull(f.ra)&&b.notNull(f.dec)||b.notNull(f.wcs))&&e.setPan(f),f.regions&&(f.regions.match(h)?e.addShapes("regions",f.regions):b.LoadRegions(f.regions,{display:e.display})));b.globalOpts.alerts=!1;if(e.raw&&e.raw.header&&e.raw.header[d]){try{var k=JSON.parse(e.raw.header[d])}catch(y){k=null}if(k)try{b.AddColormap(k)}catch(y){}}if(e.raw&&e.raw.header&&e.raw.header[d+"1"]){var l=1;for(h=
"";100>l;l++){var m=d+String(l);if(e.raw.header[m])h+=e.raw.header[m];else break}if(h){try{k=JSON.parse(h)}catch(y){k=null}if(k)try{b.AddColormap(k)}catch(y){}}}if(e.raw&&e.raw.header&&e.raw.header[c]){try{k=JSON.parse(e.raw.header[c])}catch(y){k=null}if(k)try{e.setParam("all",k)}catch(y){}}if(e.raw&&e.raw.header&&e.raw.header[c+"1"]){l=1;for(h="";100>l;l++)if(m=c+String(l),e.raw.header[m])h+=e.raw.header[m];else break;if(h){try{k=JSON.parse(h)}catch(y){k=null}if(k)try{e.setParam("all",k)}catch(y){}}}b.globalOpts.alerts=
g;e.xeqPlugins("image","onimageload");e.setStatus("load","complete");b.waiting(!1);if(a)try{b.xeqByName(a,window,e)}catch(y){b.error("in image onload callback",y,!1)}if(b.preloadwaiting&&b.preloadwaiting.length){var p=b.preloadwaiting.length;a=e.proxyURL||e.file;for(k=l=0;l<p;l++){var z=b.preloadwaiting[l];a.match(z.id)||z.id.match(a)?(z.loaded=!0,z.im=e):!1===z.loaded&&k++}if(!k){b.globalOpts.sortPreloads?(b.images.sort(function(a,c){var d=0,e=0;for(l=0;l<p;l++)z=b.preloadwaiting[l],a.id===z.im.id&&
(d=l),c.id===z.im.id&&(e=l);return d-e}),a=b.preloadwaiting[p-1].im||e,a.displayImage()):a=e;if(b.notNull(b.globalOpts.onpreload))try{b.xeqByName(b.globalOpts.onpreload,window,a)}catch(y){b.error("in onpreload callback",y,!1)}finally{delete b.globalOpts.onpreload}b.preloadwaiting=[]}}f&&f.allext&&e.hdus&&0<e.hdus.length&&e.displayExtension("all")};if(a)if("object"===typeof a){if(f=a,f.display)var l=f.display}else l=a;l||(l=0<b.displays.length?b.displays[0].id:b.DEFID);this.type="image";this.display=
b.lookupDisplay(l);this.params={};this.regstack=[];this.tmp={};this.groups={};this.params.xeqonchange=!0;this.params=$.extend(!0,this.params,b.imageOpts,f);this.display.image&&(this.params.inherit=this.display.image.params.inherit,this.params.inherit&&(this.params=$.extend(!0,this.params,this.display.image.params)));a=b.globalOpts.xeqPlugins;l=this.params.overlay;b.globalOpts.xeqPlugins=!1;this.setColormap(this.params.colormap);this.params.overlay=l;b.globalOpts.xeqPlugins=a;this.displayMode=!0;this.clickState=
0;this.clickInRegion=!1;this.clickInLayer=null;this.queried=!1;f&&f.proxyFile&&(this.proxyFile=f.proxyFile);f&&f.proxyParent&&(this.proxyParent=f.proxyParent);f&&f.proxyURL&&(this.proxyURL=f.proxyURL);f&&f.parentFile&&(this.parentFile=f.parentFile);if(f&&f.parent&&(this.parent=f.parent,this.parent.cardstr&&this.parent.ncard)){this.parent.raw={header:{},history:[],comments:[]};for(a=0;a<this.parent.ncard;a++)l=this.parent.cardstr.slice(80*a,80*(a+1)),l=b.cardpars(l),void 0!==l&&("HISTORY"===l[0]?this.parent.raw.header[l[0]+
"__"+g++]=l[1]:"COMMENT"===l[0]?this.parent.raw.header[l[0]+"__"+h++]=l[1]:this.parent.raw.header[l[0]]=l[1]);this.parent.lcs={};b.Image.prototype.initLCS.call(this.parent,this.parent.raw.header)}f&&f.id&&(this.id=f.id);this.iy=this.ix=0;this.status={};this.rgb={};this.rgb.sect={zoom:1,ozoom:1};this.layers={};this.zlayer=b.SHAPEZINDEX;this.lcs={};this.aux={};this.binning={bin:1,obin:1};this.raws=[];this.blend=$.extend(!0,{},b.blendOpts);this.mask=$.extend(!0,{},b.maskOpts);if(c)switch(b.waiting(!0,
this.display),typeof c){case "object":this.source=f&&f.source?f.source:"fits";this.mkRawDataFromHDU(c,$.extend({},{file:c.file||c.filename},f));k(f);this.params.zoom&&(c=this.parseZoom(this.params.zoom),this.rgb.sect.zoom=c,this.rgb.sect.ozoom=c);this.mkSection();f&&f.rgbFile?(this.rgbFile=f.rgbFile,this.png={image:new Image},$(this.png.image).on("load",function(){if(e.png.image.width!==e.raw.width||e.png.image.height!==e.raw.height){var a=sprintf("rgb dims [%s,%s] don't match image [%s,%s]",e.png.image.width,
e.png.image.height,e.raw.width,e.raw.height);b.error(a)}e.mkOffScreenCanvas();m(d)}).on("error",function(){b.waiting(!1);b.error("could not load image: "+e.id)}),this.png.image.src=this.rgbFile):m(d);break;default:b.error("unknown specification type for Load: "+typeof c)}};b.Image.prototype.getImageData=function(b){var a=null,c=this.fileDimensions(),e=c.xdim;c=c.ydim;if(b)if("array"===b)a=Array.from(this.raw.data);else if("base64"===b){a="";var f=new Uint8Array(this.raw.data.buffer),g=f.byteLength;
for(b=0;b<g;b++)a+=String.fromCharCode(f[b]);a=window.btoa(a)}else a=this.raw.data;return{id:this.id,file:this.file,fits:this.fitsFile||"",source:this.source,imtab:this.imtab,width:this.raw.width,height:this.raw.height,bitpix:this.raw.bitpix,bin:this.binning.bin,header:this.raw.header,hdus:this.hdus,dwidth:this.display.width,dheight:this.display.height,fwidth:e,fheight:c,data:a}};b.Image.prototype.closeImage=function(c){var a,d,e=!1;var f=b.images.length;var g=b.Dysel.getDisplayOr(this.display);c=
c||{};if("string"===typeof c)try{c=JSON.parse(c)}catch(h){b.error("can't parse closeImage opts: "+c,h)}this.setStatus("close","closing");for(a=0;a<f;a++)b.images[a].wcsim===this&&(b.images[a].wcsim=null);for(a=0;a<f;a++)b.images[a].mask.im===this&&(b.images[a].mask.im=null,b.images[a].mask.active=!1);for(a=0;a<f;a++)if(this===b.images[a]){f=b.images[a];f===f.display.image&&(e=a+1);if(e)for(!1!==c.clear&&(f.display.clearMessage(),f.display.context.clear()),c=$jscomp.makeIterator(Object.keys(f.layers)),
d=c.next();!d.done;d=c.next())d=d.value,"main"!==f.layers[d].dlayer.dtype&&f.display!==g||f.showShapeLayer(d,!1,{local:!0});f.xeqPlugins("image","onimageclose");e&&(f.display.image=null);switch(f.cmapObj.name){case "red":f.display.rgb.rim=null;break;case "green":f.display.rgb.gim=null;break;case "blue":f.display.rgb.bim=null}for(g=0;g<f.raws.length;g++)c=f.raws[g],c.hdu&&c.hdu.fits&&(d=b.lookupVfile(c.hdu.fits.vfile),1>=d.length&&b.cleanupFITSFile(c,!0)),c.altwcs&&this.freeWCS(c);f.removeProxyFile();
f.rgb=null;f.offscreen=null;f.raw=null;f.colorData=null;f.colorCells=null;f.psColors=null;f.psInverse=null;b.images.splice(a,1);break}if(e){for(a=e-=2;0<=a;a--)if(f=b.images[a],this.display===f.display){f.displayImage("all");f.refreshLayers();e=b.images.length;break}for(a=b.images.length-1;a>e;a--)if(f=b.images[a],this.display===f.display){f.displayImage("all");f.refreshLayers();break}}};b.Image.prototype.mkOffScreenCanvas=function(){if(!this.png||!this.png.image)return this;this.offscreen={};this.offscreen.canvas=
document.createElement("canvas");this.offscreen.canvas.setAttribute("width",this.png.image.width);this.offscreen.canvas.setAttribute("height",this.png.image.height);this.offscreen.context=this.offscreen.canvas.getContext("2d");b.ANTIALIAS||(this.offscreen.context.imageSmoothingEnabled=!1);this.offscreen.context.drawImage(this.png.image,0,0);try{this.offscreen.img=this.offscreen.context.getImageData(0,0,this.png.image.width,this.png.image.height)}catch(c){b.CHROMEFILEWARNING&&"Chrome"===b.BROWSER[0]&&
""===document.domain?alert("When using the file:// URI, Chrome must be run with the --allow-file-access-from-files switch to permit JS9 to access data."):alert("could not read off-screen image data [same-origin policy violation?]")}return this};b.Image.prototype.useOffScreenCanvas=function(){return this.offscreen&&(this.rgbFile||this.params.overlay)};b.Image.prototype.initLCS=function(c){var a=[[0,0,0],[0,0,0],[0,0,0]];c=c||this.raw.header;var d=c.CRPIX1||1,e=c.CRPIX2||1;if(c.LCSROTA2&&c.CROTA2){var f=
-c.CROTA2*Math.PI/180;var g=Math.sin(f);var h=Math.cos(f);f=[[0,0,0],[0,0,0],[0,0,0]];f[0][0]=h;f[0][1]=-g;f[0][2]=0;f[1][0]=g;f[1][1]=h;f[1][2]=0;(g=b.invertMatrix3(f))||(f=null)}a[0][0]=b.defNull(c.LTM1_1,1);a[1][0]=c.LTM2_1||0;a[0][1]=c.LTM1_2||0;a[1][1]=b.defNull(c.LTM2_2,1);a[2][0]=c.LTV1||0;a[2][1]=c.LTV2||0;if("image"===this.imtab&&this.params.ltvbug){if(b.notNull(c.LTV1))for(h=0;2>h;h++){var k=Math.abs(a[0][h]);0<k&&1>k&&(a[2][0]+=.5*k)}if(b.notNull(c.LTV2))for(h=0;2>h;h++)k=Math.abs(a[1][h]),
0<k&&1>k&&(a[2][1]+=.5*k)}this.lcs.physical={forward:$.extend(!0,[],a),reverse:b.invertMatrix3(a)};this.lcs.physical.reverse?f&&(this.lcs.physical.frot=$.extend(!0,[],f),this.lcs.physical.rrot=$.extend(!0,[],g),this.lcs.physical.cx=d-a[2][0]-1,this.lcs.physical.cy=e-a[2][1]-1):delete this.lcs.physical;a[0][0]=b.defNull(c.DTM1_1,1);a[1][0]=c.DTM2_1||0;a[0][1]=c.DTM1_2||0;a[1][1]=b.defNull(c.DTM2_2,1);a[2][0]=c.DTV1||0;a[2][1]=c.DTV2||0;this.lcs.detector={forward:$.extend(!0,[],a),reverse:b.invertMatrix3(a)};
this.lcs.detector.reverse?f&&(this.lcs.detector.frot=$.extend(!0,[],f),this.lcs.detector.rrot=$.extend(!0,[],g),this.lcs.detector.cx=d-a[2][0]-1,this.lcs.detector.cy=e-a[2][1]-1):delete this.lcs.detector;a[0][0]=b.defNull(c.ATM1_1,1);a[1][0]=c.ATM2_1||0;a[0][1]=c.ATM1_2||0;a[1][1]=b.defNull(c.ATM2_2,1);a[2][0]=c.ATV1||0;a[2][1]=c.ATV2||0;this.lcs.amplifier={forward:$.extend(!0,[],a),reverse:b.invertMatrix3(a)};this.lcs.amplifier.reverse?f&&(this.lcs.amplifier.frot=$.extend(!0,[],f),this.lcs.amplifier.rrot=
$.extend(!0,[],g),this.lcs.amplifier.cx=d-a[2][0]-1,this.lcs.amplifier.cy=e-a[2][1]-1):delete this.lcs.amplifier;this.params&&!this.lcs[this.params.lcs]&&(this.params.lcs="image");this.params&&!this.params.wcssys0&&(this.setWCSSys("physical"),this.params.wcssys0=this.params.lcs);this.lcs.physical&&!this.lcs.ophysical&&(this.lcs.ophysical=$.extend(!0,{},this.lcs.physical));return this};b.Image.prototype.mkRawDataFromHDU=function(c,a){var d=this,e,f,g,h;var k=h=0;a=a||{};if($.isArray(c)||b.isTypedArray(c)||
c instanceof ArrayBuffer){$.isArray(c[0])&&(c=c.reduce(function(b,a){return b.concat(a)}));var m={image:c}}else"object"===typeof c?m=c:b.error("unknown or missing input for HDU creation");m.data&&!m.image&&(m.image=m.data);m.image||b.error("data missing from JS9 FITS object: "+JSON.stringify(m));2>m.naxis&&b.error("can't image a FITS file with less than 2 dimensions");if(this.raw){var l=this.raw;var p=this.raw.width;var r=this.raw.height;var n=this.raw.bitpix;var u=this.params.wcssys;var x=this.params.wcsunits;
this.freeWCS()}this.raws=this.raws||[];if(g=this.raws.length){a.rawid=a.rawid||b.RAWIDX;for(e=f=0;e<g;e++)if(a.rawid===this.raws[e].id){var t=this.raws[e].from;this.raws[e]={from:t,id:a.rawid};this.raw=this.raws[e];f++;break}f||(this.raws.push({from:"hdu",id:a.rawid}),this.raw=this.raws[g],l=null)}else this.raws.push({from:"hdu"}),this.raw=this.raws[g],this.raw.id=b.RAWID0;this.raw.hdu=m;m.axis?(this.raw.width=m.axis[1],this.raw.height=m.axis[2]):m.naxis1&&m.naxis2?(this.raw.width=m.naxis1,this.raw.height=
m.naxis2):p&&r&&(this.raw.width=p,this.raw.height=r);m.bitpix?this.raw.bitpix=m.bitpix:n&&(this.raw.bitpix=n);if("base64"===m.encoding)for(t=window.atob(m.image),m.image=new ArrayBuffer(t.length),f=new Uint8Array(m.image),e=0;e<t.length;e++)f[e]=t.charCodeAt(e);$.isArray(m.image[0])&&(m.image=m.image.reduce(function(b,a){return b.concat(a)}));switch(this.raw.bitpix){case 8:this.raw.data=new Uint8Array(m.image);break;case 16:this.raw.data=new Int16Array(m.image);break;case -16:this.raw.data=new Uint16Array(m.image);
break;case 32:this.raw.data=new Int32Array(m.image);break;case -32:this.raw.data=new Float32Array(m.image);break;case -64:this.raw.data=new Float64Array(m.image);break;default:b.error("unsupported bitpix: "+this.raw.bitpix)}this.raw.card=m.card;this.raw.cardstr=m.cardstr;this.raw.ncard=m.ncard;if(m.head)this.raw.header=m.head;else if(this.raw.card)for(this.raw.header={},f=this.raw.card.length,e=0;e<f;e++)g=b.cardpars(this.raw.card[e]),void 0!==g&&("HISTORY"===g[0]?this.raw.header[g[0]+"__"+h++]=g[1]:
"COMMENT"===g[0]?this.raw.header[g[0]+"__"+k++]=g[1]:this.raw.header[g[0]]=g[1]);else if(this.raw.cardstr)for(this.raw.header={},f=this.raw.ncard,e=0;e<f;e++)g=this.raw.cardstr.slice(80*e,80*(e+1)),g=b.cardpars(g),void 0!==g&&("HISTORY"===g[0]?this.raw.header[g[0]+"__"+h++]=g[1]:"COMMENT"===g[0]?this.raw.header[g[0]+"__"+k++]=g[1]:this.raw.header[g[0]]=g[1]);else this.raw.header={},this.raw.header.SIMPLE=!0,this.raw.header.NAXIS=2,this.raw.header.NAXIS1=this.raw.width,this.raw.header.NAXIS2=this.raw.height,
this.raw.header.BITPIX=this.raw.bitpix;e=this.raw.header;l||this.parentFile||this.parent||void 0===e.LTV1&&void 0===e.LTV2&&void 0===e.LTM1_1&&void 0===e.LTM2_2||(this.parent={},this.parent.raw={header:$.extend(!0,{},e)},this.parent.lcs={},b.Image.prototype.initLCS.call(this.parent,this.parent.raw.header));if("image"===m.imtab&&void 0!==m.x1&&1!==m.x1||void 0!==m.y1&&1!==m.y1||void 0===m.bin||1!==m.bin)h=b.defNull(m.x1,1),k=b.defNull(m.y1,1),f=m.bin||1,0>f&&(f=1/Math.abs(f)),b.notNull(e.NAXIS1)&&
(e.NAXIS1/=f),b.notNull(e.NAXIS2)&&(e.NAXIS2/=f),b.notNull(e.CRPIX1)&&(e.CRPIX1=(e.CRPIX1+1-h-.5)/f+.5),b.notNull(e.CRPIX2)&&(e.CRPIX2=(e.CRPIX2+1-k-.5)/f+.5),b.notNull(e.CDELT1)&&(e.CDELT1*=f),b.notNull(e.CDELT2)&&(e.CDELT2*=f),b.notNull(e.CD1_1)&&(e.CD1_1*=f),b.notNull(e.CD1_2)&&(e.CD1_2*=f),b.notNull(e.CD2_1)&&(e.CD2_1*=f),b.notNull(e.CD2_2)&&(e.CD2_2*=f),e.LTM1_1=b.defNull(e.LTM1_1,1),e.LTM1_1/=f,e.LTM2_1=e.LTM2_1||0,e.LTM2_1/=f,e.LTM1_2=e.LTM1_2||0,e.LTM1_2/=f,e.LTM2_2=b.defNull(e.LTM2_2,1),
e.LTM2_2/=f,e.LTV1=e.LTV1||0,e.LTV1=(e.LTV1-h)/f+.5,e.LTV2=e.LTV2||0,e.LTV2=(e.LTV2-k)/f+.5;a.lcsUseRota2&&(e.LCSROTA2=!0);a.file&&a.file!==this.file?(this.file=a.file,this.id=null):a.filename&&a.filename!==this.file?(this.file=a.filename,this.id=null):m.file&&m.file!==this.file&&(this.file=m.file,this.id=null);this.file0=this.file=b.cleanPath(this.file)||b.ANON+b.uniqueID();a.id&&(this.id0=a.id,this.id=b.getImageID(a.id,this.display.id,this));this.id||!this.file||this.file.match(/\[.*[^a-zA-Z0-9_].*\]/)||
(a.extname||a.extnum?(a.extname?(this.file=this.file.replace(/\[.*\]/,""),this.file+="["+a.extname+"]"):a.extnum&&0<a.extnum&&(this.file=this.file.replace(/\[.*\]/,""),this.file+="["+a.extnum+"]"),m.fits&&(a.extname&&(m.fits.extname=a.extname),a.extnum&&0<a.extnum&&(m.fits.extnum=a.extnum))):m.fits?m.fits.extname?(this.file=this.file.replace(/\[.*\]/,""),this.file+="["+m.fits.extname+"]"):m.fits.extnum&&0<m.fits.extnum&&(this.file=this.file.replace(/\[.*\]/,""),this.file+="["+m.fits.extnum+"]"):this.raw.header&&
this.raw.header.EXTNAME&&(this.file=this.file.replace(/\[.*\]/,""),this.file+="["+this.raw.header.EXTNAME+"]"));this.id||(this.id0=(this.parentFile||this.file).split("/").reverse()[0],this.id=b.getImageID(this.id0,this.display.id,this));a.proxyFile&&(this.proxyFile=a.proxyFile);this.raw.filter=a.filter||"";this.raw.columns=a.columns||"";this.imtab=m.imtab?m.imtab:m.table?"table":"image";this.raw.imtab=this.imtab;void 0!==m.dmin&&void 0!==m.dmax?this.dataminmax(m.dmin,m.dmax):this.dataminmax();this.object=
this.raw.header.OBJECT;this.telescope=this.raw.header.TELESCOP;this.instrument=this.raw.header.INSTRUME;if(a.binstr)try{(t=a.binstr.split(/\s+/))&&2===t.length&&("table"===this.imtab&&m.table?(m.table.bin=parseFloat(t[0]),m.table.binMode=t[1]):(m.bin=parseFloat(t[0]),m.binMode=t[1]))}catch(v){}this.binning.bin="table"===this.imtab&&m.table?m.table.bin||1:m.bin?0<m.bin?m.bin:1/Math.abs(m.bin):1;l||(this.binning.obin=this.binning.bin);u&&this.setWCSSys(u);x&&this.setWCSUnits(x);l&&l.header.CTYPE1&&
l.header.CTYPE2&&this.raw.header.CTYPE1&&this.raw.header.CTYPE2&&(l.header.CTYPE1!==this.raw.header.CTYPE1||l.header.CTYPE2!==this.raw.header.CTYPE2)&&this.initWCS();b.notNull(m.offscreen)&&(this.png={image:m.offscreen},this.mkOffScreenCanvas());this.initWCS();this.initLCS();try{if(a.hdus)this.hdus=a.hdus;else if(this.parentFile&&b.helper.connected&&b.helper.js9helper)c={id:this.expandMacro("$id"),cmd:this.expandMacro("js9Xeq listhdus $filename"),image:this.file,fits:this.parentFile,rtype:"text"},
b.helper.send("listhdus",c,function(b){if(!b.stderr&&!b.errcode&&b.stdout)try{d.hdus=JSON.parse(b.stdout)}catch(w){d.hdus=null}});else if(this.raw.hdu&&this.raw.hdu.fits&&(t=b.listhdu(this.raw.hdu.fits.vfile)))try{this.hdus=JSON.parse(t)}catch(v){this.hdus=null}}catch(v){}if(this.raw.hdu&&this.raw.hdu.fits&&this.raw.hdu.fits.vfile){t=b.globalOpts.clearImageMemory;t=!1===t?["never"]:!0===t?["always"]:t.toLowerCase().split(/[,>]/);l=c=!1;e=0;for(a=!1;e<t.length&&!a;e++)switch(t[e]){case "never":c=!1;
a=!0;break;case "always":a=c=!0;break;case "heap":l=!0;break;case "auto":2>=this.raw.header.NAXIS&&(!this.hdus||1===this.hdus.length)?c=!0:(c=!1,a=!0);break;case "nocube":2>=this.raw.header.NAXIS?c=!0:(c=!1,a=!0);break;case "noext":this.hdus&&1!==this.hdus.length?(c=!1,a=!0):c=!0;break;case "size":t[e+1]?b.vsize(m.fits.vfile)>1E6*t[e+1]?c=!0:(c=!1,a=!0):(c=!1,a=!0)}c?(2<b.DEBUG&&b.log("removing underlying FITS vfile for %s: %s",this.id,this.raw.hdu.fits.vfile),b.cleanupFITSFile(this.raw,!0)):l&&(2<
b.DEBUG&&b.log("freeing heap space for %s: %s",this.id,this.raw.hdu.fits.vfile),b.cleanupFITSFile(this.raw,!1))}this.xeqPlugins("image","onrawdata");return this};b.Image.prototype.mkSection=function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=this;d=this.rgb.sect;var f=function(b){var a=e.display.canvas;return e.params.transformAngle?(a=Math.max(a.width,a.height),Math.min(e.raw.width*b,a)):Math.min(e.raw.width*b,a.width)},g=function(b){var a=e.display.canvas;return e.params.transformAngle?
(a=Math.max(a.width,a.height),Math.min(e.raw.height*b,a)):Math.min(e.raw.height*b,a.height)};d.ozoom=d.zoom;switch(a.length){case 0:d.xcen=Math.floor(this.raw.width/2);d.ycen=Math.floor(this.raw.height/2);d.width=f(1);d.height=g(1);break;case 1:b.isNumber(a[0])||b.error("invalid input for generating section: "+a[0]);d.zoom=parseFloat(a[0]);d.width=f(d.zoom);d.height=g(d.zoom);break;case 2:b.isNumber(a[0])&&b.isNumber(a[1])||b.error("invalid input for generating section: "+a[0]+" "+a[1]);d.xcen=parseFloat(a[0]);
d.ycen=parseFloat(a[1]);b.notNull(d.ix)&&(d.width=f(d.zoom));b.notNull(d.iy)&&(d.height=g(d.zoom));break;case 3:b.isNumber(a[0])&&b.isNumber(a[1])&&b.isNumber(a[2])||b.error("invalid input for generating section: "+a[0]+" "+a[1]+" "+a[2]),d.xcen=parseFloat(a[0]),d.ycen=parseFloat(a[1]),d.zoom=parseFloat(a[2]),d.width=f(d.zoom),d.height=g(d.zoom)}delete d.ix;delete d.iy;d.x0=d.xcen-d.width/(2*d.zoom);d.y0=d.ycen-d.height/(2*d.zoom);d.x1=d.xcen+d.width/(2*d.zoom);d.y1=d.ycen+d.height/(2*d.zoom);0>d.x0&&
(b.globalOpts.panWithinDisplay?d.x1-=d.x0:d.ix=d.x0*d.zoom,d.x0=0);0>d.y0&&(b.globalOpts.panWithinDisplay?d.y1-=d.y0:d.iy=d.y0*d.zoom,d.y0=0);d.x1>this.raw.width&&(b.globalOpts.panWithinDisplay?d.x0-=d.x1-this.raw.width:d.ix=(d.x1-this.raw.width)*d.zoom,d.x1=this.raw.width);d.y1>this.raw.height&&(b.globalOpts.panWithinDisplay?d.y0-=d.y1-this.raw.height:d.iy=(d.y1-this.raw.height)*d.zoom,d.y1=this.raw.height);0<d.ix&&0<d.x0&&(a=Math.min(d.ix,d.x0),d.x0-=a,d.ix+=a*d.zoom);0>d.ix&&d.x1<this.raw.width&&
(a=Math.min(this.raw.width-d.x1,Math.abs(d.ix)),d.x1+=a,d.ix-=a*d.zoom);0<d.iy&&0<d.y0&&(a=Math.min(d.iy,d.y0),d.y0-=a,d.iy+=a*d.zoom);0>d.iy&&d.y1<this.raw.height&&(a=Math.min(this.raw.height-d.y1,Math.abs(d.iy)),d.y1+=a,d.iy-=a*d.zoom);d.x0=Math.max(0,d.x0);d.x1=Math.min(this.raw.width,d.x1);d.y0=Math.max(0,d.y0);d.y1=Math.min(this.raw.height,d.y1);d.x0=Math.floor(d.x0);d.y0=Math.floor(d.y0);d.x1=Math.floor(d.x1);d.y1=Math.floor(d.y1);d.width=Math.ceil((d.x1-d.x0)*d.zoom);d.height=Math.ceil((d.y1-
d.y0)*d.zoom);if(0>=d.width||0>=d.height)a=sprintf("invalid image section: %s,%s [%s,%s, %s,%s, %s]",d.width,d.height,d.x0,d.y0,d.x1,d.y1,d.zoom),b.error(a);this.params.zoom=d.zoom;return this};b.Image.prototype.mkColorData=function(){var c,a=b.SCALESIZE,d=this.params.scalemin,e=this.params.scalemax,f=this.raw.width*this.raw.height,g=(a-1)/(e-d);if("static"===this.cmapObj.type)return this;if(!this.colorData||this.colorData.length<f)this.colorData=new Int32Array(f);var h=this.raw.data;var k=this.colorData;
for(c=0;c<f;c++){var m=h[c];k[c]=m<=d?0:m>=e?a-1:Math.floor((m-d)*g+.5)}return this};b.Image.prototype.calcContrastBias=function(c){var a=this.params.bias,d=b.COLORSIZE,e=this.params.contrast;if(1E-4>a-.5&&1E-4>e-1)return c;this.params.invert&&(a=1-a);c=Math.floor(((c/d-a)*e+.5)*d);return 0>c?0:c>=d?d-1:c};b.Image.prototype.mkColorCells=function(){var c,a=b.COLORSIZE;if("static"===this.cmapObj.type)return this;this.colorCells||(this.colorCells=[]);for(c=0;c<a;c++){var d=this.params.invert?a-c-1:c;
d=this.calcContrastBias(d);this.colorCells[c]=this.cmapObj.mkColorCell(d)}return this};b.Image.prototype.mkScaledCells=function(){var c,a;var d=b.COLORSIZE;var e=b.SCALESIZE,f=b.INVSIZE;var g=b.HISTSIZE;if(!this.colorCells||"static"===this.cmapObj.type)return this;if(!this.psColors){var h=this.psColors=[];var k=this.params.nancolor;var m=[];"#"===k.charAt(0)&&(k=k.slice(1));k=k.toUpperCase();for(c=a=0;6>a;a+=2,c++){var l="0123456789ABCDEF".indexOf(k.charAt(a));var p="0123456789ABCDEF".indexOf(k.charAt(a+
1));m[c]=16*l+p}h[NaN]=m}this.psInverse||(this.psInverse=[],this.psInverse[NaN]=0);k=this.params.scalemax-this.params.scalemin;a=this.params.scalemin;switch(this.params.scale){case "linear":for(h=0;h<e;h++)c=h/e,c=Math.floor(c*d),this.psColors[h]=this.colorCells[c];for(h=0;h<f;h++)c=h/f,this.psInverse[h]=c*k+a;break;case "log":g=this.params.exp;for(h=0;h<e;h++)c=Math.log(g*h/e+1)/Math.log(g),c=Math.floor(c*d),c>=d&&(c=d-1),this.psColors[h]=this.colorCells[c];for(h=0;h<f;h++)c=(Math.pow(g,h/f)-1)/
g,this.psInverse[h]=c*k+a;break;case "power":g=this.params.exp;for(h=0;h<e;h++)c=(Math.pow(g,h/e)-1)/g,c=Math.floor(c*d),c>=d&&(c=d-1),this.psColors[h]=this.colorCells[c];for(h=0;h<f;h++)c=Math.log(g*h/f+1)/Math.log(g),this.psInverse[h]=c*k+a;break;case "sqrt":for(h=0;h<e;h++)c=h/e,c=Math.floor(Math.sqrt(c)*d),c>=d&&(c=d-1),this.psColors[h]=this.colorCells[c];for(h=0;h<f;h++)c=h/f,this.psInverse[h]=c*c*k+a;break;case "squared":for(h=0;h<e;h++)c=h/e,c=Math.floor(c*c*d),c>=d&&(c=d-1),this.psColors[h]=
this.colorCells[c];for(h=0;h<f;h++)c=Math.sqrt(h/f),this.psInverse[h]=c*k+a;break;case "asinh":for(h=0;h<e;h++)c=h/e,c=Math.floor(Math.asinh(10*c)/3*d),c>=d&&(c=d-1),this.psColors[h]=this.colorCells[c];for(h=0;h<f;h++)c=h/f,c=Math.sinh(3*c)/10,this.psInverse[h]=c*k+a;break;case "sinh":for(h=0;h<e;h++)c=h/e,c=Math.floor(Math.sinh(3*c)/10*d),c>=d&&(c=d-1),this.psColors[h]=this.colorCells[c];for(h=0;h<f;h++)c=h/f,c=Math.asinh(10*c)/3,this.psInverse[h]=c*k+a;break;case "histeq":m=this.raw.data;var r=
this.raw.width*this.raw.height;k=this.raw.dmax-this.raw.dmin;var n=this.raw.dmax;a=this.raw.dmin;var u=c=0;l=[];if(!this.hist||!this.hist.length){this.hist=[];for(h=0;h<g;h++)l[h]=0;for(h=0;h<r;h++)m[h]>=a&&m[h]<=n&&(p=Math.floor((m[h]-a)/k*g+.5),p<g&&(l[p]+=1));for(h=0;h<g;h++)u+=l[h];p=u/g;for(h=m=0;h<g&&m<g;h++)for(this.hist[h]=m/g,c+=l[h];c>=p&&m<g;)c-=p,m++;for(c=(g-1)/g;h<g;)this.hist[h++]=c}for(h=0;h<e;h++)c=this.hist[h*g/e],c=Math.floor(c*d),this.psColors[h]=this.colorCells[c];for(h=0;h<f;h++){d=
h/f;for(p=0;p<g-1&&!(this.hist[p]>d);p++);c=p/g;this.psInverse[h]=c*k+a}break;default:b.error("unknown scale '"+this.params.scale+"'")}return this};b.Image.prototype.mkRGBImage=function(){var c,a,d,e,f=!1,g=null,h=null,k=null,m=!1,l=!1,p=!1,r=!1,n=[];if(!this.rgb)return this;!this.display.rgb.active||this!==this.display.rgb.rim&&this!==this.display.rgb.gim&&this!==this.display.rgb.bim||(m=!0,this.display.rgb.rim&&(g=this.display.rgb.rim),this.display.rgb.gim&&(h=this.display.rgb.gim),this.display.rgb.bim&&
(k=this.display.rgb.bim));var u=this.display.context;var x=this.rgb;var t=x.sect;if(this.MakeRGBImage&&"function"===typeof this.MakeRGBImage&&this.MakeRGBImage()||this.MakePrimaryImage&&"function"===typeof this.MakePrimaryImage&&this.MakePrimaryImage())return this;if(this.useOffScreenCanvas()){var v=t.width/t.zoom;var w=t.height/t.zoom;var q=t.x0;var z=this.offscreen.canvas.height-1-(t.y0+w);z=this.offscreen.context.getImageData(q,z,v,w);if(1===t.zoom)x.img=z;else for(x.img=u.createImageData(t.width,
t.height),x=x.img,d=c=0;c<z.height;c++,d++){var y=c*z.width;var A=d*t.zoom;for(a=u=0;u<z.width;u++,a++){q=4*(y+u);var C=a*t.zoom;for(e=0;e<t.zoom;e++){var B=Math.floor(A+e);var D=B*t.width;for(B=0;B<t.zoom;B++){var E=Math.floor(C+B);E=4*(D+E);x.data[E]=z.data[q];x.data[E+1]=z.data[q+1];x.data[E+2]=z.data[q+2];x.data[E+3]=z.data[q+3]}}}}return this}x.img&&x.img.width===t.width&&x.img.height===t.height||(x.img=u.createImageData(t.width,t.height));x=x.img;var F=x.data.length-4;if(!this.psColors&&!this.staticObj)return this;
var G=void 0!==this.params.opacity?Math.floor(255*this.params.opacity):void 0!==this.params.alpha?this.params.alpha:255;if(this.mask.active&&this.mask.im){var J=this.mask.im;if("mask"===this.mask.mode){l=!0;var I=b.notNull(this.mask.vopacity)?255*this.mask.vopacity:0;var K=b.notNull(this.params.opacity)?255*this.params.opacity:255;this.mask.invert&&(G=I,I=K,K=G)}else if("opacity"===this.mask.mode)p=!0;else if("overlay"===this.mask.mode){r=!0;var L=J.rgb.img;b.isNull(this.mask.opacity)&&(this.mask.opacity=
1)}}else if(b.notNull(this.params.flooropacity)&&!m){var R=255*this.params.flooropacity;var M=this.params.floorvalue;f=!0}var N=Math.max(1,Math.floor(1/t.zoom));var P=t.zoom*N;c=Math.floor(t.y1-1);for(d=0;c>=t.y0;c-=N,d++)for(y=c*this.raw.width,A=d*P,u=Math.floor(t.x0),a=0;u<t.x1;u+=N,a++){l?G=J.raw.data[y+u]>this.mask.value?K:I:p&&(G=255*J.raw.data[y+u]);if(m){if(z=g?g.colorData[y+u]:0,v=h?h.colorData[y+u]:0,w=k?k.colorData[y+u]:0,b.isNull(z)||b.isNull(v)||b.isNull(w))return this.display.rgb.active=
!1,b.error("RGB images are incompatible. Turning off RGB mode.","",!1),this.mkRGBImage(),this}else this.staticObj||(q=this.colorData[y+u]);var Q=G;f&&this.raw.data[y+u]<=M&&(Q=R);C=a*P;for(e=0;e<t.zoom;e++)for(B=Math.ceil(A+e),D=B*t.width,B=0;B<t.zoom;B++)if(E=Math.ceil(C+B),E=4*(D+E),E<=F)if(m)x.data[E]=g?g.psColors[z][0]:0,x.data[E+1]=h?h.psColors[v][1]:0,x.data[E+2]=k?k.psColors[w][2]:0,x.data[E+3]=G;else if(this.staticObj){var H=this.raw.data[y+u];H=b.lookupStaticColor(this,H,n);x.data[E]=H.red;
x.data[E+1]=H.green;x.data[E+2]=H.blue;x.data[E+3]=H.alpha}else if(void 0!==this.psColors[q])if(r&&L.data[E+3]){H=L.data[E+3]/255*this.mask.opacity;var O=1-H;x.data[E]=L.data[E]*H+this.psColors[q][0]*O;x.data[E+1]=L.data[E+1]*H+this.psColors[q][1]*O;x.data[E+2]=L.data[E+2]*H+this.psColors[q][2]*O;x.data[E+3]=255}else x.data[E]=this.psColors[q][0],x.data[E+1]=this.psColors[q][1],x.data[E+2]=this.psColors[q][2],x.data[E+3]=Q}return this};b.Image.prototype.blendImage=function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-
0]=arguments[d];var e=$jscomp.makeIterator(a);d=e.next().value;var f=e.next().value;e=e.next().value;var g=/normal|multiply|screen|overlay|darken|lighten|color-dodge|color-burn|hard-light|soft-light|difference|exclusion|hue|saturation|color|luminosity|clear|copy|source-over|destination-over|source-in|destination-in|source-out|destination-out|source-atop|destination-atop|xor|lighter/i;if(0===a.length)return this.blend;if(!0===d||!1===d||"true"===d||"false"===d)return"true"===d?d=!0:"false"===d&&(d=
!1),this.blend.active=d,this.xeqPlugins("image","onimageblend"),this.display.blendMode&&this.displayImage(),this;if(b.notNull(d)||b.notNull(f))b.notNull(d)&&(g.test(d)||b.error("invalid composite/blend operation: "+d),this.blend.mode=d),b.notNull(f)&&("string"===typeof f?f=parseFloat(f):"number"!==typeof f&&b.error("invalid opacity: "+f),this.blend.opacity=Math.min(Math.max(f,0),1)),b.notNull(e)&&("true"===e?e=!0:"false"===e&&(e=!1),this.blend.active=e),this.xeqPlugins("image","onimageblend"),this.display.blendMode&&
this.blend.active&&this.displayImage();return this};b.Image.prototype.maskImage=function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];d=$jscomp.makeIterator(a);var e=d.next().value;d=d.next().value;var f;if(!a.length)return this.mask;if(!0===e||!1===e||"true"===e||"false"===e)return"true"===e?e=!0:"false"===e&&(e=!1),this.mask.active=e,this.xeqPlugins("image","onimagemask"),this.displayImage(),this;if("string"===typeof e&&"{"===e.charAt(0))try{e=JSON.parse(e)}catch(g){b.error("can't parse JSON in maskImage: "+
e,g)}b.isImage(e)||d||(d=e,e=null);e&&((f=b.lookupImage(e))||b.error("unknown image for maskImage: "+e),this.raw.width===f.raw.width&&this.raw.height===f.raw.height||b.error("maskImage: mask dims ("+f.raw.width+","+f.raw.height+") don't match image dims ("+this.raw.width+","+this.raw.height+")"),this.mask.im=f,this.mask.active=!0);if(d){if("string"===typeof d)try{d=JSON.parse(d)}catch(g){b.error("can't parse JSON in maskImage: "+d,g)}a=$jscomp.makeIterator(Object.keys(d));for(e=a.next();!e.done;e=
a.next())switch(e=e.value,e){case "opacity":this.mask.vopacity=d[e];break;default:this.mask[e]=d[e]}}!f||d&&!1===d.sync||"function"!==typeof this.syncImages||this.syncImages(this.mask.syncops,[f]);(f||d)&&this.displayImage()};b.Image.prototype.calcDisplayOffsets=function(c){var a=this.rgb.sect;this.ix=(this.display.canvas.width-this.rgb.img.width)/2;this.iy=(this.display.canvas.height-this.rgb.img.height)/2;b.notNull(a.ix)&&(this.ix-=a.ix/2);b.notNull(a.iy)&&(this.iy+=a.iy/2);this.ix=Math.floor(this.ix);
this.iy=Math.floor(this.iy);if(c&&this.wcsAlign()){var d=this.wcsim;c=d.rgb.sect;d=b.pix2pix(d,this,d.getPan());var e=b.globalOpts.panWithinDisplay;b.globalOpts.panWithinDisplay=!0;this.tmp.ozoom=this.rgb.sect.ozoom;this.mkSection(d.x,d.y,c.zoom);this.rgb.sect.ozoom=this.tmp.ozoom;delete this.tmp.ozoom;b.globalOpts.panWithinDisplay=e;this.ix-=(a.xcen-(a.x0+a.x1)/2)*c.zoom;this.iy+=(a.ycen-(a.y0+a.y1)/2)*c.zoom}return this};b.Image.prototype.putImage=function(c){var a=this,d=this.rgb,e=this.display.context;
c=c||{};"reproject"===this.rawDataLayer()&&c.wcsim&&(this.wcsim=c.wcsim,this.wcsim.isawcsim=!0);this.calcDisplayOffsets(!0);e.save();void 0!==c.opacity&&(e.globalAlpha=c.opacity);void 0!==c.blend&&(e.globalCompositeOperation=c.blend);if(this.params.transform){c=this.params.transform;var f=this.display.width/2;var g=this.display.height/2;e.translate(f,g);e.transform(c[0][0],c[0][1],c[1][0],c[1][1],c[2][0],c[2][1]);e.translate(-f,-g)}e.drawImage(function(c){if(!a.offscreenRGB){var d=document.createElement("canvas");
var e=d.getContext("2d");b.ANTIALIAS||(e.imageSmoothingEnabled=!1);a.offscreenRGB={canvas:d,context:e}}a.offscreenRGB.canvas.width=c.width;a.offscreenRGB.canvas.height=c.height;a.offscreenRGB.context.putImageData(c,0,0);return a.offscreenRGB.canvas}(d.img),this.ix,this.iy);e.restore();return this};b.Image.prototype.displayImage=function(c,a){var d=0;var e=[],f={};if(!1===c)return this.displayMode=!1,this;!0===c&&(this.displayMode=!0,c="all");if(!this.displayMode)return this;"object"===typeof c&&(a=
c,c=null);c?"all"===c?(c="colors,scaled,rgb,display,plugins",f.notify=!0):"rgbonly"===c?(c="rgb,nodisplay",f.notify=!0):"display"===c&&(f.notify=!0):c="rgb";c.split(",").forEach(function(b,a,c){b=b.trim();f[b]=!0;switch(b){case "colors":f.scaled=!0;f.rgb=!0;break;case "scaled":f.rgb=!0}});f.display=!0;f.plugins=!0;this.useOffScreenCanvas()&&(f.colors=!1,f.scaled=!1);a=a||{};if("string"===typeof a)try{a=JSON.parse(a)}catch(h){b.error("can't parse displayImage opts: "+a,h)}if(this.display.blendMode&&
!1!==a.blendMode)for(c=0;c<b.images.length;c++){var g=b.images[c];g.display===this.display&&g.blend.active&&(e.push(g),d++)}f.colors&&this.mkColorData();f.scaled&&(this.mkColorCells(),this.mkScaledCells());if(f.rgb&&(this.mkRGBImage(),d))for(c=e.length-1;0<=c;c--)g=e[c],g.mkRGBImage();if(f.nodisplay)return this;if(f.display){this.display.context.clear();if(d){for(c=e.length-1;0<=c;c--)e[c].calcDisplayOffsets(!1);for(c=e.length-1;0<=c;c--)g=e[c],d={wcsim:a.wcsim,blend:g.blend.mode,opacity:g.blend.opacity},
g.putImage(d),g===this&&g.displayShapeLayers()}else this.putImage(a),this.displayShapeLayers();for(this.display.image=this;this.delayedShapes&&this.delayedShapes.length;){this.tmp.syncRunning=!0;a=this.delayedShapes.shift();switch(a.mode){case "add":this.addShapes(a.layer,a.shape,a.opts);break;case "change":this.changeShapes(a.layer,a.shape,a.opts)}delete this.tmp.syncRunning}delete this.delayedShapes}this.xeqPlugins("image","onimagedisplay");return this};b.Image.prototype.refreshImage=function(c,
a){a=a||{};if("string"===typeof a)try{a=JSON.parse(a)}catch(h){b.error("can't parse refreshImage opts: "+a,h)}if(c&&"string"!==typeof c){a.rawid=a.rawid||b.RAWID0;"function"===typeof a&&(a={onrefresh:a});!a.onrefresh&&b.imageOpts.onrefresh&&(a.onrefresh=b.imageOpts.onrefresh);if(!a.resetSection){var d=this.imageToLogicalPos({x:this.rgb.sect.xcen,y:this.rgb.sect.ycen});if(this.validWCS()){var e=b.pix2wcs(this.raw.wcs,this.rgb.sect.xcen,this.rgb.sect.ycen);var f=e.trim().split(/\s+/);var g=b.saostrtod(f[0]);
b.isHMS(this.params.wcssys)&&(g*=15);f=b.saostrtod(f[1])}}e=this.rgb.sect.zoom;this.binning.obin=this.binning.bin;this.mkRawDataFromHDU(c,a);a.resetSection?(this.mkSection(),this.mkSection(e)):(this.validWCS()&&b.notNull(g)&&b.notNull(f)?(f=b.wcs2pix(this.raw.wcs,g,f).trim().split(/ +/),c={x:parseFloat(f[0]),y:parseFloat(f[1])}):c=this.logicalToImagePos({x:d.x,y:d.y}),0<c.x&&c.x<this.raw.width&&0<c.y&&c.y<this.raw.height?this.mkSection(c.x,c.y,e):(this.mkSection(),this.mkSection(e)));this.displayImage("colors",
a);this.reFlipRot();this.notifyHelper();if(a.refreshRegions||a.resetSection||this.binning.obin!==this.binning.bin)this.refreshLayers(),this.updateShapes("regions","all","binning");this.xeqPlugins("image","onimagerefresh");b.waiting(!1);if(a.onrefresh)try{b.xeqByName(a.onrefresh,window,this)}catch(h){b.error("in image refresh callback",h)}return this}a.onrefresh&&(a.onload=a.onrefresh,delete a.onrefresh);a.refresh=this;e=document.domain?c||this.file:c||this.fitsFile||this.file;b.Load(e,a,{display:this.display})};
b.Image.prototype.fileDimensions=function(){if(this.parent&&"BINTABLE"!==this.parent.raw.header.XTENSION){var b=this.parent.raw.header.TABDIM1?this.parent.raw.header.TABDIM1:this.parent.raw.header.NAXIS1;var a=this.parent.raw.header.TABDIM2?this.parent.raw.header.TABDIM2:this.parent.raw.header.NAXIS2}else b=this.raw.header.TABDIM1?this.raw.header.TABDIM1:this.raw.header.NAXIS1,a=this.raw.header.TABDIM2?this.raw.header.TABDIM2:this.raw.header.NAXIS2;return{xdim:b,ydim:a}};b.Image.prototype.maybePhysicalToImage=
function(c){if("image"===this.imtab&&this.parent&&this.parent.lcs&&c.x&&c.y){c={x:c.x,y:c.y};c=b.Image.prototype.logicalToImagePos.call(this.parent,c,"ophysical");var a={x:Math.floor(c.x+.5),y:Math.floor(c.y+.5)}}return a};b.Image.prototype.displaySection=function(c,a){var d=this,e,f,g,h,k,m,l,p=function(a,c,d){var e;b.isNull(a)?b.isNull(c)||(e=c):e=a;return e||d},r=function(c,e){var g="";m=$.extend(!0,{},e||{});b.isNull(m.refreshRegions)&&(m.refreshRegions=!0);b.isNull(m.resetSection)&&(m.resetSection=
!0);!1!==m.waiting&&b.waiting(!0,d.display);c.fits.extname?g="["+c.fits.extname+"]":c.fits.extnum&&0<c.fits.extnum?g="["+c.fits.extnum+"]":d.parent&&(d.parent.extname?g="["+d.parent.extname+"]":d.parent.extnum&&0<d.parent.extnum&&(g="["+d.parent.extnum+"]"));g&&(m.id||(m.id=d.id.replace(/\[.*\]/,"")+g),m.file||(m.file=d.file.replace(/\[.*\]/,"")+g));if(m.separate){delete m.xcen;delete m.ycen;if("string"===typeof m.separate){g=m.separate.split(":");switch(g.length){case 1:e=g[0];break;default:e=g[0],
m.id=g[1]}m.display=b.lookupDisplay(e)}else m.display=d.display;"parentFile"===f&&d.fitsFile&&(e=b.lookupImage(d.fitsFile),m.parentFile=e&&e.parentFile?e.parentFile:d.fitsFile);h=d.listRegions("all",{mode:1,includedcoords:!0,ignoreignore:!0,saveediting:!0,savewcsconfig:!0,sortids:!1,saveid:!0});a=m.ondisplaysection||m.onrefresh||a;k=new b.Image(c,m,a);k.binning.obin=k.binning.bin;h&&!1!==m.refreshRegions&&k.addShapes("regions",h,{restoreid:!0});d.reFlipRot();k.setStatus("displaySection","complete")}else if("string"===
typeof m.refresh){delete m.xcen;delete m.ycen;g=m.refresh.split(":");switch(g.length){case 1:e=g[0];break;default:e=g[0],m.id=g[1]}m.display=b.lookupDisplay(e);m.display.image?(m.rawid=d.raw.id,m.onrefresh=m.ondisplaysection||m.onrefresh||a,m.display.image.refreshImage(c,m)):("parentFile"===f&&d.fitsFile&&(e=b.lookupImage(d.fitsFile),m.parentFile=e&&e.parentFile?e.parentFile:d.fitsFile),h=d.listRegions("all",{mode:1,includedcoords:!0,ignoreignore:!0,saveediting:!0,savewcsconfig:!0,sortids:!1,saveid:!0}),
a=m.ondisplaysection||m.onrefresh||a,k=new b.Image(c,m,a),k.binning.obin=k.binning.bin,h&&k.addShapes("regions",h,{restoreid:!0}),d.reFlipRot())}else m.rawid=d.raw.id,m.onrefresh=m.ondisplaysection||m.onrefresh||a,d.refreshImage(c,m);d.setStatus("displaySection","complete");b.waiting(!1)};this.raw&&this.raw.hdu&&this.raw.hdu.fits||b.error("invalid image for displaySection");c=c||{};if("full"===c){var n=this.fileDimensions();c={xdim:n.xdim,ydim:n.ydim,xcen:0,ycen:0}}else{if("selected"===c){this._selectShapes("regions",
"selected",null,function(b){b=b.pub;var c,e=0,f=0,g=1E6,h=0,k=1E6,l=0,n=b.shape;if(!d.parentFile&&b.lcs){b=b.lcs;var r=b.x;var p=b.y;if(c=d.maybePhysicalToImage({x:r,y:p}))r=c.x,p=c.y}else r=b.x,p=b.y;switch(n){case "annulus":var u=2*b.radii[b.radii.length-1];var x=2*b.radii[b.radii.length-1];break;case "box":u=b.width;x=b.height;break;case "circle":u=2*b.radius;x=2*b.radius;break;case "cross":u=b.width;x=b.height;break;case "ellipse":u=2*b.r1;x=2*b.r2;break;case "polygon":case "line":for(u=0;u<b.pts.length;u++)e+=
b.pts[u].x,f+=b.pts[u].y,b.pts[u].x>h&&(h=b.pts[u].x),b.pts[u].x<g&&(g=b.pts[u].x),b.pts[u].y>l&&(l=b.pts[u].y),b.pts[u].y<k&&(k=b.pts[u].y);b.x=e/b.pts.length;b.y=f/b.pts.length;"line"===b.shape&&2===b.pts.length?(u=Math.sqrt((b.pts[0].x-b.pts[1].x)*(b.pts[0].x-b.pts[1].x)+(b.pts[0].y-b.pts[1].y)*(b.pts[0].y-b.pts[1].y)),x=1):(u=h-g,x=l-k);break;case "text":x=u=10}m={xcen:r,ycen:p,xdim:u,ydim:x,from:"virtualFile",separate:!0,refreshRegions:!1,resetSection:!0};d.displaySection(m,a)});return}if("string"===
typeof c)try{c=JSON.parse(c)}catch(v){b.error("can't parse displaySection opts: "+c,v)}}c.cubecol=c.cubecol||"";if(c.cubecol){var u=this.file.split("/").reverse()[0].replace(/\[.*\]/,"").replace(".fits","_cube_"+c.cubecol+".fits").replace(/\.ftz$/,"_cube_"+c.cubecol+".fits").replace(/\.gz$/,"").replace(/\.bz2$/,"").replace(/:/g,"_");c.file||(c.file=u);c.id||(c.id=u);!1!==c.separate&&(c.separate=!0)}var x=c.separate?$.extend(!0,{},this.raw.hdu):this.raw.hdu;(f=c.from)||(f=this.parentFile&&b.helper.connected&&
b.helper.js9helper?"parentFile":"virtualFile");if("table"===this.imtab&&x.table)n=x.table;else{n={};n.bin=x.bin||1;"parentFile"===f&&this.raw.header&&b.notNull(this.raw.header.LTM1_1)&&(n.bin=1/Math.abs(this.raw.header.LTM1_1));var t={x:this.raw.width/2,y:this.raw.height/2};t=this.imageToLogicalPos(t);n.xcen=Math.floor(t.x+.5*(n.bin-1));n.ycen=Math.floor(t.y+.5*(n.bin-1));if(t=this.maybePhysicalToImage({x:n.xcen,y:n.ycen}))n.xcen=t.x,n.ycen=t.y;n.xdim=Math.floor(x.naxis1*n.bin);n.ydim=Math.floor(x.naxis2*
n.bin);n.filter=this.raw.filter||"";n.columns=this.raw.columns||""}if("string"===typeof c.bin)switch(c.bin.match(/[as]$/)&&(c.binMode=c.bin.slice(-1),c.bin=c.bin.slice(0,-1)),t=n.bin||this.binning.bin,c.bin.charAt(0)){case "*":case "x":case "X":c.bin=t*parseFloat(c.bin.slice(1));break;case "/":c.bin=t/parseFloat(c.bin.slice(1));break;case "i":case "I":c.bin=2*t;break;case "o":case "O":c.bin=t/2;break;default:b.isNumber(c.bin)?c.bin=parseFloat(c.bin):b.error("invalid bin for displaySection: "+c.bin)}c.xcen=
p(c.xcen,n.xcen,0);c.ycen=p(c.ycen,n.ycen,0);switch(this.imtab){case "table":c.xdim=p(c.xdim,n.xdim,b.fits.options.table.xdim);c.ydim=p(c.ydim,n.ydim,b.fits.options.table.ydim);c.bin=p(c.bin,n.bin,b.fits.options.table.bin);break;default:c.xdim=p(c.xdim,n.xdim,b.fits.options.image.xdim),c.ydim=p(c.ydim,n.ydim,b.fits.options.image.ydim),c.bin=p(c.bin,n.bin,b.fits.options.image.bin)}c.binMode=p(c.binMode,n.binMode,b.globalOpts.binMode);"string"===typeof c.bin&&(c.bin.match(/[as]$/)&&(c.binMode=c.bin.slice(-1)),
c.bin=parseFloat(c.bin));c.bin||(c.bin=1);"image"===this.imtab&&0<c.bin&&1>c.bin&&(c.bin=1/Math.floor(1/c.bin+.5));c.filter=p(c.filter,n.filter,"");this.raw.filter=c.filter||"";c.columns=p(c.columns,n.columns,"");this.raw.columns=c.columns||"";!1!==c.waiting&&b.waiting(!0,this.display);this.setStatus("displaySection","processing");window.setTimeout(function(){switch(f){case "parentFile":e=d.proxyFile;l=[];l.push({name:"xcen",value:c.xcen});delete c.xcen;l.push({name:"ycen",value:c.ycen});delete c.ycen;
l.push({name:"xdim",value:c.xdim});l.push({name:"ydim",value:c.ydim});void 0!==c.xdim&&(c.xdim=0);void 0!==c.ydim&&(c.ydim=0);c.binMode&&(c.bin=""+c.bin+c.binMode,delete c.binMode);l.push({name:"bin",value:c.bin});delete c.bin;u=(c.filter||"")+"@@"+(c.cols||"");l.push({name:"filter",value:u});l.push({name:"slice",value:c.slice||""});delete c.slice;g={id:d.expandMacro("$id"),image:d.file,fits:d.parentFile,rtype:"text"};g.cmd="js9Xeq imsection "+d.parentFile;c.extension&&(g.cmd=g.cmd.replace(/\[.*\]/,
""),g.cmd+="["+c.extension+"]",delete c.extension);g.cmd+=d.expandMacro(" $xdim@$xcen,$ydim@$ycen,$bin $filter $slice",l);b.helper.send("imsection",g,function(a){a="object"===typeof a?a:0<=a.search(b.analOpts.epattern)?{stderr:a}:{stdout:a};if(a.stderr)b.error(a.stderr);else if(a.errcode)b.error("in displaySection: "+a.errcode);else{var f=a.stdout.split(/\n/);a=b.cleanPath(f[0]);"/"!==a.charAt(0)&&(a=b.InstallDir(a));c.proxyFile=a;e&&e!==c.proxyFile&&d.removeProxyFile(e);if(f[1]){try{var g=JSON.parse(f[1])}catch(z){b.log("couldn't parse imsection as JSON: %s",
a),g=null}g&&(c.extname=g.extname,c.extnum=g.extnum,c.hdus=g.hdus,c.binstr=g.binstr,c.parent=g)}f[2]&&(g=b.cleanPath(f[2]),c.parentFile=g);b.fetchURL(a,a,c,function(a){b.cleanupFITSFile(d.raw,!0);!1!==c.waiting&&b.waiting(!0,d.display);b.fits.handleFITSFile(a,c,r)})}});break;case "virtualFile":b.cleanupFITSFile(d.raw,!1);b.getFITSImage(x.fits,x,c,function(b){r(b,c)});break;default:b.error("image section cannot be extracted from this data file")}},b.SPINOUT)};b.Image.prototype.displayExtension=function(c,
a,d){var e=this,f,g,h=function(c){var f=$.extend(!0,{},a);f.separate=!0;if(c===e.hdus.length){if(d)try{b.xeqByName(d,window,e)}catch(n){b.error("in displayExtension callback",n,!1)}}else{var g=e.hdus[c];"image"===g.type&&2<=g.naxis?e.displayExtension(g.hdu,f,function(){h(c+1)}):h(c+1)}};a=a||{};if("string"===typeof a)try{a=JSON.parse(a)}catch(l){b.error("can't parse displayExtension opts: "+a,l)}a.waiting=!1;this.hdus||b.error("no FITS HDUs found for displayExtension()");b.isNull(c)&&b.error("missing extname/extnum for displayExtension()");
if("all"===c)h(0);else{if("string"===typeof c){a.extension=c;var k=c.toLowerCase();for(g=f=0;f<this.hdus.length;f++)if(this.hdus[f].name&&this.hdus[f].name.toLowerCase()===k){g++;break}g||b.error("no FITS HDU "+c+" for displayExtension()")}else"number"===typeof c&&(a.extension=c,this.hdus[c]?k=this.hdus[c].name||c.toString():b.error("no FITS HDU "+c+" for displayExtension()"));if(a.separate){f="["+k+"]";c=this.id.replace(/\[.*\]/,"")+f;for(g=f=0;f<b.images.length;f++){var m=b.images[f];if(c===m.id&&
0<$("#"+m.display.id).length&&this.display.id===m.display.id){g++;break}}if(g){m.displayImage("display",a);m.display.clearMessage();if(d)try{b.xeqByName(d,window,this)}catch(l){b.error("in displayExtension callback",l,!1)}return}}a.separate||b.cleanupFITSFile(this.raw,!1);this.displaySection(a,d);return this}};b.Image.prototype.displaySlice=function(c,a,d){a=a||{};if("string"===typeof a)try{a=JSON.parse(a)}catch(f){b.error("can't parse displaySlice opts: "+a,f)}a.waiting=!1;b.isNull(c)&&b.error("missing slice for displaySlice()");
3!==this.raw.header.NAXIS&&b.error("3D image required for displaySlice()");if("all"===c)for(c=1;c<=this.raw.header.NAXIS3;c++){var e=$.extend(!0,{},a,{separate:!0});this.displaySlice(c,e,d)}else{b.isNumber(c)?a.slice="*:*:"+c:a.slice=c;if(a.separate)for(a.id=sprintf("%s_%s",this.id.replace(/_?([0-9])+:x:x/,"").replace(/_?x:([0-9])+:x/,"").replace(/_?x:x:([0-9])+/,""),a.slice.replace(/\*/g,"x")),c=0;c<b.images.length;c++)if(e=b.images[c],a.id===e.id&&0<$("#"+e.display.id).length)return e.displayImage("display",
{display:e}),this;b.cleanupFITSFile(this.raw,!1);this.displaySection(a,d)}return this};b.Image.prototype.toArray=function(c){var a;c=c||{};c.simple=!0;var d=$.extend(!0,{},this.raw.header);if(b.notNull(c.sect)){var e=c.sect;d.NAXIS1=e.x1-e.x0;d.NAXIS2=e.y1-e.y0;b.notNull(d.CRPIX1)&&(d.CRPIX1-=e.x0);b.notNull(d.CRPIX2)&&(d.CRPIX2-=e.y0);b.notNull(d.LTV1)&&(d.LTV1-=e.x0);b.notNull(d.LTV2)&&(d.LTV2-=e.y0);var f=Math.abs(this.raw.bitpix/8);var g=(e.x1-e.x0)*f;var h=g*(e.y1-e.y0);h=new ArrayBuffer(h);
h=new Uint8Array(h);var k=e.y0;for(a=0;k<e.y1;k++,a++)b.memcpy(h.buffer,a*g,this.raw.data.buffer,(k*this.raw.width+e.x0)*f,g)}else h=this.raw.data.buffer;d=b.raw2FITS({header:d},c);c=2880-d.length%2880;2880===c&&(c=0);for(k=0;k<c;k++)d+=" ";c=2880-h.byteLength%2880;2880===c&&(c=0);k=new ArrayBuffer(d.length+h.byteLength+c);var m=new Uint8Array(k);for(k=0;k<d.length;k++)m[k]=d.charCodeAt(k);if(0<(new Int8Array((new Int16Array([1])).buffer))[0]){f=d.length;g=Math.abs(this.raw.bitpix)/8;var l=new Uint8Array(h);
for(k=0;k<l.byteLength;k+=g)for(a=k+g-1,e=0;e<g;a--,e++)m[f++]=l[a]}else m.set(new Uint8Array(h),d.length);f=d.length+h.byteLength;for(k=0;k<c;k++)m[f++]=0;return m};b.Image.prototype.wcsAlign=function(){return this.wcsim&&this.params.wcsalign&&this.display===this.wcsim.display};b.Image.prototype.getPan=function(){var c=this.rgb.sect,a=(c.x0+c.x1)/2,d=(c.y0+c.y1)/2;b.notNull(c.ix)&&(a+=c.ix/(2*c.zoom));b.notNull(c.iy)&&(d+=c.iy/(2*c.zoom));return{x:a,y:d,ox:c.xcen,oy:c.ycen,x0:c.x0,y0:c.y0,x1:c.x1,
y1:c.y1,ix:c.ix||0,iy:c.iy||0}};b.Image.prototype.setPan=function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=$jscomp.makeIterator(a);d=e.next().value;e=e.next().value;if(!(0<=$.inArray("pan",this.params.disable))){0===a.length&&(d=this.raw.width/2,e=this.raw.height/2);if(1===a.length&&"string"===typeof d)if("mouse"===d&&this.ipos)d=this.ipos.x,e=this.ipos.y;else try{d=JSON.parse(d)}catch(m){b.error("can't parse setPan JSON: "+d,m)}if("object"===typeof d){a=d;b.notNull(a.x)&&
b.notNull(a.y)&&(d=a.x,e=a.y);b.notNull(a.px)&&b.notNull(a.py)&&(e=this.logicalToImagePos({x:a.px,y:a.py}),d=e.x,e=e.y);if("string"===typeof a.wcs){var f=a.wcs.trim().split(/ +/);a.ra=f[0];a.dec=f[1];3<=f.length&&(a.wcssys=f[2])}if(this.validWCS()&&b.notNull(a.ra)&&b.notNull(a.dec)){if(a.wcssys){var g=this.getWCSSys();var h=b.globalOpts.xeqPlugins;b.globalOpts.xeqPlugins=!1;this.setWCSSys(a.wcssys,!1)}"string"===typeof a.ra&&(a.ra=b.saostrtod(a.ra),b.isHMS(this.params.wcssys)&&(a.ra*=15));"string"===
typeof a.dec&&(a.dec=b.saostrtod(a.dec));f=b.wcs2pix(this.raw.wcs,a.ra,a.dec).trim().split(/ +/);d=parseFloat(f[0]);e=parseFloat(f[1]);g&&(this.setWCSSys(g,!1),b.globalOpts.xeqPlugins=h)}}b.isNumber(d)&&b.isNumber(e)||b.error("invalid input for setPan: "+d+" "+e);if(this.wcsAlign()||this.isawcsim){var k=b.globalOpts.panWithinDisplay;b.globalOpts.panWithinDisplay=!0}this.mkSection(d,e);if(this.wcsAlign()||this.isawcsim){for(g=0;g<b.images.length;g++)h=b.images[g],h!==this&&h.display===this.display&&
(h.wcsim===this||this.wcsim===h||h.wcsim&&h.wcsim===this.wcsim)&&(h.params.wcsalign||this.params.wcsalign)&&(a=b.pix2pix(this,h,{x:d,y:e}),h.mkSection(a.x,a.y));b.globalOpts.panWithinDisplay=k}this.displayImage("rgb");this.refreshLayers();b.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetpan");return this}};b.Image.prototype.getZoom=function(){return this.rgb.sect.zoom};b.Image.prototype.parseZoom=function(c){var a=[];var d=this.rgb.sect.zoom;switch(typeof c){case "string":switch(c.charAt(0)){case "*":case "x":case "X":var e=
d*parseFloat(c.slice(1));break;case "/":e=d/parseFloat(c.slice(1));break;case "I":case "i":e=2*d;break;case "O":case "o":e=d/2;break;case "T":case "t":if(this.params.transformAngle){d=-this.params.transformAngle;c={x:-this.raw.width/2,y:this.raw.height/2};a[0]=b.rotatePoint(c,d);c={x:this.raw.width/2,y:this.raw.height/2};a[1]=b.rotatePoint(c,d);c={x:-this.raw.width/2,y:-this.raw.height/2};a[2]=b.rotatePoint(c,d);c={x:this.raw.width/2,y:-this.raw.height/2};a[3]=b.rotatePoint(c,d);for(c=0;c<a.length;c++){if(b.isNull(f)||
a[c].x<f)var f=a[c].x;if(b.isNull(g)||a[c].x>g)var g=a[c].x;if(b.isNull(e)||a[c].y<e)e=a[c].y;if(b.isNull(h)||a[c].y>h)var h=a[c].y}f=g-f;e=h-e}else f=this.raw.width,e=this.raw.height;e=Math.min(this.display.width/f,this.display.height/e);e=Math.round(1E6*(e+1E-7))/1E6;break;default:e=parseFloat(c)}break;case "number":e=c;break;default:return}return e};b.Image.prototype.setZoom=function(c){var a;if(!(0<=$.inArray("zoom",this.params.disable))){(a=this.parseZoom(c))||b.error("invalid input for setZoom: "+
c);if(this.wcsAlign()||this.isawcsim){var d=b.globalOpts.panWithinDisplay;b.globalOpts.panWithinDisplay=!0}this.mkSection(a);if(this.wcsAlign()||this.isawcsim){for(c=0;c<b.images.length;c++){var e=b.images[c];if(e!==this&&e.display===this.display&&(e.wcsim===this||this.wcsim===e||e.wcsim&&e.wcsim===this.wcsim)&&(e.params.wcsalign||this.params.wcsalign)){var f=b.pix2pix(this,e,this.getPan());e.mkSection(f.x,f.y,a)}}b.globalOpts.panWithinDisplay=d}this.displayImage("rgb");this.refreshLayers();b.globalOpts.extendedPlugins&&
this.xeqPlugins("image","onsetzoom");return this}};b.Image.prototype.alignPanZoom=function(c,a){var d;if(c){"string"===typeof c&&((d=b.getImage(c))?c=d:b.error("unknown image for alignPanZoom: "+c));a=a||{};d=c.getPan();var e=c.rgb.sect.zoom||1;if(a=b.notNull(a.syncwcs)?a.syncwcs:b.globalOpts.syncWCS){var f=this.raw.wcsinfo||{cdelt1:1,crot:0};a=c.raw.wcsinfo||{cdelt1:1,crot:0};this.setPan(b.pix2pix(c,this,{x:d.ox,y:d.oy}));this.setZoom(e*f.cdelt1/a.cdelt1);this.setRotate(a.crot-f.crot)}else this.setPan({x:d.ox,
y:d.oy}),this.setZoom(e);return this}};b.Image.prototype.getNorthIsUp=function(c){var a={},d={galactic:{ra:15*b.saostrtod("12h51m26.00s"),dec:b.saostrtod("27d7m42.0s"),wcssys:"FK5"},ecliptic:{ra:15*b.saostrtod("18h0m0.0s"),dec:b.saostrtod("66d33m38.55s"),wcssys:"ICRS"}};var e=this.raw.wcsinfo||{cdelt1:1,cdelt2:1,crot:0};c||(c=this.getWCSSys());a.angle=0;0<e.cdelt1&&(a.flip="x");0>e.cdelt2&&(a.flip=(a.flip||"")+"y");switch(c){case "galactic":case "ecliptic":break;default:return e.crot&&(a.angle=-e.crot),
a}e=b.globalOpts.xeqPlugins;b.globalOpts.xeqPlugins=!1;this.setWCSSys(d[c].wcssys,!1);var f=b.pix2wcs(this.raw.wcs,this.raw.width/2,this.raw.height/2).trim().split(/\s+/);var g=b.saostrtod(f[0]);b.isHMS()&&(g*=15);f=b.saostrtod(f[1]);a.angle=b.angdist(g,f,d[c].ra,d[c].dec);b.notNull(this.raw.wcsinfo.crot)&&(a.angle-=this.raw.wcsinfo.crot);this.setWCSSys(c,!1);b.globalOpts.xeqPlugins=e;return a};b.Image.prototype.getTransform=function(){return this.params.transform};b.Image.prototype.setTransform=
function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];d=0;var e=1;a=$jscomp.makeIterator(a).next().value;this&&this.raw&&this.raw.header||b.error("invalid image for setTransform");if("reset"===a)delete this.params.transform,delete this.params.transformInverse,delete this.params.transformAngle,delete this.params.transformScale;else{var f=[[1,0,0],[0,1,0],[0,0,1]];for(a=0;a<b.globalOpts.transforms.length;a++)switch(b.globalOpts.transforms[a]){case "flip":switch(this.params.flip){case "x":var g=
[[-1,0,0],[0,1,0],[0,0,1]];f=b.matrixMultiply(f,g);e=-1;break;case "y":g=[[1,0,0],[0,-1,0],[0,0,1]];f=b.matrixMultiply(f,g);e=-1;break;case "xy":g=[[-1,0,0],[0,-1,0],[0,0,1]],f=b.matrixMultiply(f,g)}break;case "rot90":if(b.notNull(this.params.rot90)){var h=this.params.rot90*Math.PI/180;g=Math.cos(h);h=Math.sin(h);g=[[g,-h,0],[h,g,0],[0,0,1]];f=b.matrixMultiply(f,g);d+=this.params.rot90}break;case "rotate":b.notNull(this.params.rotate)&&(h=this.params.rotate*Math.PI/180,g=Math.cos(h),h=Math.sin(h),
g=[[g,-h,0],[h,g,0],[0,0,1]],f=b.matrixMultiply(f,g),d+=this.params.rotate)}this.params.transform=f;this.params.transformInverse=b.invertMatrix3(f);this.params.transformAngle=e*d;this.params.transformScale=e;return this}};b.Image.prototype.getFlip=function(){return this.params.flip};b.Image.prototype.setFlip=function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=$jscomp.makeIterator(a);var e=a.next().value;a=a.next().value;if(b.isNull(e))return this;if("reset"===e)return this.params.flip=
"none",this.setFlip(0);a=a||{};if("string"===typeof a)try{a=JSON.parse(a)}catch(m){b.error("can't parse setFlip opts: "+a,m)}this.xeqStashSave("setFlip",[e]);d=this.params;var f=0,g=0,h="";var k=(e+(this.params.flip||"")).split("");for(e=0;e<k.length;e++)switch(k[e]){case "x":f++;break;case "y":g++}1===f%2&&(h+="x");1===g%2&&(h+="y");d.flip=h||"none";this.setTransform();this.displayImage("all",a);this.refreshLayers();b.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetflip");return this};
b.Image.prototype.getRotate=function(){return this.params.rotate};b.Image.prototype.setRotate=function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];d=$jscomp.makeIterator(a);a=d.next().value;d=d.next().value;if(b.isNull(a))return this;if("reset"===a)return this.params.rotate=0,this.setRotate(0);if("string"===typeof a&&a.match(/north/i)){var e=this.getNorthIsUp();a=e.angle;b.notNull(e.flip)&&this.setParam("flip",e.flip)}"string"===typeof a&&(a=parseFloat(a));b.isNumber(a)||b.error("invalid rotation for setRotate: "+
a);this&&this.raw&&this.raw.header||b.error("invalid image for setRotate");d=d||{};if("string"===typeof d)try{d=JSON.parse(d)}catch(f){b.error("can't parse setRotate opts: "+d,f)}this.xeqStashSave("setRotate",[a]);e=this.params;for(b.globalOpts.rotateRelative&&(a+=this.params.rotate||0);0>a;)a+=360;for(;360<=a;)a-=360;e.rotate=a;this.setTransform();this.params.transformAngle&&this.display.canvas.width!==this.display.canvas.height&&this.mkSection(this.getZoom());this.displayImage("all",d);this.refreshLayers();
b.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetrotate");return this};b.Image.prototype.getRot90=function(){return this.params.rot90};b.Image.prototype.setRot90=function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];d=$jscomp.makeIterator(a);a=d.next().value;d=d.next().value;if(b.isNull(a))return this;if("reset"===a)return this.params.rot90=0,this.setRot90(0);"string"===typeof a&&(a=parseFloat(a));this&&this.raw&&this.raw.header||b.error("invalid image for setRot90");
d=d||{};if("string"===typeof d)try{d=JSON.parse(d)}catch(f){b.error("can't parse setRot90 opts: "+d,f)}switch(a){case 0:a=0;break;case 1:a=90;break;case -1:a=-90;break;case 90:break;case -90:break;default:b.error("invalid setRot90 rotation value: "+a+" (use: +/1, +/90)")}this.xeqStashSave("setRot90",[a]);var e=this.params;for(a+=this.params.rot90||0;0>a;)a+=360;for(;360<=a;)a-=360;270===a&&(a=-90);e.rot90=a;this.setTransform();this.params.transformAngle&&this.display.canvas.width!==this.display.canvas.height&&
this.mkSection(this.getZoom());this.displayImage("all",d);this.refreshLayers();b.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetrot90");return this};b.Image.prototype.reFlipRot=function(){var b=this.params.flip;var a=this.params.rot90,d=this.params.rotate;if("none"!==b){this.params.flip="none";var e=b.split("");for(b=0;b<e.length;b++)"x"!==e[b]&&"y"!==e[b]||this.setFlip(e[b])}if(a)for(this.params.rot90=0,e=Math.floor(Math.abs(a)/90),d=Math.sign(a),b=0;b<e;b++)this.setRot90(d);d&&this.setRotate(d);
return this};b.Image.prototype.refreshLayers=function(b){var a,c=$jscomp.makeIterator(Object.keys(this.layers));for(a=c.next();!a.done;a=c.next())a=a.value,this.layers[a].show&&this.layers[a].opts.panzoom&&(b&&b[a]&&(b[a].refresh=!0),this.refreshShapes(a));this.selectShapes("regions","selected")};b.Image.prototype.imageToLogicalPos=function(b,a){var c="image",e=b.x;var f=b.y;a=a||this.params.lcs||"image";switch(a){case "physical":if(this.lcs.physical){c=a;var g=this.lcs.physical.reverse;var h=this.lcs.physical.rrot;
var k=this.lcs.physical.cx;var m=this.lcs.physical.cy}break;case "detector":this.lcs.detector&&(c=a,g=this.lcs.detector.reverse,h=this.lcs.detector.rrot,k=this.lcs.detector.cx,m=this.lcs.detector.cy);break;case "amplifier":this.lcs.amplifier&&(c=a,g=this.lcs.amplifier.reverse,h=this.lcs.amplifier.rrot,k=this.lcs.amplifier.cx,m=this.lcs.amplifier.cy)}g&&(e=b.x*g[0][0]+b.y*g[1][0]+g[2][0],f=b.x*g[0][1]+b.y*g[1][1]+g[2][1],h&&(b=k+(e-k)*h[0][0]+(f-m)*h[1][0]+h[2][0],f=m+(e-k)*h[0][1]+(f-m)*h[1][1]+h[2][1],
e=b),"table"===this.imtab&&(h=0>this.raw.bitpix?.5:1,void 0!==this.raw.header.TABMIN1&&(e=e-h+this.raw.header.TABMIN1),void 0!==this.raw.header.TABMIN2&&(f=f-h+this.raw.header.TABMIN2)));return{x:e,y:f,sys:c}};b.Image.prototype.logicalToImagePos=function(b,a){var c={x:b.x,y:b.y};var e=this.raw.header.CRPIX1||1;var f=this.raw.header.CRPIX2||1;a=a||this.params.lcs||"image";switch(a){case "ophysical":if(this.lcs.ophysical){var g=this.lcs.ophysical.forward;var h=this.lcs.ophysical.frot}else this.lcs.physical&&
(g=this.lcs.physical.forward,h=this.lcs.physical.frot);break;case "physical":this.lcs.physical&&(g=this.lcs.physical.forward,h=this.lcs.physical.frot);break;case "detector":this.lcs.detector&&(g=this.lcs.detector.forward,h=this.lcs.detector.frot);break;case "amplifier":this.lcs.amplifier&&(g=this.lcs.amplifier.forward,h=this.lcs.amplifier.frot)}g&&("table"===this.imtab&&(a=0>this.raw.bitpix?.5:1,void 0!==this.raw.header.TABMIN1&&(b.x=b.x-this.raw.header.TABMIN1+a),void 0!==this.raw.header.TABMIN2&&
(b.y=b.y-this.raw.header.TABMIN2+a)),c.x=b.x*g[0][0]+b.y*g[1][0]+g[2][0],c.y=b.x*g[0][1]+b.y*g[1][1]+g[2][1],h&&(b=e+(c.x-e)*h[0][0]+(c.y-f)*h[1][0]+h[2][0],h=f+(c.x-e)*h[0][1]+(c.y-f)*h[1][1]+h[2][1],c.x=b,c.y=h));return c};b.Image.prototype.displayToImagePos=function(b){var a=this.rgb.sect,c=this.rgb.img.height;var e=this.display.width/2;var f=this.display.height/2;if(this.params.transformInverse){var g=this.params.transformInverse;var h=b.x-e;b=b.y-f;e=h*g[0][0]+b*g[1][0]+e;g=h*g[0][1]+b*g[1][1]+
f}else e=b.x,g=b.y;return{x:(e-this.ix+.5)/a.zoom+a.x0+.5,y:(c-(g-this.iy+.5))/a.zoom+a.y0+.5}};b.Image.prototype.imageToDisplayPos=function(b){var a=this.rgb.sect;var c=this.rgb.img.height;var e=this.display.width/2,f=this.display.height/2;var g=(b.x-.5-a.x0)*a.zoom+this.ix-.5;c=(a.y0-(b.y-.5))*a.zoom+c+this.iy-.5;this.params.transform&&(b=this.params.transform,a=g-e,c-=f,g=a*b[0][0]+c*b[1][0]+e,c=a*b[0][1]+c*b[1][1]+f);return{x:g,y:c}};b.Image.prototype.logicalToDisplayPos=function(b,a,d){return this.imageToDisplayPos(this.logicalToImagePos(b,
a,d))};b.Image.prototype.displayToLogicalPos=function(b){return this.imageToLogicalPos(this.displayToImagePos(b))};b.Image.prototype.getWCSSys=function(){if(this.params.wcssys)return this.params.wcssys};b.Image.prototype.setWCSSys=function(c,a){if(!(0<=$.inArray("wcs",this.params.disable)))return b.isNull(a)&&(a=b.globalOpts.wcsSetUpdatesDef),"image"===c?(this.params.wcssys="image",this.params.wcsunits="pixels",b.wcsunits.image="pixels"):"physical"===c?(this.params.wcssys="physical",this.params.wcsunits=
"pixels",a&&(b.globalOpts.wcsUnits.physical="pixels")):this.validWCS()&&("native"===c&&(c=this.params.wcssys0),c=b.wcssys(this.raw.wcs,c))&&(this.params.wcssys=c.trim(),c=b.globalOpts.wcsUnits[this.params.wcssys]||"sexagesimal",this.setWCSUnits(c,a)),b.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetwcssys"),this};b.Image.prototype.initWCS=function(c){var a,d=b.globalOpts.wcsHlength;var e=/(WCSNAME|WCSAXES|CRVAL[0-9]|CRPIX[0-9]|PC[0-9]_[0-9]|CDELT[0-9]|CD[0-9]_[0-9]|CTYPE[0-9]|CUNIT[0-9]|CRVAL[0-9]|PV[0-9]_[0-9]|PS[0-9]_[0-9]|RADESYS|LONPOLE|LATPOLE)([A-Z])/;
if(!this.raw.header)return this;c=c||this.raw.header;this.freeWCS();this.raw.altwcs={};var f="default";this.raw.altwcs[f]={};this.raw.altwcs[f].header=c;var g=$jscomp.makeIterator(Object.keys(c));for(f=g.next();!f.done;f=g.next())f=f.value,(a=f.match(e))&&a.length&&(f=a[2],this.raw.altwcs[f]||(this.raw.altwcs[f]={},this.raw.altwcs[f].header=$.extend({},c)),"RADESYS"===a[1]&&(a[1]="RADECSYS"),this.raw.altwcs[f].header[a[1]]=c[a[0]]);c=$jscomp.makeIterator(Object.keys(this.raw.altwcs));for(f=c.next();!f.done;f=
c.next()){f=f.value;e=b.raw2FITS(this.raw.altwcs[f].header);g=e.length+1;try{var h=b.vmalloc(g)}catch(k){b.error("can't malloc for wcsinit: "+g,k)}try{b.vstrcpy(e,h)}catch(k){b.error("can't copy for wcsinit: "+g,k)}this.raw.altwcs[f].wcs=b.initwcs(h,d);b.vfree(h);if(0<this.raw.altwcs[f].wcs)try{this.raw.altwcs[f].wcsinfo=JSON.parse(b.wcsinfo(this.raw.altwcs[f].wcs))}catch(k){}}this.setWCS("default");return this};b.Image.prototype.freeWCS=function(c){var a;c=c||this.raw;if(c.altwcs){var d=$jscomp.makeIterator(Object.keys(c.altwcs));
for(a=d.next();!a.done;a=d.next())a=a.value,0<c.altwcs[a].wcs&&(b.freewcs(c.altwcs[a].wcs),c.altwcs[a].wcs=null)}};b.Image.prototype.getWCS=function(){var b;var a=$jscomp.makeIterator(Object.keys(this.raw.altwcs));for(b=a.next();!b.done;b=a.next())if(b=b.value,this.raw.wcs===this.raw.altwcs[b].wcs)return a=$.extend(!0,{},this.raw.altwcs[b].wcsinfo),a.version=b,a.wcsname=this.raw.altwcs[b].header.WCSNAME,a;return null};b.Image.prototype.setWCS=function(c){var a;c=c||"default";if(!this.raw||!this.raw.altwcs)return this;
var d=$jscomp.makeIterator(Object.keys(this.raw.altwcs));for(a=d.next();!a.done;a=d.next()){a=a.value;var e=this.raw.altwcs[a].header.WCSNAME;if(c===a||c===e)return 0>=this.raw.altwcs[a].wcs&&b.error("invalid WCS for version: %s",c),this.raw.wcs=this.raw.altwcs[a].wcs,this.raw.wcsinfo=this.raw.altwcs[a].wcsinfo,c=this.raw.wcsinfo&&this.raw.wcsinfo.radecsys?this.raw.wcsinfo.radecsys:"native"!==this.params.wcssys?this.params.wcssys.trim():this.params.lcs,this.setWCSSys(c),this.params.wcssys0||(this.params.wcssys0=
c),this.setWCSUnits(this.params.wcsunits),this}b.error("could not find WCS version: "+c)};b.Image.prototype.validWCS=function(){return this.raw&&this.raw.wcs&&0<this.raw.wcs};b.Image.prototype.getWCSUnits=function(){return this.params.wcsunits?this.params.wcsunits:"pixels"};b.Image.prototype.setWCSUnits=function(c,a){if(!(0<=$.inArray("wcs",this.params.disable))){b.isNull(a)&&(a=b.globalOpts.wcsSetUpdatesDef);if("pixels"===c)b.isWCSSys(this.params.wcssys)&&(this.params.wcssys="physical"),this.params.wcsunits=
"pixels",a&&(b.globalOpts.wcsUnits[this.params.wcssys]="pixels");else if(this.validWCS()){if(b.notWCS(this.params.wcssys)){var d=b.imageOpts.wcssys;this.setWCSSys(d)}if(c=b.wcsunits(this.raw.wcs,c))this.params.wcsunits=c.trim(),a&&(b.globalOpts.wcsUnits[this.params.wcssys]=this.params.wcsunits)}b.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetwcsunits");return this}};b.Image.prototype.notifyHelper=function(){var c=this,a,d;var e=new RegExp("^"+b.ANON+"[0-9]*");var f=b.INSTALLDIR?new RegExp("^"+
b.INSTALLDIR):null;if(b.helper.connected&&!this.file.match(e)){switch(b.helper.type){case "get":case "post":b.helper.pageid||b.helper.send("pageid",null,function(a){a&&a.trim().match(/^[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}$/)&&(b.helper.pageid=a,b.helper.js9helper="js9helper")})}e=this.file;"/"!==e.charAt(0)&&f&&(d=this.file.replace(f,""));b.helper.send("image",{image:e,image2:d},function(d){if("object"===typeof d){var e=d.stdout;d.stderr&&1<b.DEBUG&&b.log(d.stderr)}else e=
d;e&&(d=e.trim().match(/(?:[^\s[]+|\[[^\]]*\])+/g)[1],"?"!==d&&(b.globalOpts.dataDir?(e=d.lastIndexOf("/")+1,c.fitsFile=b.globalOpts.dataDir+"/"+d.slice(e)):(c.fitsFile=d,c.fitsFile.includes("/")||(a=c.file.match(/.*\//))&&a.length&&(d=new RegExp("^"+b.INSTALLDIR),a=a[0].replace(d,""),c.fitsFile=a+c.fitsFile),b.globalOpts.prependJS9Dir&&(c.fitsFile&&!c.fitsFile.match(/^\${JS9_DIR}/)&&"/"!==c.fitsFile.charAt(0)&&(c.fitsFile="${JS9_DIR}/"+c.fitsFile),c.parentFile&&!c.parentFile.match(/^\${JS9_DIR}/)&&
"/"!==c.parentFile.charAt(0)&&(c.parentFile="${JS9_DIR}/"+c.parentFile))),1<b.DEBUG&&b.log("JS9 fitsFile: %s %s",c.file,c.fitsFile)),c.fitsFile&&(c.fitsFile=b.cleanPath(c.fitsFile)),c.parentFile&&(c.parentFile=b.cleanPath(c.parentFile)),c.queried||(c.queryHelper("all"),c.queried=!0))})}return this};b.Image.prototype.queryHelper=function(c){var a=this;c=c||"all";!b.helper.connected||"all"!==c&&"getAnalysis"!==c||this.analysisPackages||b.helper.send("getAnalysis",{fits:this.fitsFile},function(c){if(c)try{a.analysisPackages=
JSON.parse(c)}catch(e){b.log("can't get analysis",e)}});return this};b.Image.prototype.expandMacro=function(c,a){var d=this,e;if(c)return c.replace(/\${?([a-zA-Z][a-zA-Z0-9_()]+)}?/g,function(c,g,h){h=function(a){var c=d.params.wcssys;if(a)switch(a){case "wcs":b.notWCS(c)&&(d.params.wcssys=d.params.wcssys0);break;case "physical":case "image":d.params.wcssys=a}return c};var f=function(b){var a;"table"===d.imtab?d.raw.hdu&&d.raw.hdu.table.filter&&!b.match(d.raw.hdu.table.filter)&&(b=b.match(/\]\[/)?
b.slice(0,-1)+"&&"+d.raw.hdu.table.filter+"]":b+("["+d.raw.hdu.table.filter+"]")):"image"===d.imtab&&((a=d.file.match(/\[.*\]/))?b=b.match(/\[.*\]/)?b.replace(/\[.*\]/,a):b+a:d.raw&&d.raw.hdu&&d.raw.hdu.slice?(a=d.raw.hdu.slice.replace(/:/g,",").replace(/([0-9][0-9]*)/,"$1:$1"),b+="["+a+"]"):d.raw&&d.raw.header&&2<d.raw.header.NAXIS&&(b+="[*,*,1:1]"));return b},m=g.split("(");m[1]&&(m[1]=m[1].replace(/\)$/,""));switch(m[0]){case "id":var l=d.display.divjq.attr("id");break;case "image0":l=d.id.replace(/\[EVENTS\]/i,
"");break;case "image":l=d.id;break;case "filename":"all"==m[1]&&d.fitsFile&&d.raw&&d.raw.header&&3===d.raw.header.NAXIS?l=d.fitsFile:d.parentFile&&"this"!==m[1]?d.raw&&d.raw.filter?(l=d.parentFile,l.match(/\[.*\]/)||(l+="[EVENTS]"),l+="["+d.raw.filter+"]"):l=f(d.parentFile):d.fitsFile?l=f(d.fitsFile):b.error("no FITS file for "+d.id);break;case "fits":d.fitsFile||b.error("no FITS file for "+d.id);l=f(d.fitsFile);break;case "parent":d.parentFile||b.error("no parent FITS file for "+d.id);l=d.parentFile;
break;case "ext":d.fitsFile?(l=d.fitsFile.match(/\[.*\]/),null===l&&(l="")):b.error("no FITS file for "+d.id);break;case "imcenter":l=d.displayToLogicalPos({x:d.display.width/2,y:d.display.height/2});l=l.x+","+l.y;break;case "wcscenter":l=d.displayToImagePos({x:d.display.width/2,y:d.display.height/2});l=b.pix2wcs(d.raw.wcs,l.x,l.y).replace(/\s+/g,",");break;case "sregions":c=h(m[1]);l=d.listRegions("source",{mode:0,includedcoords:b.globalOpts.regExpandDCoords}).replace(/\s+/g,"");c&&(d.params.wcssys=
c);break;case "bregions":c=h(m[1]);l=d.listRegions("background",{mode:0,includedcoords:b.globalOpts.regExpandDCoords}).replace(/\s+/g,"");c&&(d.params.wcssys=c);break;case "regions":c=h(m[1]);l=d.listRegions("all",{mode:0,includedcoords:b.globalOpts.regExpandDCoords}).replace(/\s+/g,"");c&&(d.params.wcssys=c);break;case "mag":l=d.params.zoom?sprintf("%s%",100*d.params.zoom):"?";break;default:if(a)for(e=a.length,h=0;h<e;h++)if(a[h].name===g){l=a[h].value;break}if(void 0===l&&d&&void 0!==d.params[g])switch(g){case "wcsunits":switch(d.params[g]){case "sexagesimal":l=
"hms";break;case "degrees":l="deg";break;default:l=d.params[g]}break;case "scaleclipping":switch(d.params[g]){case "dataminmax":l="data";break;default:l=d.params[g]}break;case "colormap":l=d.useOffScreenCanvas()?"overlay":d.params[g];break;default:l="number"===typeof d.params[g]&&d.params[g]!==Math.floor(d.params[g])?d.params[g].toFixed(2):d.params[g]}void 0===l&&(l=c)}return l})};b.Image.prototype.lookupAnalysis=function(b){var a,c,e=null;if(this.analysisPackages){for(c=0;c<this.analysisPackages.length&&
!e;c++){var f=this.analysisPackages[c];for(a=0;a<f.length;a++){e=f[a];if(e.xclass&&e.xclass+":"+e.name===b)break;e=null}}if(e)return e;for(c=0;c<this.analysisPackages.length&&!e;c++)for(f=this.analysisPackages[c],a=0;a<f.length;a++){e=f[a];if(e.name===b)break;e=null}}return e};b.Image.prototype.validateAnalysis=function(c){var a,d=/imVar\((.*),(.*)\)/,e=/js9Var\((.*),(.*)\)/;var f=/fitsHeader\(([A-Za-z0-9_]+),(.*)\)/;var g=/winVar\((.*),(.*)\)/,h=function(b,a){return b&&a?String(b).toUpperCase()===
String(a).toUpperCase():!1};if(!c.title||!c.name||c.hidden)return!1;if(c.files){if(c.files.match(/^fits$/)&&!this.fitsFile||c.files.match(/^table$/)&&"table"!==this.imtab||c.files.match(/^image$/)&&"image"!==this.imtab)return!1;if(a=c.files.match(f))if(f=this.raw.header[a[1].toUpperCase()],!h(f,a[2]))return!1;if(a=c.files.match(g))if(f=b.varByName(a[1],window),!h(f,a[2]))return!1;if(a=c.files.match(e))if(f=b.varByName(a[1],b),!h(f,a[2]))return!1;if(a=c.files.match(d))if(f=b.varByName(a[1],this),!h(f,
a[2]))return!1}return!0};b.Image.prototype.getAnalysis=function(){var b,a,d=[];if(!this.analysisPackages)return d;for(a=0;a<this.analysisPackages.length;a++){var e=this.analysisPackages[a];for(b=0;b<e.length;b++){var f=e[b];this.validateAnalysis(f)&&d.push(f)}}return d};b.Image.prototype.runAnalysis=function(c,a,d){var e=this,f,g,h={},k=function(a,c){b.helper||b.error(a,c);switch(b.helper.type){case "nodejs":case "socket.io":b.helper.socket&&"polling"===b.helper.socket.io.engine.transport.name?window.setTimeout(function(){b.error(a,
c)},0):b.error(a,c);break;default:b.error(a,c)}};a=a||{};if("string"===typeof a)try{a=JSON.parse(a)}catch(m){b.error("can't parse runAnalysis opts: "+a,m)}d=d||b.globalOpts.analysisFunc;if(b.helper.connected&&this.analysisPackages){if(f=this.lookupAnalysis(c)){f.action&&(h.cmd=this.expandMacro(f.action,a));if(f.keys)for(h.keys={},c=0;c<f.keys.length;c++)h.keys[f.keys[c]]=this.expandMacro("$"+f.keys[c],a);h.id=this.expandMacro("$id");h.image=this.file;h.fits=this.fitsFile;h.rtype=f.rtype;switch(b.helper.type){case "nodejs":case "socket.io":c=
f.xclass?f.xclass+":"+f.name:f.name;break;default:c="runAnalysis"}b.waiting(!0,this.display);this.setStatus("runAnalysis","processing");b.helper.send(c,h,function(c){var l;var m="object"===typeof c?c:0<=c.search(b.analOpts.epattern)?{stderr:c}:{stdout:c};m.errcode=m.errcode||0;if(d)d.call(e,m.stdout,m.stderr,m.errcode,f);else{if(m.stderr)if(c=m.stderr,0<=c.search(/WARNING:/i)&&0>c.search(/ERROR:/i))b.log(c);else{k(c,b.analOpts.epattern);return}else if(m.errcode)if(c="ERROR: running "+f.name+" ["+
m.errcode+"]",m.stdout)b.log(c);else{k(c,b.analOpts.epattern);return}switch(f.rtype){case "text":case void 0:e.displayAnalysis("text",m.stdout,{divid:b.globalOpts.analysisDiv});break;case "plot":e.displayAnalysis("plot",m.stdout,{divid:b.globalOpts.analysisDiv});break;case "alert":m.stdout&&alert(m.stdout);break;case "fits":(l=m.stdout.split(/\s+/))&&l[0]&&(c=b.cleanPath(l[0]),"/"!==c.charAt(0)&&(c=b.InstallDir(c)),m={proxyFile:c},l[1]&&(l=b.cleanPath(l[1]),m.parentFile=l,m.proxyParent=l),m.fits2fits=
!1,m.fixpath=!1,b.Load(c,m,{display:e.display}));break;case "regions":if((l=m.stdout.split(/\s+/))&&l[0]){if(1<l.length)try{g=JSON.parse(l[1])}catch(r){g=null}g=g||{};"boolean"===typeof g.remove&&(g.remove="all");"string"===g.type?(g.remove&&e.removeShapes("regions",g.remove),e.addShapes("regions",l[0],a)):(c=b.cleanPath(l[0]),"/"!==c.charAt(0)&&(c=b.InstallDir(c)),h={responseType:"text"},b.fetchURL(null,c,h,function(b,a){g.remove&&e.removeShapes("regions",g.remove);e.addShapes("regions",b,a)}))}break;
case "catalog":(l=m.stdout.split(/\s+/))&&l[0]&&(c=b.cleanPath(l[0]),h={responseType:"text"},b.fetchURL(null,c,h,function(b,a){e.loadCatalog(null,b,a)}));break;case "none":break;default:b.error("unknown analysis result type: "+f.rtype)}}e.setStatus("runAnalysis","complete");b.waiting(!1)});return this}b.error("could not find analysis task: "+c)}};b.Image.prototype.displayAnalysis=function(c,a,d){var e=this,f,g;var h=b.lightOpts[b.LIGHTWIN];var k=function(){var a=b.Plot.opts.title;if(n&&u){$(b.lightOpts[b.LIGHTWIN].topid).arrive("#plotConfigForm",
{onceOnly:!0},function(){b.Plot.initConfigForm.call(e,u,r)});var c=b.allinone?b.allinone.plotConfigHTML:b.InstallDir(b.Plot.opts.configURL);u.winid=e.displayAnalysis("params",c,{title:a,winformat:"width=368px,height=110px,resize=1,scrolling=1"})}};d=d||{};if("string"===typeof d)try{d=JSON.parse(d)}catch(x){b.error("can't parse displayAnalysis opts: "+d,x)}var m=d.winformat;d.divid&&0<$("#"+d.divid).length&&(f=$("#"+d.divid));var l=d.title||"";this&&!l&&(d=this.fitsFile||this.id||"",d=d.split("/").reverse()[0],
l="AnalysisResults: "+d+sprintf(b.IDFMT,this.display.id));d="Analysis_"+b.uniqueID();switch(c){case "text":a="<div class='JS9Analysis'></div><pre class='JS9AnalysisText'>"+((a||"")+"</pre></div>");if(f)f.html(a),window.electron&&b.searchbar(f[0]);else{m=m||h.textWin;var p=b.lightWin(d,"inline",a,l,m);window.electron&&b.searchbar(p)}break;case "plot":if(a&&"string"===typeof a)try{var r=JSON.parse(a)}catch(x){b.error("can't plot return data: "+a,x)}else"object"===typeof a&&(r=a);if(!r)return;r.curscale=
{x:"linear",y:"linear"};a="<div id='"+d+"' class='JS9Analysis'><div id='"+d+"Plot' class='JS9Plot' ></div></div>";f?f.html(a):(m=m||h.plotWin,p=b.lightWin(d,"inline",a,l,m));var n=$("#"+d+" #"+d+"Plot");f&&(n.css("width",f.css("width")),n.css("height",f.css("height")),n.css("margin",0));if(r.data){switch(b.globalOpts.plotLibrary){case "plotly":h=$.extend(!0,{},b.Plot.opts,r.opts);r.label&&(h.title=r.label);a={x:[],y:[],type:"scatter"};3<=r.data[0].length&&(a.error_y={type:"data",array:[],visible:!0},
r.points&&r.points.yerr&&r.points.yerr.color&&(a.error_y.color=r.points.yerr.color));for(m=0;m<r.data.length;m++)a.x.push(r.data[m][0]),a.y.push(r.data[m][1]),a.error_y&&a.error_y.array&&a.error_y.array.push(r.data[m][2]);b.Plot.opts.annotate&&r.annotations&&(h.annotations=b.Plot.annotate(r));"log"===h.xscale&&(h.xaxis=h.xaxis||{},h.xaxis.type="log",h.xaxis.autorange=!0,r.curscale.x="log");"log"===h.yscale&&(h.yaxis=h.yaxis||{},h.yaxis.type="log",h.yaxis.autorange=!0,r.curscale.y="log");try{Plotly.newPlot(n.attr("id"),
[a],h)}catch(x){b.error("can't plot data (plotly)",x)}break;default:h=$.extend(!0,{},b.Plot.opts,r.opts);b.Plot.opts.annotate&&r.annotations&&(h.zoomStack.func=function(a,c){b.Plot.annotate(n,a,r)});r.color=r.color||h.color;"log"===r.xscale&&(h.xaxis=h.xaxis||{},h.xaxis.transform=b.Plot.logfunc,h.xaxis.inverseTransform=b.Plot.expfunc,r.curscale.x="log");"log"===r.yscale&&(h.yaxis=h.yaxis||{},h.yaxis.transform=b.Plot.logfunc,h.yaxis.inverseTransform=b.Plot.expfunc,r.curscale.y="log");try{var u=$.plot(n,
[r],h)}catch(x){b.error("can't plot data (flot)",x)}b.Plot.opts.annotate&&r.annotations&&b.Plot.annotate(n,u,r)}n.css("outline","none");n.attr("tabindex",0);n.on("keydown",function(a){a=b.eventToCharStr(a);switch(a){case "c":k();break;case "x":case "y":g="linear"!==r.curscale[a]?"linear":"log",b.Plot.rescale(n,u,r,a,g)}});m=$("<img src='"+b.InstallDir("images/gears.png")+"'>");m.on("click",k);a=$("<div class='JS9PlotGear'>");a.append(m);n.append(a)}break;case "params":case "regions":case "textline":f?
b.allinone?f.html(a):$.ajax({url:a,cache:!1,dataType:"text",success:function(b){f.html(b)}}):(m="params"===c?m||h.paramWin:"regions"===c?"small"===b.globalOpts.regConfigSize?m||h.regWin0:m||h.regWin:m||h.dpathWin,p=b.allinone?"inline":"ajax",p=b.lightWin(d,p,a,l,m))}return p};b.Image.prototype.saveFITS=function(c,a){if({}.hasOwnProperty.call(window,"saveAs")){c?(c=c.replace(/\s+/g,"_").replace(/(png|jpg|jpeg|fz)$/i,"fits"),c.match(/.fits$/)||(c+=".fits")):c="js9.fits";a=a||{};if("string"===typeof a){try{var d=
JSON.parse(a)}catch(f){d=null}d&&(a=d)}if("display"===a||"display"===a.source){a=this.rgb.sect;var e=this.toArray({notab:!0,twoaxes:!0,sect:a})}else"virtual"===a||"virtual"===a.source?this.raw.hdu&&this.raw.hdu.fits&&this.raw.hdu.fits.vfile?e=b.vread(this.raw.hdu.fits.vfile,"binary"):b.error("no virtual file available to save"):e=this.toArray({notab:!0,twoaxes:!0});a=new Blob([e],{type:"application/octet-binary"});b.saveAs(a,c)}else b.error("no saveAs() available to save FITS file");return c};b.Image.prototype.saveIMG=
function(c,a,d){var e;if({}.hasOwnProperty.call(window,"saveAs")){if("number"===typeof d){var f=d;d=null}else if("string"===typeof d){if(b.isNumber(d))f=parseFloat(d),d=null;else try{d=JSON.parse(d)}catch(l){d=null}d&&(f=d.quality)}d=d||{};c=c||"js9.png";a=a||"image/png";var g=this.display.width;var h=this.display.height;var k=document.createElement("canvas");k.setAttribute("width",g);k.setAttribute("height",h);var m=k.getContext("2d");"image"===d.source?m.putImageData(this.rgb.img,0,0):m.drawImage(this.display.canvas,
0,0);if(!1!==d.layers)for(d=$jscomp.makeIterator(Object.keys(this.layers)),e=d.next();!e.done;e=d.next())e=e.value,"main"===this.layers[e].dlayer.dtype&&this.layers[e].show&&(e=this.layers[e].dlayer.canvasjq[0],m.drawImage(e,0,0,g,h));b.notNull(f)&&(0>f||1<f)&&(f=.95);k.toBlob(function(a){b.saveAs(a,c)},a,f)}else b.error("no saveAs() available for saving image");return c};b.Image.prototype.savePNG=function(b,a){b=b||"js9.png";b.match(/\.png$/)||(b+=".png");return this.saveIMG(b,"image/png",a)};b.Image.prototype.saveJPEG=
function(b,a){b=b||"js9.jpg";b.match(/\.jpg$/)||b.match(/\.jpeg$/)||(b+=".jpg");return this.saveIMG(b,"image/jpeg",a)};b.Image.prototype.updateValpos=function(c,a){var d=null;var e=function(b,a){var c="";a=a||3;0>b&&(b=Math.abs(b),c="-");for(b=""+b;b.length<a;)b="0"+b;return c+b};if(this.params.valpos){void 0===a&&(a=!0);if(this.valpos)return a&&this.display.displayMessage("info",this.valpos,b.globalOpts.valposTarget),this.valpos;var f={x:c.x,y:c.y,sys:"image"};var g=this.imageToLogicalPos(c);var h=
this.imageToDisplayPos(c);h.sys="display";var k="image"===this.params.wcssys?f:g;d=this.raw.data[Math.floor(c.y-.5)*this.raw.width+Math.floor(c.x-.5)];switch(this.raw.bitpix){case 8:case 16:case -16:case 32:var m=e(d);break;case -32:case -64:m=b.floatFormattedString(d,this.params.precision,3);break;default:m=e(d)}e=m;var l=k.x.toFixed(3)+" "+k.y.toFixed(3)+" ("+k.sys+")";b.globalOpts.valposDCoords&&"image"===k.sys&&(l+="&nbsp;&nbsp;&nbsp;&nbsp;"+h.x.toFixed(3)+" "+h.y.toFixed(3)+" ("+h.sys+")");var p=
e+"&nbsp;&nbsp;&nbsp;&nbsp;"+l;d={ix:f.x,iy:f.y,ipos:f.x.toFixed(2)+"\t\t "+f.y.toFixed(2),isys:"image",px:g.x,py:g.y,ppos:g.x.toFixed(2)+"\t\t "+g.y.toFixed(2),psys:"physical",dx:h.x,dy:h.y,dpos:h.x.toFixed(2)+"\t\t "+h.y.toFixed(2),dsys:"display",cx:k.x,cy:k.y,cpos:k.x.toFixed(2)+"\t\t "+k.y.toFixed(2),csys:k.sys,ra:"",dec:"",wcspos:"",wcssys:"",racen:"",deccen:"",wcsfov:"",wcspix:"",val:d,val3:m,id:this.id,file:this.file,object:this.object||""};if(this.telescope||this.instrument)d.object&&(d.object+=
"  "),d.object+="(",this.telescope&&(d.object+=this.telescope,this.instrument&&(d.object+=", ")),this.instrument&&(d.object+=this.instrument),d.object+=")";if(this.validWCS()&&b.isWCSSys(this.params.wcssys)&&(c=b.pix2wcs(this.raw.wcs,c.x,c.y).trim().split(/\s+/),p=c[0]+" "+c[1]+" ("+(c[2]||"wcs")+")",p=e+"&nbsp;&nbsp;&nbsp;&nbsp;"+p+"&nbsp;&nbsp;&nbsp;&nbsp;"+l,d.ra=c[0],d.dec=c[1],d.wcspos=c[0]+"\t "+c[1],d.wcssys=c[2],this.raw.wcsinfo)){c=Math.abs(this.raw.wcsinfo.cdelt1);h=Math.abs(this.raw.wcsinfo.cdelt2);
f=1/60;if(this.raw.header.CUNIT1)var r=this.raw.header.CUNIT1;if(!r||r.match(/^deg/i))1<=c||1<=h?r="deg":c>=f||h>=f?(r="'",c*=60,h*=60):(r='"',c*=3600,h*=3600);k=this.rgb.sect;f=((k.x1-k.x0)*c).toFixed(0);h=((k.y1-k.y0)*h).toFixed(0);d.wcsfov=""+f+r+" \u00d7 "+h+r;f=(c/k.zoom).toFixed(3);d.wcspix=""+f+r+"/pix";d.wcsfovpix=d.wcsfov+"  ("+d.wcspix+")";c=b.pix2wcs(this.raw.wcs,(k.x1+k.x0)/2,(k.y1+k.y0)/2).trim().split(/\s+/);d.racen=c[0];d.deccen=c[1];d.wcscen=c[0]+"\t "+c[1]}d.vstrsmall=e+"&nbsp;&nbsp;&nbsp;&nbsp;"+
l;d.vstr=p;d.vstrmedium=p;d.vstrlarge=p+"&nbsp;&nbsp;&nbsp;&nbsp;"+this.file;a&&this.display.displayMessage("info",d,b.globalOpts.valposTarget)}return d};b.Image.prototype.toggleValpos=function(){this.params.valpos=!this.params.valpos;this.params.valpos||this.display.clearMessage()};b.Image.prototype.getColormap=function(){if(this.cmapObj)return{colormap:this.cmapObj.name,contrast:this.params.contrast,bias:this.params.bias}};b.Image.prototype.setColormap=function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-
0]=arguments[d];var e=this,f=$jscomp.makeIterator(a);d=f.next().value;var g=f.next().value;f=f.next().value;var h=function(a){if(e.cmapObj)switch(e.cmapObj.name){case "red":e.display.rgb.rim===e&&(e.display.rgb.rim=null);break;case "green":e.display.rgb.gim===e&&(e.display.rgb.gim=null);break;case "blue":e.display.rgb.bim===e&&(e.display.rgb.bim=null)}delete e.staticObj;e.cmapObj=b.lookupColormap(a);e.params.colormap=e.cmapObj.name;"static"===e.cmapObj.type&&(e.staticObj=$.extend(!0,{},e.cmapObj));
switch(a){case "red":e.display.rgb.rim=e;break;case "green":e.display.rgb.gim=e;break;case "blue":e.display.rgb.bim=e}e.params.overlay=!1},k=function(b,a){b=parseFloat(b);Number.isNaN(b)||(e.params.contrast=b);a=parseFloat(a);Number.isNaN(a)||(e.params.bias=a)},m=function(b){var a,c;for(a=0;a<b.length;a++)if($.isArray(b[a])&&"string"===typeof b[a][0])for(c=0;c<e.staticObj.colors.length;c++){var d=e.staticObj.colors[c];if(b[a][0]===d.name){switch(b[a].length){case 2:!1===b[a][1]||"false"===b[a][1]?
d.active=!1:!0===b[a][1]||"true"===b[a][1]?d.active=!0:(c=parseFloat(b[a][1]),0<c&&1>=c&&(c*=255),d.alpha=c);break;case 3:d.min=parseFloat(b[a][1]),Number.isNaN(d.min)&&(d.min=-Infinity),d.max=parseFloat(b[a][2]),Number.isNaN(d.max)&&(d.max=Infinity)}break}}e.params.overlay=!1};if(!(0<=$.inArray("colormap",this.params.disable)&&this.cmapObj)){switch(a.length){case 1:switch(d){case "rgb":this.display.rgb.active=!this.display.rgb.active;break;case "overlay":this.offscreen&&(this.params.overlay=!this.params.overlay);
break;case "invert":this.params.invert=!this.params.invert;break;case "reset":this.params.invert=b.imageOpts.invert;this.params.contrast=b.imageOpts.contrast;this.params.bias=b.imageOpts.bias;break;default:if(this.cmapObj&&"static"===this.cmapObj.type)if($.isArray(d))m(d);else if("string"===typeof d&&"["===d.charAt(0))try{var l=JSON.parse(d);m(l)}catch(p){b.error("can't parse JSON in setColormap: "+d,p)}else h(d);else"string"===typeof d&&h(d)}break;case 2:b.isNumber(d)&&b.isNumber(g)?k(d,g):this.cmapObj&&
"static"===this.cmapObj.type&&(h(d),m(g));break;case 3:h(d),k(g,f)}this.displayImage("colors");this.xeqStashDiscard("filterRGBImage");b.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetcolormap");return this}};b.Image.prototype.getScale=function(){if(this.params.scale)return{scale:this.params.scale,scalemin:this.params.scalemin,scalemax:this.params.scalemax,scaleclipping:this.params.scaleclipping}};b.Image.prototype.setScale=function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];
var e=this,f=$jscomp.makeIterator(a);d=f.next().value;var g=f.next().value;f=f.next().value;var h=function(a){b.scales.includes(a)?e.params.scale=a:"dataminmax"===a?(e.params.scaleclipping="dataminmax",e.params.scalemin=e.raw.dmin,e.params.scalemax=e.raw.dmax):"zscale"===a?(void 0!==e.params.z1&&void 0!==e.params.z2||e.zscale(!1),e.params.scaleclipping="zscale",e.params.scalemin=e.params.z1,e.params.scalemax=e.params.z2):"zmax"===a?(void 0===e.params.z1&&e.zscale(!1),e.params.scaleclipping="zmax",
e.params.scalemin=e.params.z1,e.params.scalemax=e.raw.dmax):"user"===a?e.params.scaleclipping="user":b.error("unknown scale: "+a)};if(!(0<=$.inArray("scale",this.params.disable))){if(a.length){switch(a.length){case 1:h(d);break;case 2:this.params.scalemin=parseFloat(d);this.params.scalemax=parseFloat(g);this.params.scaleclipping="user";break;default:h(d),"zscale"!==d&&"zmax"!==d&&(this.params.scalemin=parseFloat(g),this.params.scalemax=parseFloat(f),this.params.scaleclipping="user")}this.params.precision=
b.floatPrecision(this.params.scalemin,this.params.scalemax);this.displayImage("colors")}b.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetscale");return this}};b.Image.prototype.getOpacity=function(){var c={};b.notNull(this.params.opacity)?c.opacity=this.params.opacity:c.opacity=1;b.notNull(this.params.flooropacity)&&(c.flooropacity=this.params.flooropacity,c.floorvalue=this.params.floorvalue);return c};b.Image.prototype.setOpacity=function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-
0]=arguments[d];var e=$jscomp.makeIterator(a);d=e.next().value;var f=e.next().value;e=e.next().value;if(!(0<=$.inArray("opacity",this.params.disable))){if(a.length){switch(a.length){case 1:"string"===typeof d?"reset"===d.toLowerCase()?this.params.opacity=1:"resetfloor"===d.toLowerCase()?(delete this.params.floorvalue,delete this.params.flooropacity):"resetall"===d.toLowerCase()&&(this.params.opacity=1,delete this.params.floorvalue,delete this.params.flooropacity):b.isNumber(d)&&(this.params.opacity=
parseFloat(d));break;case 2:b.isNumber(d)&&b.isNumber(f)&&(this.params.floorvalue=parseFloat(d),this.params.flooropacity=parseFloat(f));break;case 3:b.isNumber(d)&&(this.params.opacity=parseFloat(d)),b.isNumber(f)&&b.isNumber(e)&&(this.params.floorvalue=parseFloat(f),this.params.flooropacity=parseFloat(e))}("number"===typeof d||"string"===typeof d&&!d.match(/reset/))&&this.mask.active&&this.mask.im&&(this.mask.active=!1);this.displayImage("colors")}b.globalOpts.extendedPlugins&&this.xeqPlugins("image",
"onsetopacity");return this}};b.Image.prototype.getParam=function(b){return b?"all"===b?this.params:this.params[b]:null};b.Image.prototype.setParam=function(c,a){if(!c)return null;a="true"===a?!0:"false"===a?!1:b.isNumber(a)?parseFloat(a):a;if("all"===c&&"object"===typeof a){$.extend(!0,this.params,a);if(a.colormap||a.contrast||a.bias)c=this.getColormap(),a.colormap=a.colormap||c.colormap,a.contrast=a.contrast||c.contrast,a.bias=a.bias||c.bias,this.setColormap(a.colormap,a.contrast,a.bias);if(a.scale||
a.scalemin||a.scalemax)c=this.getScale(),a.scale=a.scale||c.scale,a.scalemin=a.scalemin||c.scalemin,a.scalemax=a.scalemax||c.scalemax,this.setScale(a.scale,a.scalemin,a.scalemax);a.flip&&(this.setFlip("reset"),this.setFlip(a.flip));a.rot90&&(this.setRot90("reset"),this.setRot90(a.rot90));a.rotate&&(this.setRotate("reset"),this.setRotate(a.rotate));a.invert&&(this.params.invert=a.invert,this.displayImage("colors"));a.zoom&&this.setZoom(a.zoom);a.wcssys&&this.setWCSSys(a.wcssys);a.wcsunits&&this.setWCSUnits(a.wcsunits);
return this.params}if("disable"===c){$.isArray(a)||(a=[a]);for(c=0;c<a.length;c++){var d=$.inArray(a[c],this.params.disable);0>d&&this.params.disable.push(a[c])}return this.params.disable}if("enable"===c){$.isArray(a)||(a=[a]);for(c=0;c<a.length;c++)d=$.inArray(a[c],this.params.disable),0<=d&&this.params.disable.splice(d,1);return this.params.disable}d=this.params[c];this.params[c]=a;switch(c){case "colormap":this.setColormap(a);break;case "invert":this.displayImage("colors");break;case "contrast":c=
this.getColormap();this.setColormap(c.colormap,a,c.bias);break;case "bias":c=this.getColormap();this.setColormap(c.colormap,c.contrast,a);break;case "overlay":this.displayImage("colors");break;case "flip":this.setFlip("reset");this.setFlip(a);break;case "rot90":this.setRot90("reset");this.setRot90(a);break;case "rotate":this.setRotate("reset");this.setRotate(a);break;case "scale":this.setScale(a);break;case "scalemin":c=this.getScale();this.setScale("user",a,c.scalemax);break;case "scalemax":c=this.getScale();
this.setScale("user",c.scalemin,a);break;case "scaleclipping":c=this.getScale();this.setScale(a,c.scalemin,c.scalemax);break;case "wcssys":this.setWCSSys(a);break;case "wcsunits":this.setWCSUnits(a);break;case "zoom":this.setZoom(a)}return d};b.Image.prototype.copyParams=function(c,a,d){var e,f=[];if(c){d=d||{};if("string"===typeof c&&"["===c.charAt(0))try{c=JSON.parse(c)}catch(l){b.error("can't parse JSON in copyParams: "+c,l)}$.isArray(c)||(c=[c]);var g=$.inArray("regions",c);0<=g&&(c.splice(g,
1),c.unshift("regions"));a=a||b.images;if("string"===typeof a&&"["===a.charAt(0))try{a=JSON.parse(a)}catch(l){b.error("can't parse JSON in copyParams: "+a,l)}$.isArray(a)||(a=[a]);for(g=0;g<a.length;g++){var h=a[g];"string"===typeof h&&((h=b.lookupImage(h))||b.error("unknown image for copyParams"));if(h!==this){h!==h.display.image&&0>$.inArray(h.display.image,f)&&f.push(h.display.image);try{for(e=0;e<c.length;e++){var k=c[e];switch(k){case "alignment":h.alignPanZoom(this);break;case "contrastbias":var m=
this.getParam("contrast");h.setParam("contrast",m);m=this.getParam("bias");h.setParam("bias",m);break;case "pan":m=this.getPan();h.setPan(b.pix2pix(this,h,{x:m.ox,y:m.oy}));break;case "regions":this.copyRegions(h);break;case "shapes":d.layer&&this.copyShapes(d.layer,h);break;case "wcs":m=this.getParam("wcssys");h.setParam("wcssys",m);m=this.getParam("wcsunits");h.setParam("wcsunits",m);break;default:m=this.getParam(k),h.setParam(k,m)}}}catch(l){b.error("could not copy params for "+h.id)}finally{if(f.length)for(g=
0;g<f.length;g++)f[g].displayImage()}}}}};b.Image.prototype.getStatus=function(c){if(!b.isNull(c)&&"string"===typeof c)switch(c.toLowerCase()){case "close":return this.status.close;case "displaysection":case "displayextension":return this.status.displaySection;case "createmosaic":return this.status.createMosaic;case "load":case "preload":return b.fetchURL.status?b.fetchURL.status:this.status.load;case "loadcatalog":return this.status.loadCatalog;case "loadcolormap":return this.status.loadColormap;
case "loadproxy":return this.status.loadProxy;case "loadregions":return this.status.loadRegions;case "loadsession":return this.status.loadSession;case "reproject":case "reprojectdata":case "rotate":case "rotatedata":return this.status.reprojectData;case "runanalysis":return this.status.runAnalysis;case "separate":return this.status.separate;case "uploadfitsfile":return this.status.uploadFITSFile}};b.Image.prototype.setStatus=function(c,a){if(b.notNull(c)&&b.notNull(a))switch(a){case "error":case "complete":delete this.status.cur;
break;default:this.status.cur=c}this.status[c]=a};b.Image.prototype.dataminmax=function(c,a){var d=this.raw;var e=this.params;var f=this.raw.data;var g=Number.isNaN(e.scalemin)||!Number.isFinite(e.scalemin)||b.isNull(e.scalemin);var h=Number.isNaN(e.scalemax)||!Number.isFinite(e.scalemax)||b.isNull(e.scalemax);if("dataminmax"===e.scaleclipping){if(d.dmin===e.scalemin||b.isNull(d.dmin))g=!0;if(d.dmax===e.scalemax||b.isNull(d.dmax))h=!0}if(b.notNull(c)&&b.notNull(a))d.dmin=c,d.dmax=a;else if(d.dmin=
Number.MAX_VALUE,d.dmax=Number.MIN_VALUE,0<d.bitpix)if(void 0!==d.header.BLANK){var k=d.header.BLANK;for(c=0;c<f.length;c++)a=f[c],a!==k&&(a<d.dmin&&(d.dmin=a),a>d.dmax&&(d.dmax=a))}else for(c=0;c<f.length;c++)a=f[c],a<d.dmin&&(d.dmin=a),a>d.dmax&&(d.dmax=a);else for(c=0;c<f.length;c++)a=f[c],!Number.isNaN(a)&&Number.isFinite(a)&&(a<d.dmin&&(d.dmin=a),a>d.dmax&&(d.dmax=a));g&&(e.scalemin=d.dmin);h&&(e.scalemax=d.dmax);e.precision=b.floatPrecision(e.scalemin,e.scalemax);return this};b.Image.prototype.zscale=
function(c){if(!b.zscale||!this.raw||!this.raw.data)return this;var a=this.raw.data;var d=a.length*a.BYTES_PER_ELEMENT;try{var e=b.vmalloc(d)}catch(f){b.error("image too large for zscale malloc: "+d,f)}try{b.vmemcpy(new Uint8Array(a.buffer),e)}catch(f){b.error("can't copy image to zscale heap: "+d,f)}a=b.zscale(e,this.raw.width,this.raw.height,this.raw.bitpix,this.params.zscalecontrast,this.params.zscalesamples,this.params.zscaleline);b.vfree(e);e=a.trim().split(/\s+/);this.params.z1=parseFloat(e[0]);
this.params.z2=parseFloat(e[1]);"zmax"===c?(this.params.scalemin=this.params.z1,this.params.scalemax=this.raw.dmax):c&&(this.params.scalemin=this.params.z1,this.params.scalemax=this.params.z2);this.params.precision=b.floatPrecision(this.params.scalemin,this.params.scalemax);return this};b.Image.prototype.countsInRegions=function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=this,f,g;d="field";var h="",k=function(a,c){var d=/(annulus|box|circle|ellipse|line|polygon|point|text) *\(/;
if(!a)return c;if("string"===typeof a){var f=e.expandMacro(a);if(!f)return c;if(f.match(d))return f}(d=e.getShapes("regions",a))&&d.length||b.error("no regions found: "+a);f="";for(a=0;a<d.length;a++){var g=d[a];e.params.wcssys?(f||(f=g.wcssys||""),f+="; "+g.wcsstr):(f||(f=g.imsys||""),f+="; "+g.imstr)}return f||c};this.raw.hdu&&this.raw.hdu.fits&&this.raw.hdu.fits.vfile||b.error("no virtual file available for regcnts: "+this.id);for(f=0;f<a.length;f++){var m=a[f];if("string"===typeof m&&"{"===m.charAt(0))try{a[f]=
JSON.parse(m)}catch(p){b.error("can't parse JSON arg in regcnts: "+m,p)}}switch(a.length){case 0:break;case 1:"object"===typeof a[0]?g=a[0]:d=k(a[0],"field");break;case 2:d=k(a[0],"field");"object"===typeof a[1]?g=a[1]:h=k(a[1],"");break;default:d=k(a[0],"field"),h=k(a[1],""),g=a[2]}g=g||{};g.reduce=g.reduce||b.globalOpts.reduceRegcnts;g.dim=g.dim||Math.max(b.globalOpts.image.xdim,b.globalOpts.image.ydim);f=g.cmdswitches||"";a=this.raw.hdu.fits.vfile;(m=this.file.match(/\[.*\]/))&&(a+=m);"table"===
this.imtab?(m=this.raw.hdu.table.filter)&&!a.match(m)&&(a=a.match(/\]\[/)?a.slice(0,-1)+"&&"+m+"]":a+("["+m+"]")):3===this.raw.header.NAXIS&&0>f.search(/(^| )-c/)&&(f+=" -c "+(this.raw.hdu.slice||1));if(g.reduce&&!this.parentFile&&3>this.raw.header.NAXIS&&(m=this.fileDimensions(),m=Math.floor(Math.max(m.xdim,m.ydim)/g.dim+.5),1<m))if("table"===this.imtab)f+=" -b "+m;else{var l="bin"+m+"_"+a.split("/").reverse()[0];b.imsection(a,l,"0@0,0@0,"+m,"");a=l}b.waiting(!0,this.display);m=b.regcnts(a,d,h,f);
b.waiting(!1);l&&b.vunlink(l);(m.match(/^ERROR/)||m.match(/FITSIO status/))&&b.error(m);g.lightwin&&this.displayAnalysis("text",m,{divid:b.globalOpts.analysisDiv});return m};b.Image.prototype.radialProfile=function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=[];var f={cmdswitches:"-G -j -r"};for(d=0;d<a.length;d++)if("object"===typeof a[d]){var g=$.extend(!0,{},a[d],f);e.push(g);var h=g}else e.push(a[d]);g||e.push(f);h=h||{};if(d=this.countsInRegions.apply(this,$jscomp.arrayFromIterable(e)))try{var k=
JSON.parse(d)}catch(m){b.error("can't parse regcnts JSON",m)}k&&k.columnUnits&&k.columnUnits.radii||b.error("no radii available for radial profile");d=k.columnUnits.radii;a=k.columnUnits.surfBrightness;g=h.color||"green";e=h.errorcolor||"red";h=b.isNull(h.errorbars)||h.errorbars?"y":"n";h={color:sprintf("%s",g),label:sprintf("surface brightness(%s) vs. radius(%s)",a,d),points:{errorbars:sprintf("%s",h),yerr:{show:"true",color:sprintf("%s",e)}},data:[]};for(d=0;d<k.backgroundSubtractedResults.length;d++)a=
k.backgroundSubtractedResults[d],("undefined"===a.radius2||"NA"===a.radius2||a.radius1>a.radius2)&&b.error("radial profile source region must be an annulus"),a=[(a.radius1+a.radius2)/2,a.surfBrightness,a.surfError],h.data.push(a);return this.displayAnalysis("plot",h,{divid:b.globalOpts.analysisDiv})};b.Image.prototype.plot3d=function(c,a,d){var e,f,g=[];this.raw.header&&3===this.raw.header.NAXIS||b.error("plot3d requires a data cube with 3 dimensions");d=$.extend(!0,{},d,b.globalOpts.plot3d);d.cube=
d.cube||"*:*:all";var h=d.cube.split(":");for(e=0;e<h.length;e++)if("all"===h[e]){var k=e+1;break}k||b.error("plot3d requires specification of cube's third index");d.cmdswitches="-j -c "+d.cube;h=d.mode||"avg";d.areaunits?d.areaunits.match(/^p/)?(d.areaunits="pixels",d.cmdswitches+=" -p"):d.areaunits.match(/^a/)?d.areaunits="arcsec":(d.areaunits="pixels",d.cmdswitches+=" -p"):(d.areaunits="pixels",d.cmdswitches+=" -p");e=d.color||"green";if(c=this.countsInRegions(c,a,d))try{var m=JSON.parse(c)}catch(p){b.error("can't parse regcnts results: "+
c,p)}m||b.error("no regcnts info available for plot3d");c=(c=this.raw.header["CTYPE"+String(k)])?c.toLowerCase():"slice";a="avg"===h?"pixels"===d.areaunits?"counts/pixel**2":"counts/arcsec**2":"summed counts";a={color:sprintf("%s",e),label:sprintf("%s vs %s ",a,c),data:[]};var l=this.raw.header["CRVAL"+String(k)]||0;k=this.raw.header["CDELT"+String(k)]||1;for(e=0;e<m.source.cubeSlices;e++){c="backgroundSubtractedResults"+String(e+1);for(f=g[e]=0;f<m[c].length;f++)g[e]="avg"===h?g[e]+m[c][f].surfBrightness:
g[e]+m[c][f].netCounts;c=[e*k+l,g[e]];a.data.push(c)}return this.displayAnalysis("plot",a,{divid:d.divid||b.globalOpts.analysisDiv})};b.Image.prototype.rawDataLayer=function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=$jscomp.makeIterator(a);d=e.next().value;e=e.next().value;if(!a.length)return this.raw.id;d=d||{};if("string"===typeof d)if("function"===typeof e)d={rawid:d};else{var f=d;for(a=0;a<this.raws.length;a++){var g=this.raws[a];if(f===g.id){if("remove"===e){f===b.RAWID0&&
b.error("can't remove primary (raw0) data layer");if(g.hdu&&g.hdu.fits){var h=b.lookupVfile(g.hdu.fits.vfile);1>=h.length&&b.cleanupFITSFile(g,!0)}this.raw=this.raws[0];if(g.current0&&g.current0.id)for(h=0;h<this.raws.length;h++)if(g.current0.id===this.raws[h].id){this.raw=this.raws[h];break}for(h=0;h<b.images.length;h++)(d=b.images[h])&&d.xeqstash&&d.xeqStashDiscard(f);this.raws.splice(a,1)}else this.raw=g;this.raw.header.BITPIX&&(this.raw.bitpix=this.raw.header.BITPIX);this.imtab=this.raw.imtab||
this.imtab;this.params.scalemin=void 0;this.params.scalemax=void 0;this.dataminmax();this.mkSection();this.initWCS();this.initLCS();this.displayImage("all");this.refreshLayers();b.globalOpts.extendedPlugins&&this.xeqPlugins("image","onrawdatalayer");return!0}}return!1}if("function"!==typeof e)return!1;var k=d.rawid||b.RAWIDX;void 0===d.oraw&&(d.oraw="current0");if("current"===d.oraw)f=this.raw;else if("current0"===d.oraw)f=this.raw.id===k?this.raw.current0:this.raw;else for(a=0;a<this.raws.length;a++)if(g=
this.raws[a],d.oraw===g.id){f=g;break}f||(f=this.raws[0]);g=-1;for(a=0;a<this.raws.length;a++)if(k===this.raws[a].id){h=this.raws[a];g=a;break}if(0>g||d.alwaysCopy){h=$.extend(!0,{},f);h.current0=f;if(d.bitpix){switch(d.bitpix){case 8:h.data=new Uint8Array(f.height*f.width);break;case 16:h.data=new Int16Array(f.height*f.width);break;case -16:h.data=new Uint16Array(f.height*f.width);break;case 32:h.data=new Int32Array(f.height*f.width);break;case -32:h.data=new Float32Array(f.height*f.width);break;
case -64:h.data=new Float64Array(f.height*f.width);break;default:b.error("unsupported bitpix: "+d.bitpix)}var m=h.width*h.height;for(a=0;a<m;a++)h.data[a]=f.data[a];h.bitpix=d.bitpix}else switch(f.bitpix){case 8:h.data=new Uint8Array(f.data);break;case 16:h.data=new Int16Array(f.data);break;case -16:h.data=new Uint16Array(f.data);break;case 32:h.data=new Int32Array(f.data);break;case -32:h.data=new Float32Array(f.data);break;case -64:h.data=new Float64Array(f.data);break;default:b.error("unsupported bitpix: "+
f.bitpix)}h.id=k;h.from=d.from||h.from||"func"}e.call(this,f,h,d)&&(0<=g?this.raws[g]=h:this.raws.push(h),this.raw=h,this.raw.header.bitpix&&(this.raw.bitpix=this.raw.header.bitpix),!1!==d.dataminmax&&this.dataminmax(),d.updatewcs&&(this.initWCS(),this.initLCS()),d.resetpan&&this.setPan(),this.refreshLayers(),this.displayImage("all",d),this.reFlipRot());return!0};b.Image.prototype.gaussBlurData=function(c,a){void 0===c&&b.error("missing sigma value for gaussBlurData");this.params.sigma=c;a=a||{};
if("string"===typeof a)try{a=JSON.parse(a)}catch(d){b.error("can't parse gaussBlur opts: "+a,d)}a.bitpix=-64===this.raw.bitpix?-64:-32;a.oraw="current0";a.alwaysCopy=!0;a.rawid=a.rawid||"gaussBlur";a.sigma=c;this.xeqStashSave("gaussBlurData",[c],a.rawid);this.rawDataLayer(a,function(a,e){switch(e.bitpix){case -32:var d=new Float32Array(e.data);break;case -64:d=new Float64Array(e.data);break;default:b.error("invalid temp bitpix for gaussBlur: "+e.bitpix)}gaussBlur(d,e.data,e.width,e.height,c);return!0});
return this};b.Image.prototype.imarithData=function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=$jscomp.makeIterator(a),f=e.next().value;d=e.next().value;e=e.next().value;if(!a.length)return"add sub mul div min max reset".split(" ");e=e||{};if("string"===typeof e)try{e=JSON.parse(e)}catch(g){b.error("can't parse imarith opts: "+e,g)}e.rawid=e.rawid||"imarith";if("reset"===f||"remove"===f)this.rawDataLayer(e.rawid,"remove");else{void 0!==f&&void 0!==d||b.error("missing arg(s) for image arithmetic");
this.xeqStashSave("imarithData",a.slice(),e.rawid);switch(f){case "add":case "sub":case "mul":case "div":case "min":case "max":e.op=f;break;default:b.error("invalid operator for image arithmetic: "+f)}"object"===typeof d?(this.raw.width===d.raw.width&&this.raw.height===d.raw.height||b.error("images must be the same size for image arithmetic"),e.argtype="image",e.argval=d):b.isNumber(d)?(e.argtype="value",e.argval=d):((a=b.lookupImage(d))||b.error("imarith arg1 must be an image or a constant: "+d),
e.argval=a,e.argtype="image");"div"===e.op&&"value"===e.argtype&&0===e.argval&&b.error("imarith can't divide by zero (nor can anyone else)");if(!e.bitpix)switch(e.argtype){case "image":e.bitpix=0<this.raw.bitpix&&0<e.argval.raw.bitpix?Math.max(this.raw.bitpix,e.argval.raw.bitpix):0>this.raw.bitpix&&0>e.argval.raw.bitpix?Math.min(this.raw.bitpix,e.argval.raw.bitpix):0>this.raw.bitpix&&0<e.argval.raw.bitpix?this.raw.bitpix:e.argval.raw.bitpix;break;case "value":e.bitpix=-64===this.raw.bitpix?-64:-32}e.alwaysCopy=
!0;e.oraw="current";this.rawDataLayer(e,function(a,c,d){switch(d.argtype){case "image":a=d.argval.raw.data;switch(d.op){case "add":for(d=0;d<c.data.length;d++)c.data[d]+=a[d];break;case "sub":for(d=0;d<c.data.length;d++)c.data[d]-=a[d];break;case "mul":for(d=0;d<c.data.length;d++)c.data[d]*=a[d];break;case "div":for(d=0;d<c.data.length;d++)c.data[d]=0===a[d]?0:c.data[d]/a[d];break;case "min":for(d=0;d<c.data.length;d++)c.data[d]=Math.min(c.data[d],a[d]);break;case "max":for(d=0;d<c.data.length;d++)c.data[d]=
Math.max(c.data[d],a[d]);break;default:b.error("unknown operation for imarith: "+d.op)}break;case "value":a=d.argval;switch(d.op){case "add":for(d=0;d<c.data.length;d++)c.data[d]+=a;break;case "sub":for(d=0;d<c.data.length;d++)c.data[d]-=a;break;case "mul":for(d=0;d<c.data.length;d++)c.data[d]*=a;break;case "div":for(d=0;d<c.data.length;d++)c.data[d]=0===a?0:c.data[d]/a;break;case "min":for(d=0;d<c.data.length;d++)c.data[d]=Math.min(c.data[d],a);break;case "max":for(d=0;d<c.data.length;d++)c.data[d]=
Math.max(c.data[d],a);break;default:b.error("unknown op for imarith: "+d.op)}break;default:b.error("unknown arg type for imarith: "+d.argtype)}return!0});return this}};b.Image.prototype.shiftData=function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=$jscomp.makeIterator(a);d=e.next().value;var f=e.next().value;e=e.next().value;void 0!==d&&void 0!==f||b.error("missing translation value(s) for shiftData");e=e||{};if("string"===typeof e)try{e=JSON.parse(e)}catch(g){b.error("can't parse shift opts: "+
e,g)}e.rawid=e.rawid||"shift";e.x=parseFloat(d);e.y=parseFloat(f);this.xeqStashSave("shiftData",a.slice(),e.rawid);this.rawDataLayer(e,function(b,a,c){var d=b.data.BYTES_PER_ELEMENT;void 0===a.xoff&&(a.xoff=0);void 0===a.yoff&&(a.yoff=0);a.xoff+=c.x;a.yoff+=c.y;if(!c.fill||"clear"===c.fill){if(0<a.bitpix){var e=c.blank||a.header.BLANK||0;a.header.BLANK=e}else e=NaN;if("function"===typeof a.data.fill)a.data.fill(e);else for(c=0;c<a.data.length;c++)a.data[c]=e}for(c=0;c<b.height;c++){var f=c+a.yoff;
if(!(0>f||f>=b.height)){var g=0;var h=g+a.xoff;e=b.width;0>h&&(g-=h,e+=h,h=0);h+e>b.width&&(e-=h+e-b.width);if(0>=e)return!1;g=(c*b.width+g)*d;g=new Uint8Array(b.data.buffer,g,e*d);h=(f*b.width+h)*d;e=new Uint8Array(a.data.buffer,h,e*d);e.set(g)}}return!0});return this};b.Image.prototype.rotateData=function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e,f;var g=e=0;d=$jscomp.makeIterator(a);var h=d.next().value,k=d.next().value;this.raws&&this.raws[0]||b.error("no raw data for reprojection");
d=this.raws[0];d.header&&d.wcsinfo||b.error("no WCS info available for reprojection");k=k||{};if("string"===typeof k)try{k=JSON.parse(k)}catch(r){b.error("can't parse rotate opts: "+k,r)}k.stash="rotateData";k.rawid="rotate";k.oraw=b.RAWID0;!0!==k.resetSection&&(k.resetSection=!1);var m=d.header;var l=$.extend(!0,{},m);k.center=k.center||b.globalOpts.rotationCenter;if("file"!==k.center&&this.validWCS()){var p=this.getPan();(f=b.pix2wcs(this.raw.wcs,p.x,p.y).trim().split(/\s+/))&&1<f.length&&(l.CRPIX1=
p.x,l.CRPIX2=p.y,l.CRVAL1=b.saostrtod(f[0]),b.isHMS(this.params.wcssys)&&(l.CRVAL1*=15),l.CRVAL2=b.saostrtod(f[1]))}d.wcsinfo&&(e=d.wcsinfo.cdelt1||0,g=d.wcsinfo.cdelt2||0);if("string"===typeof h)switch(h.toLowerCase()){case "northisup":case "northup":h=0;0<e&&(e=-e);0>g&&(g=-g);break;default:h=parseInt(h,10)}b.notNull(m.CD1_1)?(g=-(h*Math.PI/180),e=Math.sin(g),g=Math.cos(g),l.CD1_1=m.CD1_1*g+m.CD1_2*e,l.CD1_2=m.CD1_1*-e+m.CD1_2*g,l.CD2_1=m.CD2_1*g+m.CD2_2*e,l.CD2_2=m.CD2_1*-e+m.CD2_2*g):(l.CROTA2=
h,l.CDELT1=e,l.CDELT2=g);k.lcsUseRota2=!0;d.wcsinfo&&(l.ptype=d.wcsinfo.ptype);this.xeqStashSave("rotateData",a.slice(),k.rawid);return this.reprojectData(l,k)};b.Image.prototype.reproject=function(c,a){var d,e,f,g,h=!1;var k={};var m=/SIMPLE|BITPIX|NAXIS|NAXIS[1-4]|AMDX|AMDY|CD[1-2]_[1-2]|CDELT[1-4]|CNPIX[1-4]|CO1_[1-9][0-9]|CO2_[1-9][0-9]|CROTA[1-4]|CRPIX[1-4]|CRVAL[1-4]|CTYPE[1-4]|CUNIT[1-4]|DATE|DATE_OBS|DC-FLAG|DEC|DETSEC|DETSIZE|EPOCH|EQUINOX|EQUINOX[a-z]|IMAGEH|IMAGEW|LATPOLE|LONGPOLE|MJD-OBS|PC00[1-4]00[1-4]|PC[1-4]_[1-4]|PIXSCALE|PIXSCAL[1-2]|PLTDECH|PLTDECM|PLTDECS|PLTDECSN|PLTRAH|PLTRAM|PLTRAS|PPO|PROJP[1-9]|PROJR0|PV[1-3]_[1-3]|PV[1-4]_[1-4]|RA|RADECSYS|SECPIX|SECPIX|SECPIX[1-2]|UT|UTMID|VELOCITY|VSOURCE|WCSAXES|WCSDEP|WCSDIM|WCSNAME|XPIXSIZE|YPIXSIZE|ZSOURCE|LTM|LTV/;
var l=/TAN|SIN|ZEA|STG|ARC/,p=function(a,c){if(!c)return a;a=$.extend(!0,{},a);b.isNull(a.CRVAL1)&&!b.isNull(c.crval1)&&(a.CRVAL1=c.crval1);b.isNull(a.CRVAL2)&&!b.isNull(c.crval2)&&(a.CRVAL2=c.crval2);b.isNull(a.CRPIX1)&&!b.isNull(c.crpix1)&&(a.CRPIX1=c.crpix1);b.isNull(a.CRPIX2)&&!b.isNull(c.crpix2)&&(a.CRPIX2=c.crpix2);b.isNull(a.CDELT1)&&!b.isNull(c.cdelt1)&&(a.CDELT1=c.cdelt1);b.isNull(a.CDELT2)&&!b.isNull(c.cdelt2)&&(a.CDELT2=c.cdelt2);b.isNull(a.CROTA2)&&!b.isNull(c.crot)&&(a.CROTA2=c.crot);
return a};if(b.reproject&&c&&this!==c){this.raws&&this.raws[0]||b.error("no raw data for reprojection");var r=this.raws[0];r.header&&r.wcsinfo||b.error("no WCS info available for reprojection");a=a||{};var n=$.extend(!0,{},r.header);var u=$jscomp.makeIterator(Object.keys(n));for(e=u.next();!e.done;e=u.next())e=e.value,m.test(e)&&delete n[e];if("object"===typeof c){c.raw&&c.raw.header?d=c.raw.header:c.BITPIX&&c.NAXIS1&&c.NAXIS2?d=c:b.error("invalid wcs object input to reproject()");u=$jscomp.makeIterator(Object.keys(d));
for(e=u.next();!e.done;e=u.next())e=e.value,m.test(e)&&(k[e]=d[e]);n=$.extend(!0,{},k,n);if(!n.NAXIS||!n.NAXIS1||!n.NAXIS2)return;n.NAXIS1=Math.min(n.NAXIS1,b.globalOpts.image.xdim);n.NAXIS2=Math.min(n.NAXIS2,b.globalOpts.image.ydim);k=b.raw2FITS(n,{addcr:!0});n="wcs_"+b.uniqueID()+".txt";b.vfile(n,k);b.globalOpts.reprojectLimits&&(k=b.globalOpts.image.xdim,m=b.globalOpts.image.ydim,e=b.globalOpts.image.xdim*b.globalOpts.image.ydim,r.header.NAXIS1*r.header.NAXIS2>e&&b.error("the max reproject size is "+
k+" * "+m+". You can use the Bin/Filter/Section plugin to extract a section, then save it as FITS and reproject the smaller image."))}else n=c;try{if(!l.test(r.wcsinfo.ptype)){var x=p(r.header,r.wcsinfo);var t="owcs_"+b.uniqueID()+".txt";b.vfile(t,b.raw2FITS(x,{addcr:!0}));var v="awcs_"+b.uniqueID()+".txt";var w=b.tanhdr(t,v,"");1<b.DEBUG&&b.log("tanhdr (input): %s %s -> %s",t,v,w);b.vunlink(t);0<=w.search(/\[struct stat="OK"/)&&(a.cmdswitches=a.cmdswitches||"",a.cmdswitches+=" -i "+v)}if(c.raw&&
!l.test(c.raw.wcsinfo.ptype)||c.ptype&&!l.test(c.ptype)){x=p(d,c.raw.wcsinfo);t="owcs_"+b.uniqueID()+".txt";b.vfile(t,b.raw2FITS(x,{addcr:!0}));var q="awcs_"+b.uniqueID()+".txt";w=b.tanhdr(t,q,"");1<b.DEBUG&&b.log("tanhdr (reproj): %s %s -> %s",t,q,w);b.vunlink(t);0<=w.search(/\[struct stat="OK"/)&&(b.vunlink(n),n=q)}}catch(C){}if(r.hdu&&r.hdu.fits.vfile)c=r.hdu.fits.vfile,r.hdu.fits.extname?c+="["+r.hdu.fits.extname+"]":r.hdu.fits.extnum&&0<r.hdu.fits.extnum&&(c+="["+r.hdu.fits.extnum+"]");else{var z=
this.toArray();c=this.id.replace(/\.png$/,"_png.fits");b.vfile(c,z)}q=this.id.replace(/\[.*\]/,"").replace(/\.png$/i,".fits").replace(/\.fz$/i,"").replace(/\.gz$/i,"");q="reproj_"+b.uniqueID()+"_"+q;d=a.rawid||"reproject";for(t=0;t<this.raws.length&&(x=this.raws[t],x.id!==d||!b.cleanupFITSFile(x,!0));t++);r.hdu&&"table"===r.hdu.imtab&&r.hdu.table&&!c.match(/\[bin /)&&(c.match(/\[EVENTS\]/)||(c+="[EVENTS]"),x=r.hdu.table,r=Math.floor(x.xcen-x.xdim/2+1),t=Math.floor(x.xcen+x.xdim/2),d=Math.floor(x.ycen-
x.ydim/2+1),x=Math.floor(x.ycen+x.ydim/2),c+="[bin X="+r+":"+t+",Y="+d+":"+x+"]");try{var y=q.lastIndexOf(".");0<=y&&(f=q.substring(0,y)+"_area"+q.substring(y));var A=a.cmdswitches||"";A+=" -a 0 "+b.globalOpts.reprojSwitches;w=b.reproject(c,q,n,A);1<b.DEBUG&&b.log("reproject: %s %s %s [%s] -> %s",c,q,n,A,w);b.vunlink(f);b.vunlink(n);v&&b.vunlink(v);z&&b.vunlink(c);0>w.search(/\[struct stat="OK"/)&&(h=!0,(g=w.match(/msg="(.*)"/))&&g[1]?b.error(g[1]+" (from mProjectPP)"):b.error(w))}catch(C){if(h)return;
b.vunlink(f);b.vunlink(n);w?b.error(w):b.error("WCS reproject failed",C)}return q}};b.Image.prototype.reprojectData=function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=this,f;d=$jscomp.makeIterator(a);var g=d.next().value,h=d.next().value;if(g&&b.reproject){if("string"===typeof g){if("all"===g){for(a=0;a<b.images.length;a++)d=b.images[a],this.display.id===d.display.id&&d.reprojectData(this);return}(d=b.getImage(g))?g=d:b.error("unknown WCS for reproject: "+g)}if(this!==g){h=
h||{};if("string"===typeof h)try{h=JSON.parse(h)}catch(k){b.error("can't parse reproject opts: "+h,k)}h.rawid||this.xeqStashSave("reprojectData",a.slice(),"reproject");h.stash||(h.stash="reprojectData");b.waiting(!0,this.display);this.setStatus("reprojectData","processing");window.setTimeout(function(){var a=function(a){e.xeqPlugins("image","onreprojectdata");c=c||{};c.refreshRegions=!0;!1!==h.resetSection&&(c.resetSection=!0);h.lcsUseRota2&&(c.lcsUseRota2=!0);e.refreshImage(a,c);e.setStatus("reprojectData",
"complete");e.xeqStashCall(e.xeqstash,[h.stash,"reprojectData"]);if("function"===typeof h.onreproject)try{b.xeqByName(h.onreproject,window,e)}catch(p){b.error("in onreproject callback",p,!1)}};h=h||{};a=h.reprojHandler||a;if(f=e.reproject(g,h)){var c=$.extend(!0,{},b.fits.options,h);c.rawid=c.rawid||"reproject";g.raw&&g.raw.header&&(c.wcsim=g);try{b.handleFITSFile(f,c,a)}catch(l){b.error("can't process reprojected FITS file",l)}}},b.SPINOUT);return this}}};b.Image.prototype.filterRGBImage=function(c){for(var a=
[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];d=$jscomp.makeIterator(a).next().value;if(!d)return Object.keys(b.ImageFilters);switch(d){case "reset":return this.setColormap("reset"),this;case "median":d="medianFilter";break;case "edge":d="edgeDetect"}b.ImageFilters[d]||b.error("JS9 image filter '"+d+"' not available");this.xeqStashSave("filterRGBImage",a.slice());a.shift();a.unshift(this.display.context,this.rgb.img);try{b.ImageFilters[d].apply(b.ImageFilters,$jscomp.arrayFromIterable(a))}catch(e){b.error("JS9 image filter '"+
d+"' failed",e)}this.displayImage("display");b.globalOpts.extendedPlugins&&this.xeqPlugins("image","onfilterrgbimage");return this};b.Image.prototype.moveToDisplay=function(c){var a,d=0,e=this.display;var f=b.lookupDisplay(c);c&&f||b.error("could not find display: "+c);this.display.clearMessage();this.display.context.clear();this.xeqPlugins("image","onimageclear");var g=$jscomp.makeIterator(Object.keys(e.layers));for(c=g.next();!c.done;c=g.next())c=c.value,"main"!==e.layers[c].dtype||f.layers[c]||
f.newShapeLayer(c,e.layers[c].opts);if(f.image)for(g=$jscomp.makeIterator(Object.keys(f.layers)),c=g.next();!c.done;c=g.next())c=c.value,"main"===f.layers[c].dtype&&f.image.showShapeLayer(c,!1,{local:!0});g=$jscomp.makeIterator(Object.keys(this.layers));for(c=g.next();!c.done;c=g.next()){c=c.value;var h=this.layers[c];(a=f.layers[c])?(this.showShapeLayer(c,!1,{local:!0}),h.dlayer=a,h.divjq=a.divjq,h.canvasjq=a.canvasjq,h.canvas=a.canvas):delete this.layers[c]}this.display=f;this.display.image=this;
this.mkSection();this.displayImage("all");g=$jscomp.makeIterator(Object.keys(this.layers));for(c=g.next();!c.done;c=g.next())c=c.value,this.showShapeLayer(c,!0,{local:!0});e.rgb.rim===this&&(e.rgb.rim=null,f.rgb.rim=this);e.rgb.gim===this&&(e.rgb.gim=null,f.rgb.gim=this);e.rgb.bim===this&&(e.rgb.bim=null,f.rgb.bim=this);e.image=null;this.refreshLayers();for(f=0;f<b.images.length;f++)if(c=b.images[f],e===c.display){c.display.image=null;c.displayImage("all");c.refreshLayers();d++;break}!d&&e.winid&&
e.winid.close&&(f=$.inArray(e,b.displays),0<=f&&b.displays.splice(f,1),e.winid.close());return this};b.Image.prototype.saveSession=function(c,a){var d,e,f,g,h,k,m=function(a){var c={};if(window.electron){var l=new RegExp("^"+window.electron.currentDir+"/");c.file=a.file.replace(l,"")}else c.file=a.file;c.dwidth=a.display.width;c.dheight=a.display.height;c.params=$.extend(!0,{},a.params);c.tmp={};"active"===a.tmp.gridStatus&&(c.tmp.gridStatus="active");h=a.imageToLogicalPos({x:a.rgb.sect.xcen,y:a.rgb.sect.ycen});
(k=a.maybePhysicalToImage(h))&&(h=k);c.sect={};c.sect.xcen=h.x;c.sect.ycen=h.y;c.sect.xdim=a.raw.width;c.sect.ydim=a.raw.height;c.sect.zoom=a.rgb.sect.zoom;c.layers=[];l=$jscomp.makeIterator(Object.keys(a.layers));for(var m=l.next();!m.done;m=l.next())g=m.value,d=a.layers[g],e=d.dlayer,"main"===e.dtype&&"crosshair"!==g&&"grid"!==g&&(f={},f.name=g,f.json=e.canvas.toJSON(e.el),f.dopts=$.extend(!0,{},e.opts),d.catalog&&(f.catalog=d.catalog),d.starbase&&(f.starbase=JSON.stringify(d.starbase)),c.layers.push(f)),
e.canvas.forEachObject(function(a){a.params&&a.params.winid&&($(a.params.winid).is(":visible")?b.error("please close your region dialog box(es) to avoid a JSON circular reference error when saving this session"):a.params.winid=null)});c.blend=a.blend;c.xeqstash=a.xeqstash;a.wcsim&&a.wcsim.id&&(c.wcsim=a.wcsim.id);delete c.params.display;c.params.rot90=0;c.params.flip="none";c.params.crosshair=!1;return c};({}).hasOwnProperty.call(window,"saveAs")||b.error("no saveAs() available to save session");
c=c||"js9.ses";c.match(/\.ses$/)||(c+=".ses");a=a||{};if("string"===typeof a)try{a=JSON.parse(a)}catch(n){b.error("can't parse session opts: "+a,n)}b.waiting(!0,this.display);var l={images:[]};if("display"===a.mode)for(a=0;a<b.images.length;a++){var p=b.images[a];p.display.id===this.display.id&&l.images.push(m(p))}else l.images.push(m(this));l.display={blendMode:this.display.blendMode};l.globals=$.extend(!0,{},b.globalOpts);delete l.globals.rgb;l.cmaps=[];for(a=0;a<b.colormaps.length;a++)"user"===
b.colormaps[a].source&&l.cmaps.push(b.colormaps[a]);try{var r=JSON.stringify(l,null,4)}catch(n){b.error("can't create json file for save session",n)}l=new Blob([r],{type:"application/json"});b.saveAs(l,c);b.waiting(!1);return c};b.Image.prototype.xeqStashSave=function(c,a,d,e){var f,g;e=e||"image";this.xeqstash=this.xeqstash||[];for(f=0;f<a.length;f++)"object"===typeof a[f]&&(a[f]instanceof b.Image?a[f]=a[f].id:a[f]instanceof b.Display&&(a[f]=a[f].id));switch(c){case "setRot90":f=this.xeqstash.length;
if(1<=f&&this.xeqstash[f-1]&&this.xeqstash[f-1].args[0]===-a[0])return this.xeqstash.pop(),this;break;case "setFlip":f=this.xeqstash.length;if(1<=f&&this.xeqstash[f-1]&&this.xeqstash[f-1].args[0]===a[0])return this.xeqstash.pop(),this;break;default:for(f=0;f<this.xeqstash.length;f++)if((g=this.xeqstash[f])&&g.func===c&&g.context===e)return g.args=a,this}this.xeqstash.push({func:c,args:a,id:d,context:e});return this};b.Image.prototype.xeqStashCall=function(c,a){var d=this,e,f=function(a,c){var e=c.context||
"image";try{switch(e){case "image":d[a].apply(d,$jscomp.arrayFromIterable(c.args));break;case "display":d.display[a].apply(d.display,$jscomp.arrayFromIterable(c.args));break;default:d[a].apply(d,$jscomp.arrayFromIterable(c.args))}}catch(p){b.error("error executing stash: "+a,p,!1)}};c=c||this.xeqstash;if($.isArray(c))for(e=0;e<c.length;e++){var g=c[e];var h=g.func;0<=$.inArray(h,a)||f(h,g)}else for(e=$jscomp.makeIterator(Object.keys(c)),h=e.next();!h.done;h=e.next())h=h.value,0<=$.inArray(h,a)||(g=
c[h],f(h,g))};b.Image.prototype.xeqStashDiscard=function(b){var a,c;if(this.xeqstash)if($.isArray(this.xeqstash))for(a=this.xeqstash.length-1;0<=a;a--)b!==this.xeqstash[a].func&&b!==this.xeqstash[a].id||this.xeqstash.splice(a,1);else for(a=$jscomp.makeIterator(Object.keys(this.xeqstash)),c=a.next();!c.done;c=a.next())c=c.value,b!==c&&b!==this.xeqstash[c].id||delete this.xeqstash[c]};b.Image.prototype.xeqPlugins=function(c,a,d){var e,f=function(b,a){b="JS9:"+b;$(document).trigger(b,a)};if(c&&a&&b.globalOpts.xeqPlugins){var g=
this.display.pluginInstances||{};var h=$jscomp.makeIterator(Object.keys(g));for(e=h.next();!e.done;e=h.next()){e=e.value;e=g[e];var k=e.plugin.opts;if(e.isActive(a)&&"function"===typeof k[a]){this.callingPlugin=a;switch(c){case "image":try{k[a].call(e,this),f(a,{im:this})}catch(l){e.errLog(a,l)}break;case "region":case "shape":try{k[a].call(e,this,d),f(a,{im:this,xreg:d})}catch(l){e.errLog(a,l)}break;case "keydown":case "keypress":var m=d.originalEvent||d;try{k[a].call(e,this,this.ipos,m),f(a,{im:this,
ipos:this.ipos,evt:m})}catch(l){e.errLog(a,l)}break;case "mouse":if(!this.clickInRegion||k[a+"_inRegion"]){m=d.originalEvent||d;try{k[a].call(e,this,this.ipos,m),f(a,{im:this,ipos:this.ipos,evt:m})}catch(l){e.errLog(a,l)}}}delete this.callingPlugin}}return this}};b.Image.prototype.uploadFITSFile=function(){var c=this,a,d=function(a){delete b.worker.uploadActive;window.setTimeout(function(){b.progress(!1)},1E3);a.stderr?b.error(a.stderr):a.stdout&&(c.fitsFile=a.stdout.trim(),c.proxyFile=c.fitsFile,
b.globalOpts.prependJS9Dir&&!c.fitsFile.match(/^\${JS9_DIR}/)&&"/"!==c.fitsFile.charAt(0)&&(c.fitsFile="${JS9_DIR}/"+c.fitsFile),c.queryHelper("all"))};if(b.worker&&("nodejs"===b.helper.type||"socket.io"===b.helper.type)&&this.raw.hdu&&this.raw.hdu.fits&&this.raw.hdu.fits.vfile){b.worker.uploadActive&&b.error("only one upload allowed at a time");var e=this.raw.hdu.fits.vfile;b.helper.send("quotacheck",null,function(f){(f.stderr||f.errcode)&&b.error(f.stderr||"from quotacheck: "+f.errcode);a=b.vread(e,
"binary");b.worker.socketio(function(){b.worker.uploadActive=!0;b.progress(!0,c.display);b.worker.send("uploadFITS",[e,a],d,[a.buffer])})});return this}};b.Image.prototype.removeProxyFile=function(c){var a=this;if("boolean"===typeof c)var d=c;else if("string"===typeof c){if(c.match(/^\//))return;var e=new RegExp("^"+b.INSTALLDIR);e=c.replace(e,"");if(e.match(/\.\./))return;e=c}else{if(!this.proxyFile)return;e=this.proxyFile;this.proxyParent&&(e=e+" "+this.proxyParent)}e&&b.Send("removeproxy",{cmd:"js9Xeq removeproxy "+
e},function(b){d&&b&&"OK"===b.stdout.trim()&&(a.proxyFile=null,a.proxyParent=null,a.fitsFile=null,a.analysisPackages=null,a.queryHelper("all"))})};b.Image.prototype.starbaseToShapes=function(c,a){var d=this,e,f,g,h=b.globalOpts.catalogs;var k=b.globalOpts.catalogs.ras;var m=b.globalOpts.catalogs.decs;var l=[],p=function(a,c){return(a=b.wcs2pix(d.raw.wcs,a,c).trim().split(/ +/))&&a.length?{x:parseFloat(a[0]),y:parseFloat(a[1])}:null};var r=function(b,a,c,d){var e;if(void 0!==d)var h=d;else{h=-1;for(e=
0;e<c.length;e++){for(d=0;d<a.length;d++)if(c[e].toLowerCase()===a[d].toLowerCase()){h=b[a[d]];break}if(0<=h)break}if(0>h)for(f=c[0],g=new RegExp("^"+f,"i"),d=0;d<a.length;d++)if(a[d].match(g)){h=b[a[d]];break}if(0>h)for(f=c[0],g=new RegExp(".*"+f+".*","i"),d=0;d<a.length;d++)if(a[d].match(g)){h=b[a[d]];break}}return h};if(c&&c.data&&c.headline){var n=c.data;var u=c.headline;var x=c.delims;a=a||{};k=r(c,u,k,a.xcol);0>k&&b.error("can't find an RA column (see Preferences:catalogs)");var t=r(c,u,m,a.ycol);
0>t&&b.error("can't find a Dec column (see Preferences:catalogs)");r=a.shape||h.shape||"circle";switch(r){case "box":var v=function(){return{width:a.width||h.width||7,height:a.height||h.height||7}};break;case "circle":v=function(){return{radius:a.radius||h.radius||3.5}};break;case "ellipse":v=function(){return{r1:a.r1||h.r1||3.5,r2:a.r2||h.r2||3.5}};break;default:v=function(){return{width:a.width||7,height:a.height||7}}}var w=this.getWCSSys();var q=a.wcssys?a.wcssys:h.wcssys?h.wcssys:"ICRS";this.setWCSSys(q,
!1);for(m=c=0;c<n.length;c++){var z=n[c][k];var y=n[c][t];"\x00"!==x[k]&&":h ".includes(x[k])&&"galactic"!==q&&"ecliptic"!==q&&(z*=15);if(e=p(z,y)){var A=v();A={id:c.toString(),shape:r,x:e.x,y:e.y,width:A.width,height:A.height,radius:A.radius,r1:A.r1,r2:A.r2,angle:0,data:{ra:z,dec:y}};if(!1!==a.save&&!1!==b.globalOpts.catalogs.save)for(e=0;e<=u.length;e++)u[e]&&(A.data[u[e]]=n[c][e]);a.color&&(A.color=a.color);l[m++]=A}}this.setWCSSys(w,!1);return l}};b.Image.prototype.loadCatalog=function(c){for(var a=
[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=$jscomp.makeIterator(a);d=e.next().value;var f=e.next().value;e=e.next().value;var g=$.extend(!0,{},b.Catalogs.opts),h=b.globalOpts.catalogs;1===a.length&&"string"!==typeof d&&(f=d,d=null);2===a.length&&"string"!==typeof d&&(e=f,f=d,d=null);if(f){h.tooltip&&(g.tooltip=h.tooltip);e=e||{};if("string"===typeof e)try{e=JSON.parse(e)}catch(m){b.error("can't parse catalog opts: "+e,m)}e.color=e.color||h.color||"#00FF00";e.wcssys=e.wcssys||h.wcssys;
e.updateWCS=!0;a={convFuncs:{def:function(a){var c={};c.val=b.saostrtod(a);c.delim=String.fromCharCode(b.saodtype());if("\x00"!==c.delim&&" \t-.:hdmsr'\"".includes(c.delim)||b.isNumber(a))return c;c.val=a;return c}},units:e.units||h.units,skip:e.skip||h.skip};try{var k=new b.Starbase(f,a)}catch(m){b.error("could not parse catalog. Is it in tab-separated column format?")}k&&k.data&&k.data.length||b.error("no objects found in catalog");a=this.starbaseToShapes(k,e);a.length?(d=d||"catalog_"+b.uniqueID(),
this.display.newShapeLayer(d,g),this.removeShapes(d),this.layers[d].catalog=f,this.layers[d].starbase=k,this.addShapes(d,a,e)):b.error("no catalog objects found");return this}};b.Image.prototype.saveCatalog=function(c,a){a=a||this.activeShapeLayer();this.layers[a]&&this.layers[a].catalog||(a&&"undefined"!==a?b.error("no catalog available: "+a):b.error("no active catalog available"));var d=new Blob([this.layers[a].catalog],{type:"text/plain;charset=utf-8"});c=c||a+".cat";c.match(/\.cat$/)||(c+=".cat");
({}).hasOwnProperty.call(window,"saveAs")?b.saveAs(d,c):b.error("no saveAs() available to save catalog");return c};b.Image.prototype.wcs2wcs=function(c,a,d,e){var f=this.getWCSSys();var g=this.getWCSUnits();c=c||f;a=a||f;if("string"===typeof d){var h=b.strtoscaled(d);b.isHMS(c,h.dtype)&&(h.dval*=15);d=h.dval}"string"===typeof e&&(h=b.strtoscaled(e),e=h.dval);h=this.setWCSSys(c,!1).getWCSSys();"native"!==c&&h!==c&&b.error("unknown or invalid wcs: "+c);d=b.wcs2pix(this.raw.wcs,d,e).trim().split(/ +/);
c=parseFloat(d[0]);d=parseFloat(d[1]);this.setWCSSys(a,!1);this.setWCSUnits("degrees",!1);c=b.pix2wcs(this.raw.wcs,c,d).trim();this.setWCSUnits(g,!1);f!==a&&this.setWCSSys(f,!1);return c};b.Image.prototype.wcs2imlen=function(c){var a=1;if(c){c=b.strtoscaled(c);var d=this.raw.wcsinfo||{cdelt1:1,cdelt2:1};void 0!==d.cdelt1?a=d.cdelt1:void 0!==d.cdelt2&&(a=d.cdelt2);switch(this.params.wcssys){case "image":break;case "physical":this.lcs&&this.lcs.physical&&(a=Math.sqrt(Math.pow(this.lcs.physical.forward[0][0],
2)+Math.pow(this.lcs.physical.forward[0][1],2)),c.dval=Math.abs(c.dval*a));break;default:c.dtype&&"."!==c.dtype&&"\x00"!==c.dtype&&(c.dval=Math.abs(c.dval/a))}return c.dval}};b.Colormap=function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=$jscomp.makeIterator(a);d=e.next().value;var f=e.next().value,g=e.next().value;e=e.next().value;if(d){this.name=d;switch(a.length){case 2:$.isArray(f[0])&&"number"===typeof f[0][0]?(this.type="lut",this.colors=f):(this.type="static",this.colors=
b.parseStaticColors(f));break;case 4:this.type="sao";this.vertices=[f,g,e];break;default:b.error("colormap requires a colormap name and 1 or 3 array args")}this.source=b.inited?"user":"core";for(a=0;a<b.colormaps.length;a++)if(b.colormaps[a].name===this.name){b.colormaps[a]=this;var h=!0;break}h||b.colormaps.push(this);1<b.DEBUG&&b.log("JS9 colormap:  %s",this.name)}};b.Colormap.prototype.mkColorCell=function(c){var a=b.COLORSIZE;var d=[0,0,0];switch(this.type){case "sao":var e=c/a;for(c=0;3>c;c++){var f=
this.vertices[c];var g=f.length;for(a=0;a<g&&!(f[a][0]>e);a++);a=0===a?f[0][1]:a===g?f[g-1][1]:(g=(f[a][1]-f[a-1][1])/(f[a][0]-f[a-1][0]))?g*(e-f[a-1][0])+f[a-1][1]:f[a][1];d[c]=255*a}break;case "lut":e=this.colors.length;c=Math.floor(c*e/a);0>c?(d[0]=255*this.colors[0][0],d[1]=255*this.colors[0][1],d[2]=255*this.colors[0][2]):c<e?(d[0]=255*this.colors[c][0],d[1]=255*this.colors[c][1],d[2]=255*this.colors[c][2]):(d[0]=255*this.colors[e-1][0],d[1]=255*this.colors[e-1][1],d[2]=255*this.colors[e-1][2]);
break;case "static":break;default:b.error("unknown colormap type")}return d};b.Display=function(c){var a=this;this.divjq=c instanceof jQuery?c:"object"===typeof c?$(c):$("#"+c);this.divjq.attr("id")||this.divjq.attr("id",b.DEFID);this.id=this.divjq.attr("id");this.tmp={};this.rgb={active:!1,rim:null,gim:null,bim:null};this.divjq.addClass("JS9");this.width=this.divjq.attr("data-width");this.width||(this.width=b.WIDTH);this.divjq.css("width",this.width);this.width=parseInt(this.divjq.css("width"),10);
this.height=this.divjq.attr("data-height");this.height||(this.height=b.HEIGHT);this.divjq.css("height",this.height);this.height=parseInt(this.divjq.css("height"),10);this.width0=this.width;this.height0=this.height;this.divjq.attr("tabindex",0);this.canvas=document.createElement("canvas");this.canvasjq=$(this.canvas).addClass("JS9Image").attr("id",this.id+"Image").attr("width",this.width).attr("height",this.height).css("z-index",b.ZINDEX);this.displayConjq=$("<div>").addClass("JS9Container").attr("id",
this.id+"DisplayConjq").css("z-index",b.ZINDEX).attr("tabindex","0").append(this.canvasjq).appendTo(this.divjq);b.allinone||(this.iconjq=$("<div>").addClass("JS9Logo").css("display","none").css("z-index",b.ZINDEX+1).appendTo(this.divjq),this.iconimgjs=$("<img>").addClass("JS9Logo").attr("src",b.InstallDir(b.globalOpts.logo)).attr("alt","js9").attr("title","js9").appendTo(this.iconjq),b.globalOpts.logoDisplay&&this.iconjq.css("display","block"));b.globalOpts.resizeHandle&&{}.hasOwnProperty.call(window,
"ResizeSensor")&&(this.divjq.css("resize","both").css("overflow","hidden"),b.bugs.webkit_resize&&(this.owidth=parseInt(this.divjq.css("width"),10),this.oheight=parseInt(this.divjq.css("height"),10),this.divjq.css("width",this.width+b.RESIZEFUDGE).css("height",this.height+b.RESIZEFUDGE)),this.resizeSensor=new ResizeSensor(this.divjq,function(){var c=a.divjq.width(),e=a.divjq.height();b.bugs.webkit_resize&&(c-=b.RESIZEFUDGE,e-=b.RESIZEFUDGE);a.resize(c,e)}));this.context=this.canvas.getContext("2d");
b.ANTIALIAS||(this.context.imageSmoothingEnabled=!1);this.tooltip=$("<div>").attr("id","tooltip_"+this.id).addClass("JS9Tooltip").appendTo(this.divjq);this.image=null;this.pluginInstances={};this.layers={};this.initMessages();this.blendMode=!1;this.mouseActions=b.globalOpts.mouseActions.slice(0);this.touchActions=b.globalOpts.touchActions.slice(0);this.divjq.on("mouseenter",this,function(a){return b.mouseEnterCB(a)});this.divjq.on("mouseover",this,function(a){return b.mouseOverCB(a)});this.divjq.on("mousedown touchstart",
this,function(a){return b.mouseDownCB(a)});this.divjq.on("mousemove touchmove",this,function(a){return b.mouseMoveCB(a)});this.divjq.on("mouseup touchend",this,function(a){return b.mouseUpCB(a)});this.divjq.on("mouseout",this,function(a){return b.mouseOutCB(a)});this.divjq.on("keypress",this,function(a){return b.keyPressCB(a)});this.divjq.on("keydown",this,function(a){return b.keyDownCB(a)});this.divjq.on("keyup",this,function(a){return b.keyUpCB(a)});this.divjq.on("wheel",this,function(a){return b.wheelCB(a)});
this.divjq.on("dragenter",this,function(c){return b.dragenterCB(a.id,c)});this.divjq.on("dragover",this,function(c){return b.dragoverCB(a.id,c)});this.divjq.on("dragexit",this,function(c){return b.dragexitCB(a.id,c)});this.divjq.on("drop",this,function(c){return b.dragdropCB(a.id,c)});this.divjq.on("contextmenu",this,function(){return!1});this.addFileDialog("Load",b.globalOpts.imageTemplates);this.addFileDialog("RefreshImage",b.globalOpts.imageTemplates);this.addFileDialog("LoadRegions",b.globalOpts.regTemplates);
this.addFileDialog("LoadSession",b.globalOpts.sessionTemplates);this.addFileDialog("LoadColormap",b.globalOpts.colormapTemplates);this.addFileDialog("LoadCatalog",b.globalOpts.catalogTemplates);b.displays.push(this);this.displayConjq.focus();b.DEBUG&&b.log("JS9 display:  %s",this.id)};b.Display.prototype.addFileDialog=function(c,a){var d=this;if(c&&b.publics[c]){var e="openLocal"+c+"-"+this.id;var f=$("<div>").addClass("JS9Hidden").appendTo(this.divjq);f=$("<input>").attr("type","file").attr("id",
e).attr("multiple",!0).appendTo(f);a&&f.attr("accept",a);f.on("change",function(a){var e=a.currentTarget;if(e.files.length)switch(c){case "Load":case "RefreshImage":var f={localAccess:!0};b.waiting(!0,d)}for(a=0;a<e.files.length;a++)b.publics[c](e.files[a],f,{display:d.id});e.value=null;return!1})}};b.Display.prototype.initMessages=function(){this.messageContainer=$("<div>").addClass("JS9Container").css("z-index",b.MESSZINDEX).appendTo(this.divjq);this.infoArea=$("<div>").addClass("JS9Message").appendTo(this.messageContainer);
this.regionsArea=$("<div>").addClass("JS9Message").appendTo(this.messageContainer);this.progressArea=$("<div>").addClass("JS9Progress").addClass("JS9Message").appendTo(this.messageContainer);this.progressBar=$("<progress>").addClass("JS9ProgressBar").attr("value",0).attr("max",100).attr("name","progress").appendTo(this.progressArea);try{this.messageContainer.draggable({start:function(c,a){this.oicb=b.globalOpts.internalContrastBias;b.globalOpts.internalContrastBias=!1},stop:function(c,a){b.globalOpts.internalContrastBias=
this.oicb}})}catch(c){}return this};b.Display.prototype.displayPlugin=function(c){var a=this,d;if("string"===typeof c)for(d=0;d<b.plugins.length;d++){var e=b.plugins[d];if(e.name===c){c=e;break}}"object"===typeof c&&c.name||b.error("unknown plugin type for displayPlugin");var f=this.pluginInstances[c.name];switch(b.globalOpts.winType){case "light":var g=b.lightOpts[b.LIGHTWIN];if(!f||!f.status){var h=c.name.replace(/\s/g,"_");d=this.id+"_"+h+"_lightDiv";e=this.id+"_"+h+"_outerDiv";h=this.id+"_"+h+
"_innerDiv";if(!f){var k=$("<div>").attr("id",e).css("display","none").appendTo($(this.divjq));$("<div>").addClass(c.name).attr("id",h).attr("data-js9id",this.divjq.attr("id")).css("height","100%").css("width","100%").appendTo(k)}k=c.opts.winDims[0]||b.WIDTH;var m=c.opts.winDims[1]||b.HEIGHT;var l=c.opts.winResize?"1":"0";g=sprintf(g.format,k,m,l);k=c.opts.toolbarHTML&&0<=c.opts.toolbarHTML.search(/\$title/)?"":c.opts.winTitle||"";k+=sprintf(b.IDFMT,this.id);e=b.lightWin(d,"div",e,k,g);d=$("#"+d+
" #"+h);f=b.instantiatePlugin(d,c,e);f.winHandle.onclose=function(){f.winHandle.hide();f.status="inactive";if(c.opts.onpluginclose)try{c.opts.onpluginclose.call(f,a.image)}catch(p){b.log("onplugincloseCB: %s [%s]\n%s",c.name,p.message,b.strace(p))}return!1};f.status="active";if(c.opts.onplugindisplay)try{c.opts.onplugindisplay.call(f,this.image)}catch(p){b.log("onplugindisplayCB: %s [%s]\n%s",c.name,p.message,b.strace(p))}}else if("inactive"===f.status){if(f.winHandle&&(f.winHandle.show(),f.status=
"active",c.opts.onplugindisplay))try{c.opts.onplugindisplay.call(f,this.image)}catch(p){b.log("onplugindisplayCB: %s [%s]\n%s",c.name,p.message,b.strace(p))}}else if("active"===f.status&&f.winHandle&&(f.winHandle.hide(),f.status="inactive",c.opts.onpluginclose))try{c.opts.onpluginclose.call(f,this.image)}catch(p){b.log("onplugincloseCB: %s [%s]\n%s",c.name,p.message,b.strace(p))}break;case "new":b.error("external window support for plugins not yet implemented")}};b.Display.prototype.displayLoadForm=
function(c){var a=this,d=b.globalOpts.localLoadFormat;"proxy"!==b.globalOpts.remoteLoadMethod||b.proxyAvailable()||(b.globalOpts.remoteLoadMethod="cgiproxy");var e=b.globalOpts.remoteLoadMethod;c=c||{local:!0,remote:!0};b.isNull(c.title)&&(c.title="",c.local&&(c.title="Open "),c.remote&&(c.title&&(c.title+="or "),c.title+="Retrieve "),c.title+="an Image ",c.local&&(c.title+="or Auxiliary File"));c.winformat=c.winformat||"width=640px,height=300px,resize=1,scrolling=1";var f=b.allinone?b.allinone.loadHTML:
b.InstallDir(b.globalOpts.loadURL);$(b.lightOpts[b.LIGHTWIN].topid).arrive(".loadForm",{onceOnly:!0},function(f){var h=$(f).data("localfile")||a.tmp.localfile;f=$(f).data("remotefile")||a.tmp.remotefile;c.local&&($(g).find(".localfile").removeClass("nodisplay"),$(g).find(".localdoc").removeClass("nodisplay"),h&&$(g).find('input[name="localfile"]').val(h),$(g).find("input[value="+d+"]").click());c.remote&&($(g).find(".remotefile").removeClass("nodisplay"),$(g).find(".remotedoc").removeClass("nodisplay"),
f&&$(g).find('input[name="remotefile"]').val(f),b.proxyAvailable()||$(g).find('input[value="proxy"]').prop("disabled",!0),$(g).find("input[value="+e+"]").click())});var g=b.Image.prototype.displayAnalysis.call(null,"params",f,c);$(g).data("dispid",this.id)};b.Display.prototype.resize=function(c,a,d){var e,f=function(b){b.left+=h;b.top+=k;b.setCoords()};b.globalOpts.resize||b.error("display resize not enabled");if(!c&&!a)return{width:this.width,height:this.height};if("full"===c){if(d=a,window.innerWidth&&
(c=window.innerWidth),window.innerHeight)for(a=window.innerHeight,e=0;e<b.globalOpts.centerDivs.length;e++){var g=b.globalOpts.centerDivs[e];this.pluginInstances[g]&&(a-=this.pluginInstances[g].divjq.height())}}else"image"===c?(this.image||b.error("can't resize display to 'image' without an image"),d=a,c=this.image.raw.width,a=this.image.raw.height):"reset"===c&&(d=a,c=this.width0||c,a=this.height0||a);c=Math.floor(c);a=a?Math.floor(a):c;(10>c||10>a)&&b.error("invalid dimension(s) passed to display resize");
if(c===this.width&&a===this.height)return this;d=d||{};if("string"===typeof d)try{d=JSON.parse(d)}catch(l){b.error("can't parse resize opts: "+d,l)}e=c;var h=(e-this.width)/2;var k=(a-this.height)/2;var m=this.width;this.width=e;this.height=a;this.divjq.css("width",e);this.divjq.css("height",a);this.canvasjq.attr("width",e);this.canvasjq.attr("height",a);b.bugs.webkit_resize&&!this.resizing&&(this.owidth=Math.min(this.owidth,e),this.oheight=Math.min(this.oheight,a));0<=$.inArray("JS9Menubar",b.globalOpts.resizeDivs)&&
(b.isNull(d.resizeMenubar)||d.resizeMenubar)&&(g=this.pluginInstances.JS9Menubar)&&$("#"+this.id+"Menubar").css("width",e);0<=$.inArray("JS9Toolbar",b.globalOpts.resizeDivs)&&(b.isNull(d.resizeToolbar)||d.resizeToolbar)&&(g=this.pluginInstances.JS9Toolbar)&&(g.divjq.attr("data-width",String(e)+"px"),b.Toolbar.init.call(g));0<=$.inArray("JS9Colorbar",b.globalOpts.resizeDivs)&&(b.isNull(d.resizeColorbar)||d.resizeColorbar)&&(g=this.pluginInstances.JS9Colorbar)&&(g.divjq.attr("data-width",String(e)+
"px"),b.Colorbar.init.call(g));0<=$.inArray("JS9Statusbar",b.globalOpts.resizeDivs)&&(b.isNull(d.resizeStatusbar)||d.resizeStatusbar)&&(g=this.pluginInstances.JS9Statusbar)&&($("#"+this.id+"Statusbar").css("width",e),g.statusBar&&g.statusBar.match(/\$colorbar/)&&!1!==d.resizeStatusbarColorbar&&(g.colorwidth=Math.max(g.colorwidth+c-m,b.Statusbar.COLORWIDTH),b.Statusbar.display.call(g,this.image,{reinit:!0})));g=$jscomp.makeIterator(Object.keys(this.layers));for(c=g.next();!c.done;c=g.next())c=c.value,
c=this.layers[c],"main"===c.dtype&&(c.divjq.css("width",e),c.divjq.css("height",a),c.canvasjq.attr("width",e),c.canvasjq.attr("height",a),c.canvas.setWidth(e),c.canvas.setHeight(a),c.canvas.calcOffset());for(e=0;e<b.images.length;e++)if(a=b.images[e],a.mkSection(),a.display&&this===a.display&&(a.resize?(a.resize.left+=h,a.resize.top+=k):a.resize={left:h,top:k},a===a.display.image))for(g=$jscomp.makeIterator(Object.keys(a.layers)),c=g.next();!c.done;c=g.next())c=c.value,c=a.layers[c],"main"!==c.dlayer.type||
c.json||(c.canvas.getObjects().forEach(f),c.canvas.renderAll());b.bugs.webkit_resize&&this.divjq.css("width",this.width+b.RESIZEFUDGE).css("height",this.height+b.RESIZEFUDGE);!this.image||!b.globalOpts.resizeRedisplay&&this.resizing||(this.image.displayImage("all",d),this.image.refreshLayers());d.center&&this.center();return this};b.Display.prototype.inResize=function(c){return b.globalOpts.resizeHandle&&c.x+b.RESIZEDIST>=this.divjq.width()&&c.y+b.RESIZEDIST>=this.divjq.height()?!0:!1};b.Display.prototype.center=
function(){var c=this.divjq,a;var d=c.offset().top;var e=c.height(),f=$(window).height();var g=c.offset().left;c=c.width();var h=$(window).width();for(a=0;a<b.globalOpts.centerDivs.length;a++){var k=b.globalOpts.centerDivs[a];this.pluginInstances[k]&&(k=this.pluginInstances[k].divjq,e+=k.height(),d=Math.min(k.offset().top,d))}d=e<f?d-(f/2-e/2):d;g=c<h?g-(h/2-c/2):g;$("html, body").animate({scrollTop:d,scrollLeft:g},250);return this};b.Display.prototype.gather=function(c){var a;c=c||{};if("string"===
typeof c)try{c=JSON.parse(c)}catch(g){b.error("can't parse gather opts: "+c,g)}var d=c.images||b.images;for(c=0;c<d.length;c++)if((a="number"===typeof d[c]?b.images[d[c]]:d[c])&&a.display!==this){var e=a.display;var f=e.divjq.closest(".JS9GridItem");a.moveToDisplay(this);0<f.length&&(a=$.inArray(e,b.displays),0<=a&&b.displays.splice(a,1),f.remove())}b.globalOpts.extendedPlugins&&this.image&&this.image.xeqPlugins("image","ongatherdisplay")};b.Display.prototype.separate=function(c){var a=this,d,e,f,
g=0,h=0,k=0,m=1,l,p,r,n,u,x,t,v,w,q,z,y,A,C,B,D={},E=/_sep[0-9][0-9]*/,F=b.globalOpts.separate,G=function(a,c,d){c||b.error("can't init separation ops: no 'from' id");l=d.layout||b.globalOpts.separate.layout||"auto";p=d.leftMargin||F.leftMargin||0;r=d.topMargin||F.topMargin||0;"auto"===l&&0<a.divjq.closest(".JS9GridContainer").length&&(l="grid");"grid"===l&&(CSS.supports("display","grid")?(f=a.divjq.closest(".JS9GridContainer"),0<f.length&&(n=f)):l="auto");switch(l){case "auto":k=1;h=0;break;case "horizontal":k=
1;h=0;break;case "vertical":k=0;h=1;break;default:k=1,h=0}u=43;x=0;t=$("#"+c);v=$("#"+c+"Menubar");0<v.length&&(v.isactive="visible"===v.closest(".JS9PluginContainer").css("visibility"));w=$("#"+c+"Toolbar");0<w.length&&(w.isactive="visible"===w.closest(".JS9PluginContainer").css("visibility"));q=$("#"+c+"Statusbar");0<q.length&&(q.isactive="visible"===q.closest(".JS9PluginContainer").css("visibility"));z=$("#"+c+"Colorbar");0<z.length&&!q.length&&(z.isactive="visible"===z.closest(".JS9PluginContainer").css("visibility"));
0<t.length&&(y=t.width(),A=t.height(),C=t.offset().top-$(window).scrollTop()-5,B=t.offset().left-$(document).scrollLeft(),v.isactive&&(A+=v.height(),C-=v.height()),w.isactive&&(A+=w.height(),C-=w.height()),q.isactive?(A+=q.height(),C-=q.height()):z.isactive&&(A+=z.height(),C-=z.height(),C+=7))},J=function(b,a){if(b){if(0<t.length){var c="";v.isactive&&(c+=sprintf("<div class='JS9Menubar' id='%sMenubar' data-width=%s></div>",a,t.width()));w.isactive&&(c+=sprintf("<div class='JS9Toolbar' id='%sToolbar' data-width=%s></div>",
a,t.width()));c+=sprintf("<div class='JS9' id='%s' data-width=%s data-height=%s></div>",a,t.width(),t.height());q.isactive?c+=sprintf("<div style='margin-top: 2px;'><div class='JS9Statusbar' id='%sStatusbar' data-width=%s></div></div>",a,t.width()):z.isactive&&(c+=sprintf("<div style='margin-top: 2px;'><div class='JS9Colorbar' id='%sColorbar' data-width=%s></div></div>",a,t.width()))}"auto"===l&&B+y*(k+.5)>window.innerWidth&&(h++,k=0);var d=sprintf("width=%s,height=%s,top=%s,left=%s,resize=1,scolling=1",
y,A,C+(A+r+u)*h,B+(y+p+x)*k);"auto"===l||"horizontal"===l?k++:"vertical"===l&&h++}return{id:a,html:c,winopts:d}},I=function(f){var h;var k=g++;f.length>k?(k="number"===typeof f[k]?b.images[f[k]]:f[k])&&k.display===a?(k.displayImage("all"),void 0===d?(d=k.display.id,G(k.display,d,c),!1===c.firstinplace&&g--,I(f)):(e="string"===typeof c.idbase?h=c.idbase+m++:d.replace(E,"")+"_sep"+b.uniqueID(),D[e]=k,k=J(d,e),h&&(k.id=h),"grid"===l?($("<div>").prop("id",k.id+"GridItem").addClass("JS9GridItem").append($(k.html)).appendTo(n),
b.AddDivs(k.id),D[k.id].moveToDisplay(k.id),I(f)):($(b.lightOpts[b.LIGHTWIN].topid).arrive("#"+e,{onceOnly:!0},function(b){h=$(b).attr("id");window.setTimeout(function(){D[h].moveToDisplay(h);I(f)},0)}),b.LoadWindow(null,{id:k.id},"light",k.html,k.winopts)))):I(f):b.globalOpts.extendedPlugins&&a.image&&a.image.xeqPlugins("image","onseparatedisplay")};c=c||{};if("string"===typeof c)try{c=JSON.parse(c)}catch(K){b.error("can't parse separate opts: "+c,K)}I(c.images||b.images)};b.Display.prototype.nextImage=
function(c){var a,d=[],e=[];c=c||1;if(!this.image)return this;var f=this.image.pos;if(!b.globalOpts.nextImageMask)for(a=0;a<b.images.length;a++){var g=b.images[a];g.display===this&&g.mask.active&&g.mask.im&&e.push(g.mask.im)}for(a=0;a<b.images.length;a++)g=b.images[a],g.display===this&&(!b.globalOpts.nextImageMask&&0<=$.inArray(g,e)||d.push(g));if(1>=d.length)return this;for(g=0;g<d.length&&this.image!==d[g];g++);for(c=g+c;c>=d.length;)c-=d.length;for(;0>c;)c+=d.length;g!==c&&(g=d[c],g.displayImage("all"),
g.display.clearMessage(),f&&(f=g.displayToImagePos(f),g.valpos=null,g.valpos=g.updateValpos(f,!0)));return this};b.Display.prototype.loadSession=function(c,a){var d=this,e,f,g={},h=function(c){var e,h=function(){var a=v.canvas.getObjects();a&&"undefined"!==typeof a.length&&(c.layers[v.layerName].nshape=a.length+1);b.Fabric.updateChildren(v,null,"objects");c.refreshLayers()},l=function(b,a){5>parseInt(b.version.slice(0,1),10)&&(a.startAngle&&(a.startAngle*=180/Math.PI),a.endAngle&&(a.endAngle*=180/
Math.PI))};var k=g[c.file]||{};k.blend&&(c.blend=$.extend(!0,{},k.blend));k.tmp&&(c.tmp=$.extend(!0,{},k.tmp));k.wcsim&&(c.wcsim=b.lookupImage(k.wcsim));if(k.layers&&k.layers.length)for(e=0;e<k.layers.length;e++){var m=k.layers[e];var t=m.name;if(!(0<=$.inArray("regions",c.params.disable)&&"regions"===t)&&"crosshair"!==t&&"grid"!==t){var v=d.newShapeLayer(t,m.dopts);c.addShapes(t,[]);v.canvas.loadFromJSON(m.json,h,l);m.catalog&&(c.layers[t].catalog=m.catalog);if(m.starbase)try{c.layers[t].starbase=
JSON.parse(m.starbase)}catch(w){}}}c.tmp&&"active"===c.tmp.gridStatus&&c.displayCoordGrid(!0);b.notNull(f)&&(--f,0===f&&b.images.sort(function(b,a){var c=0,d=0;g[b.file]&&(c=g[b.file].i);g[a.file]&&(d=g[a.file].i);return c-d}));k.xeqstash&&c.xeqStashCall(k.xeqstash);b.globalOpts.extendedPlugins&&c.xeqPlugins("image","onsessionload");if("function"===typeof a.onsessionload)try{b.xeqByName(a.onsessionload,window,c)}catch(w){b.error("in onsessionload callback",w,!1)}},k=function(c){c.file||b.error("session does not contain a filename");
e=$.extend(!0,{},c);delete e.params.display;e.params.crosshair=!1;e.params.onload=h;c=e.file;e.sect&&(e.params.xcen=e.sect.xcen,e.params.ycen=e.sect.ycen,e.params.xdim=e.sect.xdim,e.params.ydim=e.sect.ydim,e.params.zoom=e.sect.zoom,delete e.sect);window.electron&&b.desktopOpts.sessionPath&&a.sessionPath&&"/"!==e.file.charAt(0)&&!e.file.match(b.URLEXP)&&(c=b.fixPath(a.sessionPath+e.file,a));g[c]=e;b.Load(c,e.params,{display:d.id})},m=function(a){var c;a.globalOpts&&($.extend(!0,b.globalOpts,a.globalOpts),
delete a.globalOpts);if(a.cmaps)for(c=0;c<a.cmaps.length;c++){var e=a.cmaps[c];if(e.name){var g=0<=$.inArray(e.name,b.globalOpts.topColormaps)?{toplevel:!0}:{toplevel:!1};b.AddColormap(e,g)}}if(a.images)for(f=a.images.length,c=0;c<a.images.length;c++)a.images[c].i=c,k(a.images[c]);else k(a);if(a.display)for(c=$jscomp.makeIterator(Object.keys(a.display)),e=c.next();!e.done;e=c.next())switch(e=e.value,e){case "blendMode":b.BlendDisplay(a.display[e],{display:d});break;default:d[e]=a.display[e]}};a=a||
{};if("string"===typeof a)try{a=JSON.parse(a)}catch(l){b.error("can't parse loadSession opts: "+a,l)}b.waiting(!0,this);"object"===typeof c?m(c):$.ajax({url:c,cache:!1,dataType:"json",mimeType:"application/json",async:!1,success:function(b){m(b)},error:function(a,d,e){b.error("could not load session: "+c,e)}});return this};b.Display.prototype.displayMessage=function(b,a,d){};b.Display.prototype.clearMessage=function(b){};b.Display.prototype.createMosaic=function(c,a){var d=this,e,f,g,h,k=this.image,
m=function(){var a;for(a=0;a<h.length;a++)b.vunlink(h[a])},l=function(a,c){var d;0>c.search(/\[struct stat="OK"/)&&(b.waiting(!1),m(),(d=c.match(/msg="(.*)"/))&&d[1]?b.error(d[1]+" (from "+a+")"):b.error(c||"unknown "+a+" failure"))},p=function(a,c){c=c||{};var e=$.extend(!0,{},c);!1!==c.waiting&&b.waiting(!0,d);e.display=d.id;a=new b.Image(a,e);k.setStatus("createMosaic","complete");a.setStatus("createMosaic","complete");b.waiting(!1);if(c.onmosaic)try{b.xeqByName(c.onmosaic,window,a)}catch(t){b.error("in create mosaic callback",
t,!1)}},r=function(c){for(var d=[],e=0;e<arguments.length;++e)d[e-0]=arguments[e];if(a.verbose||1<b.DEBUG)d=sprintf.apply(null,$jscomp.arrayFromIterable(d)),b.log(d)};a=a||{};if("string"===typeof a)try{a=JSON.parse(a)}catch(n){b.error("can't parse createMosaic opts: "+a,n)}a.reduce=a.reduce||b.globalOpts.reduceMosaic;a.dim=a.dim||Math.max(b.globalOpts.image.xdim,b.globalOpts.image.ydim);if(c)if("string"===typeof c)if("current"===c)c=this.image?[this.image]:[];else if("all"===c)for(c=[],e=0;e<b.images.length;e++)b.images[e].display.id===
this.id&&c.push(b.images[e]);else c=[c];else $.isArray(c)||b.error("unknown input type for createMosaic()");else c=this.image?[this.image]:[];c.length||b.error("no images specified for createMosaic()");for(e=0;e<c.length;e++)"string"===typeof c[e]&&((f=b.lookupImage(c[e]))?c[e]=f:b.error("unknown image for mosaic: "+c[e])),f=c[e],f.raw.hdu&&f.raw.hdu.fits&&f.raw.hdu.fits.vfile||b.error("no virtual file available for mosaic: "+f.id);b.waiting(!0,this);k.setStatus("createMosaic","processing");window.setTimeout(function(){var d=
b.uniqueID();var f=function(b){return"mosaic_"+d+"_"+b};var k=f("in.lst");var t=f("in.tbl");var v=f("in.hdr");var w=f("bin.lst");var q=f("bin.tbl");var z=f("out.lst");var y=f("out.tbl");var A=f("out.hdr");f=c[0].id.replace(/\[.*\]/,"").replace(/\.fz$/i,"").replace(/\.gz$/i,"").replace(/\.fits$/i,"_mosaic.fits");var C=f.replace(/\.fits$/,"_area.fits");h=[k,t,v,w,q,z,y,A,C];C="|                                                    fname|\n|                                                     char|\n";
for(e=0;e<c.length;e++)C+=c[e].raw.hdu.fits.vfile+"\n";b.vfile(k,C);k=b.imgtbl(k,".",t,"-C");l("mImgtbl",k);b.vsize(t)||b.error("no image data found with which to construct a mosaic");k=b.makehdr(t,v,"");l("mMakeHdr",k);if("js9"===a.reduce){C=b.vread(v).split("\n");for(e=v=0;e<C.length;e++)switch(k=C[e].split("="),k[0].trim()){case "NAXIS1":v=Math.max(v,parseFloat(k[1].trim()));break;case "NAXIS2":v=Math.max(v,parseFloat(k[1].trim()))}g=Math.max(1,Math.floor(v/a.dim+.5));C="|                                                    fname|\n|                                                     char|\n";
t=b.vread(t);t=t.trim().split("\n");t.splice(0,3);for(e=0;e<t.length;e++)if(k=t[e].trim().split(/\s+/),v=k[k.length-2],k=k[k.length-1],v&&k){var B=k+"["+v+"]";var D=k.split("/").reverse()[0].replace(/\.(g|f)z$/,"");v="bin_"+v+"_"+D;h.push(v);k="0@0,0@0,"+g;r("bin %s [%s]",B,g);b.imsection(B,v,k,"");C+=v+"\n"}b.vfile(w,C);k=b.imgtbl(w,".",q,"-C");l("mImgtbl",k);b.vsize(q)||b.error("no image data found to construct a mosaic");k=b.makehdr(q,A,"");l("mMakeHdr",k);t=b.vread(q)}else k=b.shrinkhdr(a.dim,
v,A),l("mShrinkHdr",k),t=b.vread(t);t=t.trim().split("\n");t.splice(0,3);C="|                                                    fname|\n|                                                     char|\n";for(e=0;e<t.length;e++)k=t[e].trim().split(/\s+/),v=k[k.length-2],k=k[k.length-1],v&&k&&(w="-a 1","shrink"===a.reduce&&(w+=" -h "+v),w+=" "+b.globalOpts.reprojSwitches,D=k.split("/").reverse()[0].replace(/\.(g|f)z$/,""),q="reproj_"+v+"_"+D,C+=q+"\n",h.push(q),h.push(q.replace(/\.fits$/i,"_area.fits")),
r("reproject: %s [%s] -> %s",k,v,q),k=b.reproject(k,q,A,w),l("mProjectPP",k));b.vfile(z,C);k=b.imgtbl(z,".",y,"");l("mImgtbl",k);b.vsize(y)||b.error("no FITS files were added to output table for mosaic");r("create mosaic: %s",f);k=b.madd(y,A,f,"");l("mAdd",k);m();z=$.extend(!0,{},b.fits.options,a);z.image={xdim:0,ydim:0};z.file=f;b.fits.handleFITSFile(f,z,p)},b.SPINOUT);return this};b.Display.prototype.moveImageInStack=function(c,a){var d,e,f,g;for(e=d=0;d<b.images.length;d++)if(b.images[d].display.id===
this.id&&(c===e&&(f=d),a===e&&(g=d),e++),b.notNull(f)&&b.notNull(g)){b.images.splice(g,0,b.images.splice(f,1)[0]);break}};b.Command=function(c){var a;c=c||{};var d=$jscomp.makeIterator(Object.keys(c));for(a=d.next();!a.done;a=d.next())a=a.value,this[a]=c[a];c.name||b.error("command has no name");c.get||c.set||b.error("command requires get and/or set routine");b.commands.push(this);1<b.DEBUG&&b.log("JS9 command:  %s",this.name)};b.Command.prototype.getDisplayInfo=function(b){b&&b.id&&(this.display=
b,this.image=b.image);return this};b.Command.prototype.getWhich=function(b){return this.get&&!this.set?"get":this.set&&!this.get?"set":this.which?this.which(b):0===b.length?"get":"set"};b.Helper=function(){"file:"===b.globalOpts.helperProtocol&&(b.globalOpts.helperProtocol="http:");document.domain&&"localhost"!==document.domain||(b.globalOpts.htimeout=b.globalOpts.lhtimeout);b.globalOpts.helperProtocol.match(/\/\/$/)||(b.globalOpts.helperProtocol+="//");this.helper=this.connected=!1;this.type=b.allinone&&
!b.globalOpts.allinoneHelper?"none":b.globalOpts.helperType||"sock.io";this.pageid=null;this.connect()};b.Helper.prototype.connectinfo=function(){if(null===b.helper.connected)return"notConfigured";if(b.helper.connected){var c="connected "+b.helper.type+" "+b.helper.url;b.helper.pageid&&(c+="<p>"+b.helper.pageid);return c}return"notConnected "+b.helper.type};b.Helper.prototype.connect=function(c){var a=this,d=b.globalOpts.ehretries,e=b.globalOpts.ehtimeout,f=function(c,d){a.connected=!1;a.helper=!1;
a.ready=!0;$(document).trigger("JS9:helperReady",{type:"socket.io",status:"error"});c=c||"timeout";d&&"timeout"!==d||(d="or connection refused");d===c&&(c="");"error"===d&&(d="is the helper running?");b.globalOpts.requireHelper?b.error("helper connect error: "+c+" ("+d+")"):b.DEBUG&&b.log("JS9 helper connect error: "+c+" ("+d+")")},g=function(c){$.ajax({url:c,dataType:"script",timeout:b.globalOpts.htimeout,cache:!0,success:function(){"undefined"===typeof io?f("socket io object is undefined",null):
(a.socket=io.connect(a.url,b.socketioOpts),a.socket.on("connect",function(){var c;a.connected=!0;a.helper=!0;var d=[];for(c=0;c<b.displays.length;c++)d.push(b.displays[c].id);a.socket.emit("initialize",{displays:d,pageid:a.pageid},function(c){a.pageid=c.pageid;a.js9helper=c.js9helper;b.globalOpts.dataPathModify=c.dataPathModify;a.ready=!0;$(document).trigger("JS9:helperReady",{type:"socket.io",status:"OK"});b.DEBUG&&b.log("JS9 helper: connect: "+a.type)});$(document).trigger("JS9:connected",{type:"socket.io",
status:"OK"})}),a.socket.on("connect_error",function(){a.connected=!1;a.helper=!1;1<b.DEBUG&&b.log("JS9 helper: connect error")}),a.socket.on("connect_timeout",function(){a.connected=!1;a.helper=!1;1<b.DEBUG&&b.log("JS9 helper: connect timeout")}),a.socket.on("disconnect",function(c){a.connected=!1;a.helper=!1;1<b.DEBUG&&b.log("JS9 helper: disconnect: "+c);"io server disconnect"===c&&(1<b.DEBUG&&b.log("JS9 helper: manual reconnect"),a.socket.connect())}),a.socket.on("reconnect",function(){a.connected=
!0;a.helper=!0;1<b.DEBUG&&b.log("JS9 helper: reconnect")}),a.socket.on("msg",b.msgHandler))},error:function(b,a,c){f(a,c)}})},h=function(b,a,c){$.ajax({url:b,dataType:"jsonp",success:function(){g(a)},error:function(){0<--c?window.setTimeout(function(){h(b,a,c)},e):f()}})};c&&(this.type=c);if(this.socket){try{this.socket.disconnect()}catch(k){b.log("warning: can't disconnect from socket")}this.socket=null}b.globalOpts.helperURL?0<=b.globalOpts.helperURL.search(/:\/\//)?this.url=b.globalOpts.helperURL:
this.url=b.globalOpts.helperProtocol+b.globalOpts.helperURL:this.url=document.domain?location.origin?location.origin:b.globalOpts.helperProtocol+document.domain:b.globalOpts.helperProtocol+"localhost";this.baseurl=this.url;switch(this.type){case "none":this.connected=null;this.ready=!0;$(document).trigger("JS9:helperReady",{type:"none",status:"OK"});break;case "get":case "post":b.globalOpts.helperCGI||b.error("cgi script name missing for helper");this.url+="/"+b.globalOpts.helperCGI;this.helper=this.connected=
!0;b.DEBUG&&b.log("JS9 helper: connect: "+this.type);this.ready=!0;$(document).trigger("JS9:helperReady",{type:"get",status:"OK"});break;case "sock.io":case "nodejs":b.globalOpts.helperPort||b.error("port missing for helper");this.url=this.url.replace(/:[0-9][0-9]*$/,"")+":"+b.globalOpts.helperPort;c=2>=b.DEBUG?"socket.io.min.js":"socket.io.js";this.sockurl=this.url+"/socket.io/"+c;window.electron?(this.aliveurl=this.url+"/alive",h(this.aliveurl,this.sockurl,d)):g(this.sockurl);break;default:b.error("unknown helper type: "+
this.type)}};b.Helper.prototype.send=function(c,a,d){var e=this;if(!this.connected)return null;if(a&&"object"===typeof a){try{a.cookie=document.cookie}catch(f){delete a.cookie}b.globalOpts.dataPath&&!a.dataPath&&(a.dataPath=b.globalOpts.dataPath+":.")}else a={dataPath:"."};b.TOROOT&&(a.dataPath+=":"+b.TOROOT);switch(this.type){case "get":case "post":a.key=c;b.helper.pageid&&(a.pageid=b.helper.pageid);b.DEBUG&&b.log("JS9 cgi helper [%s, %s]: %s",this.type,JSON.stringify(a),this.url);$.ajax({url:this.url,
type:this.type.toUpperCase(),data:a,dataType:"text",success:function(a){"string"===typeof a&&0<=a.search(b.analOpts.epattern)&&b.log(a);d&&d(a)},error:function(a,c,d){b.DEBUG&&b.log("JS9 helper: "+e.type+" failure: "+c+" "+d)}});break;case "sock.io":case "nodejs":b.helper.socket.emit(c,a,d)}return this};b.WebWorker=function(c){var a=this,d=function(){a.worker.onmessage=b.WebWorker.prototype.msgHandler.bind(a);a.handlers=[]};c.match(b.URLEXP)?b.fetchURL(null,c,null,function(b){a.worker=new Worker(URL.createObjectURL(b));
d()}):(this.worker=new Worker(c),d())};b.WebWorker.prototype.msgHandler=function(c){var a=b.helper,d=c.data;switch(d.cmd){case "progress":b.progress(d.result.value,d.result.max);break;case "initsocketio":if("OK"===d.result)for(this.sockinit=!0,c=0;c<this.handlers.length;c++){var e=this.handlers[c];if(e.id===d.id){e.func(d.result);this.handlers.splice(c,1);break}}break;case "uploadFITS":for(c=0;c<this.handlers.length;c++)if(e=this.handlers[c],e.id===d.id){e.func(d.result);this.handlers.splice(c,1);
break}break;case "connect_error":case "connect_timeout":delete b.worker.uploadActive;b.progress(!1);1<b.DEBUG&&b.log("JS9 worker socketio: "+d.cmd);break;case "disconnect":delete b.worker.uploadActive;b.progress(!1);d.result=d.result||"JS9 worker socket was disconnected";window.setTimeout(function(){b.worker.send("initsocketio",[a.url,a.pageid],function(){d.alert?alert(d.result):1<b.DEBUG&&b.log(d.result)})},b.WORKEROUT);break;case "error":delete b.worker.uploadActive,b.progress(!1),b.error(d.result||
"in web worker")}};b.WebWorker.prototype.send=function(c,a,d,e){var f=c+b.uniqueID(),g={id:f,cmd:c,args:a};d&&(a=a||[],this.handlers.push({id:f,cmd:c,args:a,func:d}));e?this.worker.postMessage(g,e):this.worker.postMessage(g)};b.WebWorker.prototype.socketio=function(c){var a=b.helper;b.worker.send("initsocketio",[a.url,a.pageid],function(a){"OK"===a?c&&c():b.error("can't init socket.io for JS9 worker: "+a)})};b.WebWorker.prototype.terminate=function(){this.worker.terminate()};fabric.major_version=
parseFloat(fabric.version.split(".")[0]);fabric.minor_version=parseFloat(fabric.version.split(".")[1]);fabric.patch_version=parseFloat(fabric.version.split(".")[2]);b.Fabric={};b.Fabric.elements="cornerSize cornerColor cornerStyle borderColor transparentCorners selectionLineWidth centeredScaling hasControls hasRotatingPoint lockMovementX lockMovementY lockRotation lockScalingX lockScalingY lockUniScaling selectable hasBorders params pub".split(" ");b.Fabric.opts={originX:"center",originY:"center",
strokeWidth:2,selectionLineWidth:2,borderColor:"#00EEFF",cornerColor:"#00EEFF",cornerSize:fabric.isTouchSupported?10:6,cornerStyle:"circle",hasControls:!0,hasRotatingPoint:!0,hasBorders:!0,transparentCorners:!1,centeredScaling:!0,strokeUniform:!0,selectable:!0,padding:0,canvas:{selection:!0},fill:"transparent",objectCaching:!1};b.Fabric.rescaleStrokeWidth=function(b,a){var c=(this.scaleX+this.scaleY)/2;4<=fabric.major_version||3===fabric.major_version&&6===fabric.minor_version&&3<=fabric.patch_version||
2<=fabric.major_version&&this.params&&"annulus"!==this.params.shape&&"cross"!==this.params.shape||(b=b||1,b*=c,!a&&this.params&&(a=this.params.sw1),a&&("group"===this.type?this.forEachObject(function(c){c.rescaleBorder(b,a)}):this.set("strokeWidth",a/b)))};b.Fabric.rescaleEvenly=function(){if(this.params&&this.scaleX!==this.scaleY)switch(this.params.shape){case "annulus":case "circle":var b=this.params.lastscale||1;this.scaleX!==b?this.scaleY=this.scaleX:this.scaleY!==b&&(this.scaleX=this.scaleY);
this.params.lastscale=this.scaleX}};fabric.Object.prototype.rescaleBorder=b.Fabric.rescaleStrokeWidth;fabric.Object.prototype.rescaleEvenly=b.Fabric.rescaleEvenly;b.Fabric.newShapeLayer=function(c,a,d){var e=this,f=function(b,a){var d=l.display.image;var e=l.canvas.getActiveObject();var f={};if(d)if(b.params)"activeSelection"===e.type&&(f.group=e),d._updateShape(c,b,f,a);else if("activeSelection"===b.type||"group"===b.type&&!b.params){var g=b.getObjects();for(e=0;e<g.length;e++){var h=g[e];h.params&&
(f.group=b,d._updateShape(c,h,f,a))}}},g=function(b){e.image&&l.display.image._updateMultiDialogs(b)},h=function(a,c){a.params.sel=null;a.display.image&&(a.display.image.layer=null);if(c){switch(c.type){case "polyline":case "polygon":b.Fabric.removePolygonAnchors(a,c)}f(c,"unselect");g(-1)}},k=function(a,d){a.params.sel&&d.params&&a.params.sel!==d&&h(a,a.params.sel);a.display.image&&(a.display.image.layer=c);if(d){switch(d.type){case "polyline":case "polygon":b.Fabric.addPolygonAnchors(a,d),a.canvas.renderAll()}d.polyparams?
a.params.sel=d.polyparams.polygon:d.params&&(a.params.sel=d);f(d,"select");g(1)}},m=function(a,c,d){a.params.sel&&a.params.sel!==d&&h(a,a.params.sel);d=d||a.canvas.getActiveObject();var e=a.canvas.getActiveObjects();for(c=0;c<e.length;c++){var k=e[c];if(k.params&&k.params.parent&&k.params.parent.obj){var l=k.params.parent.obj;0>$.inArray(l,e)&&d.addWithUpdate(l)}if(k.params&&k.params.children)for(l=0;l<k.params.children.length;l++){var m=k.params.children[l].obj;0>$.inArray(m,e)&&d.addWithUpdate(m)}switch(k.type){case "polyline":case "polygon":k.params&&
b.Fabric.removePolygonAnchors(a,k)}f(k,"select")}a.canvas.renderAll();g(1)};if(e&&c){if(e.layers[c])return e.layers[c];e.layers[c]={};var l=e.layers[c];l.layerName=c;l.params=[];l.params.sel=null;l.params.sellayer=null;d?l.dtype="other":(l.dtype="main",d=e.divjq);var p=d.attr("id")+"-"+c.replace(/\s+/,"_")+"-shapeLayer";l.display=e;l.opts=$.extend(!0,{},a);l.opts.canvas=l.opts.canvas||{};void 0===l.opts.canvas.selection&&(l.opts.canvas.selection=!0);l.el=b.Fabric.elements;l.divjq=$("<div>").addClass("JS9Container").css("z-index",
0).appendTo(d);l.canvasjq=$("<canvas>").addClass("JS9Layer").attr("id",p).attr("width",d.css("width")).attr("height",d.css("height")).appendTo(l.divjq);b.bugs.webkit_resize&&"main"===l.dtype&&l.canvasjq.attr("width",e.width).attr("height",e.height);l.canvas=new fabric.Canvas(l.canvasjq[0]);l.canvas.renderOnAddRemove=!1;l.canvas.preserveObjectStacking=!0;l.opts.movable?(l.opts.lockMovementX=!1,l.opts.lockMovementY=!1,l.opts.selectable=!0,l.opts.evented=!0):!1===l.opts.movable&&(l.opts.lockMovementX=
!0,l.opts.lockMovementY=!0,l.opts.selectable=!1,l.opts.evented=!1);void 0===l.opts.changeable&&void 0!==l.opts.fixinplace&&(l.opts.changeable=!l.opts.fixinplace);void 0===l.opts.changeable&&void 0!==l.opts.locked&&(l.opts.changeable=!l.opts.locked);l.opts.changeable?(l.opts.hasControls=!0,l.opts.hasRotatingPoint=!0,l.opts.hasBorders=!0,l.opts.lockMovementX=!1,l.opts.lockMovementY=!1,l.opts.lockRotation=!1,l.opts.lockScalingX=!1,l.opts.lockScalingY=!1,l.opts.lockUniScaling=!1,l.opts.selectable=!0,
l.opts.evented=!0,l.opts.usekeyboard=!0):!1===l.opts.changeable&&(l.opts.hasControls=!1,l.opts.hasRotatingPoint=!1,l.opts.hasBorders=!1,l.opts.lockMovementX=!0,l.opts.lockMovementY=!0,l.opts.lockRotation=!0,l.opts.lockScalingX=!0,l.opts.lockScalingY=!0,l.opts.lockUniScaling=!0,l.opts.selectable=!1,l.opts.evented=!1,l.opts.usekeyboard=!1);l.opts.selectable&&(l.opts.canvas.selection=!0);if(l.opts.onmousedown||l.opts.onmouseup||l.opts.onmousemove||l.opts.tooltip||l.opts.onmouseover||l.opts.onmouseout){l.opts.evented=
!0;if(l.opts.onmousedown)l.canvas.on("mouse:down",function(a){if(l.display.image&&a.target){var d=a.target,e=d.params;if(!e||e&&!1!==e.changeable)"main"===l.dtype&&(l.display.image.clickInRegion=!0,l.display.image.clickInLayer=c),l.opts.onmousedown.call(l.canvas,l.display.image,d.pub,a.e,d)}else if(l.canvas._selection=l.canvas.selection)l.canvas.selection=b.specialKey(a.e)});else l.canvas.on("mouse:down",function(a){if(l.canvas._selection=l.canvas.selection)l.canvas.selection=b.specialKey(a.e)});
if(l.opts.onmouseup)l.canvas.on("mouse:up",function(b){l.display.image&&b.target&&l.opts.onmouseup.call(l.canvas,l.display.image,b.target.pub,b.e,b.target);l.canvas.selection=l.canvas._selection||l.canvas.selection});else l.canvas.on("mouse:up",function(){l.canvas.selection=l.canvas._selection||l.canvas.selection});if(l.opts.onmousemove)l.canvas.on("mouse:move",function(b){l.display.image&&b.target&&l.opts.onmousemove.call(l.canvas,l.display.image,b.target.pub,b.e,b.target)});if(l.opts.onmouseover)l.canvas.on("mouse:over",
function(b){l.display.image&&b.target&&l.opts.onmouseover.call(l.canvas,l.display.image,b.target.pub,b.e,b.target)});if(l.opts.onmouseout)l.canvas.on("mouse:out",function(b){l.display.image&&b.target&&l.opts.onmouseout.call(l.canvas,l.display.image,b.target.pub,b.e,b.target)});if(l.opts.onmousedblclick)l.canvas.on("mouse:dblclick",function(b){l.display.image&&b.target&&l.opts.onmousedblclick.call(l.canvas,l.display.image,b.target.pub,b.e,b.target)});l.opts.tooltip&&(l.canvas.on("mouse:over",function(a){l.display.image&&
a.target&&b.tooltip(a.target.left+a.target.width+2,a.target.top+a.target.height+2,l.opts.tooltip,l.display.image,a.target.pub,a.e,a.target)}),l.canvas.on("mouse:out",function(a){l.display.image&&a.target&&b.tooltip(a.target.left,a.target.top,null,l.display.image,a.target.pub,a.e,a.target)}))}else l.canvas.on("mouse:down",function(a){if(l.canvas._selection=l.canvas.selection)l.canvas.selection=b.specialKey(a.e)}),l.canvas.on("mouse:up",function(){l.canvas.selection=l.canvas._selection||l.canvas.selection});
l.canvas.on("object:modified",function(a){var c=[];if(a.target){var d=a.target;b.Fabric.updateChildren(l,d,"deltas");if(l.opts.sortOverlapping&&(d.setCoords(),l.canvas.forEachObject(function(b){b!==d&&d.intersectsWithObject(b)&&(e=b.getScaledWidth(),f=b.getScaledHeight(),c.push({obj:b,siz:e*f}))}),c.length)){var e=d.getScaledWidth();var f=d.getScaledHeight();c.push({obj:d,siz:e*f});c.sort(function(b,a){return b.siz<=a.siz?-1:1});var g=c.length;for(a=0;a<g;a++)try{c[a].obj.sendToBack()}catch(w){}}}});
l.canvas.on("object:scaling",function(a){a.target&&(a=a.target,a.rescaleEvenly(),a.rescaleBorder(),b.Fabric.updateChildren(l,a,"scaling"),"activeSelection"!==a.type&&"group"!==a.type||f(a,"scaling"))});l.canvas.on("object:moving",function(a){a.target&&(a=a.target,b.Fabric.updateChildren(l,a,"moving"),"activeSelection"!==a.type&&"group"!==a.type||f(a,"moving"))});l.canvas.on("object:rotating",function(a){a.target&&(a=a.target,b.Fabric.updateChildren(l,a,"rotating"),"activeSelection"!==a.type&&"group"!==
a.type||f(a,"rotating"))});l.canvas.on("selection:created",function(a){if(!b.globalOpts.skipSelectionProcessing)if(a.target){var c=a.target;"activeSelection"===c.type||"group"===c.type&&!c.params?m(l,a,c):k(l,c)}else a.selected&&a.selected.length&&(1===a.selected.length?(c=a.selected[0],k(l,c)):m(l,a))});l.canvas.on("selection:updated",function(a){if(!b.globalOpts.skipSelectionProcessing)if(a.target){var c=a.target;"activeSelection"===c.type||"group"===c.type&&!c.params?m(l,a,c):k(l,c)}else a.selected&&
a.selected.length&&(1===a.selected.length?(c=a.selected[0],k(l,c)):m(l,a))});l.canvas.on("before:selection:cleared",function(a){if(!b.globalOpts.skipSelectionProcessing&&a.target)if(a=a.target,"activeSelection"===a.type||"group"===a.type&&!a.params){a=l;var c;var d=a.canvas.getActiveObjects();for(c=0;c<d.length;c++){var e=d[c];h(a,e)}g(-1)}else h(l,a)});if(l.divjq.closest(b.lightOpts[b.LIGHTWIN].drag).length)if(fabric.isTouchSupported)l.divjq.on("touchstart",function(){l.canvas.calcOffset()});else l.divjq.on("mouseenter",
function(){l.canvas.calcOffset()});return l}};b.Fabric.showShapeLayer=function(c,a,d){var e=this,f;var g=0;if(f=this.getShapeLayer(c)){d=d||{};if("string"===typeof d)try{d=JSON.parse(d)}catch(l){b.error("can't parse showShapeLayer opts: "+d,l)}var h=f.canvas;var k=this.display.layers[c];if(b.isNull(a))return f.show;if(!0===a||"true"===a){if(!d.local&&(f.show=!0,this!==this.display.image))return;f.show&&(h.selection=f.opts.canvas.selection);f.json&&f.show&&h.loadFromJSON(f.json,function(){var a,d;
b.Fabric.updateChildren(f.dlayer,null,"objects");e.resize&&(h.getObjects().forEach(function(a){a.left+=e.resize.left;a.top+=e.resize.top;a.setCoords()}),h.calcOffset());f.zindex=Math.abs(f.zindex);k.divjq.css("z-index",f.zindex);var g=$jscomp.makeIterator(Object.keys(e.layers));for(a=g.next();!a.done;a=g.next())if(a=a.value,c!==a&&e.layers[a].show&&(a=e.display.layers[a],a.divjq.css("z-index")<f.zindex&&(d=a.canvas.getActiveObject())))b.Fabric.removePolygonAnchors(a,d),a.canvas.getActiveObject()&&
a.canvas.discardActiveObject();e.restoreSelection(c)});d=$jscomp.makeIterator(Object.keys(this.layers));for(a=d.next();!a.done;a=d.next())a=a.value,this.layers[a].json&&g++;g||(this.resize=null);this.xeqPlugins("shape","onshapelayershow",c)}else{if(!d.local&&this!==this.display.image){f.show=!1;return}if(f.show){g=h.getObjects();for(a=g.length;a--;){var m=g[a];m.params&&(m.params.winid&&(m.params.winid.close(),m.params.winid=null),m.params.anchors&&b.Fabric.removePolygonAnchors(f.dlayer,m))}g=h.toJSON(f.dlayer.el);
f.json=JSON.stringify(g);this.saveSelection(c);h.selection=!1;k&&(f.zindex=-Math.abs(f.zindex),k.divjq.css("z-index",f.zindex));h.clear()}d.local||(f.show=!1);this.xeqPlugins("shape","onshapelayerhide",c)}return this}};b.Fabric.displayShapeLayers=function(){var b;if(this!==this.display.image){if(this.display.image&&this.display.image.layers){var a=$jscomp.makeIterator(Object.keys(this.display.image.layers));for(b=a.next();!b.done;b=a.next())b=b.value,this.display.image.showShapeLayer(b,!1,{local:!0})}if(this.layers)for(a=
$jscomp.makeIterator(Object.keys(this.layers)),b=a.next();!b.done;b=a.next())b=b.value,this.showShapeLayer(b,!0,{local:!0})}};b.Fabric.toggleShapeLayers=function(){var b,a;if(this.toggleLayers){var d=$jscomp.makeIterator(Object.keys(this.layers));for(b=d.next();!b.done;b=d.next())b=b.value,(a=this.layers[b])&&this.toggleLayers[b]&&this.showShapeLayer(b,!0);delete this.toggleLayers}else for(this.toggleLayers={},d=$jscomp.makeIterator(Object.keys(this.layers)),b=d.next();!b.done;b=d.next())b=b.value,
"crosshair"!==b&&(a=this.layers[b])&&a.show&&"main"===a.dlayer.dtype&&(this.toggleLayers[b]=!0,this.showShapeLayer(b,!1))};b.Fabric.getShapeLayer=function(b,a){if(!b)return null;var c=this.layers[b];if(!c){a=this.display.layers[b];if(!a)return null;this.layers[b]={};c=this.layers[b];c.show=!0;c.nshape=0;c.dlayer=a;c.opts=c.dlayer.opts;c.canvas=c.dlayer.canvas;c.canvas.calcOffset()}return c};b.Fabric.activeShapeLayer=function(b){var a,c;if(b)if($.isArray(b)){var e=0;for(a=this.zlayer-1;e<b.length;e++){var f=
this.layers[b[e]];"main"===f.dlayer.dtype&&(f.zindex=a--,f.show?c||(c=b[e]):f.zindex=-f.zindex,f.dlayer.divjq.css("z-index",f.zindex))}b=c}else{if((f=this.layers[b])&&f.show){c=f.zindex;f.zindex=this.zlayer-1;f.dlayer.divjq.css("z-index",f.zindex);var g=$jscomp.makeIterator(Object.keys(this.layers));for(e=g.next();!e.done;e=g.next())e=e.value,a=this.layers[e],a!==f&&a.zindex===f.zindex&&"main"===a.dlayer.dtype&&(a.zindex=c,a.dlayer.divjq.css("z-index",a.zindex));this.xeqPlugins("shape","onshapelayeractive",
b)}b=this}else{b=$jscomp.makeIterator(Object.keys(this.layers));for(e=b.next();!e.done;e=b.next())e=e.value,a=this.layers[e],"main"===a.dlayer.dtype&&(void 0===f||a.zindex>f)&&(f=a.zindex,c=e);b=c}return b};b.Fabric._parseShapeOptions=function(c,a,d){var e,f={},g={};a=a||{};if(a.remove)return{remove:a.remove};var h=a.parent||d&&d.params&&d.params.parent;delete a.parent;a.restoreid||delete a.id;delete a.restoreid;g.tags=[];if(a.tags)if("string"===typeof a.tags){var k=a.tags.toLowerCase().split(",");
for(e=0;e<k.length;e++)g.tags[e]=k[e].trim()}else if($.isArray(a.tags))for(e=0;e<a.tags.length;e++)g.tags[e]=a.tags[e].trim();if(b.notNull(a.angle)){if(!h)switch(a.shape){case "box":case "cross":case "ellipse":case "text":if(this.raw.wcsinfo)this.raw.wcsinfo.crot&&(a.angle+=this.raw.wcsinfo.crot);else if(b.notNull(this.raw.header.LTM1_1)||b.notNull(this.raw.header.LTM1_2)){try{var m=Math.atan((this.raw.header.LTM1_2||0)/(this.raw.header.LTM1_1||0))}catch(u){m=0}m&&(m=180*-m/Math.PI,a.angle+=m)}b.notNull(this.params.transformAngle)&&
(a.angle+=this.params.transformAngle);b.notNull(this.params.transformScale)&&(a.angle*=this.params.transformScale)}f.angle=-a.angle}void 0!==a.dx&&void 0!==a.dy&&(f.left=a.dx,f.top=a.dy);void 0!==a.x&&void 0!==a.y&&(m=this.imageToDisplayPos(a),f.left=m.x,f.top=m.y);void 0!==a.px&&void 0!==a.py&&(m=this.logicalToDisplayPos({x:a.px,y:a.py}),f.left=m.x,f.top=m.y);"string"===typeof a.wcs&&(m=a.wcs.trim().split(/ +/),a.ra=m[0],a.dec=m[1],3<=m.length&&(a.wcssys=m[2]));if(this.validWCS()&&b.notNull(a.ra)&&
b.notNull(a.dec)){if(a.wcssys){var l=this.getWCSSys();var p=b.globalOpts.xeqPlugins;b.globalOpts.xeqPlugins=!1;this.setWCSSys(a.wcssys,!1)}else a._wcssys&&(l=this.getWCSSys(),p=b.globalOpts.xeqPlugins,b.globalOpts.xeqPlugins=!1,this.setWCSSys(a._wcssys,!1),delete a._wcssys);"string"===typeof a.ra&&(a.ra=b.saostrtod(a.ra),b.isHMS(this.params.wcssys)&&(a.ra*=15));"string"===typeof a.dec&&(a.dec=b.saostrtod(a.dec));m=b.wcs2pix(this.raw.wcs,a.ra,a.dec).trim().split(/ +/);l&&(this.setWCSSys(l,!1),b.globalOpts.xeqPlugins=
p);m=this.imageToDisplayPos({x:parseFloat(m[0]),y:parseFloat(m[1])});f.left=m.x;f.top=m.y}void 0!==a.left&&(f.left=a.left);void 0!==a.top&&(f.top=a.top);void 0===f.left&&!0!==a.noLeftTop&&(f.left=d&&void 0!==d.left?d.left:this.display.canvasjq.attr("width")/2-1);void 0===f.top&&!0!==a.noLeftTop&&(f.top=d&&void 0!==d.top?d.top:this.display.canvasjq.attr("height")/2-1+1);a.deltax&&(f.left+=a.deltax);a.deltay&&(f.top-=a.deltay);c="main"!==this.display.layers[c].dtype||a.preservedcoords?1:this.rgb.sect.zoom;
if(""===a.strokeDashes||""===a.strokeDashArray)a.strokeDashArray=[];""===a.strokeWidth&&(a.strokeWidth=b.Fabric.opts.strokeWidth);switch(a.shape){case "annulus":g.radii=[];if(void 0!==a.radii)if("string"===typeof a.radii)for(g.radii=a.radii.replace(/ /g,"").split(","),p=e=0;e<g.radii.length;e++)""!==g.radii[e]&&(a.sizeScale&&(g.radii[e]*=a.sizeScale),g.radii[p++]=this.wcs2imlen(g.radii[e]));else{if(g.radii=a.radii,a.sizeScale)for(e=0;e<g.radii.length;e++)g.radii[e]*=a.sizeScale}else for(a.ireg&&b.SCALEIREG&&
(b.notNull(a.iradius)&&(a.iradius/=c),b.notNull(a.oradius)&&(a.oradius/=c)),a.sizeScale&&(b.notNull(a.iradius)&&(a.iradius*=a.sizeScale),b.notNull(a.oradius)&&(a.oradius*=a.sizeScale)),c=(a.oradius-a.iradius)/a.nannuli,l=a.nannuli+1,e=0;e<l;e++)p=a.iradius+c*e,a.sizeScale&&(p*=a.sizeScale),g.radii.push(p);break;case "box":case "cross":a.ireg&&b.SCALEIREG&&(b.notNull(a.width)&&(a.width/=c),b.notNull(a.height)&&(a.height/=c));a.sizeScale&&(b.notNull(a.width)&&(a.width*=a.sizeScale),b.notNull(a.height)&&
(a.height*=a.sizeScale));break;case "circle":a.ireg&&b.SCALEIREG&&b.notNull(a.radius)&&(a.radius/=c);a.sizeScale&&b.notNull(a.radius)&&(a.radius*=a.sizeScale);break;case "ellipse":a.ireg&&b.SCALEIREG&&(b.notNull(a.r1)&&(a.r1/=c),b.notNull(a.r2)&&(a.r2/=c));a.sizeScale&&(b.notNull(a.r1)&&(a.r1*=a.sizeScale),b.notNull(a.r2)&&(a.r2*=a.sizeScale));break;case "point":switch(a.ptshape){case "box":a.width=2*a.ptsize;a.height=2*a.ptsize;break;case "circle":a.radius=a.ptsize;break;case "ellipse":a.rx=a.ptsize,
a.ry=a.ptsize/2}a.lockRotation=!0;a.lockScalingX=!0;a.lockScalingY=!0;a.lockUniScaling=!0;a.hasControls=!1;a.hasRotatingPoint=!1;a.hasBorders=!0;break;case "line":case "polygon":if(b.notNull(a.wcspts)&&this.validWCS()){a.pts=[];a.wcssys&&(l=this.getWCSSys(),p=b.globalOpts.xeqPlugins,b.globalOpts.xeqPlugins=!1,this.setWCSSys(a.wcssys,!1));for(e=0;e<a.wcspts.length;e++)m=b.wcs2pix(this.raw.wcs,a.wcspts[e].ra,a.wcspts[e].dec).trim().split(/ +/),a.pts.push({x:parseFloat(m[0]),y:parseFloat(m[1])});l&&
(this.setWCSSys(l,!1),b.globalOpts.xeqPlugins=p)}if(a.pts&&a.pts.length){if("string"===typeof a.pts){m=a.pts.replace(/ /g,"").split(",");l=m.length;if("string"===typeof m[0])for(e=0;e<l;e++)m[e]=parseFloat(m[e]);a.pts=[];for(p=e=0;e<l;e+=2,p++)a.pts[p]={x:m[e],y:m[e+1]}}l=a.pts.length;for(e=0;e<l;e++)p=a.pts[e],b.notNull(p.x)&&b.notNull(p.y)?a.pts[e]=this.imageToDisplayPos(a.pts[e]):b.notNull(p.dx)&&b.notNull(p.dy)&&(a.pts[e].x=p.dx,delete a.pts[e].dx,a.pts[e].y=p.dy,delete a.pts[e].dy);a.left&&a.top?
p={x:a.left,y:a.top}:a.dx&&a.dy?p={x:a.dx,y:a.dy}:(p=b.centerPolygon(a.pts),f.left=p.x,f.top=p.y);a.points=[];for(e=0;e<l;e++)m={x:(a.pts[e].x-p.x)/c,y:(a.pts[e].y-p.y)/c},a.points.push(m)}else d&&d.points&&d.points.length||("polygon"===a.shape&&a.polypoints?a.points=a.points||a.polypoints:"line"===a.shape&&a.linepoints&&(a.points=a.points||a.linepoints));if(a.ireg&&b.SCALEIREG)for(l=a.points.length,e=0;e<l;e++)a.points[e].x/=c,a.points[e].y/=c}e=$jscomp.makeIterator(Object.keys(a));for(c=e.next();!c.done;c=
e.next())switch(c=c.value,c){case "tags":case "x":case "y":case "px":case "py":case "deltax":case "deltay":case "ra":case "dec":case "pts":case "left":case "top":case "angle":case "radii":case "ireg":break;case "type":case "originX":case "originY":case "width":case "height":case "scaleX":case "scaleY":case "flipX":case "flipY":case "opacity":case "cornerSize":case "transparentCorners":case "hoverCursor":case "padding":case "borderColor":case "cornerColor":case "centeredScaling":case "centeredRotation":case "fill":case "fillRule":case "backgroundColor":case "stroke":case "strokeWidth":case "strokeDashArray":case "strokeLineCap":case "strokeLineJoin":case "strokeMiterLimit":case "shadow":case "borderOpacityWhenMoving":case "borderScaleFactor":case "borderDashArray":case "transformMatrix":case "minScaleLimit":case "selectable":case "evented":case "visible":case "hasControls":case "hasBorders":case "hasRotatingPoint":case "rotatingPointOffset":case "perPixelTargetFind":case "includeDefaultValues":case "clipTo":case "lockMovementX":case "lockMovementY":case "lockRotation":case "lockScalingX":case "lockScalingY":case "lockUniScaling":case "send":case "radius":case "rx":case "ry":case "points":case "selectionLineWidth":case "fontFamily":case "fontSize":case "fontStyle":case "fontWeight":case "text":case "textDecoration":case "textAlign":case "lineHeight":case "textBackgroundColor":case "textOpts":case "groupid":f[c]=
a[c];break;case "shape":var r=a[c];break;default:g[c]=a[c]}if(!(a=g.color||f.stroke)){a=g.tags;e=g.tagcolors;e=e||{};p=$jscomp.makeIterator(Object.keys(e));for(c=p.next();!c.done;c=p.next())if(c=c.value,l=c.split("_"),0===$(a).not(l).length&&0===$(l).not(a).length){var n=e[c];break}if(!n)for(p=$jscomp.makeIterator(Object.keys(e)),c=p.next();!c.done;c=p.next())if(c=c.value,l=c.split("_"),0===$(a).not(l).length){n=e[c];break}if(!n)for(p=$jscomp.makeIterator(Object.keys(e)),c=p.next();!c.done;c=p.next())if(c=
c.value,l=c.split("_"),0===$(l).not(a).length){n=e[c];break}a=n=n||d&&d.get("stroke")||e.defcolor||b.globalOpts.defcolor||"#000000"}f.stroke=a;f.selectColor=f.stroke;if(!0===b.globalOpts.controlsMatchRegion||"corner"===b.globalOpts.controlsMatchRegion)f.cornerColor=f.stroke;if(!0===b.globalOpts.controlsMatchRegion||"border"===b.globalOpts.controlsMatchRegion)f.borderColor=f.stroke;void 0===g.changeable&&void 0!==g.fixinplace&&(g.changeable=!g.fixinplace);void 0===g.changeable&&void 0!==g.locked&&
(g.changeable=!g.locked);if(void 0!==g.changeable||void 0!==g.editing)d=void 0!==g.editing?g.editing:!g.changeable,f.lockMovementX=d,f.lockMovementY=d,f.lockRotation=d,f.lockScalingX=d,f.lockScalingY=d,f.hasControls=!d,f.hasRotatingPoint=!d,f.hasBorders=!d;void 0!==g.movable&&(d=!g.movable,f.lockMovementX=d,f.lockMovementY=d);void 0!==g.resizable&&(d=g.resizable,f.hasControls=d,f.hasBorders=d);void 0!==g.rotatable&&(d=!g.rotatable,void 0===f.lockRotation&&(f.lockRotation=d,f.hasRotatingPoint=!d));
void 0!==g.editing&&(f.visible=!g.editing);return{shape:r,opts:f,params:g}};b.Fabric._exportShapeOptions=function(b){return"object"!==typeof b?[]:Object.keys(b).filter(function(a){switch(a){case "top":case "left":case "width":case "height":case "radii":case "radius":case "rx":case "ry":case "angle":case "panzoom":case "iradius":case "oradius":case "nannuli":case "aradius1":case "aradius2":case "configURL":case "sortOverlapping":case "tagcolors":case "pts":case "ptshape":case "ptsize":case "linepoints":case "polypoints":case "responseType":case "display":case "tags":case "r1":case "r2":case "x":case "y":case "dx":case "dy":case "px":case "py":case "ra":case "dec":case "shape":case "parent":case "rtn":case "_wcssys":case "file":case "savefile":case "savewhich":case "saveformat":case "saveselection":case "savewcs":case "sortids":case "send":case "listonchange":case "multitext":return!1;
case "text":return"text"===b.shape?!1:!0;case "editing":return b.editing;default:return!0}})};b.Fabric._handleChildText=function(c,a,d){if("regions"===c)if(d=d||{},"text"!==a.params.shape&&d.text&&(!a.params.children||!a.params.children.length)){var e=a.height*a.scaleX/2-12;e=1E-6>Math.abs(a.angle)?{x:a.left,y:a.top-e}:b.rotatePoint({x:a.left,y:a.top-e},a.angle,{x:a.left,y:a.top});var f=this.displayToImagePos(e);e={x:f.x,y:f.y,angle:-a.angle,color:a.stroke,text:d.text,tags:a.params.tags,parent:"TBD",
rtn:"object"};d.textOpts&&(e=$.extend(!0,{},e,d.textOpts));var g=this.addShapes(c,"text",e);g.params.parent={id:a.params.id,obj:a,dleft:a.left-g.left,dtop:a.top-g.top,lastscalex:a.scaleX,lastscaley:a.scaleY,lastangle:a.angle,textheight:12};this._updateShape(c,g,null,"child",g.params);void 0!==d.strokeWidth&&(g.params.parent.strokeWidth=d.strokeWidth);if(f.x!==e.x||f.y!==e.y)g.params.parent.moved=!0;d.textOpts&&void 0!==d.textOpts.ra&&void 0!==d.textOpts.dec&&(g.params.hasTextOpts=!0);a.params.children.push({id:g.params.id,
obj:g});this._updateShape(c,a,null,"addchild",a.params)}else if(a.params.children&&0<a.params.children.length&&(b.notNull(d.text)||b.notNull(d.textOpts)||b.notNull(d.color)))for(g=0;g<a.params.children.length;g++)f=a.params.children[g].obj,e=$.extend(!0,{},d.textOpts||{}),b.notNull(d.text)&&(e.text=d.text),b.globalOpts.regSyncTextColor&&!e.color&&!1!==d.synctextcolor&&b.notNull(d.color)&&(e.color=d.color),0<Object.keys(e).length&&this.changeShapes(c,f.params.id,e)};b.Fabric.addShapes=function(c,a,
d){var e,f={},g=[],h={};if(!(0<=$.inArray("regions",this.params.disable)&&"regions"===c)){d=d||{};if("string"===typeof d)try{d=JSON.parse(d)}catch(w){b.error("can't parse shape opts: "+d,w)}if(this.display.image!==this)this.delayedShapes=this.delayedShapes||[],this.delayedShapes.push({layer:c,shape:a,mode:"add",opts:d});else{if(d.file&&b.globalOpts.reloadRefreshReg)try{this.removeShapes("regions",d.file)}catch(w){}if((e=this.getShapeLayer(c))&&e.show){var k=e.canvas;if("string"===typeof a){var m=
this.parseRegions(a,d);a="string"===typeof m?[{shape:m}]:m}else if(!$.isArray(a))if("object"===typeof a)a=[a];else return;if(b.isNull(e.zindex)||Number.isNaN(e.zindex)){if("main"===this.display.layers[c].dtype)switch(c){case b.Crosshair.LAYERNAME:case b.Grid.LAYERNAME:e.zindex=1;break;default:e.zindex=this.zlayer++}else e.zindex=b.SHAPEZINDEX;var l=this.display.layers[c];l.divjq.css("z-index",e.zindex);this.xeqPlugins("shape","onshapelayercreate",c)}var p=$.extend(!0,{},b.Fabric.opts,e.opts,d);for(l=
0;l<a.length;l++){var r=a[l];!0===r.preservedcoords&&((b.isNull(r.dx)||b.isNull(r.dy))&&$.isArray(r.pts)&&b.isNull(r.pts[0].dx)&&b.error("preservedcoords requires positions in display coords"),r.sticky=!0,r.preservedcoords=Object.keys(r),r.wcsconfig={wcssys:"image"});var n=$.extend(!0,{},p,r);var u=this._parseShapeOptions(c,n);if(u.remove){if(!0===u.remove||"true"===u.remove)u.remove="all";if(!1!==u.remove&&"false"!==u.remove){this.removeShapes(c,u.remove);continue}}if(u.shape){n=u.opts;f=u.params;
void 0===f.id&&(f.id=++e.nshape);void 0===f.wcsconfig&&(f.wcsconfig={wcssys:this.getWCSSys()});f.exports=this._exportShapeOptions(d).concat(this._exportShapeOptions(r));f.parent=null;f.children=[];n.stroke&&(n.color=n.stroke,n.stroke=b.colorToHex(n.stroke));e.opts.noCenteredScaling&&0<=$.inArray(u.shape,e.opts.noCenteredScaling)&&(n.centeredScaling=!1);switch(u.shape){case "annulus":f.shape="annulus";m=n.top;u=n.left;n.top=0;n.left=0;var x=[];if(f.radii)for(r=0;r<f.radii.length;r++)n.radius=f.radii[r],
x.push(new fabric.Circle(n));n.top=m;n.left=u;n.width=2*n.radius;n.height=2*n.radius;m=new fabric.Group(x,n);break;case "box":f.shape="box";m=new fabric.Rect(n);break;case "circle":f.shape="circle";m=new fabric.Circle(n);break;case "cross":f.shape="cross";m=n.top;u=n.left;r=n.angle;x=n.width/2;var t=n.height/2;var v=[];n.left=0;n.top=0;n.angle=0;n.points=[{x:-x,y:0},{x:x,y:0}];v.push(new fabric.Polyline(n.points,n));n.points=[{x:0,y:-t},{x:0,y:t}];v.push(new fabric.Polyline(n.points,n));n.top=m;n.left=
u;n.angle=r;m=new fabric.Group(v,n);break;case "ellipse":f.shape="ellipse";n.rx=f.r1;n.ry=f.r2;m=new fabric.Ellipse(n);break;case "point":f.shape="point";switch(f.ptshape){case "box":m=new fabric.Rect(n);break;case "circle":m=new fabric.Circle(n);break;case "ellipse":m=new fabric.Ellipse(n);break;default:m=new fabric.Rect(n)}break;case "line":f.shape="line";m=new fabric.Polyline(n.points,n);break;case "polygon":f.shape="polygon";m=new fabric.Polygon(n.points,n,!0);break;case "text":f.shape="text";
f.text=n.text||"Double-click to add text here";n.fill=n.stroke;n.strokeWidth=0;m=new fabric.Text(f.text,n);break;default:b.error("unknown shape: "+u.shape)}k.add(m);f.layerName=c;f.sw1=Math.max(1,Math.floor(m.strokeWidth+.5));f.listonchange=!1;m.params=f;u="main"!==this.display.layers[c].dtype||m.params.preservedcoords?1:this.rgb.sect.zoom;if(e.opts.panzoom)switch(f.shape){case "point":case "text":break;default:m.scale(u)}m.rescaleBorder();!1===m.params.changeable&&k.sendToBack(m);this._handleChildText(c,
m,n);"TBD"!==d.parent&&this._updateShape(c,m,null,"add",f);if(d.onaddshapes&&m.pub)try{b.xeqByName(d.onaddshapes,this,this,m.pub)}catch(w){b.error("in onaddshapes callback",w,!1)}g.push(m);n.groupid&&(h[n.groupid]=h[n.groupid]||[],h[n.groupid].push(m))}}e=$jscomp.makeIterator(Object.keys(h));for(a=e.next();!a.done;a=e.next())a=a.value,this.groupShapes(c,h[a],{groupid:a,select:!1});(void 0===f.redraw||f.redraw)&&k.renderAll();return"object"===d.rtn?m:"objs"===d.rtn?g:f.id}}}};b.Fabric._parseShapes=
function(c,a,d){var e=this;if(!this.layers||!c||!this.layers[c])return null;var f=this.layers[c].canvas;d=d||{};b.tmp.regSelect={layer:c,im:this,all:[]};f.getObjects().forEach(function(a){a.params?a.params.parent||b.tmp.regSelect.all.push(a.params.id):"group"===a.type&&(a=e.lookupGroup(a))&&b.tmp.regSelect.all.push(a)});try{regSelect.parse(a)}catch(g){b.error("parsing selection filter: "+a,g)}if(d.saveselection&&a)switch(a.trim()){case "all":case "saved":case "selected":break;default:this.layers[c].selection=
a}a=b.tmp.regSelect.ids;delete b.tmp.regSelect;return a};b.Fabric._selectShapes=function(c,a,d,e){var f=this,g,h,k,m=[],l=function(b,a){0>$.inArray(b,m)&&(e.call(f,b,a),m.push(b))},p=function(b){var a;if(!b)return[];var c=b.length;do{for(a=0;c--;){var d=b[c];"group"!==d.type||d.params||(b.splice.apply(b,[c,1].concat($jscomp.arrayFromIterable(d.getObjects()))),a++)}c=b.length}while(a);return b},r=function(b,a){var c,d,e=[],f=[];var g=a.length;for(c=0;c<g;c++){var h=a[c];("activeSelection"===h.type||
"group"===h.type&&!h.params)&&e.push(h)}var k=e.length;(d=b.getActiveObject())&&("activeSelection"===d.type||"group"===d.type&&!d.params||(d=null));if(k||d)for(c=0;c<g;c++){var l=a[c];for(b=0;b<k;b++)h=e[b],h.contains(l)&&(f[c]=h);f[c]||d&&d.contains(l)&&(f[c]=d)}return f},n=function(b,a){var c;for(c=0;c<a.length;c++){var d=a[c];if("activeSelection"===d.type||"group"===d.type&&!d.params){if(d.contains(b))return d}else if(d.params&&d===b)return v[c]}return null};if(!this.layers||!c||!this.layers[c])return null;
"function"!==typeof e&&b.error("selectShapes requires a callback");d=d||{};var u=this.layers[c].canvas;a||(a=u.getActiveObject()&&"auto"===b.globalOpts.regWhichDefault?"selected":"all");if("string"===typeof a&&a.startsWith("["))try{a=JSON.parse(a)}catch(y){b.error("can't parse array selection")}if("string"===typeof a){if(this.layers[c].selection){if("and"===d.saved)a="(saved) && ("+a+")";else if("or"===d.saved||!0===d.saved)a="(saved) || ("+a+")";a=a.replace(/saved/gi,this.layers[c].selection)}if(a.match(/&|\||!/))a=
this._parseShapes(c,a,d);else if(d.saveselection&&a)switch(a.trim()){case "all":case "saved":case "selected":break;default:this.layers[c].selection=a}}$.isArray(a)||(a=[a]);for(h=0;h<a.length;h++){var x=u.getObjects().reverse();var t=x.length;var v=r(u,x);var w=a[h];"string"===typeof w&&/^[1-9]\d*$/.test(w)&&(w=parseInt(w,10));var q={group:null,canvas:u,layer:c};switch(typeof w){case "object":t=p(x);for(g=t.length;g--;)if((k=t[g])&&k.params&&k===w){q.group=n(k,x);l(k,q);break}break;case "number":t=
p(x);for(g=t.length;g--;)if((k=t[g])&&k.params&&k.params.id===w){q.group=n(k,x);l(k,q);break}break;case "string":if("selected"===w)for(t=p(u.getActiveObjects()),g=t.length;g--;)k=t[g],q.group=n(k,x),k.params&&!k.params.parent&&l(k,q);else for(;t--;)if(k=x[t],"group"===k.type&&!k.params)w===this.lookupGroup(k)||"all"===w.toLowerCase()?(q.group=k,!1!==d.transparentgroup?k.forEachObject(function(b){b.params&&!b.params.parent&&l(b,q)}):l(k,q)):k.forEachObject(function(b){b.params&&w===b.params.file&&
l(b,q)});else if(k.params&&(g=k.stroke.toLowerCase(),!k.params.parent||"child"===w||"All"===w)&&("child"!==w||k.params.parent))if(q.group=v[t],"all"===w.toLowerCase())l(k,q);else if(w.toLowerCase()===g||b.colorToHex(w).toLowerCase()===g)l(k,q);else if(w===k.params.shape)l(k,q);else if(w===k.params.file)l(k,q);else if("object"===typeof k.params.data&&w===k.params.data.syncid)l(k,q);else if("child"===w&&k.params.parent)l(k,q);else if("dcoords"===w&&k.params.preservedcoords)l(k,q);else if("nodcoords"===
w&&!k.params.preservedcoords)l(k,q);else if("parent"===w&&k.params.children&&k.params.children.length)l(k,q);else if(0<=$.inArray(w,b.wcssyss)&&k.params.wcsconfig&&k.params.wcsconfig.wcssys===w)l(k,q);else if(k.params.tags)for(g=0;g<k.params.tags.length;g++){var z=k.params.tags[g];w.match(/^\/.*\/$/)&&z.match(new RegExp(w.slice(1,-1)))?l(k,q):w===z&&l(k,q)}}}return this};b.Fabric.selectShapes=function(c,a,d){var e,f=[];if(e=this.getShapeLayer(c)){var g=e.canvas;d=d||{};if("string"===typeof d)try{d=
JSON.parse(d)}catch(h){b.error("can't parse selectShapes opts: "+d,h)}b.isNull(d.transparentgroup)&&(d.transparentgroup=!1);b.isNull(d.saveselection)&&(d.saveselection=!0);a=a||"all";if("reset"===a)return delete e.selection,!1!==d.activateselection&&(g.getActiveObject()&&g.discardActiveObject(),g.renderAll()),this;this._selectShapes(c,a,d,function(b){!(0>$.inArray(b,f))||b.params&&b.params.groupid||f.push(b)});f.length&&(g.getActiveObject()&&g.discardActiveObject(),c=1===f.length?f[0]:new fabric.ActiveSelection(f,
{canvas:g}),g.setActiveObject(c),g.renderAll());return this}};b.Fabric.unselectShapes=function(b,a,d){if(this.getShapeLayer(b)&&this.layers[b])return a&&"all"!==a&&"selected"!==a?this.selectShapes(b,(this.layers[b].selection||"selected")+" && !("+a+")",d):this.selectShapes(b,"reset")};b.Fabric.updateShapes=function(b,a,d,e){var c=this;this._selectShapes(b,a,null,function(a,f){c._updateShape(b,a,f,d,e)});return this};b.Fabric._updateMultiDialogs=function(b){var a=this;$("form[class*='regionsConfigForm']").each(function(c,
e){c=$(e).data("multi");var d=$(e).data("winid");e=$(e).data("im");c&&d&&e===a&&!1!==e.tmp.updateMulti&&e.initRegionsForm(null,{winid:d,multi:c,setmode:b})})};b.Fabric._updateShape=function(c,a,d,e,f){var g=this,h,k,m,l={},p=this.layers[c],r=/^(child||export|unexport|move|mouseout)$/;var n=function(b){return b.toFixed(2)};var u=function(a,c,d,e,f,g,h){var k=b.pix2wcs(a,d.x,d.y).trim().split(/\s+/);h.rastr=k[0];h.decstr=k[1];h.wcssys=k[2];var l=b.strtoscaled(k[0]);b.isHMS(k[2],l.dtype)&&(l.dval*=15);
var m=b.strtoscaled(k[1]);h.ra=l.dval;h.dec=m.dval;if(!1!==g.updateWCS&&(g.updateWCS||c.opts.updateWCS)){h.wcsstr=b.reg2wcs(a,e,b.REGSIZE).replace(/;$/,"");"line"===d.shape&&f&&(h.wcsstr=h.wcsstr.replace(/} *$/,f+"}"));k=h.wcsstr.replace(/.*\(/,"").replace(/\).*/,"").split(",");for(a=0;a<k.length;a++)k[a]=k[a].trim();h.wcsposstr=[k[0],k[1]];switch(d.shape){case "annulus":h.wcssizestr=[k[k.length-1]];break;case "box":case "cross":h.wcssizestr=[k[2],k[3]];break;case "circle":h.wcssizestr=[k[2]];break;
case "ellipse":h.wcssizestr=[k[2],k[3]];break;case "line":case "polygon":for(h.wcspts=[],a=0;a<k.length;a+=2)l=b.strtoscaled(k[a]),b.isHMS(h.wcssys,l.dtype)&&(l.dval*=15),m=b.strtoscaled(k[a+1]),h.wcspts.push({ra:l.dval,dec:m.dval})}}};if(a&&a.params){d=d||{};f=f||{};e=e||"update";var x="main"!==this.display.layers[c].dtype||a.params.preservedcoords?1:this.rgb.sect.zoom;l.mode=e;l.id=a.params.id;l.groupid=a.params.groupid;l.shape=a.params.shape;l.layer=c;l.color=a.color||a.stroke;l.tags=a.params.tags;
l.sticky=a.params.sticky;l.preservedcoords=a.params.preservedcoords;a.params.ignore&&(l.ignore=!0);l.parent=a.params.parent?a.params.parent.obj.params.id:null;l.child=a.params.children&&a.params.children.length?a.params.children[0].id:null;var t=a.getCenterPoint();var v={x:0,y:0};if(d.group&&(v=d.group.getCenterPoint(),t={x:v.x+t.x*d.group.scaleX,y:v.y+t.y*d.group.scaleY},d.group.angle&&(t=b.rotatePoint(t,d.group.angle,v)),"activeSelection"!==d.group.type)){if((m=p.canvas.getActiveObject())&&"activeSelection"===
m.type){var w=m.getObjects();var q=w.length;for(h=0;h<q;h++)if(w[h]===d.group){var z=m.getCenterPoint();break}}z||(m=null);m&&(t={x:z.x+t.x*m.scaleX,y:z.y+t.y*m.scaleY},m.angle&&(t=b.rotatePoint(t,m.angle,z)))}l.preservedcoords&&(l.dx=t.x,l.dy=t.y);h=this.displayToImagePos(t);l.x=h.x;l.y=h.y;l.lcs=this.imageToLogicalPos(h);"export"!==e&&a.params.wcsconfig&&("image"===a.params.wcsconfig.wcssys?k="image":"physical"===a.params.wcsconfig.wcssys&&(k="physical"));"image"===k||"image"===this.params.wcssys&&
"physical"!==k?(l.imsys="image",h=l.x,w=l.y,k=1):(l.imsys=l.lcs.sys,h=l.lcs.x,w=l.lcs.y,k=Math.sqrt(Math.pow(this.lcs.physical.reverse[0][0],2)+Math.pow(this.lcs.physical.reverse[0][1],2)));l.angle=-a.angle;d.group&&(l.angle-=d.group.angle);m&&(l.angle-=m.angle);m=l.angle;if(!l.parent)switch(l.shape){case "box":case "cross":case "ellipse":case "text":if(b.notNull(this.params.transformScale)&&(l.angle/=this.params.transformScale),b.notNull(this.params.transformAngle)&&(l.angle-=this.params.transformAngle),
this.raw.wcsinfo)this.raw.wcsinfo.crot&&(l.angle-=this.raw.wcsinfo.crot);else if(b.notNull(this.raw.header.LTM1_1)||b.notNull(this.raw.header.LTM1_2)){try{var y=Math.atan((this.raw.header.LTM1_2||0)/(this.raw.header.LTM1_1||0))}catch(E){y=0}y&&(y=180*-y/Math.PI,l.angle-=y)}}for(;0>l.angle;)l.angle+=360;for(;360<=l.angle;)l.angle-=360;t=a.scaleX/x;y=a.scaleY/x;d.group&&(t*=d.group.scaleX,y*=d.group.scaleY);switch(l.shape){case "annulus":l.shape="annulus";l.radii=[];"image"!==l.imsys&&(l.lcs.radii=
[]);l.imstr="annulus("+n(h)+","+n(w)+",";var A="annulus "+l.x+" "+l.y+" ";w=a.getObjects();q=w.length;for(h=0;h<q;h++)v=w[h].radius*t,y=v*k,l.imstr+=n(y),A=b.REGSIZE?A+(l.x+" "+l.y+" "+(l.x+v)+" "+l.y+" "):A+(v+" "),l.imstr=h===q-1?l.imstr+")":l.imstr+",",l.radii.push(v),"image"!==l.imsys&&l.lcs.radii.push(y);break;case "box":case "cross":l.width=a.width*t;l.height=a.height*y;y=l.width*k;A=l.height*k;"image"!==l.imsys&&(l.lcs.width=y,l.lcs.height=A);l.imstr=l.shape+"("+n(h)+","+n(w)+","+n(y)+","+
n(A)+","+l.angle.toFixed(4)+")";A=b.REGSIZE?l.shape+" "+l.x+" "+l.y+" "+l.x+" "+l.y+" "+(l.x+l.width)+" "+l.y+" "+l.x+" "+l.y+" "+l.x+" "+(l.y+l.height)+" "+l.angle*Math.PI/180:l.shape+" "+l.x+" "+l.y+" "+l.width+" "+l.height+" "+l.angle*Math.PI/180;break;case "circle":l.radius=a.radius*t;y=l.radius*k;"image"!==l.imsys&&(l.lcs.radius=y);l.imstr="circle("+n(h)+","+n(w)+","+n(y)+")";A=b.REGSIZE?"circle "+l.x+" "+l.y+" "+l.x+" "+l.y+" "+(l.x+l.radius)+" "+l.y:"circle "+l.x+" "+l.y+" "+l.radius;break;
case "ellipse":l.r1=a.width*t/2;l.r2=a.height*y/2;y=l.r1*k;A=l.r2*k;"image"!==l.imsys&&(l.lcs.r1=y,l.lcs.r2=A);l.imstr="ellipse("+n(h)+","+n(w)+","+n(y)+","+n(A)+","+l.angle.toFixed(4)+")";A=b.REGSIZE?"ellipse "+l.x+" "+l.y+" "+l.x+" "+l.y+" "+(l.x+l.r1)+" "+l.y+" "+l.x+" "+l.y+" "+l.x+" "+(l.y+l.r2)+" "+l.angle*Math.PI/180:"ellipse "+l.x+" "+l.y+" "+l.r1+" "+l.r2+" "+l.angle*Math.PI/180;break;case "point":l.width=a.width*t;l.height=a.height*y;y=l.width*k;A=l.height*k;"image"!==l.imsys&&(l.lcs.width=
y,l.lcs.height=A);l.imstr="point("+n(h)+","+n(w)+")";A="point "+l.x+" "+l.y;break;case "line":case "polygon":l.imstr=l.shape+"(";A=l.shape+" ";l.pts=[];"image"!==l.imsys&&(l.lcs.pts=[]);for(h=0;h<a.points.length;h++)if(0<h&&(l.imstr+=",",A+=" "),y=this.displayToImagePos({x:v.x+a.left+a.points[h].x*a.scaleX,y:v.y+a.top+a.points[h].y*a.scaleY}),y=b.rotatePoint(y,m,{x:l.x,y:l.y}),"image"===l.imsys?l.imstr+=n(y.x)+","+n(y.y):(x=this.imageToLogicalPos(y),d=x.x,x=x.y,l.imstr+=n(d)+","+n(x),l.lcs.pts.push({x:d,
y:x})),A+=y.x+" "+y.y,l.pts.push(y),"line"===l.shape)if(0===h)var C=0;else d=l.pts[h-1],C+=Math.sqrt((y.x-d.x)*(y.x-d.x)+(y.y-d.y)*(y.y-d.y));if("line"===l.shape&&b.notNull(C)){l.imstr+=') {"size":'+n(C)+',"units":"pixels"';if(2===l.pts.length){for(y=180*Math.atan2(l.pts[1].y-l.pts[0].y,l.pts[1].x-l.pts[0].x)/Math.PI;0>y;)y+=360;var B=',"posang":'+y.toFixed(4)+',"posunits":"degrees"';l.imstr+=B}l.imstr+="}"}else l.imstr+=")";l.angle=0;break;case "text":l.imstr="text("+n(h)+","+n(w)+',"'+a.text+'",'+
l.angle.toFixed(4)+")",A="text "+l.x+" "+l.y+' "'+a.text+'" '+l.angle*Math.PI/180,l.text=a.text}this.validWCS()&&(u(this.raw.wcs,p,l,A,B,f,l),"export"!==e&&a.params.wcsconfig&&a.params.wcsconfig.wcssys&&(n=b.globalOpts.xeqPlugins,b.globalOpts.xeqPlugins=!1,v=this.getWCSSys(),b.notWCS(a.params.wcsconfig.wcssys)||(this.setWCSSys(a.params.wcsconfig.wcssys,!1),u(this.raw.wcs,p,l,A,B,f,a.params.wcsconfig)),l.wcsconfig=$.extend(!0,{},a.params.wcsconfig),this.setWCSSys(v,!1),b.globalOpts.xeqPlugins=n));
l.data=a.params.data;a.set("pub",l);a.params.winid&&($(a.params.winid).is(":visible")?this.initRegionsForm(a):a.params.winid=null);if(f.nocb)return l;(function(){var d=function(a){try{g.params.xeqonchange=!1,b.xeqByName(a,window,g,l)}catch(G){b.log("error in onchange: %s [%s]\n%s",g.id,G.message,b.strace(G))}finally{g.params.xeqonchange=!0}};a.params.parent||e.match(r)||(g.params.xeqonchange&&p.show&&(p.opts.onchange?d(p.opts.onchange):"regions"===c&&b.Regions.opts.onchange&&d(b.Regions.opts.onchange)),
d="on"+c+"change",g.xeqPlugins("shape",d,l))})();if("regions"===c&&b.globalOpts.regToClipboard){switch(e){case "update":h=l.parent||l.id;break;default:h=null}if(b.notNull(h)){try{var D=this.listRegions(h,{mode:1,includedcoords:!0})}catch(E){D=null}D&&(b.clipboard=D)}}"regions"===c&&"wcs"===e&&this._updateMultiDialogs(!0);return l}};b.Fabric.lookupGroup=function(b,a){var c;a=a||"regions";if(!this.getShapeLayer(a))return null;a=this.layers[a].canvas;if("string"===typeof b){var e=a.getObjects();for(a=
0;a<e.length;a++){var f=e[a];if("group"===f.type&&!f.params){var g=f.getObjects();for(c=0;c<g.length;c++){var h=g[c];if(h.params&&h.params.groupid===b)return f}}}}else if("object"===typeof b&&"group"===b.type&&!b.params&&(e=b.getObjects())&&e.length&&e[0]&&e[0].params)return e[0].params.groupid;return null};b.Fabric.listGroups=function(c,a,d){var e="";d=d||"regions";var f=this.getShapeLayer(d);if(!f)return e;c=c||"all";if("string"===typeof a)try{a=JSON.parse(a)}catch(m){b.error("can't parse listGroups opts: "+
a,m)}a=a||{};var g=f.canvas.getObjects();for(f=0;f<g.length;f++){var h=g[f];if("group"===h.type&&!h.params){var k=h.getObjects()[0].params.groupid;if("all"===c||c===k)!1===a.includeregions?e+=k+";":(h=this.getShapes(d,k,{format:"text",includejson:!1,includecomments:!0})+";;",h=h.substring(h.indexOf(";")+1),e+=k+":;"+h)}}b.notNull(a.mode)&&0<a.mode&&this.display.displayMessage("regions",e);return e.replace(/;\s*/g,"\n").replace(/\n\n$/,"\n")};b.Fabric.groupShapes=function(c,a,d){var e=this,f,g,h,k,
m=[],l=[];var p=this.getShapeLayer(c);if(!p)return 0;var r=p.dlayer;d=d||{};if("string"===typeof d)try{d=JSON.parse(d)}catch(u){b.error("can't parse groupShapes opts: "+d,u)}p=p.canvas;var n=function(b){var a=1;for(b=b.groupid||"group_"+a;e.lookupGroup(b);)a+=1,b=b.replace(/_[0-9][0-9]*$/,"")+("_"+a);return b}(d);this._selectShapes(c,a,d,function(a){if(0>$.inArray(a,m)){h=!1;if(a.params.groupid)switch(b.globalOpts.regGroupConflict){case "skip":k=a.params.groupid;h=!0;break;default:g=sprintf("%s can only be a member of one group [%s,%s]",
"regions"===c?"regions":"shapes",a.params.id,a.params.groupid),b.error(g)}if(!h&&(a.params.groupid=n,0>$.inArray("groupid",a.params.exports)&&a.params.exports.push("groupid"),m.push(a),l.push(a.pub),a.params&&a.params.children.length))for(f=0;f<a.params.children.length;f++)a.params.children[f].obj&&m.push(a.params.children[f].obj)}});if(!m.length)return k;p.getActiveObject()&&p.discardActiveObject();a=new fabric.ActiveSelection(m,{canvas:p});b.globalOpts.skipSelectionProcessing=!0;p.setActiveObject(a);
p.getActiveObject().toGroup();!1===d.select&&p.getActiveObject()&&p.discardActiveObject();delete b.globalOpts.skipSelectionProcessing;p.renderAll();this.groups[c]=this.groups[c]||[];this.groups[c].push(n);"function"===typeof r.opts.ongroupcreate&&r.opts.ongroupcreate.call(r.canvas,n,this,l,m);return n};b.Fabric.ungroupShapes=function(c,a,d){var e,f;var g=this.getShapeLayer(c);if(!g||!this.layers[c])return this;b.isNull(a)&&b.error("ungroup requires a group id or selection");d=d||{};var h=g.canvas;
var k=h.getObjects();for(g=0;g<k.length;g++){var m=k[g];if("group"===m.type&&!m.params){var l=m.getObjects();for(f=e=0;e<l.length;e++){var p=l[e];if(p.params&&("all"===a||a===p.params.groupid)){f||(h.getActiveObject()&&h.discardActiveObject(),b.globalOpts.skipSelectionProcessing=!0,h.setActiveObject(m),h.getActiveObject().toActiveSelection(),d.select||h.discardActiveObject(),h.requestRenderAll(),delete b.globalOpts.skipSelectionProcessing,f++);delete p.params.groupid;var r=$.inArray("groupid",p.params.exports);
0<=r&&p.params.exports.splice(r,1)}}}}this.groups[c]&&(r=$.inArray(a,this.groups[c]),0<=r&&this.groups[c].splice(r,1));return this};b.Fabric.removeShapes=function(c,a,d){var e=this,f,g,h=!1,k={mode:1,includedcoords:!0,sortids:!1},m=[],l=[];if(f=this.getShapeLayer(c)){var p=f.canvas;d=d||{};p.getActiveObject()&&(g=p.getActiveObjects());"regions"===c&&b.globalOpts.unremoveReg&&(this.regstack.push(this.listRegions(a,k,c)),this.regstack.length>b.globalOpts.unremoveReg&&(this.regstack=this.regstack.slice(0,
b.globalOpts.unremoveReg)));this._selectShapes(c,a,d,function(b,a){if(!(!1===b.params.removable&&!d.overrideRemovable||b.params.sticky&&!1===d.sticky)){"main"===f.dlayer.dtype&&e._updateShape(c,b,a,"remove");b.params.winid&&(b.params.winid.close(),b.params.winid=null);if(b.params.parent){var k=b.params.parent.obj;for(a=k.params.children.length-1;0<=a;a--)if(b===k.params.children[a].obj){k.params.children.splice(a,1);break}}for(a=0;a<b.params.children.length;a++)k=b.params.children[a].obj,m.push(k);
b.params.groupid&&0>$.inArray(b.params.groupid,l)&&l.push(b.params.groupid);g&&!h&&0<=$.inArray(b,g)&&(h=!0);m.push(b)}});h&&p.discardActiveObject();for(a=0;a<l.length;a++)this.ungroupShapes(c,l[a]);for(a=0;a<m.length;a++)p.remove(m[a]);p.renderAll();!p.size()&&b.globalOpts.resetEmptyShapeId&&(f.nshape=0);return this}};b.Fabric.getShapes=function(c,a,d){var e={},f=[];d=d||{};if("string"===typeof d)try{d=JSON.parse(d)}catch(k){b.error("can't parse getShapes opts: "+d,k)}if("regions"===c&&("text"===
d.format||"csv"===d.format||"regions"===d.format)){d.mode=d.mode||1;a=this.listRegions(a,d);if("csv"===d.format){var g=a.split(";");c=0;for(a="";c<g.length;c++)if(g[c])if(g[c].toLowerCase().match(b.WCSEXP))d.includewcs&&(a+=g[c].trim()+"\n");else{var h=g[c].replace(/\(/,",").replace(/\).*/,"").trim();a+=h+"\n"}}else"regions"===d.format&&(a=a.replace(/ *; */g,"\n"));return a}this._selectShapes(c,a,d,function(b){e=b.pub||{};d.includeObj&&(e.obj=b);f.push(e)});!1!==d.sortids&&f.sort(function(b,a){return(b.id||
0)-(a.id||0)});return f};b.Fabric.changeShapes=function(c,a,d){var e=this,f,g,h,k,m,l,p,r,n,u,x,t,v=[],w=[];if((m=this.getShapeLayer(c))&&d){if("string"===typeof d)try{d=JSON.parse(d)}catch(y){b.error("can't parse shape opts: "+d,y)}if(this.display.image!==this)this.delayedShapes=this.delayedShapes||[],this.delayedShapes.push({layer:c,shape:a,mode:"change",opts:d});else{var q=m.canvas;if((l=q.getActiveObject())&&"activeSelection"===l.type){var z=q.getActiveObjects();q.discardActiveObject();q.renderAll();
l=null}b.isNull(d.saveselection)&&(d.saveselection=!0);this._selectShapes(c,a,d,function(a,z){n="main"!==e.display.layers[c].dtype||a.params.preservedcoords?1:e.rgb.sect.zoom;d.radii&&(a.params.radii=[]);d.tags&&(a.params.tags=[]);void 0!==d.locked&&delete a.params.changeable;k=$.extend(!0,{},a.params,d);h=e._parseShapeOptions(c,k,a);if(h.remove){if(!0===h.remove||"true"===h.remove)h.remove="all";if(!1!==h.remove&&"false"!==h.remove){e.removeShapes(c,h.remove||"all");return}}u=e._exportShapeOptions(d).filter(function(b){return!{}.hasOwnProperty.call(a.params.exports,
b)});h.params.exports=a.params.exports.concat(u);h.opts.stroke&&(h.opts.color=h.opts.stroke,h.opts.stroke=b.colorToHex(h.opts.stroke));switch(a.params.shape){case "text":h.opts.stroke&&(h.opts.fill=h.opts.stroke);h.opts.strokeWidth=0;break;case "line":case "polygon":h.opts.points&&h.opts.points.length&&(a.angle=0)}a.set(h.opts);a.params=$.extend(!1,{},a.params,h.params);h.opts.strokeWidth&&(a.params.sw1=h.opts.strokeWidth);switch(a.params.shape){case "annulus":if(d.radii&&d.radii.length){a.forEachObject(function(a){v.push(a)});
p=v.length;for(f=0;f<p;f++)a.remove(v[f]),q.remove(v[f]);p=a.params.radii.length;r=0;x=$.extend(!0,{},d);x.stroke=x.stroke||a.get("stroke");x.strokeWidth=x.strokeWidth||a.get("strokeWidth");x.strokeDashArray=x.strokeDashArray||a.get("strokeDashArray");for(f=0;f<p;f++)x.radius=a.params.radii[f],g=new fabric.Circle(x),r=Math.max(r,a.params.radii[f]),a.add(g);a.scaleX=n;a.scaleY=n;a.width=2*r;a.height=2*r;l===a&&q.setActiveObject(a)}break;case "box":d.width&&(a.scaleX=n);d.height&&(a.scaleY=n);break;
case "circle":d.radius&&(a.scaleX=n,a.scaleY=n);break;case "cross":x=$.extend(!0,{},d);x.stroke=x.stroke||a.get("stroke");x.width&&(a.scaleX=n,w[0]=[{x:-x.width/2,y:0},{x:x.width/2,y:0}],delete x.width);x.height&&(a.scaleY=n,w[1]=[{x:0,y:-x.height/2},{x:0,y:x.height/2}],delete x.height);x.angle&&delete x.angle;a.forEachObject(function(a,b){t=$.extend(!0,{},x);w[b]&&(t.points=w[b]);a.set(t)});break;case "ellipse":d.r1&&(a.rx=a.params.r1,a.scaleX=n,a.width=2*a.rx);d.r2&&(a.ry=a.params.r2,a.scaleY=n,
a.height=2*a.ry);break;case "line":case "polygon":if(d.points&&d.points.length||d.pts&&d.pts.length)a.scaleX=n,a.scaleY=n;l===a&&(b.Fabric.removePolygonAnchors(m.dlayer,a),b.Fabric.addPolygonAnchors(m.dlayer,a));b.resetPolygonCenter(a);break;case "text":d.text&&(a.params.text=d.text)}a.rescaleBorder();!1===a.params.changeable&&q.sendToBack(a);switch(h.opts.send){case "front":q.bringToFront(a);l===a&&q.discardActiveObject();break;case "back":q.sendToBack(a),l===a&&q.discardActiveObject()}b.Fabric.updateChildren(m.dlayer,
a,"moving");b.Fabric.updateChildren(m.dlayer,a,"scaling");b.Fabric.updateChildren(m.dlayer,a,"rotating");b.Fabric.updateChildren(m.dlayer,a,"deltas");a.setCoords();e._handleChildText(c,a,d);e._updateShape(c,a,z,"update");if(d.onchangeshapes&&a.pub)try{b.xeqByName(d.onchangeshapes,e,e,a.pub)}catch(C){b.error("in onchangeshapes callback",C,!1)}});z&&this.selectShapes(c,z);(void 0===d.redraw||d.redraw)&&q.renderAll();return this}}};b.Fabric.refreshShapes=function(c){if(c){var a={mode:1,sticky:!1,ignoreignore:!0,
saveediting:!0,savewcsconfig:!0,sortids:!1,saveid:!0};var d=b.globalOpts.xeqPlugins;b.globalOpts.xeqPlugins=!1;var e=this.getWCSSys();"image"===e&&(this.validWCS()?this.setWCSSys("native",!1):this.setWCSSys("physical",!1));if(this.tmp.panzoomRefresh&&this.tmp.panzoomRefresh[c])this.tmp.panzoomRefresh[c].regstr?this.tmp.panzoomRefresh[c].refresh&&(a=this.tmp.panzoomRefresh[c].regstr,this.addShapes(c,a,{restoreid:!0})):(a=this.listRegions("all",a,c),this.tmp.panzoomRefresh[c]={regstr:a,refresh:!1},
this.removeShapes(c,"all",{overrideRemovable:!0,sticky:!1}));else if(a=this.listRegions("all",a,c))this.saveSelection(c),this.removeShapes(c,"all",{overrideRemovable:!0,sticky:!1}),this.addShapes(c,a,{restoreid:!0,sortids:!1}),this.restoreSelection(c);"image"===e&&(this.setWCSSys(e,!1),this.updateShapes(c,"all","refresh"));b.globalOpts.xeqPlugins=d;return this}};b.Fabric.copyShapes=function(c,a,d){var e=[];if(this.getShapeLayer(c)){if("object"===typeof a)e.push(a);else if("all"===a)for(a=0;a<b.images.length;a++)this!==
b.images[a]&&e.push(b.images[a]);else(a=b.lookupImage(a))&&e.push(a);if(e.length){var f={mode:1,includedcoords:b.globalOpts.regCopyDCoords,sortids:!1};d=this.listRegions(d,f,c);for(a=0;a<e.length;a++)f=this.display.layers[c]?this.display.layers[c].opts:b.Regions.opts,e[a].display.newShapeLayer(c,f),e[a].addShapes(c,d);return this}}};b.Fabric._addPolygonPoint=function(c,a,d){var e=Number.MAX_VALUE;if(a&&a.points){d=b.eventToDisplayPos(d);var f=a.getCenterPoint().x;var g=a.getCenterPoint().y;f=(d.x-
f)/a.get("scaleX");var h=(d.y-g)/a.get("scaleY");for(g=-a.get("angle")*Math.PI/180;g>2*Math.PI;)g-=2*Math.PI;d=Math.cos(g)*f-Math.sin(g)*h;h=Math.sin(g)*f+Math.cos(g)*h;f=a.points;for(g=0;g<f.length;g++){var k=f[g];var m=f[(g+1)%f.length];var l=k.x<m.x?k.x:m.x;var p=k.y<m.y?k.y:m.y;var r=k.x>m.x?k.x:m.x;var n=k.y>m.y?k.y:m.y;var u=k.x-m.x;k=k.y-m.y;var x=Math.sqrt(u*u+k*k);0!==x&&(u/=x,k/=x);x=d-m.x;var t=h-m.y;x=x*u+t*k;u=m.x+u*x;m=m.y+k*x;u<l?u=l:u>r&&(u=r);m<p?m=p:m>n&&(m=n);l=(u-d)*(u-d)+(m-h)*
(m-h);if(l<e){e=l;var v=u;var w=m;var q=g===f.length?0:g}}c=this.getShapeLayer(c);b.Fabric.removePolygonAnchors(c.dlayer,a);f.splice(q+1,0,{x:v,y:w});switch(a.type){case "polyline":case "polygon":b.Fabric.addPolygonAnchors(c.dlayer,a),c.dlayer.canvas.renderAll()}a.polyparams?c.dlayer.params.sel=a.polyparams.polygon:a.params&&(c.dlayer.params.sel=a)}};b.Fabric._removePolygonPoint=function(c,a){if(a&&a.polyparams){var d=a.polyparams.polygon;var e=d.points;if(!("polygon"===d.type&&3>=e.length||"polyline"===
d.type&&2>=e.length)){var f=a.polyparams.point;delete a.polyparams.point;c=this.getShapeLayer(c);b.Fabric.removePolygonAnchors(c.dlayer,d);e.splice(f,1);b.resetPolygonCenter(d);c.canvas.setActiveObject(d)}}};b.Fabric.addPolygonAnchors=function(c,a){var d,e={},f=c.canvas,g=function(a){if(a.target&&a.target.polyparams)var d=a.target;else a.transform&&a.transform.target&&a.transform.target.polyparams&&(d=a.transform.target);if(d&&(a=d.polyparams.polygon,!1!==a.params.changeable)){var g=a.get("points");
var h=d.polyparams.point;void 0!==h&&void 0!==g[h]&&(a.angle?e=b.rotatePoint({x:d.left,y:d.top},-a.angle,{x:a.left,y:a.top}):(e.x=d.left,e.y=d.top),g[h].x=(e.x-a.left)/a.scaleX,g[h].y=(e.y-a.top)/a.scaleY,b.resetPolygonCenter(a),c.display.image&&(d=c.display.image,d._updateShape(a.params.layerName,a,null,"update"),(d.params.listonchange||a.params.listonchange)&&d.listRegions(a,{mode:2})),f.renderAll())}},h=function(a){var c,d={};for(c=0;c<a.params.anchors.length;c++)d.x=a.left+a.points[c].x*a.scaleX,
d.y=a.top+a.points[c].y*a.scaleY,a.angle&&(d=b.rotatePoint(d,a.angle,{x:a.left,y:a.top})),a.params.anchors[c].set({left:d.x,top:d.y,angle:a.angle}),a.params.anchors[c].setCoords();a._calcDimensions(!0);f.renderAll()};if(!a.params.anchors&&!1!==a.params.changeable){a.params.anchors=[];for(d=0;d<a.points.length;d++){e.x=a.left+a.points[d].x*a.scaleX;e.y=a.top+a.points[d].y*a.scaleY;a.angle&&(e=b.rotatePoint(e,a.angle,a.getCenterPoint()));var k=new fabric.Rect({left:e.x,top:e.y,hasControls:!1,hasRotatingPoint:!1,
hasBorders:!1,selectable:!0,fill:a.get("stroke"),hoverCursor:"pointer",width:b.Fabric.opts.cornerSize+2,height:b.Fabric.opts.cornerSize+2,padding:2});k.on("moving",g);k.polyparams={};k.polyparams.polygon=a;k.polyparams.point=d;a.params.anchors[d]=k;f.add(k)}a.on("moving",function(){h(a)});a.on("rotating",function(){h(a)});a.on("scaling",function(){h(a)});a.setCoords()}};b.Fabric.removePolygonAnchors=function(b,a){var c=b.canvas;if(a&&a.params&&a.params.anchors){for(b=0;b<a.params.anchors.length;b++)c.remove(a.params.anchors[b]);
delete a.params.anchors}};b.Fabric._ungroupAnnulus=function(b,a){var c,e;if(e=this.getShapeLayer(b)){this.editAnnulus={annulus:a.params.id,ids:[]};var f={top:a.top,left:a.left,lockMovementX:!0,lockMovementY:!0,stroke:a.stroke,strokeDashArray:[3,1]};var g=a.getObjects();g.sort(function(a,b){return b.radius-a.radius});for(c=0;c<g.length;c++){f.radius=g[c].radius;0===f.radius&&(f.radius=1E-6);f.ignore=!0;var h=this.addShapes(b,"circle",f);this.editAnnulus.ids.push(h)}f={editing:!0};this.changeShapes(b,
a,f);e.canvas.getActiveObject()===a&&e.canvas.discardActiveObject();e.canvas.sendToBack(a);e.canvas.renderAll()}};b.Fabric._regroupAnnulus=function(b,a){var c,e=[];if(this.editAnnulus&&(c=this.getShapeLayer(b))){if("boolean"===typeof a)var f=a;else"object"===typeof a&&(f=a.shiftKey);a={editing:!1};if(!f){c.canvas.getObjects().forEach(function(a){a.params&&"circle"===a.params.shape&&e.push(a)});a.radii=[];var g=[].concat($jscomp.arrayFromIterable(this.editAnnulus.ids));for(f=e.length-1;0<=f;f--){var h=
e[f].params.id;for(c=g.length-1;0<=c;c--){var k=g[c];if(h===k){1E-6===e[f].pub.radius&&(e[f].pub.radius=0);a.radii.push(e[f].pub.radius);g.splice(c,1);break}}if(!g.length)break}a.radii.sort(function(a,b){return a-b})}this.changeShapes(b,this.editAnnulus.annulus,a);this.removeShapes(b,this.editAnnulus.ids);delete this.editAnnulus}};b.Fabric.updateChildren=function(c,a,d){var e,f,g={};if("regions"===c.layerName)if("objects"===d){a=c.canvas.getObjects().reverse();c=a.length;do{for(d=0;c--;){var h=a[c];
"group"!==h.type||h.params||(a.splice.apply(a,[c,1].concat($jscomp.arrayFromIterable(h.getObjects()))),d++)}c=a.length}while(d);a.forEach(function(a){a.params&&(a.params.parent||a.params.children.length)&&(g[a.params.id]=a)});a.forEach(function(a){if(a.params)for(a.params.parent&&(a.params.parent.obj=g[a.params.parent.id]),e=0;e<a.params.children.length;e++)a.params.children[e].obj=g[a.params.children[e].id]})}else if(a&&a.params)if("deltas"===d)a.params.parent&&(h=a.params.parent,c=h.obj.left-a.left,
a=h.obj.top-a.top,c!==h.dleft||a!==h.dtop?(h.dleft=c,h.dtop=a,h.moved=!0):delete h.moved);else for(e=0;e<a.params.children.length;e++){var k=a.params.children[e].obj;h=k.params.parent;switch(d){case "moving":k.left=a.left-h.dleft;k.top=a.top-h.dtop;break;case "rotating":for(f=a.angle;0>f;)f+=360;for(;360<=f;)f-=360;var m=f-h.lastangle;var l=b.rotatePoint({x:k.left,y:k.top},m,{x:a.left,y:a.top});k.left=l.x;k.top=l.y;h.dleft=a.left-k.left;h.dtop=a.top-k.top;for(k.angle+=m;0>k.angle;)k.angle+=360;for(;360<=
k.angle;)k.angle-=360;h.lastangle=f;break;case "scaling":h.dleft*=a.scaleX/h.lastscalex,h.dtop=a.scaleY/h.lastscaley*(h.dtop-h.textheight)+h.textheight,h.lastscalex=a.scaleX,h.lastscaley=a.scaleY,h.moved=!0,k.left=a.left-h.dleft,k.top=a.top-h.dtop}k.setCoords();c.display.image&&c.display.image.updateShapes(c.layerName,k,"updatechild")}};b.resetPolygonCenter=function(c){var a={};var d=c._calcDimensions();var e=(d.left+d.width/2)*c.scaleX;d=(d.top+d.height/2)*c.scaleY;c.angle?a=b.rotatePoint({x:c.left+
e,y:c.top+d},c.angle,{x:c.left,y:c.top}):(a.x=c.left+e,a.y=c.top+d);e/=c.scaleX;var f=d/c.scaleY;for(d=0;d<c.points.length;d++)c.points[d].x-=e,c.points[d].y-=f;c.left=a.x;c.top=a.y;a=c._calcDimensions();c.width=a.width;c.height=a.height;c.pathOffset={x:a.left+c.width/2,y:a.top+c.height/2};c.setCoords()};b.Fabric.saveSelection=function(b){if(b=this.getShapeLayer(b)){var a=b.canvas.getActiveObjects();1===a.length&&((a=a[0],a.params)?!1!==a.params.changeable&&(b.savesel=a.params.id):"group"===a.type&&
(a=this.lookupGroup(a))&&(b.savesel=a))}};b.Fabric.restoreSelection=function(c){var a;if((a=this.getShapeLayer(c))&&a.savesel){var d=a.canvas;var e=a.savesel;var f=d.getObjects();var g=f.length;for(d=0;d<g;d++){var h=f[d];if(h.params&&h.params.id===e){var k=h.params.id;break}else if("group"===h.type&&this.lookupGroup(h)===e){k=e;break}}k&&(b.globalOpts.skipSelectionProcessing=!0,this.selectShapes(c,k,{saveselection:!1}),delete b.globalOpts.skipSelectionProcessing,this.updateShapes(c,k,"restore"));
delete a.savesel}};b.Fabric.print=function(c){var a,d="",e=0,f=sprintf("width=%s,height=%s,menubar=1,toolbar=1,status=0,scrollbars=1,resizable=1",this.display.canvasjq.attr("width"),this.display.canvasjq.attr("height"));c=c||{};if("string"===typeof c)try{c=JSON.parse(c)}catch(m){b.error("can't parse print opts: "+c,m)}var g=this.display.canvas.toDataURL("image/png");var h="<html><body style='padding: 0px; margin: 0px' onload='window.print(); return false'>";var k=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",
0,e);h+=k+"<img src='"+g+"'></div>";g=$jscomp.makeIterator(Object.keys(this.layers));for(a=g.next();!a.done;a=g.next())a=a.value,a=this.layers[a],"main"===a.dlayer.dtype&&a.show&&(h+=""+k+a.dlayer.canvas.toSVG()+"</div>");(void 0===c.colorbar||c.colorbar)&&(c=this.display.pluginInstances.JS9Colorbar)&&c.isActive()&&(e+=2,g=c.colorbarjq[0].toDataURL("image/png"),e+=this.display.height,k=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,e),h+=k+"<img src='"+g+"'></div>",c.textjq&&c.textjq[0]&&
(g=c.textjq[0].toDataURL("image/png"),e+=c.colorbarjq.height()+1,k=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,e),h+=k+"<img style='width:"+this.display.width+"px;'src='"+g+"'></div>"));h+="</body></html>";window.electron&&(d="data:text/html,"+h);(k=window.open(d,this.id,f))?k.document?(k.document.open(),k.document.write(h),k.document.close()):b.error("no method available for drawing image into print window"):b.error("could not create print window (check your pop-up blockers)")};
b.Fabric.initGraphics=function(){b.Display.prototype.newShapeLayer=b.Fabric.newShapeLayer;b.Image.prototype._selectShapes=b.Fabric._selectShapes;b.Image.prototype._updateShape=b.Fabric._updateShape;b.Image.prototype._parseShapes=b.Fabric._parseShapes;b.Image.prototype._parseShapeOptions=b.Fabric._parseShapeOptions;b.Image.prototype._exportShapeOptions=b.Fabric._exportShapeOptions;b.Image.prototype._handleChildText=b.Fabric._handleChildText;b.Image.prototype._addPolygonPoint=b.Fabric._addPolygonPoint;
b.Image.prototype._removePolygonPoint=b.Fabric._removePolygonPoint;b.Image.prototype._ungroupAnnulus=b.Fabric._ungroupAnnulus;b.Image.prototype._regroupAnnulus=b.Fabric._regroupAnnulus;b.Image.prototype._updateMultiDialogs=b.Fabric._updateMultiDialogs;b.Image.prototype.addShapes=b.Fabric.addShapes;b.Image.prototype.updateShapes=b.Fabric.updateShapes;b.Image.prototype.getShapes=b.Fabric.getShapes;b.Image.prototype.changeShapes=b.Fabric.changeShapes;b.Image.prototype.removeShapes=b.Fabric.removeShapes;
b.Image.prototype.refreshShapes=b.Fabric.refreshShapes;b.Image.prototype.copyShapes=b.Fabric.copyShapes;b.Image.prototype.selectShapes=b.Fabric.selectShapes;b.Image.prototype.unselectShapes=b.Fabric.unselectShapes;b.Image.prototype.groupShapes=b.Fabric.groupShapes;b.Image.prototype.ungroupShapes=b.Fabric.ungroupShapes;b.Image.prototype.listGroups=b.Fabric.listGroups;b.Image.prototype.lookupGroup=b.Fabric.lookupGroup;b.Image.prototype.saveSelection=b.Fabric.saveSelection;b.Image.prototype.restoreSelection=
b.Fabric.restoreSelection;b.Image.prototype.getShapeLayer=b.Fabric.getShapeLayer;b.Image.prototype.showShapeLayer=b.Fabric.showShapeLayer;b.Image.prototype.activeShapeLayer=b.Fabric.activeShapeLayer;b.Image.prototype.displayShapeLayers=b.Fabric.displayShapeLayers;b.Image.prototype.toggleShapeLayers=b.Fabric.toggleShapeLayers;b.Image.prototype.print=b.Fabric.print};b.Fabric.initGraphics();b.MouseTouch={};b.MouseTouch.CLASS="JS9";b.MouseTouch.NAME="MouseTouch";b.MouseTouch.WIDTH=512;b.MouseTouch.HEIGHT=
220;b.MouseTouch.BASE=b.MouseTouch.CLASS+b.MouseTouch.NAME;b.MouseTouch.mouseText=[];b.MouseTouch.mouseText[0]="Move mouse, no buttons pressed:";b.MouseTouch.mouseText[1]="Move mouse, primary button pressed:";b.MouseTouch.mouseText[2]="Move mouse, secondary button pressed:";b.MouseTouch.touchText=[];b.MouseTouch.touchText[0]="Touch move, with one finger:";b.MouseTouch.touchText[1]="Touch move, with two fingers:";b.MouseTouch.touchText[2]="Touch move, with three fingers:";b.MouseTouch.textHTML="<div style='float: left'>%s</div>";
b.MouseTouch.actionHTML="<div style='float: left'><b>%s</b></div>";b.MouseTouch.actionid=function(b,a){return(b+"_"+a).replace(/[^A-Za-z0-9_]/g,"_")};b.MouseTouch.addText=function(c,a){a=sprintf(b.MouseTouch.textHTML,a);return $("<div>").addClass(b.MouseTouch.BASE+"Text").html(a).appendTo(c)};b.MouseTouch.addAction=function(c,a,d){a=b.MouseTouch.actionid(a,d);d=sprintf(b.MouseTouch.actionHTML,d);return $("<div>").addClass(b.MouseTouch.BASE+"Action").attr("id",a).html(d).appendTo(c)};b.MouseTouch.isPinch=
function(c,a){var d,e,f=b.globalOpts.pinchWait,g=b.globalOpts.pinchThresh;if(!c)return-1;a=c.display;if(!b.globalOpts.mousetouchZoom||2!==c.pos.touches.length)return-1;switch(a.ispinch){case -1:case 1:return a.ispinch}c=Math.sqrt((c.pos.touches[0].x-c.pos.touches[1].x)*(c.pos.touches[0].x-c.pos.touches[1].x)+(c.pos.touches[0].y-c.pos.touches[1].y)*(c.pos.touches[0].y-c.pos.touches[1].y));a.dist0||(a.dist0=c);a.deltas.push(Math.floor(c-a.dist0));if(a.deltas.length>=f){c=1;for(e=d=0;c<f;c++)a.deltas[c]>
a.deltas[c-1]?d++:a.deltas[c]<a.deltas[c-1]&&e++;a.ispinch=d>=g||e>=g?1:-1;a.lastzoom=0;return a.ispinch}return 0};b.MouseTouch.Actions={};b.MouseTouch.Actions["display value/position"]=function(c,a,d){!b.specialKey(d)&&b.globalOpts.internalValPos&&c&&a&&0<a.x&&0<a.y&&a.x<=c.raw.width&&a.y<=c.raw.height&&(c.valpos=c.updateValpos(a,!0))};b.MouseTouch.Actions["change contrast/bias"]=function(c,a,d){if(b.globalOpts.internalContrastBias&&c&&a&&"static"!==c.cmapObj.type&&(a=c.display,!(c.pos0&&c.pos&&
Math.abs(c.pos0.x-c.pos.x)<b.NOMOVE&&Math.abs(c.pos0.y-c.pos.y)<b.NOMOVE||c.clickInRegion||b.specialKey(d)||c.useOffScreenCanvas()))){var e=b.eventToDisplayPos(d,c.posOffset);d=Math.floor(e.x+.5);e=Math.floor(e.y+.5);b.globalOpts.containContrastBias&&(0>d||0>e||d>=a.canvas.width||e>=a.canvas.height)||(c.params.bias=d/a.canvas.width,c.params.contrast=e/a.canvas.height*10,b.bugs.firefox_linux?window.setTimeout(function(){c.displayImage("scaled",{blendMode:!1})},0):c.displayImage("scaled",{blendMode:!1}),
c.xeqStashDiscard("filterRGBImage"),b.globalOpts.extendedPlugins&&c.xeqPlugins("image","onchangecontrastbias"))}};b.MouseTouch.Actions["change contrast/bias"].stop=function(b,a,d){b.display.blendMode&&b.displayImage("rgb")};b.MouseTouch.Actions["wheel zoom"]=function(c,a){var d=b.globalOpts.panzoomRefreshLimit,e=0;a=a.originalEvent.deltaY*Math.sign(b.DIRZOOM);if(c&&b.globalOpts.mousetouchZoom&&(c.tmp.wheelzooms=c.tmp.wheelzooms||0,0===c.tmp.wheelzooms++%b.MODZOOM)){var f=c.getZoom();a=0>a?Math.min(b.MAXZOOM,
f+b.ADDZOOM):Math.max(b.MINZOOM,f-b.ADDZOOM);if(b.globalOpts.mousetouchLimit){var g=Math.min(c.display.width/c.raw.width,c.display.height/c.raw.height);if(g>a&&f>a)return}a=Math.round(100*(a+1E-5))/100;f=$jscomp.makeIterator(Object.keys(c.layers));for(g=f.next();!g.done;g=f.next())g=g.value,c.layers[g].show&&c.layers[g].opts.panzoom&&c.layers[g].canvas.size()>d&&(c.tmp.panzoomRefresh=c.tmp.panzoomRefresh||{},c.tmp.panzoomRefresh[g]={},e++);c.tmp.panzoomTimeout&&(clearTimeout(c.tmp.panzoomTimeout),
delete c.tmp.panzoomTimeout);if(e||c.tmp.panzoomRefresh)c.tmp.panzoomTimeout=setTimeout(function(){c.refreshLayers(c.tmp.panzoomRefresh);delete c.tmp.panzoomRefresh},b.TIMEOUT);c.setZoom(a)}};b.MouseTouch.Actions["pan the image"]=function(c,a,d){var e=b.globalOpts.panMouseThreshold;a=b.globalOpts.panzoomRefreshLimit;if(c){d=c.rgb.sect;var f=(c.pos0.x-c.pos.x)/d.zoom;var g=(c.pos0.y-c.pos.y)/d.zoom;if(Math.abs(f)>=e||Math.abs(g)>=e){"x"===c.params.flip?f=-f:"y"===c.params.flip?g=-g:"xy"===c.params.flip&&
(f=-f,g=-g);90===c.params.rot90?(e=f,f=-g,g=e):180===c.params.rot90?(f=-f,g=-g):-90===c.params.rot90&&(e=f,f=g,g=-e);f={x:d.xcen+f,y:d.ycen-g};c.params.rotate&&(f=b.rotatePoint(f,-c.params.rotate,{x:d.xcen,y:d.ycen}));d=$jscomp.makeIterator(Object.keys(c.layers));for(g=d.next();!g.done;g=d.next())g=g.value,c.layers[g].show&&c.layers[g].opts.panzoom&&c.layers[g].canvas.size()>a&&(c.tmp.panzoomRefresh=c.tmp.panzoomRefresh||{},c.tmp.panzoomRefresh[g]={});c.setPan(f);c.pos0=c.pos}}};b.MouseTouch.Actions.pinch=
function(c,a,d){c&&(a=c.display,d=a.zoom0*Math.sqrt((c.pos.touches[0].x-c.pos.touches[1].x)*(c.pos.touches[0].x-c.pos.touches[1].x)+(c.pos.touches[0].y-c.pos.touches[1].y)*(c.pos.touches[0].y-c.pos.touches[1].y))/a.dist0,d=Math.max(b.MINZOOM,Math.min(b.MAXZOOM,Math.round(100*(d+1E-5))/100)),d!==a.lastzoom&&c.setZoom(d),a.lastzoom=d)};b.MouseTouch.Actions.start=function(c,a,d){c&&(a=c.display,a.ispinch=0,a.dist0=0,a.zoom0=c.rgb.sect.zoom,a.deltas=[]);a=b.MouseTouch.getAction(c,d);b.MouseTouch.Actions[a]&&
b.MouseTouch.Actions[a].start&&b.MouseTouch.Actions[a].start(c,c.ipos,d)};b.MouseTouch.Actions.stop=function(c,a,d){a=b.MouseTouch.getAction(c,d);b.MouseTouch.Actions[a]&&b.MouseTouch.Actions[a].stop&&b.MouseTouch.Actions[a].stop(c,c.ipos,d)};b.MouseTouch.getAction=function(c,a){if(!c)return e;var d=c.display;switch(c.clickState){case 0:var e=d.mouseActions[0];break;case 1:e=d.mouseActions[1];break;case 2:e=d.mouseActions[2];break;case -1:e=d.touchActions[0];break;case -2:switch(b.MouseTouch.isPinch(c,
a)){case -1:e=d.touchActions[1];break;case 1:e="pinch"}break;case -3:e=d.touchActions[2]}return e};b.MouseTouch.action=function(c,a,d){if((d=d||b.MouseTouch.getAction(c,a))&&b.MouseTouch.Actions[d])b.MouseTouch.Actions[d](c,c.ipos,a)};b.MouseTouch.mousetouchzoom=function(c,a){c=b.lookupDisplay(c);a=a.checked;c&&(b.globalOpts.mousetouchZoom=a)};b.MouseTouch.init=function(){var c=this,a;this.divjq.html("");this.divjq.addClass("JS9PluginScrolling");this.mousetouchContainer=$("<div>").addClass(b.MouseTouch.BASE+
"Container").attr("id",this.id+"MouseTouchContainer").appendTo(this.divjq);var d=sprintf("<div class='%s'><span><b>Drag an action to reconfigure JS9 mouse/touch events:</b></span><p>",b.MouseTouch.BASE+"Header");this.mousetouchHeadContainer=$("<span style='float: left'>").addClass(b.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchHeadContainer").html(d).appendTo(this.mousetouchContainer);this.mousetouchTextContainer=$("<span style='float: left'>").addClass(b.MouseTouch.BASE+"Container").attr("id",
this.id+"MouseTouchTextContainer").appendTo(this.mousetouchContainer);this.mousetouchActionContainer=$("<span style='float: left'>").addClass(b.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchActionContainer").appendTo(this.mousetouchContainer);if(b.TOUCHSUPPORTED){this.mousetouchTouchTextContainer=$("<div>").addClass(b.MouseTouch.BASE+"TextContainer").attr("id",this.id+"TouchTextContainer").html("").appendTo(this.mousetouchTextContainer);for(a=0;a<b.MouseTouch.touchText.length;a++)b.MouseTouch.addText.call(this,
this.mousetouchTouchTextContainer,b.MouseTouch.touchText[a]);for(a=b.MouseTouch.touchText.length;a<this.display.touchActions.length;a++)b.MouseTouch.addText.call(this,this.mousetouchMouseTextContainer,"&nbsp;");this.mousetouchTouchContainer=$("<div>").addClass(b.MouseTouch.BASE+"ActionContainer").attr("id",this.id+"TouchContainer").html("").appendTo(this.mousetouchActionContainer);for(a=0;a<this.display.touchActions.length;a++)d=this.display.touchActions[a],b.MouseTouch.addAction.call(this,this.mousetouchTouchContainer,
"touch",d);this.mousetouchTouchContainer.sortable({start:function(a,b){c.oidx=b.item.index()},stop:function(a,b){a=b.item.index();b=c.display.touchActions.splice(c.oidx,1)[0];c.display.touchActions.splice(a,0,b);delete c.oidx}})}if(!/iPad|iPhone|iPod/.test(navigator.platform)){this.mousetouchMouseTextContainer=$("<div>").addClass(b.MouseTouch.BASE+"TextContainer").attr("id",this.id+"MouseTextContainer").appendTo(this.mousetouchTextContainer);for(a=0;3>a;a++)b.MouseTouch.addText.call(this,this.mousetouchMouseTextContainer,
b.MouseTouch.mouseText[a]);for(a=3;a<this.display.mouseActions.length;a++)b.MouseTouch.addText.call(this,this.mousetouchMouseTextContainer,"&nbsp;");this.mousetouchMouseContainer=$("<div>").addClass(b.MouseTouch.BASE+"ActionContainer").attr("id",this.id+"MouseContainer").html("").appendTo(this.mousetouchActionContainer);for(a=0;a<this.display.mouseActions.length;a++)d=this.display.mouseActions[a],b.MouseTouch.addAction.call(this,this.mousetouchMouseContainer,"mouse",d);this.mousetouchMouseContainer.sortable({start:function(a,
b){c.oidx=b.item.index()},stop:function(a,b){a=b.item.index();b=c.display.mouseActions.splice(c.oidx,1)[0];c.display.mouseActions.splice(a,0,b);delete c.oidx}})}d=sprintf("<p><div class='%s'>Use mouse wheel or pinch to zoom:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type='checkbox' value='1' onclick='javascript:JS9.MouseTouch.mousetouchzoom(\"%s\", this);'></div>",b.MouseTouch.BASE+"Footer",this.display.id);this.mousetouchFootContainer=$("<span style='float: left'>").addClass(b.MouseTouch.BASE+
"Container").attr("id",this.id+"MouseTouchFootContainer").html(d).appendTo(this.mousetouchContainer);b.globalOpts.mousetouchZoom&&this.mousetouchContainer.find("input").attr("checked",!0)};b.Regions={};b.Regions.CLASS="JS9";b.Regions.NAME="Regions";b.Regions.opts={updateWCS:!0,panzoom:!0,tags:"source,include",strokeWidth:2,iradius:15,oradius:30,nannuli:1,width:60,height:60,radius:30,r1:30,r2:20,ptshape:"box",ptsize:2,linepoints:[{x:-30,y:30},{x:30,y:-30}],polypoints:[{x:-30,y:30},{x:30,y:30},{x:0,
y:-30}],fontFamily:"Helvetica",fontSize:14,fontStyle:"normal",fontWeight:300,textAlign:"left",angle:0,aradius1:4,aradius2:8,configURL:"./params/regionsconfig.html",saveURL:"./params/regionssave.html",sortOverlapping:!0,title:"Edit region",noCenteredScaling:["box","line"],tagcolors:{include_source:"#00FF00",exclude_source:"#FF0000",include_background:"#FFD700",exclude_background:"#FF8C00",source:"#00FF00",background:"#FFD700",defcolor:"#00FF00"},onmousedblclick:function(c,a,d,e){((a=e.params)&&!a.winid&&
!a.ignore||!a&&"activeSelection"===e.type||!a&&"group"===e.type)&&b.globalOpts.editRegions&&c.displayRegionsForm(e)},onmousedown:function(c,a,d,e){a=e.params;b.specialKey(d)&&(a&&c._regroupAnnulus(a.layerName,d),"polygon"===e.type||"polyline"===e.type?(c._addPolygonPoint(a.layerName,e,d),c._updateShape(a.layerName,e,null,"update")):e.polyparams&&e.polyparams.polygon?(d=e.polyparams.polygon,c._removePolygonPoint(d.params.layerName,e),c._updateShape(d.params.layerName,d,null,"update")):a&&"annulus"===
a.shape&&c._ungroupAnnulus(a.layerName,e))},onmouseup:function(){var b,a=[];this.getActiveObject()&&a.push(this.getActiveObject());a.push(this.getActiveObjects());for(b=0;b<a.length;b++)a[b].polyparams&&this.setActiveObject(a[b].polyparams.polygon)},onchange:null};b.Regions.init=function(c){b.Image.prototype.parseRegions=b.Regions.parseRegions;b.Image.prototype.saveRegions=b.Regions.saveRegions;b.Image.prototype.listRegions=b.Regions.listRegions;b.Image.prototype.copyRegions=b.Regions.copyRegions;
b.Image.prototype.changeRegionTags=b.Regions.changeRegionTags;b.Image.prototype.toggleRegionTags=b.Regions.toggleRegionTags;b.Image.prototype.unremoveRegions=b.Regions.unremoveRegions;b.Image.prototype.initRegionsForm=b.Regions.initConfigForm;b.Image.prototype.displayRegionsForm=b.Regions.displayConfigForm;b.Image.prototype.processRegionsForm=b.Regions.processConfigForm;var a=this.display.newShapeLayer(c||"regions",b.Regions.opts);a.canvas.on("mouse:up",function(){var b,c=[];if(a.display.image){var f=
a.display.image;c.push(a.canvas.getActiveObjects());for(b=0;b<c.length;b++)if(c[b].params){f.params.listonchange?"all"===f.params.whichonchange?f.listRegions("all",{mode:2}):f.listRegions("selected",{mode:2}):c[b].params.listonchange&&f.listRegions("selected",{mode:2});break}}});return this};b.Regions.displayConfigForm=function(c,a){var d=this,e=0,f=b.Regions.opts.title;if(this&&(a=a||{},c||this.getShapes("regions").length)){a.type=a.type||"config";switch(a.type){case "save":var g=b.allinone?b.allinone.regionsSaveHTML:
b.InstallDir(b.Regions.opts.saveURL);f="Save regions";var h=b.lightOpts[b.LIGHTWIN].regWin1;break;default:if(g=b.allinone?b.allinone.regionsConfigHTML:b.InstallDir(b.Regions.opts.configURL),!c||!c.params&&"activeSelection"===c.type||!c.params&&"group"===c.type)a.multi=!0}if(a.multi&&($("form[class='regionsConfigForm']").each(function(b,c){b=$(c).data("multi");var f=$(c).data("winid");c=$(c).data("im");b&&f&&c===d&&(a.winid=f,c.initRegionsForm(null,a),e++)}),f=f.replace(/regions?/,"selected regions"),
e))return;$(b.lightOpts[b.LIGHTWIN].topid).arrive(".regionsConfigForm",{onceOnly:!0},function(){a.firsttime=!0;c&&c.params&&d.updateShapes("regions",c,"wcsconfig");d.initRegionsForm(c,a)});a.winid=this.displayAnalysis("regions",g,{title:f,winformat:h});c&&c.params&&(c.params.winid=a.winid)}};b.Regions.initConfigForm=function(c,a){var d=this,e,f,g,h,k,m,l,p=!1,r=this.raw.wcsinfo||{cdelt1:1,cdelt2:1};var n={type:"multi",pub:{shape:"multi",wcsconfig:{}},params:{}};var u=function(a){if(void 0!==a)return"number"===
typeof a&&0!==a%1&&(a=Math.round(1E4*(a+1E-5))/1E4),String(a)},x=function(a){var b=String.fromCharCode(13,10);return"string"===typeof a?a.replace(/\\n/g,b):a};if(c&&c.pub)var t=c.pub.wcsconfig&&c.pub.wcsconfig.wcssys?c.pub.wcsconfig.wcssys:this.params.wcssys;else t=this.params.wcssys,c=n;var v=!1===c.params.changeable;a=a||{};if(c.params.winid)var w=c.params.winid;else a.winid&&(w=a.winid);if(w){var q="#"+$(w).attr("id")+" .regionsConfigForm ";if($(q).length){p=$(q).data("multi")?!0:a.multi;$(q+"."+
c.pub.shape).each(function(a,b){$(b).removeClass("nodisplay")});$(q+".val").each(function(a,l){g="";f=$(l).attr("name");switch(f){case "x":case "y":c.pub.lcs&&void 0!==c.pub.lcs[f]?g=u(c.pub.lcs[f]):void 0!==c.pub[f]&&(g=u(c.pub[f]));break;case "radii":c.pub.radii&&(g=!b.notWCS(t)&&c.pub.wcsconfig&&c.pub.wcsconfig.wcsstr?c.pub.wcsconfig.wcsstr.replace(/^annulus\(/,"").replace(/\)$/,"").split(",").slice(2).join(","):c.pub.imstr.replace(/^annulus\(/,"").replace(/\)$/,"").split(",").slice(2).join(","));
break;case "pts":c.pub.pts?c.pub.pts.forEach(function(a){g&&(g+=", ");g+=a.x.toFixed(2)+", "+a.y.toFixed(2)}):c.pub.imstr&&(g=c.pub.imstr.replace(/^.*\(/,"").replace(/\)$/,""));break;case "linelength":if(c.pub.pts&&2===c.pub.pts.length){k=c.pub.pts[0];m=c.pub.pts[1];g=u(Math.sqrt((m.x-k.x)*(m.x-k.x)+(m.y-k.y)*(m.y-k.y)));switch(t){case "image":case "physical":break;default:g*=Math.abs(r.cdelt1),g*=Math.abs(r.cdelt2)}g=u(g);d.tmp.linelength=g}break;case "lineangle":if(c.pub.pts&&2===c.pub.pts.length){k=
c.pub.pts[0];m=c.pub.pts[1];for(g=180*Math.atan2(m.y-k.y,m.x-k.x)/Math.PI;0>g;)g+=360;g=u(g);d.tmp.lineangle=g}break;case "fontFamily":c.getFontFamily&&(g=c.getFontFamily());break;case "fontSize":c.getFontSize&&(g=c.getFontSize());break;case "fontStyle":c.getFontStyle&&(g=c.getFontStyle());break;case "fontWeight":c.getFontWeight&&(g=c.getFontWeight());break;case "colorPicker":g=void 0!==c.pub.color?b.colorToHex(c.pub.color):$(q).data("colorpicker")||b.globalOpts.defcolor;break;case "color":p||(void 0!==
c.pub.color?g=u(c.pub.color):$(q).data("colorpicker")&&(g=$(q).data("colorpicker")));break;case "strokeWidth":g=c.params.sw1?c.params.sw1:$(q).data("strokewidth")||"";break;case "strokeDashes":c.strokeDashArray?(g=c.strokeDashArray.join(" "),g.match(/NaN/)&&(g="")):g=$(q).data("strokedashes")||"";break;case "regstr":g=!b.notWCS(t)&&c.pub.wcsconfig&&c.pub.wcsconfig.wcsstr?c.pub.wcsconfig.wcssys+";"+c.pub.wcsconfig.wcsstr:c.pub.imsys+";"+c.pub.imstr;break;case "xpos":switch(t){case "image":c.pub.preservedcoords&&
void 0!==c.pub.dx?g=sprintf("d%.1f",c.pub.dx):void 0!==c.pub.x&&(g=sprintf("%.1f",c.pub.x));break;case "physical":c.pub.lcs?g=sprintf("%.1f",c.pub.lcs.x):void 0!==c.pub.x&&(g=sprintf("%.1f",c.pub.x));break;default:c.pub.wcsconfig&&b.notNull(c.pub.wcsconfig.ra)?g=sprintf("%.6f",c.pub.wcsconfig.ra):void 0!==c.pub.x&&(g=sprintf("%.1f",c.pub.x))}$(q+"[name='"+f+"']").prop("readonly",v);break;case "ypos":switch(t){case "image":c.pub.preservedcoords&&void 0!==c.pub.dy?g=sprintf("d%.1f",c.pub.dy):void 0!==
c.pub.y&&(g=sprintf("%.1f",c.pub.y));break;case "physical":c.pub.lcs?g=sprintf("%.1f",c.pub.lcs.y):void 0!==c.pub.y&&(g=sprintf("%.1f",c.pub.y));break;default:c.pub.wcsconfig&&b.notNull(c.pub.wcsconfig.dec)?g=sprintf("%.6f",c.pub.wcsconfig.dec):void 0!==c.pub.y&&(g=sprintf("%.1f",c.pub.y))}$(q+"[name='"+f+"']").prop("readonly",v);break;case "radius":case "oradius":case "length":case "width":case "r1":switch(t){case "image":void 0!==c.pub[f]&&(g=u(c.pub[f]));break;case "physical":c.pub.lcs&&void 0!==
c.pub.lcs[f]&&(g=u(c.pub.lcs[f]));break;default:c.pub.wcsconfig&&b.notNull(c.pub.wcsconfig.wcssizestr)?g=u(c.pub.wcsconfig.wcssizestr[0]):void 0!==c.pub[f]&&(g=u(c.pub[f]))}$(q+"[name='"+f+"']").prop("readonly",v);break;case "height":case "r2":switch(t){case "image":void 0!==c.pub[f]&&(g=u(c.pub[f]));break;case "physical":c.pub.lcs&&void 0!==c.pub.lcs[f]&&(g=u(c.pub.lcs[f]));break;default:c.pub.wcsconfig&&b.notNull(c.pub.wcsconfig.wcssizestr)?g=u(c.pub.wcsconfig.wcssizestr[1]):void 0!==c.pub[f]&&
(g=u(c.pub[f]))}$(q+"[name='"+f+"']").prop("readonly",v);break;case "wcssys":case "savewcs":z=$(q).find("[name='"+f+"']");if(!z.find("option").length)for(e=0;e<b.wcssyss.length;e++)z.append("<option>"+b.wcssyss[e]+"</option>");h="savewcs"===f?b.globalOpts.regSaveWCS||t:t;z.find("option").each(function(a,b){h===b.value&&(g=b.value)});break;case "wcsunits":c.pub.wcsunits&&(g=c.pub.wcsunits);break;case "childtext":c.params.children&&0<c.params.children.length&&(g=x(c.params.children[0].obj.text));break;
case "text":void 0!==c.pub[f]&&(g=x(u(c.pub[f])));break;case "id":p?g="selected":void 0!==c.pub.id&&(g=String(c.pub.id),$(l).css("width",g.length+"ch"));break;case "tags":void 0!==c.pub[f]&&(g=u(c.pub[f]));break;case "savefile":g=$(q).data("savefile")||d.tmp.saveregionsFile||"js9.reg";window.electron&&!g.match(/.*\//)&&(g=window.electron.currentDir+"/"+g);break;case "selectfilter":g=$(q).data("selectfilter");break;case "selectshape":case "selectcolor":case "selecttag":case "selectwcs":case "selectgroup":b.Regions.regionsConfigSetSelectMenu(d,
$(q),f);break;default:void 0!==c.pub[f]&&(g=u(c.pub[f]))}$(l).val(g)});(p||!this.raw.wcs||0>this.raw.wcs)&&$(q).find("[name='wcssys']").hide();"text"!==c.type&&c.params.children&&$(q+".childtext").removeClass("nodisplay");if(a.firsttime){window.electron&&$(q).find(".rsavebrowse, .rconfigbrowse").removeClass("nodisplay");p?($(q).find("label[for='savecur']").text("sel"),$(q).find("input[id='savecur']").data("tooltip","save selected regions"),$(q).find("[id='selectreg']").prop("checked",!0)):$(q).find(".checkboxes").removeClass("nodisplay");
if(b.favorites.wcs&&b.favorites.wcs.length){var z=$(q).find(".rwcsbuttons").removeClass("nodisplay");var y=z.find(".rwcsbuttoncontainer");if(y.length&&!y.find(".rwcsbutton").length){for(e=0;e<b.favorites.wcs.length;e++){n=b.favorites.wcs[e];var A="string"===typeof n?n.split(":"):n;n=A[0];A=A[1]||n;if("save"===a.type){var C="rsavecol_R"+(e+2);var B="rsaveradio"}else C="rconfigcol_R"+(e+2),B="rconfigradio";y.append("<span class='rconfigcol_R rwcsbutton "+C+"'>\n                                <input type='radio'\n                                       id='rwcsbutton_"+
n+"'\n                                       name='rwcsbutton'\n                                       class='rwcsradio "+B+"}'\n                                       value='"+n+"'\n                                       data-tooltip='save using "+n+' wcs\'\n                                       onclick=\'\n                                           $(this).closest("form")\n                                           .find("[name=savewcs]")\n                                           .val("'+n+'")\n                                           .trigger("change");\'>\n                                <label for=\'rwcsbutton_'+
n+"'>"+A+"</label>\n                                </span>")}$(q).find(".rwcsbuttons").find("[value='"+t+"']").prop("checked",!0)}}b.globalOpts.internalColorPicker&&$.fn.spectrum.inputTypeColorSupport()||(z=$(q).find("input[name='colorPicker']"),z.spectrum({showButtons:!1,showInput:!1,preferredFormat:"hex6"}),z.on("move.spectrum",function(a,b){a=b.toHexString();$(q).find("input[name='color']").val(a);$(q).data("colorpicker",a)}))}void 0===c.params.listonchange&&(c.params.listonchange=!1);c.params.listonchange?
$(q+"[name='listonchange']").prop("checked",!0):$(q+"[name='listonchange']").prop("checked",!1);!1!==c.params.changeable?$(q+"[name='locked']").prop("checked",!1):$(q+"[name='locked']").prop("checked",!0);c.params.sticky?$(q+"[name='sticky']").prop("checked",!0):$(q+"[name='sticky']").prop("checked",!1);$(q+"[id='includejson']").prop("checked",b.globalOpts.regIncludeJSON);$(q+"[id='includecomments']").prop("checked",b.globalOpts.regIncludeComments);$(q+"[id='savedcoords']").prop("checked",b.globalOpts.regSaveDCoords);
$(q+"[id='includewcs']").prop("checked",b.globalOpts.csvIncludeWCS);$(q).find("input[name='saveformat']").prop("checked",!1);$(q).find("input[value='"+b.globalOpts.regSaveFormat+"']").prop("checked",!0);$(q).find("input[name='rwcsbutton']").prop("checked",!1);$(q).find("input[value='"+(b.globalOpts.regSaveWCS||t)+"']").prop("checked",!0);n="save"===a.type?"save"+b.globalOpts.regSaveWhich1:"save"+b.globalOpts.regSaveWhich2;$(q+"[id='"+n+"']").prop("checked",!0);"save"===a.type&&$(q).find("input[name='savefile']").trigger("change");
$(q).find("input[name='strokeMenu']").prop("selectedIndex",0);$(q).find("input[name='dashesMenu']").prop("selectedIndex",0);if(p)if($(q).find(".regid").hide(),$(q).find(".edit").hide(),$(q).find(".childtext").hide(),$(q).find(".multi").removeClass("nodisplay"),0>=a.setmode)$(q).find("[name='multitext']").val(""),$(q).find('input[name="color"]').val(""),$(q).find('input[name="strokeWidth"]').val(""),$(q).find('input[name="strokeDashes"]').val(""),$(q).data("strokewidth",""),$(q).data("strokedashes",
""),0>a.setmode&&($(q).find("[name='selectfilter']").val(""),$(q).data("selectfilter",""));else if((y=this.layers.regions.canvas.getActiveObject())&&"group"===y.type&&!y.params){if((n=y.getObjects())&&n.length&&n[0]&&n[0].params)var D=n[0].params.groupid;D?($(q).find("[name='selectfilter']").val(D),$(q).data("selectfilter",D),n=this.listGroups(D),A=n.substring(n.indexOf("\n")+1),$(q).find("[name='multitext']").val(A)):$(q).find("[name='multitext']").val("")}else if(y){y=this.layers.regions.canvas.getActiveObjects();
e=0;n=[];for(A="";e<y.length;e++)D=y[e],"group"!==D.type||D.params?n.push(D):A+=this.lookupGroup(D)+"\n";C=this.listRegions(n,{mode:1,includejson:!1,includecomments:!1}).replace(/ *; */g,"\n");if(A+=C.substring(C.indexOf("\n")+1))B="selected",$(q).find("[name='selectfilter']").val(B),$(q).data("selectfilter",B),$(q).find("[name='multitext']").val(A)}else{if(n=$(q).find("[name='selectfilter']").val()||"selected",A=this.listRegions(n,{mode:1,includejson:!1,includecomments:!1}).replace(/ *; */g,"\n"))$(q).find("[name='selectfilter']").val(n),
$(q).data("selectfilter",n),$(q).find("[name='multitext']").val(A)}else switch($(q).find("input:text[readonly]").css("border-color","#A5A5A5").css("background","#E9E9E9"),$(q).find("input:text:not([readonly])").css("border-color","#E9E9E9").css("background","white"),c.pub.shape){case "box":case "cross":case "ellipse":$(q+".angle").removeClass("nodisplay");break;case "text":$(q+".textangle").removeClass("nodisplay");break;case "line":c.pub.pts&&2===c.pub.pts.length?($(q+".linelength").removeClass("nodisplay"),
$(q+".lineangle").removeClass("nodisplay")):($(q+".linelength").addClass("nodisplay"),$(q+".lineangle").addClass("nodisplay"))}$(q+".xtrareg").addClass("nodisplay");$(q+".xtracsv").addClass("nodisplay");$(q+".xtrasvg").addClass("nodisplay");$(q+".xtra"+b.globalOpts.regSaveFormat).removeClass("nodisplay");$(q).data("im",this);$(q).data("shape",c);$(q).data("winid",w);$(q).data("multi",p);b.BROWSER[3]?(w="touchstart",D="touchend"):(w="mouseover",D="mouseout");if("save"===a.type)$(q).on(w,function(){$(q).find("input[name='savefile']").focus()});
$(q).data("tooltipInit")||($(q).data("tooltipInit",!0),$(".rconfigcol_R, .rsavecol_R").on(w,function(a){var c=a.currentTarget;a=$(c).find("input, textarea, span").data("tooltip");c=$(c).closest(b.lightOpts[b.LIGHTWIN].top).find(b.lightOpts[b.LIGHTWIN].dragBar);a&&c.length&&(l=$(c)[0].childNodes[0].nodeValue.replace(/:.*/,""),$(c)[0].childNodes[0].nodeValue=l+": "+a)}),$(".rconfigcol_R, .rsavecol_R").on(D,function(a){a=$(a.currentTarget).closest(b.lightOpts[b.LIGHTWIN].top).find(b.lightOpts[b.LIGHTWIN].dragBar);
a.length&&(l=$(a)[0].childNodes[0].nodeValue.replace(/:.*/,""),$(a)[0].childNodes[0].nodeValue=l)}))}}};b.Regions.processConfigForm=function(c,a,d){var e,f=1;var g={type:"multi",pub:{shape:"multi"},params:{}};var h=d.length,k={},m=this.raw.wcsinfo||{cdelt1:1,cdelt2:1},l=function(a){if(void 0!==a)return"number"===typeof a&&0!==a%1&&(a=Math.round(1E4*(a+1E-5))/1E4),String(a)},p=function(a,b){return t?!0:void 0===a?!1:l(a)!==l(b)},r=function(a,c,d){if("remove"===c)return"selected"===d;if("childtext"===
c)return a.params.children&&0<a.params.children.length?a.params.children[0].obj&&a.params.children[0].obj.params?d!==a.params.children[0].obj.params.text:!1:d!==a.params.text;if("strokeWidth"===c)return a.params&&a.params.sw1?d!==a.params.sw1:!0;if("strokeDashes"===c){if(a.strokeDashArray)return JSON.stringify(a.strokeDashArray)!==JSON.stringify(d);if($.isArray(d))switch(d.length){case 0:return!1;case 1:return""!==d[0];default:return""!==d[0]&&""!==d[1]}else return""!==d}if("tags"!==c&&""===d)return!1;
if("misc"===c&&""!==d||"radii"===c&&a.params.radii)return!0;if("angle"===c)return a.angle!==-parseFloat(d);if("ix"===c)return a.pub.preservedcoords&&"d"===d.charAt(0).toLowerCase()?p(a.pub.dx,b.saostrtod(d.substring(1))):p(a.pub.x,b.saostrtod(d));if("iy"===c)return a.pub.preservedcoords&&"d"===d.charAt(0).toLowerCase()?p(a.pub.dy,b.saostrtod(d.substring(1))):p(a.pub.y,b.saostrtod(d));if("px"===c&&a.pub.lcs)return p(a.pub.lcs.x.toFixed(1),d);if("py"===c&&a.pub.lcs)return p(a.pub.lcs.y.toFixed(1),d);
if("ra"===c)return a.pub.wcsconfig&&a.pub.wcsconfig.wcsposstr?p(b.saostrtod(a.pub.wcsconfig.wcsposstr[0]),b.saostrtod(d)):a.pub.wcsposstr?p(b.saostrtod(a.pub.wcsposstr[0]),b.saostrtod(d)):!1;if("dec"===c){if(a.pub.wcsconfig&&a.pub.wcsconfig.wcsposstr)return p(b.saostrtod(a.pub.wcsconfig.wcsposstr[1]),b.saostrtod(d));if(a.pub.wcsposstr)return p(b.saostrtod(a.pub.wcsposstr[1]),b.saostrtod(d))}return"sticky"===c?t?!1:p(a.pub.sticky||!1,d):"locked"===c?t?!1:!1!==a.params.changeable?!1===d:!0===d:"listonchange"===
c&&t?!1:a.pub.lcs&&void 0!==a.pub.lcs[c]?p(a.pub.lcs[c],d)?!0:!1:p(a.pub[c],d)||p(a.params[c],d)||p(a[c],d)?!0:!1},n=function(a){return"true"===a?!0:"false"===a?!1:b.isNumber(a)?parseFloat(a):a},u=function(a){var b=String.fromCharCode(13,10);return"string"===typeof a?a.replace(/\\n/g,b):a};this.lcs&&this.lcs.physical&&(f=Math.sqrt(Math.pow(this.lcs.physical.forward[0][0],2)+Math.pow(this.lcs.physical.forward[0][1],2)));if(a&&a.pub)var x=a.pub.wcsconfig&&a.pub.wcsconfig.wcssys?a.pub.wcsconfig.wcssys:
this.params.wcssys;else x=this.params.wcssys,a=g;var t=$(c).data("multi");g=a.pub.layer||"regions";for(e=0;e<h;e++){var v=d[e].name;var w=d[e].value;if("xpos"===v||"ypos"===v)switch(x){case "image":v="i"+v.charAt(0);break;case "physical":v="p"+v.charAt(0);break;default:v=this.validWCS()?"xpos"===v?"ra":"dec":"xpos"===v?"ix":"iy"}switch(v){case "multitext":case "colorPicker":case "savefile":case "rwcsbutton":case "savewcs":case "saveformat":case "includejson":case "includecomments":case "savewhich":case "savedcoords":break;
case "text":"text"===a.type&&r(a,v,w)&&(k[v]=u(w));break;case "selectfilter":if(w&&w!==$(c).data("selectfilter")){$(c).data("selectfilter",w);this.lookupGroup(w)?this.groupShapes(g,w):this.selectShapes(g,w);return}break;case "strokeDashes":if(""===w)k.strokeDashArray=[];else{var q=w.trim().split(/\s+/);if(t&&w||r(a,v,q))k.strokeDashArray=0===q.length?[]:q.map(function(a){return parseInt(a,10)})}break;case "strokeWidth":if(""===w)k[v]="";else if(b.isNumber(w))if(q=parseInt(w,10),0>=q)k[v]="";else if(t&&
w||!t&&r(a,v,q))k[v]=n(q);break;case "color":""===w?k[v]="":r(a,v,w)&&(k[v]=n(w));break;case "tags":t?w&&(k[v]='""'===w||"''"===w?"":n(w)):r(a,v,w)&&(k[v]=n(w));break;case "childtext":"text"!==a.type&&r(a,v,w)&&(k.text=u(w));break;case "ix":r(a,v,w)&&(a.pub.preservedcoords&&"d"===w.charAt(0).toLowerCase()?(k.dx=n(w.substring(1)),void 0===k.dy&&void 0!==a.pub.dy&&(k.dy=a.pub.dy)):(k.x=n(w),void 0===k.y&&void 0!==a.pub.y&&(k.y=a.pub.y)));break;case "iy":r(a,v,w)&&(a.pub.preservedcoords&&"d"===w.charAt(0).toLowerCase()?
(k.dy=n(w.substring(1)),void 0===k.dx&&void 0!==a.pub.dx&&(k.dx=a.pub.dx)):(k.y=n(w),void 0===k.x&&void 0!==a.pub.x&&(k.x=a.pub.x)));break;case "px":r(a,v,w)&&(k.px=n(w),void 0===k.py&&a.pub.lcs&&(k.py=a.pub.lcs.y));break;case "py":r(a,v,w)&&(k.py=n(w),void 0===k.px&&a.pub.lcs&&(k.px=a.pub.lcs.x));break;case "ra":r(a,v,w)&&(k.ra=w,void 0===k.dec&&(a.pub.wcsconfig&&a.pub.wcsconfig.wcsposstr?k.dec=a.pub.wcsconfig.wcsposstr[1]:a.pub.wcsposstr&&(k.dec=a.pub.wcsposstr[1])));break;case "dec":r(a,v,w)&&
(k.dec=w,void 0===k.ra&&(a.pub.wcsconfig&&a.pub.wcsconfig.wcsposstr?k.ra=a.pub.wcsconfig.wcsposstr[0]:a.pub.wcsposstr&&(k.ra=a.pub.wcsposstr[0])),void 0===k.wcssys&&(k.wcssys=x));break;case "wcssys":break;case "radius":case "length":case "width":case "r1":switch(x){case "image":r(a,v,w)&&(k[v]=n(w));break;case "physical":r(a,v,w)&&(k[v]=n(w)*f);break;default:q=b.strtoscaled(w),w=Math.abs(q.dval/m.cdelt1),v=v.replace("wcs",""),r(a,v,w)&&(k[v]=n(w))}break;case "height":case "r2":switch(x){case "image":r(a,
v,w)&&(k[v]=n(w));break;case "physical":r(a,v,w)&&(k[v]=n(w)*f);break;default:q=b.strtoscaled(w),w=Math.abs(q.dval/m.cdelt2),v=v.replace("wcs",""),r(a,v,w)&&(k[v]=n(w))}break;case "radii":r(a,v,w)&&(k[v]=w);break;case "linelength":if(a.pub.pts&&2===a.pub.pts.length&&b.isNumber(w)&&w!==this.tmp.linelength){w=parseFloat(w);switch(x){case "image":case "physical":break;default:void 0!==m.cdelt1?w/=Math.abs(m.cdelt1):void 0!==m.cdelt2&&(w/=Math.abs(m.cdelt2))}k.pts?(v=k.pts[0],q=k.pts[1]):(v=a.pub.pts[0],
q=a.pub.pts[1]);if(0<=$.inArray("line",b.Regions.opts.noCenteredScaling)){var z=Math.sqrt((v.x-q.x)*(v.x-q.x)+(v.y-q.y)*(v.y-q.y));var y=v.x-w*(v.x-q.x)/z;w=v.y-w*(v.y-q.y)/z;k.pts=[v,{x:y,y:w}]}else y={x:(v.x+q.x)/2,y:(v.y+q.y)/2},z=parseFloat(this.tmp.lineangle)||0,v.x=y.x-w/2,v.y=y.y,q.x=y.x+w/2,q.y=y.y,k.pts=[b.rotatePoint(v,z,y),b.rotatePoint(q,z,y)]}break;case "lineangle":a.pub.pts&&2===a.pub.pts.length&&b.isNumber(w)&&w!==this.tmp.lineangle&&(z=parseFloat(w)-parseFloat(this.tmp.lineangle)||
0,k.pts?(v=k.pts[0],q=k.pts[1]):(v=a.pub.pts[0],q=a.pub.pts[1]),0<=$.inArray("line",b.Regions.opts.noCenteredScaling)?k.pts=[v,b.rotatePoint(q,z,v)]:(y={x:(v.x+q.x)/2,y:(v.y+q.y)/2},k.pts=[b.rotatePoint(v,z,y),b.rotatePoint(q,z,y)]));break;case "remove":r(a,v,w)&&(t?k[v]="selected":void 0!==a.pub.id&&(k[v]=a.pub.id));break;case "locked":r(a,v,!n(w))&&(k.changeable=!n(w));break;case "misc":if(w.trim())try{var A=JSON.parse(w);$.extend(k,A)}catch(C){b.error("invalid json: "+w)}break;default:r(a,v,w)&&
(k[v]=n(w))}}0<Object.keys(k).length&&(c=t?$(c).find("[name='selectfilter']").val()||"selected":$(c).find("[name='id']").val()||a,this.changeShapes(g,c,k),this.initRegionsForm(a,{multi:t}))};b.Regions.regionsConfigSetSelectFilter=function(c,a){var d=[];var e=[],f=[],g=c.closest("form"),h=g.find("[name='selectfilter']"),k=g.data("im");g=function(a){if(!a)return"";a=a.trim();return"("===a.charAt(0)&&")"===a.charAt(a.length-1)?a:"("+a+")"};if(k){f=k.listGroups("all",{includeregions:!1}).split("\n");
var m=c.val().trim();var l=h.val().trim();if("other"===a&&"saved"===m)(a=k.layers.regions.selection||"")&&l&&(a=g(a)+" && "+g(l)),h.val(""+a);else{l&&(d=l.split(/\s+/));if(d.length&&(d=d[d.length-1],!m.match(/[&|]/)&&!d.match(/[&|!]/))){switch(a){case "regions":e=b.regions;break;case "wcssys":e=b.wcssyss;break;case "groups":e=f;break;case "ops":e=["!","&&","||"]}m=0<=$.inArray(d,e)?"|| "+m:0<=$.inArray(d,f)||0<=$.inArray(m,f)?"|| "+m:"&& "+m}d=l+" "+m;if(b.globalOpts.regConfigAddParens){d=d.split("||");
if(2<=d.length)for(l=0;l<d.length;l++)a=d[l].trim(),0<a.indexOf("&&")?d[l]=g(a):d[l]=a;d=d.join(" || ").replace(/  */g," ")}h.val(d)}c.prop("selectedIndex",0)}};b.Regions.regionsConfigSetSelectMenu=function(b,a,d){var c,f;d.match(/^select/)||(d="select"+d);a=a.find("[name='"+d+"']");var g=a[0];for(c=g.options.length-1;1<=c;c--)g.remove(c);g=b.getShapes("regions","all");switch(d){case "selectshape":b=0;for(f=[];b<g.length;b++)c=g[b].shape,0>$.inArray(c,f)&&(a.append("<option>"+c+"</option>"),f.push(c));
break;case "selectcolor":b=0;for(f=[];b<g.length;b++)c=g[b].color,0>$.inArray(c,f)&&(a.append("<option>"+c+"</option>"),f.push(c));break;case "selecttag":b=0;for(f=[];b<g.length;b++)for(c=g[b].tags,d=0;d<c.length;d++)0>$.inArray(c[d],f)&&(a.append("<option>"+c[d]+"</option>"),f.push(c[d]));break;case "selectwcs":b=0;for(f=[];b<g.length;b++)g[b].wcsconfig&&(c=g[b].wcsconfig.wcssys,0>$.inArray(c,f)&&(a.append("<option>"+c+"</option>"),f.push(c)));break;case "selectgroup":if(c=b.listGroups("all",{includeregions:!1}))for(g=
c.split("\n"),b=0;b<g.length;b++)a.append("<option>"+g[b]+"</option>")}};b.Regions.regionsConfigSetSelectOrGroup=function(c,a,d,e){var f=a.find('[name="selectfilter"]');var g=a.find('[name="multitext"]'),h=f.val().trim();if(c){var k=c.layers.regions.canvas;!1===e&&(c.tmp.updateMulti=!1);h||(f.val(""),g.val(""),a.data("selectfilter",""),k.getActiveObject()&&k.discardActiveObject(),k.renderAll(),d="clear");d||(d=c.lookupGroup(h)?"group":"select");switch(d){case "select":a.data("selectfilter",h);c.selectShapes("regions",
h,{transparentgroup:!1});break;case "group":a.data("selectfilter",h);d=c.groupShapes("regions",h);f.val(d);g.val(c.listGroups(d));if(f=c.lookupGroup(d))k.setActiveObject(f),k.renderAll(),b.Regions.regionsConfigSetSelectMenu(c,a,"selectgroup");break;case "ungroup":c.ungroupShapes("regions",h);f.val("");g.val("");a.data("selectfilter","");k.getActiveObject()&&k.discardActiveObject();b.Regions.regionsConfigSetSelectMenu(c,a,"selectgroup");break;case "clear":a.find('input[name="color"]').val(""),a.find('input[name="strokeWidth"]').val(""),
a.find('input[name="strokeDashes"]').val(""),a.data("strokewidth",""),a.data("strokedashes","")}delete c.tmp.updateMulti}};b.Regions.pasteFromClipboard=function(c){var a,d=0,e=0;if(this){(a=b.CopyFromClipboard().trim())||b.error(b.CLIPBOARDERROR);if(a.match(/(annulus|box|circle|cross|ellipse|line|polygon|point|text) *\(/)){var f=b.globalOpts.regToClipboard;b.globalOpts.regToClipboard=!1;var g=this.addShapes("regions",a,{rtn:"objs"});if(c){var h=g.length;for(c=0;c<h;c++)d+=g[c].pub.x,e+=g[c].pub.y;
d/=h;e/=h;for(c=0;c<h;c++){var k=g[c].pub.x-d+this.ipos.x;var m=g[c].pub.y-e+this.ipos.y;this.changeShapes("regions",g[c].pub.id,{x:k,y:m})}}b.globalOpts.regToClipboard=f}else b.error(b.CLIPBOARDERROR2);return a}};b.Regions.listRegions=function(c,a,d){var e=this,f,g,h,k,m,l="";var p="none";var r=!1,n=[];var u={};var x=[],t=[];var v={includeObj:!0};var w=function(c,d){var f,g={},h=c.params,k=h.children,l=h.exports;for(f=0;f<l.length;f++){var m=l[f];if(("text"!==m||"text"===c.type)&&"textOpts"!==m){if("strokeDashArray"===
m&&c.strokeDashArray){var n=c.strokeDashArray.join("");if(""===n||n.match(/NaN/))continue}"id"===m&&a.file||"wcsconfig"===m&&a.file||"data"===m&&"object"===typeof h.data&&!1===h.data.doexport&&a.file||("strokeWidth"===m&&h.sw1?g[m]=h.sw1:void 0!==c[m]?g[m]=c[m]:void 0!==h[m]?g[m]=h[m]:d&&void 0!==d[m]&&(g[m]=d[m]))}}if(0<k.length&&k[0].obj.text){n=k[0].obj;g.text=n.text;g.textOpts=w(n);if(c.angle!==n.angle){if(g.textOpts.angle=-n.angle,"circle"===c.params.shape||"annulus"===c.params.shape)n.params.hasTextOpts=
!0}else 0===n.angle||"circle"!==c.params.shape&&"annulus"!==c.params.shape||(g.textOpts.angle=-n.angle,n.params.hasTextOpts=!0);if(n.params.parent.moved||n.params.hasTextOpts)n.pub.ra&&n.pub.dec?(y&&A&&y!==A?(n=e.wcs2wcs(y,A,n.pub.ra,n.pub.dec),n=n.trim().split(/\s+/),d=b.saostrtod(n[0]),b.isHMS(A)&&(d*=15),n=b.saostrtod(n[1])):(d=n.pub.ra,n=n.pub.dec),g.textOpts.ra=d,g.textOpts.dec=n):n.pub.lcs?(g.textOpts.px=n.pub.lcs.x,g.textOpts.py=n.pub.lcs.y):(g.textOpts.x=n.pub.x,g.textOpts.y=n.pub.y);g.textOpts.color===
c.stroke&&delete g.textOpts.color;g.textOpts.text&&delete g.textOpts.text;Object.keys(g.textOpts).length||delete g.textOpts}return g};a=a||{};if("string"===typeof a)try{a=JSON.parse(a)}catch(D){b.error("can't parse listRegions opts: "+a,D)}b.notNull(a.sortids)&&(v.sortids=a.sortids);var q=a.mode;b.isNull(q)&&(q=3);d=d||"regions";if(this.getShapeLayer(d)){if(a.wcssys||a.wcsunits){var z=b.globalOpts.xeqPlugins;b.globalOpts.xeqPlugins=!1;if(a.wcssys){var y=this.getWCSSys();this.setWCSSys(a.wcssys,!1);
var A=this.getWCSSys()}if(a.wcsunits){var C=this.getWCSUnits();this.setWCSUnits(a.wcsunits,!1)}this.updateShapes(d,c,"export")}b.isNull(a.includedcoords)&&(a.includedcoords=b.globalOpts.regListDCoords);n=this.getShapes(d,c,v);v=n.length;if(q)for(f=0;f<v;f++){var B=n[f];if((h=B.tags.join(","))&&"source,include"!==h&&"include,source"!==h){r=!0;break}}f=$jscomp.makeIterator(Object.keys(b.Regions.opts.tagcolors));for(B=f.next();!B.done;B=f.next())h=B.value,t.push(b.Regions.opts.tagcolors[h]);for(f=0;f<
v;f++)if(B=n[f],u=B.obj,x=[],!B.sticky||!1!==a.sticky)if(!B.preservedcoords||a.includedcoords)if(!B.ignore||a.ignoreignore)if($.isArray(u.params.preservedcoords)){for(g=0;g<u.params.preservedcoords.length;g++)switch(h=u.params.preservedcoords[g],h){case "pts":0>$.inArray("dx",x)&&x.push("dx");0>$.inArray("dy",x)&&x.push("dy");0>$.inArray("points",x)&&x.push("points");break;default:x.push(h)}"none"!==p&&(l+="; ");"image"!==p&&(l+="image",l+="; ");l+=B.shape+"({";for(m=g=0;g<x.length;g++)if(h=x[g],
"shape"!==h&&"sticky"!==h&&"wcsconfig"!==h){"pts"===h&&(h="dx",u.params.preservedcoords.push("dy"),u.params.preservedcoords.push("points"));if("preservedcoords"===h)p=!0;else if(b.notNull(B[h]))p=B[h];else if(b.notNull(u[h]))p=u[h];else switch(h){case "dx":p=u.left;break;case "dy":p=u.top;break;case "color":p=u.stroke;break;default:p=null}if(p)switch(0<m++&&(l+=","),l+='"'+h+'":',typeof p){case "string":l+='"'+p+'"';break;case "object":try{l+=JSON.stringify(p)}catch(D){b.error("can't parse: "+p,D)}break;
default:l+=""+p}}l+="})";p="image"}else h=B.tags.join(","),g=h.includes("exclude")?"-":"",u=w(u,B),a.saveid?u.id=B.id:delete u.id,a.savewcsconfig&&B.wcsconfig&&0<Object.keys(B.wcsconfig).length?u.wcsconfig=$.extend(!0,{},B.wcsconfig):delete u.wcsconfig,B.color&&!t.includes(B.color)&&(u.color=B.color),r&&(k=" # "+h),a.saveediting||delete u.editing,B.wcsstr&&b.isWCSSys(this.params.wcssys)?("wcs"!==p&&("none"!==p&&(l+="; "),l=B.wcssys?l+B.wcssys:l+this.params.wcssys,p="wcs"),l+="; "+g+B.wcsstr):B.imstr&&
(p!==B.imsys&&("none"!==p&&(l+="; "),l+=B.imsys,p=B.imsys),l+="; "+g+B.imstr),!1!==a.includejson&&1===q%2&&0<Object.keys(u).length&&("line"===B.shape&&(l=l.replace(/ *{[^{}]*}$/,"")),l+=" "+JSON.stringify(u)),k&&(l+=k);!1===a.includecomments&&(l=l.replace(/ *#[^;]*/g,""));if(y||C)y&&this.setWCSSys(y,!1),C&&this.setWCSUnits(C,!1),this.updateShapes(d,c,"export"),b.globalOpts.xeqPlugins=z;1<q&&this.display.displayMessage("regions",l);return l}};b.Regions.copyRegions=function(b,a){return this.copyShapes("regions",
b,a)};b.Regions.parseRegions=function(c,a){var d=this,e,f,g=[],h=/^-?(annulus|box|circle|cross|ellipse|line|polygon|point|text)$/,k=/^(fk4|fk5|icrs|galactic|ecliptic|image|physical|linear)$/,m=/^(image|physical)$/,l=/[dr:]/,p=/\(\s*([^)]+?)\s*\)/,r=/(\{.*\})/,n=/\s*,\s*/,u=/#(?![a-zA-Z0-9]{6}['"])/,x=function(a){return"0"===a||"false"===a.toLowerCase()?!1:!0},t=function(a){for(var b,c,d,e={},f=/([a-zA-Z][a-zA-Z0-9_]*)\s*=\s*(\d+(\s*\d+)*|[^ '"{]+|['"{][^'"}]*['"}])/g,g={color:function(a){return{color:a}},
dash:function(a){if(a)return{strokeDashArray:[3,1]}},dashlist:function(a){if(a){var b=a.split(" ");for(a=0;a<b.length;a++)b[a]=parseFloat(b[a]);return{strokeDashArray:b}}},delete:function(a){return{removable:x(a)}},edit:function(a){return{selectable:x(a)}},fixed:function(a){return{zoomable:!x(a)}},font:function(a){var b={};a=a.split(" ");var c=a.length;1<=c&&(b.fontFamily=a[0]);2<=c&&(b.fontSize=parseFloat(a[1]));3<=c&&(b.fontStyle=a[2]);4<=c&&(b.fontWeight=a[3]);return b},highlite:function(a){return{hasControls:x(a),
hasBorders:x(a),hasRotatingPoint:x(a)}},move:function(a){return{movable:x(a)}},rotate:function(a){return{rotatable:x(a)}},resize:function(a){return{resizable:x(a)}},changeable:function(a){return{changeable:x(a)}},select:function(a){return{selectable:x(a)}},text:function(a){return{text:a}},tag:function(a){return{tags:a}},width:function(a){return{strokeWidth:parseFloat(a)}}};null!==(b=f.exec(a));)if(c=b[1].toLowerCase(),b=b[2].replace(/^['"{]|['"}]$/g,""),{}.hasOwnProperty.call(g,c)&&"function"===typeof g[c])for(c=
g[c](b)||{},b=$jscomp.makeIterator(Object.keys(c)),d=b.next();!d.done;d=b.next())d=d.value,"tags"===d&&{}.hasOwnProperty.call(e,d)?e[d]+=","+c[d]:e[d]=c[d];else e[c]=b;if(a=a.replace(f,""))e._comment=a.trim();return e},v=function(a){var c,d={opts:{},args:[],isregion:0};a.includes("(")?d.cmd=a.split("(")[0].trim().toLowerCase():a.includes("{")?d.cmd=a.split("{")[0].trim().toLowerCase():a.includes("#")?d.cmd=a.split("#")[0].trim().toLowerCase():d.cmd=a.trim().toLowerCase();d.cmd&&(d.isregion=0<=d.cmd.search(h));
var e=a.trim().split(u);if((c=r.exec(e[0]))&&c[0])try{d.opts=JSON.parse(c[0].trim())}catch(M){b.error("can't parse opts: "+c[0],M)}d.comment=e[1];if(d.comment){var f=t(d.comment.trim());void 0!==f._comment&&(d.comment=f._comment,delete f._comment)}f&&(d.opts=$.extend({},f,d.opts));(c=p.exec(a))&&c[0].match(r)?d.args=[]:c&&c[1]&&(d.args=c[1].split(n));d.isregion&&d.cmd.startsWith("-")&&(d.cmd=d.cmd.slice(1),d.comment?d.comment.match(/exclude/)||(d.comment+=",exclude"):d.comment="exclude");return d},
w=function(a,c){var e={};if("d"===a.charAt(0).toLowerCase()&&"d"===c.charAt(0).toLowerCase())return e.dx=parseFloat(a.substring(1)),e.dy=parseFloat(c.substring(1)),e;a=b.strtoscaled(a);c=b.strtoscaled(c);!a.dtype.match(l)&&!c.dtype.match(l)||A||z.match(m)||(B=!0,y=z);if(A||B)return b.isHMS(y,a.dtype)&&(a.dval*=15),"r"===a.dtype&&(a.dval=180*a.dval/Math.PI),"r"===c.dtype&&(c.dval=180*c.dval/Math.PI),c=b.wcs2pix(d.raw.wcs,a.dval,c.dval).split(/ +/),e.x=parseFloat(c[0]),e.y=parseFloat(c[1]),e;if("physical"===
y)return c=d.logicalToImagePos({x:a.dval,y:c.dval}),e.x=c.x,e.y=c.y,e;e.x=a.dval;e.y=c.dval;return e},q=function(a,c){a=b.strtoscaled(a);var e=d.raw.wcsinfo||{cdelt1:1,cdelt2:1};!a.dtype.match(l)||A||z.match(m)||(B=!0,y=z);A||B?("r"===a.dtype&&(a.dval=180*a.dval/Math.PI),0!==b.REGSIZE&&b.error("region size based on ang sep is not implemented"),a.dval=Math.abs(a.dval/e["cdelt"+c])):"physical"===y&&d.lcs&&d.lcs.physical&&(c=Math.sqrt(Math.pow(d.lcs.physical.forward[0][0],2)+Math.pow(d.lcs.physical.forward[0][1],
2)),a.dval=Math.abs(a.dval*c));return a.dval};c=c.trim();if(!c.match(/(\(|\{|#|;|\n)/))return c;var z=this.getWCSSys();a=this.getWCSUnits();var y="physical";var A=b.isWCSSys(y);var C=c.split(/\n|;/);for(c=0;c<C.length;c++)if("#"!==C[c].trim().substr(0,1)){var B=!1;var D=v(C[c]);var E=D.args.length;if(D.isregion){var F=$.extend(!0,{},D.opts);F.shape=D.cmd;F.wcsconfig=F.wcsconfig||{wcssys:y};2<=E&&"line"!==F.shape&&"polygon"!==F.shape&&$.extend(F,w(D.args[0],D.args[1]));F.textOpts&&void 0!==F.textOpts.ra&&
void 0!==F.textOpts.dec&&(F.textOpts._wcssys=y);switch(D.cmd){case "annulus":if(0<E)for(F.radii=[],e=2;e<E;e++)F.radii.push(q(D.args[e],1));break;case "box":case "cross":3<=E&&(F.width=q(D.args[2],1));4<=E&&(F.height=q(D.args[3],2));5<=E&&(F.angle=b.strtoscaled(D.args[4]).dval);break;case "circle":3<=E&&(F.radius=q(D.args[2],1));break;case "ellipse":3<=E&&(F.r1=q(D.args[2],1));4<=E&&(F.r2=q(D.args[3],2));5<=E&&(F.angle=b.strtoscaled(D.args[4]).dval);break;case "line":case "polygon":if(0<E)for(F.pts=
[],f=e=0;e<E;e+=2,f++){var G=w(D.args[e],D.args[e+1]);b.notNull(G.dx)&&b.notNull(G.dy)?F.pts[f]={dx:G.dx,dy:G.dy}:F.pts[f]={x:G.x,y:G.y}}break;case "text":3<=E&&(F.text=D.args[2].replace(/^['"]/,"").replace(/["']$/,"")),4<=E&&(F.angle=b.strtoscaled(D.args[3]).dval)}D.comment&&(F.tags=D.comment);g.push(F)}else D.cmd.match(k)?(e=b.globalOpts.xeqPlugins,b.globalOpts.xeqPlugins=!1,this.setWCSSys(D.cmd,!1),b.globalOpts.xeqPlugins=e,y=this.getWCSSys(),A=b.isWCSSys(y)):"remove"!==D.cmd&&"delete"!==D.cmd||
g.push({remove:!0})}e=b.globalOpts.xeqPlugins;b.globalOpts.xeqPlugins=!1;this.setWCSSys(z,!1);this.setWCSUnits(a);b.globalOpts.xeqPlugins=e;return g};b.Regions.saveRegions=function(c,a,d){var e,f,g;c&&(f=c.match(/\.([^.]*)$/))&&f[1]&&f[1].match(/^(reg|svg|csv)$/)&&(e=f[1]);if("object"===typeof d){var h=d;d=null}else if(d&&"string"===typeof d){try{h=JSON.parse(d)}catch(r){h=null}h&&(d=null)}h&&(b.notNull(h.layer)&&(d=h.layer),b.notNull(h.type)&&(e=h.type),b.notNull(h.format)&&(e=h.format));h=h||{};
d=d||"regions";e=e||"reg";this.layers[d]||b.error("can't find layer for saveRegions: "+d);c||(c="regions"!==d?"js9_"+d+"."+e:"js9."+e);switch(e){case "svg":try{b.globalOpts.svgBorder&&(g=this.addShapes(d,"box",{left:this.rgb.img.width/2,top:this.rgb.img.height/2,width:this.rgb.img.width,height:this.rgb.img.height,color:"black",strokeWidth:1,tags:"SVGBorder"}));var k=this.layers[d].dlayer.canvas.toSVG();b.globalOpts.svgBorder&&this.removeShapes(d,g)}catch(r){b.error("can't convert layer to SVG: "+
d)}break;case "csv":try{h.mode=1;h.file=c;b.isNull(h.includewcs)&&(h.includewcs=b.globalOpts.csvIncludeWCS);b.isNull(h.savedcoords)&&(h.includedcoords=b.globalOpts.regSaveDCoords);var m=this.listRegions(a,h,d);f=m.split(";");var l=0;for(k="";l<f.length;l++)if(f[l])if(f[l].toLowerCase().match(b.WCSEXP))h.includewcs&&(k+=f[l].trim()+"\n");else{var p=f[l].replace(/\(/,",").replace(/\).*/,"").trim();k+=p+"\n"}}catch(r){b.error("can't convert layer to region: "+d)}break;default:try{h.mode=1,h.file=c,b.isNull(h.includejson)&&
(h.includejson=b.globalOpts.regIncludeJSON),b.isNull(h.includecomments)&&(h.includecomments=b.globalOpts.regIncludeComments),b.notNull(h.savedcoords)?h.includedcoords=h.savedcoords:h.includedcoords=b.globalOpts.regSaveDCoords,m=this.listRegions(a,h,d).replace(/; */g,"\n"),k=!1!==h.includecomments?"# Region file format: JS9 version 1.0\n"+m+"\n":m+"\n"}catch(r){b.error("can't convert layer to region: "+d)}}a=new Blob([k],{type:"text/plain;charset=utf-8"});({}).hasOwnProperty.call(window,"saveAs")?
b.saveAs(a,c):b.error("no saveAs() available to save region file");return this.tmp.saveregionsFile=c};b.Regions.unremoveRegions=function(){var b=this.regstack.pop();return b?this.addShapes("regions",b):null};b.Regions.changeRegionTags=function(b,a,d){var c;b=b||"all";a=a||[];d=d||[];$.isArray(a)||(a=a.split(",").map(function(a){return a.trim()}));$.isArray(d)||(d=d.split(",").map(function(a){return a.trim()}));var f=this.getShapes("regions",b);for(b=0;b<f.length;b++){var g=f[b].tags;var h=[];for(c=
0;c<a.length;c++)0>$.inArray(a[c],g)&&h.push(a[c]);for(c=0;c<g.length;c++)0>$.inArray(g[c],d)&&h.push(g[c]);this.changeShapes("regions",f[b].id,{tags:h})}};b.Regions.toggleRegionTags=function(b,a,d){var c;var f=this.getShapes("regions",b||"all");for(b=0;b<f.length;b++){var g=f[b].tags;var h="";for(c=0;c<g.length;c++)if(g[c]===a){h=g[c]=d;break}else if(g[c]===d){h=g[c]=a;break}h&&this.changeShapes("regions",f[b].id,{tags:g})}};b.Plot={};b.Plot.CLASS="JS9";b.Plot.NAME="Plot";b.Plot.opts={annotate:!1,
annotateColor:"#FF0000",color:"blue",zoomStack:{enabled:!0},selection:{mode:"xy"},series:{clickable:!0,hoverable:!0,lines:{show:!0},points:{show:!1}},legend:{backgroundColor:null,backgroundOpacity:0},xaxis:{autorange:!0},yaxis:{autorange:!0},title:"Plot Configuration",configURL:"./params/plotconfig.html"};b.Plot.logfunc=function(b){return 0===b?0:Math.log(b)};b.Plot.expfunc=function(b){return 0===b?0:Math.exp(b)};b.Plot.rescale=function(c,a,d,e,f,g,h){switch(b.globalOpts.plotLibrary){case "flot":switch(e){case "x":var k=
a.getAxes().xaxis;break;case "y":k=a.getAxes().yaxis}switch(f){case "linear":k.options.transform=null;k.options.inverseTransform=null;d.curscale[e]=f;break;case "log":k.options.transform=b.Plot.logfunc,k.options.inverseTransform=b.Plot.expfunc,d.curscale[e]=f}b.isNumber(g)?k.options.min=Number.parseFloat(g):""==g&&(k.options.min=null);b.isNumber(h)?k.options.max=Number.parseFloat(h):""==h&&(k.options.max=null);a.setupGrid();a.draw();break;case "plotly":switch(e){case "x":var m={xaxis:{type:f,autorange:!0}};
d.curscale[e]=f;break;case "y":m={yaxis:{type:f,autorange:!0}},d.curscale[e]=f}Plotly.restyle(c.attr("id"),m)}};b.Plot.annotate=function(c,a,d){var e;var f=[];var g=d.data,h=d.annotations.color||b.Plot.opts.annotateColor,k=function(a,b){if(!a.text)return null;var c=a.x||0;if("%Y"===a.y.toUpperCase())for(a=1;a<b.length-1;a++){if(b[a][0]>c){var d=Math.max(b[a-1][1],b[a][1],b[a+1][1]);break}}else d=a.y;return{x:c,y:d}};switch(b.globalOpts.plotLibrary){case "flot":var m=-25;c.find(".plotAnnotation").remove();
for(e=0;e<d.annotations.data.length;e++){var l=d.annotations.data[e];var p=k(l,g);f=a.pointOffset({x:p.x,y:p.y});0>f.left||f.left>c.width()||(l=sprintf("<div class='plotAnnotation' style='position: absolute; left: %spx; top:%spx; color: %s; font-size: small'>%s</div>",f.left,f.top+m,h,"&darr;"+l.text),c.append(l))}break;case "plotly":m=-30;for(e=0;e<d.annotations.data.length;e++)if(l=d.annotations.data[e],p=k(l,g))c={x:p.x,y:p.y,xref:"x",yref:"y",text:l.text,arrowcolor:h,font:{color:h},showarrow:!0,
arrowhead:2,ax:0,ay:m},f.push(c);return f}};b.Plot.initConfigForm=function(c,a){var d,e,f=function(a){if(void 0!==a)return"number"===typeof a&&0!==a%1&&(a=Math.round(100*(a+.001))/100),String(a)};if(c&&a){var g=c.winid;var h="#"+$(g).attr("id")+" #plotConfigForm ";"flot"===b.globalOpts.plotLibrary&&($(h+".val").each(function(g,h){d="";e=$(h).attr("name");switch(e){case "xscale":b.notNull(a.curscale.x)&&(d=f(a.curscale.x));break;case "xmin":b.notNull(c.getAxes().xaxis.options.min)&&(d=f(c.getAxes().xaxis.options.min));
break;case "xmax":b.notNull(c.getAxes().xaxis.options.max)&&(d=f(c.getAxes().xaxis.options.max));break;case "yscale":b.notNull(a.curscale.y)&&(d=f(a.curscale.y));break;case "ymin":b.notNull(c.getAxes().yaxis.options.min)&&(d=f(c.getAxes().yaxis.options.min));break;case "ymax":b.notNull(c.getAxes().yaxis.options.max)&&(d=f(c.getAxes().yaxis.options.max))}$(h).val(d)}),$(h).data("im",this),$(h).data("plot",c),$(h).data("pobj",a),$(h).data("winid",g),$(h).data("tooltipInit")||($(h).data("tooltipInit",
!0),b.BROWSER[3]?(g="touchstart",h="touchend"):(g="mouseover",h="mouseout"),$(".plotcol_P").on(g,function(a){var c=a.currentTarget;a=$(c).find("input").data("tooltip");c=$(c).closest(b.lightOpts[b.LIGHTWIN].top).find(b.lightOpts[b.LIGHTWIN].dragBar);a&&c.length&&(a=b.Plot.opts.title+": "+a,$(c)[0].childNodes[0].nodeValue=a)}),$(".plotcol_P").on(h,function(a){a=$(a.currentTarget).closest(b.lightOpts[b.LIGHTWIN].top).find(b.lightOpts[b.LIGHTWIN].dragBar);a.length&&($(a)[0].childNodes[0].nodeValue=b.Plot.opts.title)})))}};
b.Plot.processConfigForm=function(c,a,d,e){var f=e.length;switch(b.globalOpts.plotLibrary){case "plotly":return}for(c=0;c<f;c++){var g=e[c].name;var h=e[c].value;switch(g){case "xscale":""===h&&(h="linear");b.Plot.rescale(null,a,d,"x",h);break;case "xmin":b.Plot.rescale(null,a,d,"x",null,h,null);break;case "xmax":b.Plot.rescale(null,a,d,"x",null,null,h);break;case "yscale":""===h&&(h="linear");b.Plot.rescale(null,a,d,"y",h);break;case "ymin":b.Plot.rescale(null,a,d,"y",null,h,null);break;case "ymax":b.Plot.rescale(null,
a,d,"y",null,null,h)}}b.Plot.initConfigForm.call(this,a,d)};b.plotOpts=b.Plot.opts;b.Catalogs={};b.Catalogs.CLASS="JS9";b.Catalogs.NAME="Catalogs";b.Catalogs.opts={hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,selectable:!1,canvas:{selection:!1},updateWCS:!1,panzoom:!0,shape:"circle",strokeWidth:2,width:10,height:10,radius:5,eradius:{x:5,y:3},angle:0,tagcolors:{defcolor:"#00FF00"},sortOverlapping:!1};
b.Crosshair={};b.Crosshair.CLASS="JS9";b.Crosshair.NAME="Crosshair";b.Crosshair.LAYERNAME="crosshair";b.Crosshair.opts={hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,selectable:!1,canvas:{selection:!1},updateWCS:!1,panzoom:!1,arrowSize:14,strokeWidth:1,color:"#00FF00",sortOverlapping:!1,hiddenPts:{pts:[{x:-9999,y:-9999},{x:-9999,y:-9900}]}};b.Crosshair.display=function(c,a,d){var e=b.Crosshair.LAYERNAME;
if(c&&(d=/iPad|iPhone|iPod/.test(navigator.platform)?!0:d.shiftKey,c.tmp.arrowCrosshair||d&&!c.tmp.shiftKey&&c.crosshair&&c.params.crosshair)){if(c.tmp.arrowCrosshair&&!c.params.crosshair){var f=b.Crosshair.opts.arrowSize/c.rgb.sect.zoom;d=a.x-f;var g=a.x+f;var h=a.y-f;var k=a.y+f}else d=0,g=c.raw.width,h=0,k=c.raw.height;g={pts:[{x:d,y:a.y},{x:g,y:a.y}],redraw:!1};c.changeShapes(e,c.crosshair.h,g);d={pts:[{x:a.x,y:h},{x:a.x,y:k}],redraw:!0};c.changeShapes(e,c.crosshair.v,d);c.crosshair.visible=!0;
if(b.globalOpts.wcsCrosshair&&c.validWCS()){h=b.pix2wcs(c.raw.wcs,a.x,a.y).trim().split(/\s+/);var m=b.saostrtod(h[0]);b.isHMS(c.params.wcssys)&&(m*=15);var l=b.saostrtod(h[1]);for(a=0;a<b.displays.length;a++)if((f=b.displays[a].image)&&f!==c&&f.crosshair&&f.params.crosshair&&f.validWCS()){g=f.raw.width;k=f.raw.height;try{var p=b.wcs2pix(f.raw.wcs,m,l)}catch(r){p=null}p&&(h=p.trim().split(/\s+/),d=parseFloat(h[0]),h=parseFloat(h[1]),0<d&&d<g&&0<h&&h<k&&(g={pts:[{x:0,y:h},{x:g,y:h}],redraw:!1},f.changeShapes(e,
f.crosshair.h,g),d={pts:[{x:d,y:0},{x:d,y:k}],redraw:!0},f.changeShapes(e,f.crosshair.v,d),f.crosshair.visible=!0))}}}};b.Crosshair.hide=function(c,a,d){a=b.Crosshair.LAYERNAME;d=b.Crosshair.opts.hiddenPts;c&&(c.crosshair&&c.crosshair.visible||c.tmp.arrowCrosshairVisible)&&(c.changeShapes(a,c.crosshair.h,d),c.changeShapes(a,c.crosshair.v,d),c.crosshair.visible=!1,delete c.tmp.arrowCrosshairVisible)};b.Crosshair.create=function(c){var a=b.Crosshair.opts.hiddenPts,d=b.Crosshair.LAYERNAME;c&&!c.crosshair&&
(c.crosshair={},c.crosshair.h=c.addShapes(d,"line",a),c.crosshair.v=c.addShapes(d,"line",a),c.crosshair.visible=!1)};b.Crosshair.keyaction=function(b,a,d){b&&d&&d.shiftKey&&(b.tmp.shiftKey=!0)};b.Crosshair.keyup=function(b,a,d){b&&b.tmp.shiftKey&&d&&!d.shiftKey&&delete b.tmp.shiftKey};b.Crosshair.init=function(){var c,a=b.Crosshair.LAYERNAME;for(c=0;c<b.displays.length;c++)b.displays[c].layers.crosshair||b.displays[c].newShapeLayer(a,b.Crosshair.opts);return this};b.Image.prototype.toggleCrosshair=
function(){this.params.crosshair=!this.params.crosshair;this.params.crosshair||b.Crosshair.hide(this)};b.Image.prototype.toggleWCSCrosshair=function(){b.globalOpts.wcsCrosshair=!b.globalOpts.wcsCrosshair};b.Grid={};b.Grid.CLASS="JS9";b.Grid.NAME="Grid";b.Grid.LAYERNAME="grid";b.Grid.opts={movable:!1,cover:"display",reduceDims:!0,strokeWidth:1,margin:0,labelMargin:10,stride:32,raLines:8,raSkip:0,raAngle:0,decLines:8,decSkip:0,decAngle:90,sexaPrec:1,degPrec:3,lineColor:"#00FFFF",labelColor:"#00FFFF",
labelFontFamily:"Helvetica, sans-serif",labelFontSize:11,labelFontStyle:"normal",labelFontWeight:300,labelRAOffx:3,labelRAOffy:-1,labelDecOffx:-14,labelDecOffy:6};b.Grid.limits=function(b,a,d,e){b=d-a;b=1<b?10:.1<b?100:.01<b?1E3:.001<b?1E4:1E-4<b?1E5:1E6;a=Math.floor(a*b)/b;d=Math.ceil(d*b)/b;return{lo:a,hi:d,inc:Math.ceil((d-a)/e*b)/b}};b.Grid.getLabel=function(c,a,d){var e,f=!1;switch(c.wcsunits){case "sexagesimal":"ra"===d&&"galactic"!==c.wcssys&&"ecliptic"!==c.wcssys&&(a/=15);a=b.saodtostr(a,
":",c.sexaPrec);var g=a.split(":");if(c.last[d])for(a="",e=0;e<g.length;e++)if(a&&(a+=":"),f||g[e]!==c.last[d][e])a+=g[e],f=!0;c.last[d]=$.extend({},g);break;default:a=a.toFixed(c.degPrec)}a=a.replace(/0+$/,"");c=a.indexOf(".");0>c?a+=".0":c===a.length-1&&(a+="0");return a=a.replace(/:\.0/,":0.0")};b.Grid.display=function(c,a){var d,e,f,g;var h=this.display;var k=this.raw;var m=[{ra:0,dec:0},{ra:0,dec:0},{ra:0,dec:0},{ra:0,dec:0}];if(b.isNull(c))switch(this.tmp.gridStatus){case "inactive":case void 0:return!1;
case "active":case "processing":return!0;default:return!0}this.removeShapes(b.Grid.LAYERNAME);if(!1===c||!this.raw.wcs||0>=this.raw.wcs)this.tmp.gridStatus="inactive";else{a=a||{};if("string"===typeof a)try{a=JSON.parse(a)}catch(B){b.error("can't parse displayCoordGrid JSON",B)}this.tmp.gridStatus="processing";c=$.extend(!0,{},b.Grid.opts,a);c.wcsunits=this.getWCSUnits();c.wcssys=this.getWCSSys();c.last={};b.wcsunits(this.raw.wcs,"degrees");if("image"===c.cover){var l=[Math.max(1,Math.floor(k.width/
h.width)),Math.max(1,Math.floor(k.height/h.height))];a=[{x:0,y:0},{x:k.width-1,y:k.height-1}]}else{l=c.reduceDims?k.width<k.height?[k.width/k.height,1]:k.height<k.width?[1,k.height/k.width]:[1,1]:[1,1];a=[];var p={x:this.ix+c.margin,y:this.iy-c.margin};var r=this.displayToImagePos(p);a[0]={x:r.x,y:r.y};p={x:h.width-1-this.ix-c.margin,y:h.height-1-this.iy-c.margin};r=this.displayToImagePos(p);a[1]={x:r.x,y:r.y}}var n=b.pix2wcs(k.wcs,a[0].x,a[0].y).trim().split(/\s+/);m[0].ra=b.saostrtod(n[0]);m[0].dec=
b.saostrtod(n[1]);n=b.pix2wcs(k.wcs,a[0].x,a[1].y).trim().split(/\s+/);m[1].ra=b.saostrtod(n[0]);m[1].dec=b.saostrtod(n[1]);n=b.pix2wcs(k.wcs,a[1].x,a[0].y).trim().split(/\s+/);m[2].ra=b.saostrtod(n[0]);m[2].dec=b.saostrtod(n[1]);n=b.pix2wcs(k.wcs,a[1].x,a[1].y).trim().split(/\s+/);m[3].ra=b.saostrtod(n[0]);m[3].dec=b.saostrtod(n[1]);h=m[0].ra;r=m[0].dec;a=m[0].ra;var u=m[0].dec;for(n=1;4>n;n++)h=Math.min(h,m[n].ra),r=Math.min(r,m[n].dec),a=Math.max(a,m[n].ra),u=Math.max(u,m[n].dec);n=b.Grid.limits.call(this,
c,h,a,c.raLines*l[0]);h=n.lo;a=n.hi;m=n.inc;n=b.Grid.limits.call(this,c,r,u,c.decLines*l[1]);r=n.lo;u=n.hi;var x=n.inc;b.wcsunits(this.raw.wcs,c.wcsunits);var t=Math.abs(this.raw.wcsinfo.cdelt1);var v=t*b.Grid.opts.stride;var w=a-v;var q=Math.abs(this.raw.wcsinfo.cdelt2);var z=q*b.Grid.opts.stride;var y=u-z;n="image;";for(f=h;f<=a;f+=m){var A="line(";var C=q;p=e=0;for(g=r;g<=u;g+=C)(d=b.wcs2pix(k.wcs,f,g).trim().split(/ +/))&&d.length&&(l=parseFloat(d[0]),d=parseFloat(d[1]),l>=-c.margin&&l<=k.width+
c.margin&&d>=-c.margin&&d<=k.height+c.margin?(A+=String(l+1+","+d+1+", "),p++,0===e?(e=1,g<y&&(C=z)):1===e&&g>y&&(e=2,C=q)):1===e&&(e=2,g-=C,C=q));1<p&&(n+=A.replace(/,\s+$/,") "),n+=' {"color": "'+c.lineColor+'"};')}for(g=r;g<=u;g+=x){A="line(";C=t;p=e=0;for(f=h;f<=a;f+=C)(d=b.wcs2pix(k.wcs,f,g).trim().split(/ +/))&&d.length&&(l=parseFloat(d[0]),d=parseFloat(d[1]),l>=-c.margin&&l<=k.width+c.margin&&d>=-c.margin&&d<=k.height+c.margin?(A+=String(l+1+","+d+1+", "),p++,0===e?(e=1,f<w&&(C=v)):1===e&&
f>w&&(e=2,C=t)):1===e&&(e=2,f-=C,C=t));1<p&&(n+=A.replace(/,\s+$/,") "),n+=' {"color": "'+c.lineColor+'"};')}e=c.labelDecOffx/this.rgb.sect.zoom;C=c.labelDecOffy/this.rgb.sect.zoom;t=0;f=v=h;for(A=0;f<=a;f+=m){for(g=r;g<=u;g+=x)(d=b.wcs2pix(k.wcs,f,g).trim().split(/ +/))&&d.length&&(l=parseFloat(d[0]),d=parseFloat(d[1]),p=this.imageToDisplayPos({x:l,y:d}),p.x>this.ix+c.labelMargin&&p.x<this.rgb.img.width+this.ix-c.labelMargin&&p.y>this.iy+c.labelMargin&&p.y<this.rgb.img.height+this.iy-c.labelMargin&&
(t>=c.decSkip?(n+=sprintf('text(%s,%s,%s,%s) {"color":"%s", "fontFamily":"%s", "fontSize":%s, "fontStyle":"%s", "fontWeight":"%s", "originX":"left", "originY":"top"};',l+e,d+C,b.Grid.getLabel.call(this,c,g,"dec"),c.decAngle,c.labelColor,c.labelFontFamily,c.labelFontSize,c.labelFontStyle,c.labelFontWeight),A++):(f!==v&&t++,v=f)));if(A)break}e=c.labelRAOffx/this.rgb.sect.zoom;C=c.labelRAOffy/this.rgb.sect.zoom;t=0;g=v=r;for(A=0;g<=u;g+=x){for(f=h;f<=a;f+=m)(d=b.wcs2pix(k.wcs,f,g).trim().split(/ +/))&&
d.length&&(l=parseFloat(d[0]),d=parseFloat(d[1]),p=this.imageToDisplayPos({x:l,y:d}),p.x>this.ix+c.labelMargin&&p.x<this.rgb.img.width+this.ix-c.labelMargin&&p.y>this.iy+c.labelMargin&&p.y<this.rgb.img.height+this.iy-c.labelMargin&&(t>=c.raSkip?(n+=sprintf('text(%s,%s,%s,%s) {"color":"%s", "fontFamily":"%s", "fontSize":%s, "fontStyle":"%s", "fontWeight":"%s", "originX":"left", "originY":"top"};',l+e,d+C,b.Grid.getLabel.call(this,c,f,"ra"),c.raAngle,c.labelColor,c.labelFontFamily,c.labelFontSize,c.labelFontStyle,
c.labelFontWeight),A++):(g!==v&&t++,v=g)));if(A)break}this.addShapes(b.Grid.LAYERNAME,n,c);this.tmp.gridStatus="active"}};b.Grid.toggle=function(b){if(b)switch(b.tmp.gridStatus){case void 0:case null:case "inactive":b.displayCoordGrid(!0);break;case "active":b.displayCoordGrid(!1)}};b.Grid.regrid=function(b){b&&"active"===b.tmp.gridStatus&&"complete"===b.status.load&&b.displayCoordGrid(!0)};b.Grid.init=function(c){c=$.extend(!0,{},b.Catalogs.opts,b.Grid.opts,c);this.display.newShapeLayer(b.Grid.LAYERNAME,
c).canvas.on("mouse:up",function(){return!1})};b.Image.prototype.displayCoordGrid=b.Grid.display;b.isImage=function(c){return"object"===typeof c&&b.notNull(c.id)&&b.notNull(c.raw)&&b.notNull(c.rgb)&&b.notNull(c.params)&&b.notNull(c.display)||"string"===typeof c&&b.lookupImage(c)?!0:!1};b.Dysel={};b.Dysel.CLASS="JS9";b.Dysel.NAME="Dysel";b.Dysel.display=null;b.Dysel.plugins=[];b.Dysel.init=function(b){};b.Dysel.unhighlightSelection=function(){b.bugs.webkit_resize?$(".JS9").find(".JS9Image").removeClass("JS9Highlight"):
$(".JS9").removeClass("JS9Highlight")};b.Dysel.highlightSelection=function(c){c&&b.Dysel.retrievePlugins().length&&1!==b.displays.length&&(b.Dysel.unhighlightSelection(),c=c.display,b.bugs.webkit_resize?$(c.divjq).find(".JS9Image").addClass("JS9Highlight"):$(c.divjq).addClass("JS9Highlight"))};b.Dysel.addPlugins=function(c){b.Dysel.plugins.push(c)};b.Dysel.retrievePlugins=function(){return b.Dysel.plugins};b.Dysel.getDisplay=function(c){return b.Dysel.retrievePlugins().length?"previous"===c?b.Dysel.odisplay:
b.Dysel.display:null};b.Dysel.getDisplayOr=function(c){return"previous"===c?b.Dysel.getDisplay(c):b.Dysel.getDisplay()||c};b.Dysel.select=function(c){c&&b.Dysel.retrievePlugins().length&&(b.Dysel.odisplay=b.Dysel.display,b.Dysel.display=c,c.image&&(b.Dysel.highlightSelection(c.image),c.image.xeqPlugins("image","ondynamicselect",null)))};b.Dysel.imageload=function(c){c&&b.Dysel.select(c.display)};b.Dysel.imageclose=function(c){var a,d;if(c&&(d=b.Dysel.getDisplay())&&d.image===c){for(d=a=0;a<b.images.length;a++)c.display===
b.images[a].display&&d++;if(1>=d)for(a=0;a<b.displays.length;a++)if(d=b.displays[a],c.display!==d&&d.image){b.Dysel.select(b.displays[a]);break}}};b.getDynamicDisplayOr=b.Dysel.getDisplayOr;b.Titlebar={};b.Titlebar.CLASS="JS9";b.Titlebar.NAME="Titlebar";b.Titlebar.init=function(c){b.Titlebar.title||(b.Titlebar.title=document.title)};b.Titlebar.imageload=function(c){c&&b.globalOpts.updateTitlebar&&(b.Titlebar.imid=window.electron?c.fitsFile||c.file||c.id:c.id,document.title=b.Titlebar.title+": "+b.Titlebar.imid)};
b.Titlebar.imagedisplay=function(c){c&&c.id!==b.Titlebar.imid&&b.globalOpts.updateTitlebar&&(b.Titlebar.imid=window.electron?c.fitsFile||c.file||c.id:c.id,document.title=b.Titlebar.title+": "+b.Titlebar.imid)};b.Titlebar.imageclose=function(){b.globalOpts.updateTitlebar&&(document.title=b.Titlebar.title)};Math.log10=Math.log10||function(b){return Math.log(b)/Math.LN10};"function"!==typeof Object.create&&(Object.create=function(b){var a=function(){};a.prototype=b;return new a});Math.asinh=Math.asinh||
function(b){return-Infinity===b?b:Math.log(b+Math.sqrt(b*b+1))};Math.sinh=Math.sinh||function(b){return(Math.exp(b)-Math.exp(-b))/2};Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(b,a){if(null==this)throw new TypeError('"this" is null or not defined');var c=Object(this),e=c.length>>>0;if(0===e)return!1;a|=0;for(a=Math.max(0<=a?a:e-Math.abs(a),0);a<e;){var f=c[a],g=b;if(f===g||"number"===typeof f&&"number"===typeof g&&isNaN(f)&&isNaN(g))return!0;a++}return!1}});
b.getRawCopy=function(c,a){var d=$.extend(!0,{},c);d.bitpix=a||c.bitpix;switch(d.bitpix){case 8:d.data=new Uint8Array(c.data);break;case 16:d.data=new Int16Array(c.data);break;case -16:d.data=new Uint16Array(c.data);break;case 32:d.data=new Int32Array(c.data);break;case -32:d.data=new Float32Array(c.data);break;case -64:d.data=new Float64Array(c.data);break;default:b.error("unsupported bitpix: "+d.bitpix)}return d};b.getRawLine=function(c,a,d,e){switch(c.bitpix){case 8:var f=new Uint8Array(c.data.buffer,
a,c.width);var g=new Uint8Array(d.data.buffer,e,c.width);break;case 16:case -16:f=new Uint16Array(c.data.buffer,a,c.width);g=new Uint16Array(d.data.buffer,e,c.width);break;case 32:f=new Uint32Array(c.data.buffer,a,c.width);g=new Uint32Array(d.data.buffer,e,c.width);break;case -32:f=new Float32Array(c.data.buffer,a,c.width);g=new Float32Array(d.data.buffer,e,c.width);break;case -64:f=new Float64Array(c.data.buffer,a,c.width);g=new Float64Array(d.data.buffer,e,c.width);break;default:b.error("unsupported bitpix: "+
c.bitpix)}return[f,g]};b.memcpy=function(b,a,d,e,f){b=new Uint8Array(b,a,f);d=new Uint8Array(d,e,f);b.set(d)};b.jupyterFocus=function(b,a){({}).hasOwnProperty.call(window,"Jupyter")&&(b=b instanceof jQuery?b:$(b),b.find(a||"input, textarea").each(function(a,b){Jupyter.keyboard_manager.register_events($(b))}))};b.getImageID=function(c,a,d){var e,f=0,g=1,h=b.images.length,k=/.*<([0-9][0-9]*)>$/,m=/<[0-9][0-9]*>/;c=b.cleanPath(c.replace(m,""),"id");for(e=0;e<h;e++){var l=b.images[e];l.display.id===a&&
l!==d&&c===l.id0.replace(m,"")&&(l.id&&0<=l.id.search(k)&&(l=l.id.replace(k,"$1"),g=Math.max(g,parseInt(l,10))),f++)}return f?c+"<"+String(g+1)+">":c};b.uniqueID=function(){var b=1;return function(){return b++}}();b.waiting=function(c,a){switch(c){case !0:if({}.hasOwnProperty.call(window,"Spinner")&&"spinner"===b.globalOpts.waitType){if(a)if("object"===typeof a)var d=a.divjq[0];else"string"===typeof a&&(c=b.lookupDisplay(a))&&(d=c.divjq[0]);d||(d=$("body").get(0));b.spinner||(b.spinner={},c={color:b.globalOpts.spinColor,
opacity:b.globalOpts.spinOpacity},b.spinner.spinner=new Spinner(c));b.spinner.spinner.spin(d)}else $("body").addClass("waiting");break;case !1:({}).hasOwnProperty.call(window,"Spinner")&&"spinner"===b.globalOpts.waitType?b.spinner&&b.spinner.spinner.stop():$("body").removeClass("waiting")}};b.progress=function(c,a){if("boolean"===typeof c||"string"===typeof c)switch(c){case !0:case "indeterminate":a&&(b.progress.display=a,b.progress.display.displayMessage("progress",c));break;case !1:case "":b.progress.display&&
(b.progress.display.clearMessage("progress"),delete b.progress.display)}else"number"===typeof c&&b.progress.display&&b.progress.display.displayMessage("progress",[c,a])};b.msgHandler=function(c,a){var d=[];var e=c.cmd,f=c.id,g=b.globalOpts.alerts,h=b.globalOpts.quietReturn?"":"OK";a&&(b.globalOpts.alerts=!1);if(b.publics[e]){$.isArray(c.args)||(c.args=[c.args]);for(d=0;d<c.args.length;d++)if("''"===c.args[d]||'""'===c.args[d])c.args[d]="";d=$.extend(!0,[],c.args);a:{var k=d;if(f){if(0<k.length){c=
k[k.length-1];if("string"===typeof c)try{var m=JSON.parse(c)}catch(p){m=null}else"object"===typeof c&&(m=c);if(m&&"object"===typeof m&&{}.hasOwnProperty.call(m,"display")&&1===Object.keys(m).length){k.pop();break a}}m={display:f}}else m=null}switch(e){case "RunAnalysis":a&&(1===d.length&&d.push(null),d.push(a))}m&&d.push(m);try{var l=b.publics[e].apply(b.publics,$jscomp.arrayFromIterable(d))}catch(p){l="ERROR: "+p.message}if(a){b.globalOpts.alerts=g;if(l instanceof b.Display||l instanceof b.Image)l=
l.id;switch(e){case "NewShapeLayer":l&&l.layerName&&(l=l.layerName);break;case "RunAnalysis":l.match(/^ERROR:/)||(a=null)}a&&a(l)}return l}if(e&&"#"!==e){m=b.lookupCommand(e);k=b.lookupDisplay(f,!1);if(m&&k)switch(m.getDisplayInfo(k),c.args?d=$.extend(!0,[],c.args):c.paramlist&&(d=c.paramlist.split(/ +/)),m.getWhich(d)){case "get":try{l=m.get(d)||""}catch(p){l="ERROR: "+p.message}break;case "set":try{l=m.set(d)||h}catch(p){l="ERROR: "+p.message}break;default:l="ERROR: unknown cmd type for '"+e+"'"}else m||
(l="ERROR: unknown cmd '"+e+"'"),k||(l="ERROR: unknown display ("+f+")");if(a){b.globalOpts.alerts=g;if(l instanceof b.Display||l instanceof b.Image)l=l.id;a(l)}return l}a&&a("");a&&(b.globalOpts.alerts=g)};b.lightWin=function(c,a,d,e,f){f=f||"";switch(b.LIGHTWIN){case "dhtml":f.match(/(left|top|center)=/)||(f&&(f+=","),f+=""+b.globalOpts.lightWinPos);var g=dhtmlwindow.open(c,a,d,e,f);/iPad|iPhone|iPod/.test(navigator.platform)&&$("#"+c+" "+b.lightOpts[b.LIGHTWIN].drag).css("-webkit-overflow-scrolling",
"touch").css("overflow-y","scroll");$("#"+c+" "+b.lightOpts[b.LIGHTWIN].dragBar).on("dblclick",function(){g.close()}).on("touchend",function(a){var c=(new Date).getTime(),d=$(a.currentTarget).data("lasttime");d&&c-d>b.DBLCLICK0&&c-d<b.DBLCLICK&&g.close();$(a.currentTarget).data("lasttime",c)});$("#"+c+" "+b.lightOpts[b.LIGHTWIN].dragBar).on("touchend",function(){dhtmlwindow.distancex||dhtmlwindow.distancey?0<b.lightOpts.nclick&&(b.lightOpts.nclick=0):2<=b.lightOpts.nclick?(alert("trouble closing this window? double-tap the window handle"),
b.lightOpts.nclick=-1):0<=b.lightOpts.nclick&&b.lightOpts.nclick++})}return g};b.checkNew=function(c){c||b.error("internal failure in a JS9 constructor")};b.specialKey=function(b){return b.metaKey||b.ctrlKey};b.strace=function(c){var a="";1<b.DEBUG&&(a=c.stack||c.stacktrace||"");return a};b.floatToString=function(c){return"number"===typeof c?sprintf("%g",parseFloat(c.toFixed(b.globalOpts.floatPrecision))):"string"===typeof c?c:String(c)};b.floatPrecision=function(b,a){return Math.max(Math.floor(Math.log10(Math.abs(b))),
Math.floor(Math.log10(Math.abs(a))))};b.floatFormattedString=function(b,a,d){var c="";if(void 0===b)return c;-2>a?(a="%."+String(2+d)+"e",c=sprintf(a,b)):0>a?c=b.toFixed(Math.abs(a)+3+d):2>a?(a="%."+String(a+d)+"f",c=sprintf(a,b)):5>a?c=b.toFixed(0+d):(a="%."+String(2+d)+"e",c=sprintf(a,b));return c};b.centerPolygon=function(b){var a;if(b&&b.length){var c=b.length;for(a=0;a<c;a++){if(void 0===e||b[a].x<e)var e=b[a].x;if(void 0===f||b[a].x>f)var f=b[a].x;if(void 0===g||b[a].y<g)var g=b[a].y;if(void 0===
h||b[a].y>h)var h=b[a].y}return{x:(e+f)/2,y:(g+h)/2}}};b.centroidPolygon=function(b,a){var c=0,e=0,f=0,g=0,h=0,k=[];if(b&&b.length){var m=b.length;if(a){for(a=0;a<m;a++)g+=b[a].x,h+=b[a].y;return{x:g/m,y:h/m}}for(a=0;a<m;a++)k[a]={},k[a].x=b[a].x,k[a].y=b[a].y;k[m]={};k[m].x=k[0].x;k[m].y=k[0].y;for(a=0;a<m;a++)b=k[a].x*k[a+1].y-k[a+1].x*k[a].y,c+=b,e+=(k[a].x+k[a+1].x)*b,f+=(k[a].y+k[a+1].y)*b;m=c/2;return{x:e/(6*m),y:f/(6*m)}}};b.lookupImage=function(c,a){var d,e,f=b.images.length;if(!c)return null;
window.electron&&(e=window.electron.currentDir+"/"+c);for(d=0;d<f;d++){var g=b.images[d];if((c===g||c===g.id||c===g.file||c===g.file.replace(/\[.*\]$/,"")||e===g.file||e===g.file.replace(/\[.*\]$/,"")||c===g.file0||c===b.TOROOT+g.file||g.fitsFile&&c===g.fitsFile)&&0<$("#"+g.display.id).length){var h=g.display.id;if(!a||"string"===typeof a&&a===h||"object"===typeof a&&a.id===h)return g}}return null};b.lookupDisplay=function(c,a){var d,e=new RegExp("[-_]?("+b.PLUGINS+")$");void 0===a&&(a=!0);if(c&&
0>c.toString().search(b.SUPERMENU)){for(d=0;d<b.displays.length;d++)if(c===b.displays[d]||c===b.displays[d].id||c===b.displays[d].oid)return b.displays[d];if("string"===typeof c)for(c=c.replace(e,""),d=0;d<b.displays.length;d++)if(c===b.displays[d]||c===b.displays[d].id||c===b.displays[d].oid)return b.displays[d];if(a)b.error("can't find JS9 display with id: "+c);else return null}return b.displays[0]};b.getImage=function(c){var a=b.lookupImage(c);!a&&(c=b.lookupDisplay(c,!1))&&(a=c.image);return a};
b.lookupVfile=function(c){var a,d,e=[];if(!c)return e;for(a=0;a<b.images.length;a++){var f=b.images[a];for(d=0;d<f.raws.length;d++){var g=f.raws[d];g.hdu&&g.hdu.fits&&c===g.hdu.fits.vfile&&e.push({im:f,raw:g,idx:d})}}return e};b.loadScript=function(b,a,d){var c=document.getElementsByTagName("head")[0],f=document.createElement("script");f.type="text/javascript";a&&(f.onload=a);d&&(f.onerror=d);f.src=b;c.appendChild(f)};b.fetchURL=function(c,a,d,e){var f=new XMLHttpRequest;d=d||{};c||a||b.error("invalid url specification for fetchURL");
a||(a=c,c=/([^\\/]+)$/.exec(a)[1]);c||(c=/([^\\/]+)$/.exec(a)[1]);d.proxy&&b.globalOpts.cgiProxy&&a.match(/\.(fits|ftz|fz|fits\.gz|fits\.bz2)(\?.*)?$/)&&(a=b.globalOpts.cgiProxy+"?fits="+a);var g=d.allowCache||a.match(/\?/)?a:a+"?r="+Math.random();g=g.replace(/^\${JS9_DIR}\//,b.INSTALLDIR);f.open("GET",g,!0);f.responseType=d.responseType?d.responseType:"blob";b.globalOpts.xtimeout&&(f.timeout=b.globalOpts.xtimeout);f.onload=function(){if(4===f.readyState)if(200===f.status||0===f.status)if(delete b.fetchURL.status,
"blob"===f.responseType){var g=new Blob([f.response]);c.match("://")?g.name=c.split("/").reverse()[0].replace(/\?.*$/,""):g.name=c;"uc"===g.name&&(g.name="google_"+b.uniqueID()+".fits");e?e(g,d):b.Load(g,d)}else d.display?e(f.response,d,{display:d.display}):e(f.response,d);else 404===f.status?b.error("could not find "+a):b.error("can't load: "+a+" "+f.statusText+" "+f.status)};f.onerror=function(){b.error("cannot load: "+a+" ... please check the url/pathname")};f.ontimeout=function(){b.error("timeout awaiting response from server: "+
a)};b.fetchURL.status="processing";try{f.send()}catch(h){b.error("request to load "+a+" failed",h)}};b.saveAs=function(c,a){var d;if(window.electron){(d=a.match(/.*\//))&&d[0]&&(d=d[0],b.SaveDir(d,{onceOnly:!0}));var e=a.split("/").reverse()[0];window.setTimeout(function(){try{saveAs(c,e)}catch(f){b.error("could not saveAs",f)}},b.TIMEOUT)}else try{saveAs(c,a)}catch(f){b.error("could not saveAs",f)}};b.fitsLibrary=function(c){if(!c)return b.fits.name;var a=c.toLowerCase();switch(a){case "astroem":case "cfitsio":b.fits=
Astroem;b.fits.options=b.fits.options||{};b.fits.options.handler=b.NewFitsImage;b.fits.options.error=b.error;b.userOpts.fits?(b.fits.options.extlist=b.userOpts.fits.extlist,b.fits.options.table={xdim:b.userOpts.fits.xdim,ydim:b.userOpts.fits.ydim,bin:b.userOpts.fits.bin||1},b.fits.options.image={xdim:b.userOpts.fits.ixdim||b.userOpts.fits.xmax,ydim:b.userOpts.fits.iydim||b.userOpts.fits.ymax,bin:b.userOpts.fits.ibin||1}):(b.fits.options.extlist=b.globalOpts.extlist,b.fits.options.table={bin:b.globalOpts.table.bin||
1},b.notNull(b.globalOpts.table.xdim)?b.fits.options.table.xdim=b.globalOpts.table.xdim:b.notNull(b.globalOpts.dims)&&(b.fits.options.table.xdim=b.globalOpts.dims[0]),b.notNull(b.globalOpts.table.ydim)?b.fits.options.table.ydim=b.globalOpts.table.ydim:b.notNull(b.globalOpts.dims)&&(b.fits.options.table.ydim=b.globalOpts.dims[1]),b.fits.options.image={bin:b.globalOpts.image.bin||1},b.notNull(b.globalOpts.image.xdim)?b.fits.options.image.xdim=b.globalOpts.image.xdim:b.notNull(b.globalOpts.xmax)&&(b.fits.options.image.xdim=
b.globalOpts.xmax),b.notNull(b.globalOpts.image.ydim)?b.fits.options.image.ydim=b.globalOpts.image.ydim:b.notNull(b.globalOpts.ymax)&&(b.fits.options.image.ydim=b.globalOpts.ymax));b.fits.maxFITSMemory&&b.globalOpts.maxMemory&&b.fits.maxFITSMemory(b.globalOpts.maxMemory);break;default:b.error("unknown fits library: "+c)}b.fits.ready=!0;b.fits.name=a;b.fits.options.error=b.error;b.fits.options.waiting=b.waiting;return a};b.handleFITSFile=function(c,a,d){b.fits.handleFITSFile?b.fits.handleFITSFile(c,
a,d):b.error("no FITS module available to process FITS file")};b.cleanupFITSFile=function(c,a){var d;b.hostFS&&(d=new RegExp("^"+b.hostFS));return b.fits.cleanupFITSFile&&c&&c.hdu&&c.hdu.fits?(d&&c.hdu.fits.vfile&&c.hdu.fits.vfile.match(d)&&(a=!1),b.fits.cleanupFITSFile(c.hdu.fits,a),!0):!1};b.handleImageFile=function(c,a,d){var e=new FileReader;a=$.extend(!0,{},b.fits.options,a);d=d||b.Load;e.onload=function(b){var e,f,k,m=new Image;m.onload=function(){var b=0;var g=document.createElement("canvas");
var h=g.getContext("2d");var n=m.height,u=m.width;g.width=u;g.height=n;h.drawImage(m,0,0);e=h.getImageData(0,0,u,n).data;f=new Float32Array(n*u);for(h=0;h<n;h++)for(g=0;g<u;g++){var x=.299*e[b]+.587*e[b+1]+.114*e[b+2];f[(n-h)*u+g]=x;b+=4}k={filename:c.name,naxis:2,axis:[0,u,n],bitpix:-32,bin:1,head:{SIMPLE:!0,BITPIX:-32,NAXIS:2,NAXIS1:u,NAXIS2:n},data:f,offscreen:m};k.dmin=Number.MAX_VALUE;k.dmax=Number.MIN_VALUE;for(b=0;b<n*u;b++)!Number.isNaN(k.data[b])&&Number.isFinite(k.data[b])&&(k.dmin=Math.min(k.dmin,
k.data[b]),k.dmax=Math.max(k.dmax,k.data[b]));a.source="img";d(k,a)};m.src=b.target.result};e.readAsDataURL(c)};b.getFITSImage=function(c,a,d,e){b.fits.getFITSImage?b.fits.getFITSImage(c,a,d,e):b.error("no FITS module available to process FITS image")};b.fits2fits=function(c,a,d,e){var f,g={};d=d||{};var h=b.notNull(d.fits2fits)?d.fits2fits:b.globalOpts.fits2fits;!0===h?h="always":!1===h&&(h="never");if(h.match(/never/i))return!1;if(!b.helper.connected||"nodejs"!==b.helper.type&&"socket.io"!==b.helper.type)return"always"===
h&&b.globalOpts.requireFits2Fits&&b.error("can't run fits2fits without connected JS9 helper"),!1;if(!b.helper.js9helper)if(b.globalOpts.requireFits2Fits)b.error("js9helper not found for fits2fits processing");else return!1;if(!b.globalOpts.workDir)return b.globalOpts.requireFits2Fits&&b.error("can't run fits2fits without a workdir"),!1;var k=d.xdim||b.fits.options.image.xdim||b.fits.options.table.xdim;var m=d.ydim||b.fits.options.image.ydim||b.fits.options.table.ydim;var l=d.bin||b.fits.options.image.bin||
b.fits.options.table.bin;var p=d.binMode||b.globalOpts.binMode;p="a"===p?"a":"";"string"===typeof l&&(l.match(/[as]$/)&&(p=l.slice(-1)),l=parseInt(l,10));l=Math.max(1,l||1);b.notNull(d.xcen)&&b.notNull(d.ycen)?g.sect=k+"@"+d.xcen+","+m+"@"+d.ycen+","+l+p:g.sect=k+","+m+","+l+p;m=h.toLowerCase().split(/[>,]/);for(k=0;k<m.length;k++)switch(m[k]){case "size":m[k+1]&&(b.isNumber(m[k+1])&&(g.maxsize=1E6*parseFloat(m[k+1])),k++)}g.fits=b.cleanPath(a);g.parent=!0;b.waiting(!0,c);b.helper.send("fits2fits",
g,function(a){a="object"===typeof a?a:0<=a.search(b.analOpts.epattern)?{stderr:a}:{stdout:a};a.stderr&&b.error(a.stderr,b.analOpts.epattern);if(a.stdout){a.stdout.match(/^ERROR:/)&&(b.globalOpts.requireFits2Fits?b.error(a.stdout):a.stdout=g.fits);var h=a.stdout.split(/\n/);a=b.cleanPath(h[0]);if(a===g.fits)var k=$.extend(!0,{},d);else{"/"!==a.charAt(0)&&(a=b.InstallDir(a));k=$.extend(!0,{},d);delete k.xcen;delete k.ycen;delete k.bin;void 0!==k.xdim&&(k.xdim=0);void 0!==k.ydim&&(k.ydim=0);k.source=
"fits2fits";k.proxyFile=a;if(h[1]){try{f=JSON.parse(h[1])}catch(x){}f&&(k.extname=f.extname,k.extnum=f.extnum,k.hdus=f.hdus,k.parent=f)}h[2]&&(h=b.cleanPath(h[2]),k.parentFile=h,k.extname?(k.parentFile=k.parentFile.replace(/\[.*\]/,""),k.parentFile+="["+k.extname+"]"):k.extnum&&0<k.extnum&&(k.parentFile=k.parentFile.replace(/\[.*\]/,""),k.parentFile.file+="["+k.extnum+"]"));e&&(k.onload=e)}k.fits2fits=!1;b.Load(a,k,{display:c})}});return!0};b.lookupColormap=function(c,a){var d;void 0===a&&(a=!0);
c||(c=b.imageOpts.colormap);if(c)for(d=0;d<b.colormaps.length;d++)if(b.colormaps[d].name===c)return b.colormaps[d];if(a)b.error("unknown colormap '"+c+"'");else return null};b.lookupCommand=function(c){var a;if(c){var d=c.toLowerCase();for(a=0;a<b.commands.length;a++)if(c=b.commands[a],c.name===d||c.alias===d||c.alias2===d)return c}return null};b.error=function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=$jscomp.makeIterator(a);d=e.next().value;var f=e.next().value;e=e.next().value;
var g,h,k,m="",l="",p=!0;b.waiting(!1);"processing"===b.fetchURL.status&&(b.fetchURL.status="error");for(h=0;h<b.images.length;h++){var r=b.images[h];(k=r.status.cur)&&r.status[k]&&r.setStatus(k,"error")}"string"===typeof f?(f=d.match(f))?f[1]?d=f[1]:f[0]&&(d=f[0]):p=!1:"object"===typeof f&&(g=f);3>a.length&&(e=!0);if(p&&(g&&g.message?d+=" ("+g.message+")":d&&(g=Error(d)),(a=b.strace(g))&&(l="\n\nStacktrace:\n"+a),b.globalOpts.alerts&&(d&&"string"===typeof d&&0>d.search(/ERROR/)&&(m="JS9 ERROR: "),
alert(m+(d+l))),e))throw g;};b.log=function(b){for(var a=[],c=0;c<arguments.length;++c)a[c-0]=arguments[c];void 0!==window.console&&void 0!==window.console.log&&console.log.apply(console,$jscomp.arrayFromIterable(a))};b.eventToCharStr=function(c){var a={37:"leftArrow",38:"upArrow",39:"rightArrow",40:"downArrow",8:"delete"},d={188:"44",109:"45",190:"46",191:"47",192:"96",220:"92",222:"39",221:"93",219:"91",173:"45",187:"61",186:"59",189:"45"},e={96:"~",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",
56:"*",57:"(",48:")",45:"_",61:"+",91:"{",93:"}",92:"|",59:":",39:'"',44:"<",46:">",47:"?"};var f="number"===typeof c?c:c.which||c.keyCode;var g=String(f);({}).hasOwnProperty.call(d,g)&&(f=d[g]);f=!c.shiftKey&&65<=f&&90>=f?String.fromCharCode(f+32):!c.shiftKey&&{}.hasOwnProperty.call(a,f)?a[f]:c.shiftKey&&{}.hasOwnProperty.call(e,f)?e[f]:String.fromCharCode(f);b.specialKey(c)&&(f="M-"+f);return f};b.eventToDisplayPos=function(b,a){b||(b=window.event);if(b.target)var c=b.target;else b.srcElement&&
(c=b.srcElement);3===c.nodeType&&(c=c.parentNode);a=a||$(c).offset();if(b.originalEvent)if(b.originalEvent.touches&&b.originalEvent.touches.length){var e=b.originalEvent.touches;c=e[0].pageX;var f=e[0].pageY}else b.originalEvent.changedTouches&&b.originalEvent.changedTouches.length?(e=b.originalEvent.changedTouches,c=e[0].pageX,f=e[0].pageY):(c=b.pageX,f=b.pageY);else c=b.pageX,f=b.pageY;b=a.left+1;a=a.top+1;f={x:Math.floor(c-b),y:Math.floor(f-a)};if(e&&e.length)for(f.touches=[{x:f.x,y:f.y}],c=1;c<
e.length;c++)f.touches[c]={x:Math.floor(e[c].pageX-b),y:Math.floor(e[c].pageY-a)};return f};b.pix2pix=function(c,a,d){if(!c||!a||0>=c.raw.wcs||0>=a.raw.wcs)return d;var e=d.x;d=d.y;var f=b.pix2wcs(c.raw.wcs,e,d).trim().split(/\s+/);var g=b.saostrtod(f[0]);b.isHMS(c.params.wcssys)&&(g*=15);c=b.saostrtod(f[1]);f=b.wcs2pix(a.raw.wcs,g,c).trim().split(/\s+/);a=parseFloat(f[0]);c=parseFloat(f[1]);.5>Math.abs(a-e)&&(a=e);.5>Math.abs(c-d)&&(c=d);return{x:a,y:c}};b.angdist=function(b,a,d,e){var c=function(a,
b){var c=[],d=Math.cos(b);c[0]=Math.cos(a)*d;c[1]=Math.sin(a)*d;c[2]=Math.sin(b);return c};b=c(b*Math.PI/180,a*Math.PI/180);d=c(d*Math.PI/180,e*Math.PI/180);return 180*-function(a,b){var c=a[0];var d=a[1];a=a[2];var e=Math.sqrt(c*c+d*d+a*a);0!=e&&(c/=e,d/=e,a/=e);e=b[0];var f=b[1];var g=b[2];b=f*c-e*d;c=g*(c*c+d*d)-a*(e*c+f*d);return 0!=b||0!=c?Math.atan2(b,c):0}(b,d)/Math.PI};b.rotatePoint=function(b,a,d){d=d||{x:0,y:0};a=Math.PI*a/180;var c=Math.cos(a);a=Math.sin(a);return{x:c*(b.x-d.x)-a*(b.y-
d.y)+d.x,y:a*(b.x-d.x)+c*(b.y-d.y)+d.y}};b.matrixMultiply=function(b,a){var c,e,f,g=b.length,h=b[0].length,k=a[0].length;var m=Array(g);for(c=0;c<g;++c)for(m[c]=Array(k),e=0;e<k;++e)for(f=m[c][e]=0;f<h;++f)m[c][e]+=b[c][f]*a[f][e];return m};b.invertMatrix3=function(b){var a,c,e=0,f=0,g=b[0][0]*b[1][1],h=[[0,0,0],[0,0,0],[0,0,0]];for(a=0;3>a;a++)for(c=0;2>c;c++)if(void 0===b[a][c]||Number.isNaN(b[a][c]))return null;0<=g?e+=g:f+=g;g=-b[0][1]*b[1][0];0<=g?e+=g:f+=g;a=e+f;if(0===a||1E-15>Math.abs(a/(e-
f)))return null;a=1/a;h[0][0]=b[1][1]*a;h[1][0]=-b[1][0]*a;h[0][1]=-b[0][1]*a;h[1][1]=b[0][0]*a;h[2][0]=-(b[2][0]*h[0][0]+b[2][1]*h[1][0]);h[2][1]=-(b[2][0]*h[0][1]+b[2][1]*h[1][1]);return h};b.isNumber=function(b){return!isNaN(parseFloat(b))&&isFinite(b)};b.notNull=function(b){return void 0!==b&&null!==b};b.isNull=function(b){return void 0===b||null===b};b.defNull=function(c,a){return b.notNull(c)?c:a};b.isWCSSys=function(b){return"image"!==b&&"physical"!==b};b.notWCS=function(b){return"image"===
b||"physical"===b};b.isHMS=function(c,a){a=a||String.fromCharCode(b.saodtype());return(":"===a||"h"===a)&&"galactic"!==c&&"ecliptic"!==c};b.ishealpix=function(b){return b&&"table"===b.imtab&&b.raw&&b.raw.header&&b.raw.header.CTYPE1&&b.raw.header.CTYPE1.match(/--HPX/i)};b.proxyAvailable=function(){return b.globalOpts.loadProxy&&!b.allinone&&"none"!==b.globalOpts.helperType&&b.globalOpts.workDir};b.cardpars=function(c){var a=c.slice(0,8).trim();if("HISTORY"===a||"COMMENT"===a)return[a,c.slice(9).trim()];
if("="===c[8])return c=c.slice(10).replace(/'/g," ").replace(/ \/.*/,"").trim(),"T"===c?c=!0:"F"===c?c=!1:b.isNumber(c)&&(c=parseFloat(c)),[a,c]};b.raw2FITS=function(c,a){var d,e=!1,f="",g={};var h=/^(NAXIS|CRPIX|CRVAL|CTYPE|CUNIT|CDELT)[34567]/;var k=function(a,b,c,d){var e=a;if("XTENSION"!==b||c){var f=new RegExp(b+" *= *(-?[-+]?[0-9]*.?[0-9]*([eE][-+]?[0-9]+)?) *");a?(a=a.replace(f,"$1"),a=parseFloat(a)):a=void 0;a!==c&&(e=sprintf("%-8s= %20s / %-47s",b,c,d||""))}else e=sprintf("%s  = %20s / %-47s",
"SIMPLE","T","file does conform to FITS standard");g[b]=!0;return e};if(!c)return f;a=a||{};"boolean"===typeof a&&(a={addcr:a});if(c.card||c.cardstr){var m=c.header||{};var l=c.card?c.card.length:c.ncard;for(d=0;d<l;d++)if(h=c.card?c.card[d].slice(0,80):c.cardstr.slice(80*d,80*(d+1)),!a.notab||!h.match(/^TAB(TYP|MIN|MAX|DIM)[1,2]/)){if(h.match(/^XTENSION/)&&0===d&&a.simple)f+=k(h,"XTENSION");else if(h.match(/^BITPIX /)&&c.bitpix)f+=k(h,"BITPIX",c.bitpix,"bits/pixel");else if(h.match(/^NAXIS1 /)&&
c.width)f+=k(h,"NAXIS1",c.width,"x image dim");else if(h.match(/^NAXIS2 /)&&c.height)f+=k(h,"NAXIS2",c.height,"y image dim");else if(h.match(/^CRPIX1 /)&&b.notNull(m.CRPIX1))f+=k(h,"CRPIX1",m.CRPIX1,"ref point");else if(h.match(/^CRPIX2 /)&&b.notNull(m.CRPIX2))f+=k(h,"CRPIX2",m.CRPIX2,"ref point");else if(h.match(/^CDELT1 /)&&b.notNull(m.CDELT1))f+=k(h,"CDELT1",m.CDELT1,"deg/pixel");else if(h.match(/^CDELT2 /)&&b.notNull(m.CDELT2))f+=k(h,"CDELT2",m.CDELT2,"deg/pixel");else if(h.match(/^CD1_1 /)&&
b.notNull(m.CD1_1))f+=k(h,"CD1_1",m.CD1_1,"WCS matrix value");else if(h.match(/^CD1_2 /)&&b.notNull(m.CD1_2))f+=k(h,"CD1_2",m.CD1_2,"WCS matrix value");else if(h.match(/^CD2_1 /)&&b.notNull(m.CD2_1))f+=k(h,"CD2_1",m.CD2_1,"WCS matrix value");else if(h.match(/^CD2_2 /)&&b.notNull(m.CD2_2))f+=k(h,"CD2_2",m.CD2_2,"WCS matrix value");else if(h.match(/^LTV1 /)&&b.notNull(m.LTV1))f+=k(h,"LTV1",m.LTV1,"IRAF ref. point");else if(h.match(/^LTV2 /)&&b.notNull(m.LTV2))f+=k(h,"LTV2",m.LTV2,"IRAF ref. point");
else if(h.match(/^LTM1_1 /)&&b.notNull(m.LTM1_1))f+=k(h,"LTM1_1",m.LTM1_1,"IRAF matrix value");else if(h.match(/^LTM1_2 /)&&b.notNull(m.LTM1_2))f+=k(h,"LTM1_2",m.LTM1_2,"IRAF matrix value");else if(h.match(/^LTM2_1 /)&&b.notNull(m.LTM2_1))f+=k(h,"LTM2_1",m.LTM2_1,"IRAF matrix value");else if(h.match(/^LTM2_2 /)&&b.notNull(m.LTM2_2))f+=k(h,"LTM2_2",m.LTM2_2,"IRAF matrix value");else if(a.twoaxes&&h.match(/^NAXIS /))f+=k(h,"NAXIS",2,"number of data axes");else if(a.twoaxes&&h.match(/^(NAXIS|CRPIX|CRVAL|CTYPE|CUNIT|CDELT)[34567]/))continue;
else if(a.twoaxes&&h.match(/^(DATASUM|CHECKSUM)/))continue;else"END "===h.substring(0,4)?(b.notNull(m.LTV1)&&!g.LTV1&&(f+=k(null,"LTV1",m.LTV1,"IRAF ref. point"),a.addcr&&(f+="\n")),b.notNull(m.LTV2)&&!g.LTV2&&(f+=k(null,"LTV2",m.LTV2,"IRAF ref. point"),a.addcr&&(f+="\n")),b.notNull(m.LTM1_1)&&!g.LTM1_1&&(f+=k(null,"LTM1_1",m.LTM1_1,"IRAF matrix value"),a.addcr&&(f+="\n")),b.notNull(m.LTM1_2)&&!g.LTM1_2&&(f+=k(null,"LTM1_2",m.LTM1_2,"IRAF matrix value"),a.addcr&&(f+="\n")),b.notNull(m.LTM2_1)&&!g.LTM2_1&&
(f+=k(null,"LTM2_1",m.LTM2_1,"IRAF matrix value"),a.addcr&&(f+="\n")),b.notNull(m.LTM2_2)&&!g.LTM2_2&&(f+=k(null,"LTM2_2",m.LTM2_2,"IRAF matrix value"),a.addcr&&(f+="\n")),f+=h,e=!0):f+=h;a.addcr&&(f+="\n")}}else if(c.header||c.BITPIX){c=c.header?c.header:c;if(void 0!==c.SIMPLE||void 0!==c.simple)l=void 0!==c.SIMPLE?c.SIMPLE:c.simple,!0===l?l="T":!1===l&&(l="F"),f+=sprintf("%-8s= %20s / %-47s","SIMPLE",l,"conforms to FITS standard"),a.addcr&&(f+="\n");if(void 0!==c.BITPIX||void 0!==c.bitpix)l=void 0!==
c.BITPIX?c.BITPIX:c.bitpix,f+=sprintf("%-8s= %20s / %-47s","BITPIX",l,"bits/pixel"),a.addcr&&(f+="\n");k=$jscomp.makeIterator(Object.keys(c));for(d=k.next();!d.done;d=k.next())if(d=d.value,"js9Protocol"!==d&&"js9Endian"!==d&&"SIMPLE"!==d&&"simple"!==d&&"BITPIX"!==d&&"bitpix"!==d&&("END"===d&&(e=!0),a.twoaxes&&"NAXIS"===d&&(c[d]=2),!a.twoaxes||!d.match(h))){if(d.match(/HISTORY__[0-9]+/))f+=sprintf("HISTORY %-72s",c[d]);else if(d.match(/COMMENT__[0-9]+/))f+=sprintf("COMMENT %-72s",c[d]);else{l=c[d];
!0===l?l="T":!1===l?l="F":""===l?l="' '":Number.isNaN(l)?l="NaN":b.isNumber(l)||"'"===l.charAt(0)||(l="'"+l+"'");l=sprintf("%-8s= %20s",d,l);m=80-l.length;if(0<m)for(d=0;d<m;d++)l+=" ";f+=l}a.addcr&&(f+="\n")}}e||(f+=sprintf("%-8s%-72s","END"," "),a.addcr&&(f+="\n"));return f};b.hdus2Str=function(c){var a,d="";if(!c)return d;for(a=0;a<c.length;a++){var e=c[a];var f=e.name?e.name:0===a?"Primary":"N/A";d+=sprintf("<b>#%d</b>:&#09;<b>name</b>: %s&#09;<b>type</b>: %s",e.hdu,f,e.type);switch(e.type){case "image":d+=
sprintf("&#09;<b>bitpix</b>: %d&#09;<b>naxis</b>: %d",e.bitpix,e.naxis);if(e.naxes.length){d+="&#09;<b>axes</b>: [";for(f=0;f<e.naxes.length;f++)d+=sprintf("%d",e.naxes[f]),f!==e.naxes.length-1&&(d+=", ");d+="]"}break;case "table":case "ascii":f="&#09;";9>=e.rows&&(f+="&#09;");d+=sprintf("&#09;<b>rows</b>: %d%s<b>cols</b>: [",e.rows,f);for(f=0;f<e.cols.length;f++)d+=""+e.cols[f].name,b.notNull(e.cols[f].min)&&b.notNull(e.cols[f].max)&&(d+=":"+e.cols[f].min+":"+e.cols[f].max),f!==e.cols.length-1&&
(d+=", ");d+="]"}d+="\n\n"}return d};CanvasRenderingContext2D.prototype.clear=CanvasRenderingContext2D.prototype.clear||function(b){b&&(this.save(),this.setTransform(1,0,0,1,0,0));this.clearRect(0,0,this.canvas.width,this.canvas.height);b&&this.restore()};b.searchbar=function(c,a){c=$(c);var d=function(a){g.unmark({done:function(){g.mark(a,{caseSensitive:k.opts.matchcase,diacritics:k.opts.diacritics,accuracy:k.opts.matchwords?"exactly":"partially",wildcards:k.opts.matchwildcards?"enabled":"disabled",
done:function(){k.results=g.find("mark");k.currentIndex=0;f()}})}})},e=function(a){var b=a.prop("data-btn");k.opts[b]?(a.removeClass("JS9SearchButton-false"),a.addClass("JS9SearchButton-true")):(a.removeClass("JS9SearchButton-true"),a.addClass("JS9SearchButton-false"))},f=function(){if(k.results.length){var a=k.results.eq(k.currentIndex);k.results.removeClass("current");a.length&&(a.addClass("current"),a=a.position().top,0>a||a>h.height())&&(a=a+h.scrollTop()-50,h.scrollTop(a))}};a=a||".JS9AnalysisText";
if(c.is(a))var g=c;else if(g=c.find(a),!g.length)return;var h=c.find(b.lightOpts[b.LIGHTWIN].drag);h.length||(h=c);var k=h.find(".JS9Searchbar");if(k.length)k.css("display","block");else{k=$("<div>").addClass("JS9Searchbar").appendTo(h);k.opts={matchcase:!1,matchdiacritics:!1,matchwords:!1,matchwildcards:!1};var m=$("<input type='search'>").addClass("JS9SearchInput").appendTo(k);m.on("input",function(){d(m.val())});k.opts.matchwildcards?m.prop("placeholder","sea*rch template?"):m.prop("placeholder",
"search term(s)");a=$("<button>").addClass("JS9SearchButton").prop("data-btn","next").html("&darr;").appendTo(k);var l=$("<button>").addClass("JS9SearchButton").prop("data-btn","prev").html("&uarr;").appendTo(k);a.add(l).on("click",function(a){k.results&&k.results.length&&(k.currentIndex+=$(a.currentTarget).is(l)?-1:1,0>k.currentIndex&&(k.currentIndex=k.results.length-1),k.currentIndex>k.results.length-1&&(k.currentIndex=0),f())});var p=$("<button>").addClass("JS9SearchButton JS9SearchButton-"+k.opts.matchcase).prop("data-btn",
"matchcase").html("Match Case").appendTo(k);p.on("click",function(){k.opts.matchcase=!k.opts.matchcase;e(p);d(m.val())});e(p);var r=$("<button>").addClass("JS9SearchButton JS9SearchButton-"+k.opts.matchdiacritics).prop("data-btn","matchdiacritics").html("Match Diacritics").appendTo(k);r.on("click",function(){k.opts.matchdiacritics=!k.opts.matchdiacritics;e(r);d(m.val())});e(r);var n=$("<button>").addClass("JS9SearchButton JS9SearchButton-"+k.opts.matchwords).prop("data-btn","matchwords").html("Whole Words").appendTo(k);
n.on("click",function(){k.opts.matchwords=!k.opts.matchwords;e(n);d(m.val())});e(n);var u=$("<button>").addClass("JS9SearchButton JS9SearchButton-"+k.opts.matchwildcards).prop("data-btn","matchwildcards").html("Wildcards").appendTo(k);u.on("click",function(){k.opts.matchwildcards=!k.opts.matchwildcards;k.opts.matchwildcards?m.prop("placeholder","sea*rch template?"):m.prop("placeholder","search term(s)");e(u);d(m.val())});e(u);$("<button>").addClass("JS9SearchButton").prop("data-btn","close").html("Close").appendTo(k).on("click",
function(){g.unmark();m.val("");k.css("display","none")});h.css("outline","none");h.attr("tabindex","0");h.on("keydown",function(a){var c=String.fromCharCode(a.which||a.keyCode);b.specialKey(a)&&"F"===c&&("none"===k.css("display")?(k.css("display","block"),m.focus()):(g.unmark(),m.val(""),k.css("display","none")))})}};b.tooltip=function(c,a,d,e,f,g){var h=function(a){return a.replace(/\$([a-zA-Z0-9_./]+)/g,function(a,c,d){c=c.split(".");switch(c[0]){case "im":d=e;break;case "xreg":d=f;break;case "evt":d=
g;break;case "data":d=f.data;break;default:return a}for(a=1;a<c.length;a++)d=d[c[a]],d=b.isNumber(d)?d.toFixed(6):d;void 0===d&&(d="");return d})};d?(d=h(d),e.display.tooltip.html(d),h=e.display.tooltip.width(),d=e.display.tooltip.height(),c=Math.max(2,Math.min(c,e.display.width-(h+10))),a=Math.max(2,Math.min(a,e.display.height-(d+10))),e.display.tooltip.css({left:c,top:a,display:"inline-block"})):e.display.tooltip.html("").css({left:-9999,display:"none"})};b.xeqByName=function(c){for(var a=[],d=
0;d<arguments.length;++d)a[d-0]=arguments[d];d=$jscomp.makeIterator(a);var e=d.next().value;d=d.next().value;a=a.slice(2);var f=typeof e;switch(f){case "function":return e.apply(d,a);case "string":(f=/\(\s*([^)]+?)\s*\)/.exec(e))&&f[1]&&(e=e.slice(0,f.index),a=f[1].split(/\s*,\s*/));f=e.split(".");var g=f.pop();for(e=0;e<f.length;e++)d=d[f[e]];"undefined"===typeof d[g]&&"function"===typeof b.publics[g]&&(d=b.publics);return d[g].apply(d,$jscomp.arrayFromIterable(a));default:b.error("unknown func type: "+
f)}};b.varByName=function(c,a){a=a||b;var d=c.split(".");var e=d.pop();for(c=0;c<d.length;c++)if(a=a[d[c]],!a)return null;return a[e]};b.mergePrefs=function(c){var a,d=!1;c=c||{};var e=$jscomp.makeIterator(Object.keys(c));for(a=e.next();!a.done;a=e.next()){var f=a.value;if("config"===f)"merge"===c[f].objects&&(d=!0);else if({}.hasOwnProperty.call(b,f)){var g=typeof b[f];a=typeof c[f];if(g===a||"string"===a)switch(g){case "object":$.isArray(c[f])?b[f]=c[f]:d?$.extend(!0,b[f],c[f]):$.extend(b[f],c[f]);
break;case "number":case "string":b[f]=c[f]}}}};b.loadPrefs=function(c,a){$.ajax({url:c,cache:!1,dataType:"json",mimeType:"application/json",async:!1,success:function(a){b.mergePrefs(a)},error:function(d,e,f){a&&b.log("JS9 prefs file not available: %s",c)}})};b.isTypedArray=function(b){b=Object.prototype.toString.call(b);return{}.hasOwnProperty.call({"[object Int8Array]":!0,"[object Uint8Array]":!0,"[object Uint8ClampedArray]":!0,"[object Int16Array]":!0,"[object Uint16Array]":!0,"[object Int32Array]":!0,
"[object Uint32Array]":!0,"[object Float32Array]":!0,"[object Float64Array]":!0},b)};b.Starbase=function(b,a){var c,e,f=0;var g=function(a){var b;for(b=0;b<a.length;b++)if(null===a[b].match(/^-+$/))return 0;return b};var h=function(a){return a};this.head={};this.convFuncs=[];this.data=[];this.delims=[];if(b){a=a||{};b=b.replace(/\s+$/,"").split("\n");if(a.skip&&(c=a.skip.split(""))&&c.length)for(;f<b.length&&(c[0]===b[f][0]||"\n"===c[1]&&""===b[f]);f++);if(void 0!==b[f]&&void 0!==b[f+1]){this.headline=
b[f++].trim().split(/ *\t */);a.units&&(this.unitline=b[f++].trim().split(/ *\t */));this.dashline=b[f++].trim().split(/ *\t */);for(e=g(this.dashline);0===e||e!==this.headline.length;)a.units?(this.headline=this.unitline,this.unitline=this.dashline):this.headline=this.dashline,this.dashline=b[f++].trim().split(/ *\t */),e=g(this.dashline);for(g=0;g<this.headline.length;g++)this.headline[g]=this.headline[g].replace(/\./g,"_"),this.convFuncs[g]=a.convFuncs&&a.convFuncs[this.headline[g]]?a.convFuncs[this.headline[g]]:
a.convFuncs&&a.convFuncs.def?a.convFuncs.def:h;for(a=0;f<b.length&&(!c||!c.length||c[0]!==b[f][0]&&("\n"!==c[1]||""!==b[f]));f++,a++)for(this.data[a]=b[f].split("\t"),g=0;g<this.data[a].length;g++)h=this.convFuncs[g](this.data[a][g]),this.data[a][g]=h.val,this.delims[g]=h.delim||null;for(g=0;g<this.headline.length;g++)this[this.headline[g]]=g}}};b.colorToHex=function(b){var a={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",
black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",
darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",
lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",
mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",
peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",
violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd3",antiquewhite1:"#ffefdb",antiquewhite2:"#eedfcc",antiquewhite3:"#cdc0b0",antiquewhite4:"#8b8378",cadetblue1:"#98f5ff",cadetblue2:"#8ee5ee",cadetblue3:"#7ac5cd",cadetblue4:"#53868b",darkgoldenrod1:"#ffb90f",darkgoldenrod2:"#eead0e",darkgoldenrod3:"#cd950c",darkgoldenrod4:"#8b6508",darkgrey:"#a9a9a9",darkolivegreen1:"#caff70",darkolivegreen2:"#bcee68",darkolivegreen3:"#a2cd5a",darkolivegreen4:"#6e8b3d",
darkorange1:"#ff7f00",darkorange2:"#ee7600",darkorange3:"#cd6600",darkorange4:"#8b4500",darkorchid1:"#bf3eff",darkorchid2:"#b23aee",darkorchid3:"#9a32cd",darkorchid4:"#68228b",darkseagreen1:"#c1ffc1",darkseagreen2:"#b4eeb4",darkseagreen3:"#9bcd9b",darkseagreen4:"#698b69",darkslategray1:"#97ffff",darkslategray2:"#8deeee",darkslategray3:"#79cdcd",darkslategray4:"#528b8b",darkslategrey:"#2f4f4f",deeppink1:"#ff1493",deeppink2:"#ee1289",deeppink3:"#cd1076",deeppink4:"#8b0a50",deepskyblue1:"#00bfff",deepskyblue2:"#00b2ee",
deepskyblue3:"#009acd",deepskyblue4:"#00688b",dimgrey:"#696969",dodgerblue1:"#1e90ff",dodgerblue2:"#1c86ee",dodgerblue3:"#1874cd",dodgerblue4:"#104e8b",hotpink1:"#ff6eb4",hotpink2:"#ee6aa7",hotpink3:"#cd6090",hotpink4:"#8b3a62",indianred:"#cd5c5c",indianred1:"#ff6a6a",indianred2:"#ee6363",indianred3:"#cd5555",indianred4:"#8b3a3a",lavenderblush1:"#fff0f5",lavenderblush2:"#eee0e5",lavenderblush3:"#cdc1c5",lavenderblush4:"#8b8386",lemonchiffon1:"#fffacd",lemonchiffon2:"#eee9bf",lemonchiffon3:"#cdc9a5",
lemonchiffon4:"#8b8970",lightblue1:"#bfefff",lightblue2:"#b2dfee",lightblue3:"#9ac0cd",lightblue4:"#68838b",lightcyan1:"#e0ffff",lightcyan2:"#d1eeee",lightcyan3:"#b4cdcd",lightcyan4:"#7a8b8b",lightgoldenrod:"#eedd82",lightgoldenrod1:"#ffec8b",lightgoldenrod2:"#eedc82",lightgoldenrod3:"#cdbe70",lightgoldenrod4:"#8b814c",lightgray:"#d3d3d3",lightpink1:"#ffaeb9",lightpink2:"#eea2ad",lightpink3:"#cd8c95",lightpink4:"#8b5f65",lightsalmon1:"#ffa07a",lightsalmon2:"#ee9572",lightsalmon3:"#cd8162",lightsalmon4:"#8b5742",
lightskyblue1:"#b0e2ff",lightskyblue2:"#a4d3ee",lightskyblue3:"#8db6cd",lightskyblue4:"#607b8b",lightslateblue:"#8470ff",lightslategrey:"#778899",lightsteelblue1:"#cae1ff",lightsteelblue2:"#bcd2ee",lightsteelblue3:"#a2b5cd",lightsteelblue4:"#6e7b8b",lightyellow1:"#ffffe0",lightyellow2:"#eeeed1",lightyellow3:"#cdcdb4",lightyellow4:"#8b8b7a",mediumorchid1:"#e066ff",mediumorchid2:"#d15fee",mediumorchid3:"#b452cd",mediumorchid4:"#7a378b",mediumpurple1:"#ab82ff",mediumpurple2:"#9f79ee",mediumpurple3:"#8968cd",
mediumpurple4:"#5d478b",mistyrose1:"#ffe4e1",mistyrose2:"#eed5d2",mistyrose3:"#cdb7b5",mistyrose4:"#8b7d7b",navajowhite1:"#ffdead",navajowhite2:"#eecfa1",navajowhite3:"#cdb38b",navajowhite4:"#8b795e",navyblue:"#000080",olivedrab1:"#c0ff3e",olivedrab2:"#b3ee3a",olivedrab3:"#9acd32",olivedrab4:"#698b22",orangered1:"#ff4500",orangered2:"#ee4000",orangered3:"#cd3700",orangered4:"#8b2500",palegreen1:"#9aff9a",palegreen2:"#90ee90",palegreen3:"#7ccd7c",palegreen4:"#548b54",paleturquoise1:"#bbffff",paleturquoise2:"#aeeeee",
paleturquoise3:"#96cdcd",paleturquoise4:"#668b8b",palevioletred1:"#ff82ab",palevioletred2:"#ee799f",palevioletred3:"#cd6889",palevioletred4:"#8b475d",peachpuff1:"#ffdab9",peachpuff2:"#eecbad",peachpuff3:"#cdaf95",peachpuff4:"#8b7765",rosybrown1:"#ffc1c1",rosybrown2:"#eeb4b4",rosybrown3:"#cd9b9b",rosybrown4:"#8b6969",royalblue1:"#4876ff",royalblue2:"#436eee",royalblue3:"#3a5fcd",royalblue4:"#27408b",seagreen1:"#54ff9f",seagreen2:"#4eee94",seagreen3:"#43cd80",seagreen4:"#2e8b57",skyblue1:"#87ceff",
skyblue2:"#7ec0ee",skyblue3:"#6ca6cd",skyblue4:"#4a708b",slateblue1:"#836fff",slateblue2:"#7a67ee",slateblue3:"#6959cd",slateblue4:"#473c8b",slategray1:"#c6e2ff",slategray2:"#b9d3ee",slategray3:"#9fb6cd",slategray4:"#6c7b8b",slategrey:"#708090",springgreen1:"#00ff7f",springgreen2:"#00ee76",springgreen3:"#00cd66",springgreen4:"#008b45",steelblue1:"#63b8ff",steelblue2:"#5cacee",steelblue3:"#4f94cd",steelblue4:"#36648b",violetred:"#d02090",violetred1:"#ff3e96",violetred2:"#ee3a8c",violetred3:"#cd3278",
violetred4:"#8b2252",webgray:"#808080",webgreen:"#008000",webgrey:"#808080",webmaroon:"#800000",webpurple:"#800080",x11gray:"#bebebe",x11green:"#00ff00",x11grey:"#bebebe",x11maroon:"#b03060",x11purple:"#a020f0",aquamarine1:"#7fffd4",aquamarine2:"#76eec6",aquamarine3:"#66cdaa",aquamarine4:"#458b74",azure1:"#f0ffff",azure2:"#e0eeee",azure3:"#c1cdcd",azure4:"#838b8b",bisque1:"#ffe4c4",bisque2:"#eed5b7",bisque3:"#cdb79e",bisque4:"#8b7d6b",blue1:"#0000ff",blue2:"#0000ee",blue3:"#0000cd",blue4:"#00008b",
brown1:"#ff4040",brown2:"#ee3b3b",brown3:"#cd3333",brown4:"#8b2323",burlywood1:"#ffd39b",burlywood2:"#eec591",burlywood3:"#cdaa7d",burlywood4:"#8b7355",chartreuse1:"#7fff00",chartreuse2:"#76ee00",chartreuse3:"#66cd00",chartreuse4:"#458b00",chocolate1:"#ff7f24",chocolate2:"#ee7621",chocolate3:"#cd661d",chocolate4:"#8b4513",coral1:"#ff7256",coral2:"#ee6a50",coral3:"#cd5b45",coral4:"#8b3e2f",cornsilk1:"#fff8dc",cornsilk2:"#eee8cd",cornsilk3:"#cdc8b1",cornsilk4:"#8b8878",cyan1:"#00ffff",cyan2:"#00eeee",
cyan3:"#00cdcd",cyan4:"#008b8b",firebrick1:"#ff3030",firebrick2:"#ee2c2c",firebrick3:"#cd2626",firebrick4:"#8b1a1a",gold1:"#ffd700",gold2:"#eec900",gold3:"#cdad00",gold4:"#8b7500",goldenrod1:"#ffc125",goldenrod2:"#eeb422",goldenrod3:"#cd9b1d",goldenrod4:"#8b6914",gray0:"#000000",gray1:"#030303",gray10:"#1a1a1a",gray100:"#ffffff",gray11:"#1c1c1c",gray12:"#1f1f1f",gray13:"#212121",gray14:"#242424",gray15:"#262626",gray16:"#292929",gray17:"#2b2b2b",gray18:"#2e2e2e",gray19:"#303030",gray2:"#050505",gray20:"#333333",
gray21:"#363636",gray22:"#383838",gray23:"#3b3b3b",gray24:"#3d3d3d",gray25:"#404040",gray26:"#424242",gray27:"#454545",gray28:"#474747",gray29:"#4a4a4a",gray3:"#080808",gray30:"#4d4d4d",gray31:"#4f4f4f",gray32:"#525252",gray33:"#545454",gray34:"#575757",gray35:"#595959",gray36:"#5c5c5c",gray37:"#5e5e5e",gray38:"#616161",gray39:"#636363",gray4:"#0a0a0a",gray40:"#666666",gray41:"#696969",gray42:"#6b6b6b",gray43:"#6e6e6e",gray44:"#707070",gray45:"#737373",gray46:"#757575",gray47:"#787878",gray48:"#7a7a7a",
gray49:"#7d7d7d",gray5:"#0d0d0d",gray50:"#7f7f7f",gray51:"#828282",gray52:"#858585",gray53:"#878787",gray54:"#8a8a8a",gray55:"#8c8c8c",gray56:"#8f8f8f",gray57:"#919191",gray58:"#949494",gray59:"#969696",gray6:"#0f0f0f",gray60:"#999999",gray61:"#9c9c9c",gray62:"#9e9e9e",gray63:"#a1a1a1",gray64:"#a3a3a3",gray65:"#a6a6a6",gray66:"#a8a8a8",gray67:"#ababab",gray68:"#adadad",gray69:"#b0b0b0",gray7:"#121212",gray70:"#b3b3b3",gray71:"#b5b5b5",gray72:"#b8b8b8",gray73:"#bababa",gray74:"#bdbdbd",gray75:"#bfbfbf",
gray76:"#c2c2c2",gray77:"#c4c4c4",gray78:"#c7c7c7",gray79:"#c9c9c9",gray8:"#141414",gray80:"#cccccc",gray81:"#cfcfcf",gray82:"#d1d1d1",gray83:"#d4d4d4",gray84:"#d6d6d6",gray85:"#d9d9d9",gray86:"#dbdbdb",gray87:"#dedede",gray88:"#e0e0e0",gray89:"#e3e3e3",gray9:"#171717",gray90:"#e5e5e5",gray91:"#e8e8e8",gray92:"#ebebeb",gray93:"#ededed",gray94:"#f0f0f0",gray95:"#f2f2f2",gray96:"#f5f5f5",gray97:"#f7f7f7",gray98:"#fafafa",gray99:"#fcfcfc",green1:"#00ff00",green2:"#00ee00",green3:"#00cd00",green4:"#008b00",
grey:"#bebebe",grey0:"#000000",grey1:"#030303",grey10:"#1a1a1a",grey100:"#ffffff",grey11:"#1c1c1c",grey12:"#1f1f1f",grey13:"#212121",grey14:"#242424",grey15:"#262626",grey16:"#292929",grey17:"#2b2b2b",grey18:"#2e2e2e",grey19:"#303030",grey2:"#050505",grey20:"#333333",grey21:"#363636",grey22:"#383838",grey23:"#3b3b3b",grey24:"#3d3d3d",grey25:"#404040",grey26:"#424242",grey27:"#454545",grey28:"#474747",grey29:"#4a4a4a",grey3:"#080808",grey30:"#4d4d4d",grey31:"#4f4f4f",grey32:"#525252",grey33:"#545454",
grey34:"#575757",grey35:"#595959",grey36:"#5c5c5c",grey37:"#5e5e5e",grey38:"#616161",grey39:"#636363",grey4:"#0a0a0a",grey40:"#666666",grey41:"#696969",grey42:"#6b6b6b",grey43:"#6e6e6e",grey44:"#707070",grey45:"#737373",grey46:"#757575",grey47:"#787878",grey48:"#7a7a7a",grey49:"#7d7d7d",grey5:"#0d0d0d",grey50:"#7f7f7f",grey51:"#828282",grey52:"#858585",grey53:"#878787",grey54:"#8a8a8a",grey55:"#8c8c8c",grey56:"#8f8f8f",grey57:"#919191",grey58:"#949494",grey59:"#969696",grey6:"#0f0f0f",grey60:"#999999",
grey61:"#9c9c9c",grey62:"#9e9e9e",grey63:"#a1a1a1",grey64:"#a3a3a3",grey65:"#a6a6a6",grey66:"#a8a8a8",grey67:"#ababab",grey68:"#adadad",grey69:"#b0b0b0",grey7:"#121212",grey70:"#b3b3b3",grey71:"#b5b5b5",grey72:"#b8b8b8",grey73:"#bababa",grey74:"#bdbdbd",grey75:"#bfbfbf",grey76:"#c2c2c2",grey77:"#c4c4c4",grey78:"#c7c7c7",grey79:"#c9c9c9",grey8:"#141414",grey80:"#cccccc",grey81:"#cfcfcf",grey82:"#d1d1d1",grey83:"#d4d4d4",grey84:"#d6d6d6",grey85:"#d9d9d9",grey86:"#dbdbdb",grey87:"#dedede",grey88:"#e0e0e0",
grey89:"#e3e3e3",grey9:"#171717",grey90:"#e5e5e5",grey91:"#e8e8e8",grey92:"#ebebeb",grey93:"#ededed",grey94:"#f0f0f0",grey95:"#f2f2f2",grey96:"#f5f5f5",grey97:"#f7f7f7",grey98:"#fafafa",grey99:"#fcfcfc",honeydew1:"#f0fff0",honeydew2:"#e0eee0",honeydew3:"#c1cdc1",honeydew4:"#838b83",ivory1:"#fffff0",ivory2:"#eeeee0",ivory3:"#cdcdc1",ivory4:"#8b8b83",khaki1:"#fff68f",khaki2:"#eee685",khaki3:"#cdc673",khaki4:"#8b864e",magenta1:"#ff00ff",magenta2:"#ee00ee",magenta3:"#cd00cd",magenta4:"#8b008b",maroon1:"#ff34b3",
maroon2:"#ee30a7",maroon3:"#cd2990",maroon4:"#8b1c62",orange1:"#ffa500",orange2:"#ee9a00",orange3:"#cd8500",orange4:"#8b5a00",orchid1:"#ff83fa",orchid2:"#ee7ae9",orchid3:"#cd69c9",orchid4:"#8b4789",pink1:"#ffb5c5",pink2:"#eea9b8",pink3:"#cd919e",pink4:"#8b636c",plum1:"#ffbbff",plum2:"#eeaeee",plum3:"#cd96cd",plum4:"#8b668b",purple1:"#9b30ff",purple2:"#912cee",purple3:"#7d26cd",purple4:"#551a8b",red1:"#ff0000",red2:"#ee0000",red3:"#cd0000",red4:"#8b0000",salmon1:"#ff8c69",salmon2:"#ee8262",salmon3:"#cd7054",
salmon4:"#8b4c39",seashell1:"#fff5ee",seashell2:"#eee5de",seashell3:"#cdc5bf",seashell4:"#8b8682",sienna1:"#ff8247",sienna2:"#ee7942",sienna3:"#cd6839",sienna4:"#8b4726",snow1:"#fffafa",snow2:"#eee9e9",snow3:"#cdc9c9",snow4:"#8b8989",tan1:"#ffa54f",tan2:"#ee9a49",tan3:"#cd853f",tan4:"#8b5a2b",thistle1:"#ffe1ff",thistle2:"#eed2ee",thistle3:"#cdb5cd",thistle4:"#8b7b8b",tomato1:"#ff6347",tomato2:"#ee5c42",tomato3:"#cd4f39",tomato4:"#8b3626",turquoise1:"#00f5ff",turquoise2:"#00e5ee",turquoise3:"#00c5cd",
turquoise4:"#00868b",wheat1:"#ffe7ba",wheat2:"#eed8ae",wheat3:"#cdba96",wheat4:"#8b7e66",yellow1:"#ffff00",yellow2:"#eeee00",yellow3:"#cdcd00",yellow4:"#8b8b00"};if(!b)return"";var c=b.toLowerCase();return"undefined"!==typeof a[c]?a[c]:(a=b.match(/rgb\((\d+)[,\s]+(\d+)[,\s]+(\d+)\)/i))?sprintf("#%02x%02x%02x",a[1],a[2],a[3]):b};b.parseStaticColors=function(c){var a,d=[];if("string"===typeof c)try{c=JSON.parse(c)}catch(h){}$.isArray(c)||b.error("invalid input for static colors");for(a=0;a<c.length;a++){var e=
"string"===typeof c[a]?c[a].split(":"):c[a];if($.isArray(e)){e[0]||b.error("no color specified: "+c[a]);try{var f=tinycolor(e[0])}catch(h){b.error("invalid color: "+e[0])}b.isNull(e[1])?(e[1]=1,e[2]=Infinity):e[1]=""===e[1]?-Infinity:parseFloat(e[1]);b.isNull(e[2])?e[2]=e[1]:e[2]=""===e[2]?Infinity:parseFloat(e[2]);var g={active:!0,red:f._r,green:f._g,blue:f._b,alpha:255*f._a,min:e[1],max:e[2]};"string"===typeof e[0]&&(g.name=e[0])}else"object"===typeof e&&(g=e);d.push(g)}d.sort(function(a,b){return a.min-
b.min});return d};b.lookupStaticColor=function(b,a,d){var c={red:0,green:0,blue:0,alpha:0};if(b&&b.staticObj){c=b.params.nocolor||c;if(a<b.staticObj.colors[0].min)return c;if(d&&d[a])return d[a];a:{var f=b.staticObj.colors;for(var g,h,k=0,m=f.length-1;k<=m;)if(g=Math.floor((k+m)/2),h=f[g],a>=h.min&&a<=h.max){f=g;break a}else h.max<a?k=g+1:m=g-1;f=-1}0>f?b=c:(b=b.staticObj.colors[f],b.active||(b=c));d&&1E7>=a&&(d[a]=b);return b}return c};b.strtoscaled=function(c){c=b.saostrtod(c);var a=String.fromCharCode(b.saodtype());
switch(a){case '"':c/=3600;break;case "'":c/=60;break;case "r":c*=180/Math.PI}return{dval:c,dtype:a}};b.cleanPath=function(c,a){if(!c)return"";var d=c.replace(/\[.*\]/,"");d.match(/(<(animation|form|math|maction|svg|script|video)\s|<\?xml|javascript:|on.*&equals;|alert\(|alert&lpar;)|window\./i)&&(b.globalOpts.alerts=!0,b.error((a||"filename")+" is susceptible to XSS attack: "+d));return c.trim().replace(/\/\.\//,"/").replace(/^\.\//,"")};b.fixPath=function(c,a){a=a||{};window.electron&&b.desktopOpts.currentPath&&
!1!==a.fixpath&&!c.match(b.URLEXP)&&(c.match(/^\${JS9_DIR}\//)?c=c.replace(/^\${JS9_DIR}\//,b.INSTALLDIR):c.match(/^\${JS9_INSTALLDIR}\//)?c=c.replace(/^\${JS9_INSTALLDIR}\//,b.INSTALLDIR):c.match(/^\${JS9_PAGEDIR}\//)?c=c.replace(/^\${JS9_PAGEDIR}\//,""):"/"!==c.charAt(0)&&(c=window.electron.currentDir+"/"+c));return c};b.localAccess=function(c){if(!c||!b.globalOpts.localAccess||!b.hostFS)return null;c=c.replace(/\[.*\]/,"");var a="."+c.split(".").pop().toLowerCase();c=b.hostFS+"/"+c;return 0<=b.vsize(c)&&
0<=$.inArray(a,b.globalOpts.localTemplates.split(","))?(2<b.DEBUG&&b.log("local access file: %s",c),c):null};b.dirname=function(b){return b&&b.includes("/")?b.match(/.*\//)[0]:""};b.mouseDownCB=function(c){var a=c.data,d=a.image,e=$(document).scrollLeft(),f=$(document).scrollTop();if(d){b.globalOpts.clickToFocus&&(d.display.displayConjq.focus(),window.scrollTo(e,f));c.target&&(d.posOffset=$(c.target).offset());d.pos0=b.eventToDisplayPos(c,d.posOffset);d.pos=d.pos0;d.ipos0=d.displayToImagePos(d.pos);
d.ipos=d.ipos0;a.resizing=a.inResize(d.pos);if(!a.resizing){c.preventDefault();({}).hasOwnProperty.call(b,"MouseTouch")&&b.MouseTouch.action(d,c,"start");if(d.clickInRegion&&"regions"===d.clickInLayer){d.display.clearMessage("regions");return}b.specialKey(c)||d.xeqPlugins("mouse","onmousedown",c)}d.clickState=c.which;switch(c.which){case 3:d.clickState=2}c.originalEvent&&c.originalEvent.touches&&c.originalEvent.touches.length&&(d.clickState=-c.originalEvent.touches.length);$(document).on("mousemove."+
a.id,a,function(a){return b.mouseMoveCB(a)});$(document).on("mouseup."+a.id,a,function(a){return b.mouseUpCB(a)})}};b.mouseUpCB=function(c){var a,d=c.data;if(a=d.image){a.pos=b.eventToDisplayPos(c,a.posOffset);a.ipos=a.displayToImagePos(a.pos);var e=Math.abs(a.pos0.x-a.pos.x)<b.NOMOVE&&Math.abs(a.pos0.y-a.pos.y)<b.NOMOVE;d.inResize(a.pos)||c.preventDefault();({}).hasOwnProperty.call(b,"MouseTouch")&&b.MouseTouch.action(a,c,"stop");a.clickInRegion&&a.clickInLayer&&(e||a.updateShapes(a.clickInLayer,
"selected","update"));if(b.specialKey(c))e&&!a.clickInRegion&&b.globalOpts.metaClickPan&&(a.editAnnulus?a._regroupAnnulus("regions",c):a.setPan(a.ipos.x,a.ipos.y));else{a.xeqPlugins("mouse","onmouseup",c);if(e&&(a.xeqPlugins("mouse","onclick",c),{}.hasOwnProperty.call(b,"Menubar")))b.Menubar.onclick(a.display);"click"===b.globalOpts.dynamicSelect&&b.Dysel.getDisplayOr(d)!==d&&b.Dysel.select(d)}a.clickInRegion=!1;a.clickInLayer=null;a.clickState=0;a.posOffset=null;a.tmp.panzoomRefresh&&(a.refreshLayers(a.tmp.panzoomRefresh),
delete a.tmp.panzoomRefresh);d.resizing&&(d.resizing=!1,b.bugs.webkit_resize&&(c=parseInt(d.divjq.css("width"),10),e=parseInt(d.divjq.css("height"),10),c<d.owidth&&d.divjq.css("width",d.owidth+b.RESIZEFUDGE),e<d.oheight&&d.divjq.css("height",d.oheight+b.RESIZEFUDGE)),b.globalOpts.resizeRedisplay||(a.displayImage("all"),a.refreshLayers()));$(document).off("mouseup."+d.id);$(document).off("mousemove."+d.id);for(a=0;a<b.displays.length;a++)c=b.displays[a],c!==d&&c.image&&c.image.clickState&&c.divjq.trigger("mouseup")}else if({}.hasOwnProperty.call(b,
"Menubar"))b.Menubar.onclick(c.data)};b.mouseMoveCB=function(c){var a=c.data;var d=a.image;d&&!b.specialKey(c)&&(d.pos=b.eventToDisplayPos(c,d.posOffset),d.ipos=d.displayToImagePos(d.pos),d.pos0||(d.pos0=d.pos),d.ipos0||(d.ipos0=d.ipos),a.resizing||(c.preventDefault(),d.valpos=null,d.clickInRegion&&"regions"===d.clickInLayer&&(a=d.display.layers.regions.params.sel)&&a.params&&((d.params.listonchange||a.params.listonchange||b.globalOpts.intensivePlugins)&&d._updateShape("regions",a,null,"move"),(d.params.listonchange||
a.params.listonchange)&&d.listRegions("selected",{mode:2}),b.globalOpts.intensivePlugins&&d.xeqPlugins("region","onregionsmove",a.pub)),{}.hasOwnProperty.call(b,"MouseTouch")&&b.MouseTouch.action(d,c),{}.hasOwnProperty.call(b,"Crosshair")&&d.tmp.arrowCrosshairVisible&&!d.params.crosshair&&b.Crosshair.hide(d,d.ipos,c),d.valpos||(d.valpos=d.updateValpos(d.ipos,!1)),b.specialKey(c)||d.xeqPlugins("mouse","onmousemove",c)))};b.mouseEnterCB=function(c){var a=c.data,d=a.image;c.preventDefault();d&&(b.specialKey(c)||
"move"===b.globalOpts.dynamicSelect&&b.Dysel.getDisplayOr(a)!==a&&b.Dysel.select(a))};b.mouseOverCB=function(c){var a=c.data.image,d=$(document).scrollLeft(),e=$(document).scrollTop();c.preventDefault();a&&(b.globalOpts.clickToFocus||(a.display.displayConjq.focus(),window.scrollTo(d,e)),b.specialKey(c)||(a.pos=b.eventToDisplayPos(c),a.ipos=a.displayToImagePos(a.pos),b.specialKey(c)||a.xeqPlugins("mouse","onmouseover",c)))};b.mouseOutCB=function(c){var a=c.data.image;c.preventDefault();a&&(b.globalOpts.clickToFocus||
a.display.displayConjq.blur(),a.clickInRegion&&a.clickInLayer&&a.updateShapes(a.clickInLayer,"selected","mouseout"),b.specialKey(c)||(a.pos=b.eventToDisplayPos(c),a.ipos=a.displayToImagePos(a.pos),b.specialKey(c)||a.xeqPlugins("mouse","onmouseout",c)))};b.wheelCB=function(c){var a=c.data.image;a&&b.globalOpts.mousetouchZoom&&{}.hasOwnProperty.call(b,"MouseTouch")&&b.MouseTouch.Actions["wheel zoom"]&&(b.MouseTouch.Actions["wheel zoom"](a,c),c.preventDefault())};b.keyPressCB=function(b){var a=b.data.image;
b.preventDefault();a&&a.xeqPlugins("keypress","onkeypress",b)};b.keyDownCB=function(c){var a=c.data.image;c.preventDefault();if({}.hasOwnProperty.call(b,"Keyboard")){var d=a?a.ipos:{x:null,y:null};b.Keyboard.action(a,d,c)}a&&a.xeqPlugins("keydown","onkeydown",c)};b.keyUpCB=function(b){var a=b.data.image;a&&a.xeqPlugins("keydown","onkeyup",b)};b.dragenterCB=function(b,a){a.stopPropagation();a.preventDefault()};b.dragoverCB=function(b,a){a.stopPropagation();a.preventDefault()};b.dragexitCB=function(b,
a){a.stopPropagation();a.preventDefault()};b.dragdropCB=function(c,a){var d;a.originalEvent&&(a=a.originalEvent);a.stopPropagation();a.preventDefault();var e=$.extend(!0,{},b.fits.options);e.display=e.display||c;e.extlist=e.extlist||b.globalOpts.extlist;var f=a.target.files||a.dataTransfer.files;var g=b.lookupDisplay(e.display);f.length?window.setTimeout(function(){for(d=0;d<f.length;d++){var a=f[d];var c=a.path||a.name||"";c.match(/\.reg$/)?b.LoadRegions(a,{display:e.display}):c.match(/\.cat$/)?
b.LoadCatalog(null,a,{display:e.display}):c.match(/\.ses$/)?b.LoadSession(a,{display:e.display}):c.match(/\.js9ses$/)?b.LoadSession(a,{display:e.display}):c.match(/\.cmap$/)?b.LoadColormap(a):(b.waiting(!0,g),e.refresh=b.globalOpts.refreshDragDrop,e.localAccess=!0,b.Load(a,e,{display:e.display}))}},b.SPINOUT):(c=a.dataTransfer.getData("text"),c.match(b.URLEXP)&&(b.proxyAvailable()?b.LoadProxy(c,{display:e.display}):b.globalOpts.cgiProxy&&b.Load(c,{proxy:!0},{display:e.display})))};b.RegisterPlugin=
function(c,a,d,e){var f;if(c&&a&&d){var g=c+a;e?(e.viewMenuItem&&(e.menuItem=e.viewMenuItem),e.menuItem&&!e.menu&&(e.menu="view"),e.menu&&(e.menu=e.menu.toLowerCase())):e=[];b.PLUGINS&&(b.PLUGINS+="|");b.PLUGINS+=g.replace(/JS9/,"");b.PLUGINS+="|";b.PLUGINS+=a;b.plugins.push({xclass:c,xname:a,name:g,opts:e,func:d,instances:[]});e.help&&(d=e.help.match(/^.*[\\/]/),d[0]&&(f="plugins/"+d[0].replace(/[\\/]+$/,"")),d=e.help.replace(/^.*[\\/]/,""),e=e.menuItem?e.menuItem:g,b.helpOpts[a]={type:f,url:d,heading:c,
title:e});b.inited&&b.instantiatePlugins()}};b.instantiatePlugin=function(c,a,d,e){var f,g="visible";if("string"===typeof a){for(f=0;f<b.plugins.length;f++){var h=b.plugins[f];if(h.name===a){a=h;break}}"string"===typeof a&&b.error("unknown plugin: "+a)}h=Object.create(a.func.prototype);h.name=a.name;h.isActive=function(a){if("active"!==this.status||a&&!{}.hasOwnProperty.call(this.plugin.opts,a))return!1;switch(this.winType){case "virtual":return!0;default:return this.divjq.is(":visible")}};h.errLog=
function(a,c){b.log("error in %s: %s [%s]\n%s",a,this.name,c.message,b.strace(c))};if(c){var k=c instanceof jQuery?c:"object"===typeof c?$(c):$("#"+c);for(f=0;f<a.instances.length;f++)if(k.is(a.instances[f].odivjq))return a.instances[f]}else k=$("div");c?d?(h.id=k.attr("id")||a.name,h.winType="light",h.winHandle=d,h.odivjq=k,h.divjq=k,h.outerdivjq=h.divjq.closest(b.lightOpts[b.LIGHTWIN].top)):(h.id=k.attr("id")||a.name,h.winType="div",0<=$.inArray(h.name,b.globalOpts.hiddenPluginDivs)&&(g="hidden"),
k.wrap("<div class='JS9PluginContainer' style='visibility: "+g+"'>"),h.odivjq=k,h.divjq=k,h.divjq.addClass(a.xclass+"Plugin").addClass("JS9Plugin"),h.odivjq.attr("id")||h.odivjq.attr("id",h.id),h.outerdivjq=h.divjq.closest(".JS9PluginContainer"),!1!==k.data("toolbarseparate")&&(a.opts.toolbarSeparate||k.data("toolbarseparate"))&&(d="<div class='"+b.lightOpts[b.LIGHTWIN].dragBar.substr(1)+"'>",$(d).insertBefore(h.divjq))):(h.id=a.name,h.winType="virtual");h.plugin=a;h.el=c;h.status="active";a.instances.push(h);
if("virtual"===h.winType)for(f=0;f<b.displays.length;f++)b.displays[f].pluginInstances[a.name]||(h.div=null,h.display=b.displays[f],a.func.apply(h,e),b.displays[f].pluginInstances[a.name]=h);else{h.div=h.divjq[0];h.outerdiv=h.outerdivjq[0];!a.opts.winDims||h.divjq.width()&&h.divjq.height()||(h.divjq.css("width",a.opts.winDims[0]),h.divjq.css("height",a.opts.winDims[1]));c=h.divjq.data("js9id")||h.id;if("*"===c)if(a.opts.dynamicSelect){h.display=b.displays[0];h.isDynamic=!0;b.Dysel.addPlugins(a.name);
var m="*"}else b.error(a.name+" is not dynamically selectable");else h.display=b.lookupDisplay(c),m=h.display.id;if(k=k.data("toolbarhtml")||a.opts.toolbarHTML)k=b.Image.prototype.expandMacro.call(null,k,[{name:"title",value:a.opts.winTitle||""}]),c=h.divjq.closest(b.lightOpts[b.LIGHTWIN].drag),0===c.length&&(c=h.divjq),$("<div class='JS9PluginToolbar-"+h.winType+"'>").css("z-index",b.BTNZINDEX).html(k).data("displayid",m).insertAfter(c);h.display.pluginInstances[a.name]=h;a.func.apply(h,e);if("*"===
m)for(f=0;f<b.displays.length;f++)b.displays[f].pluginInstances[a.name]?h.display=b.displays[f]:b.displays[f].pluginInstances[a.name]=h}return h};b.instantiatePlugins=function(){var c,a=function(a){var c,d;$("div."+a.name).each(function(c,d){b.instantiatePlugin($(d),a,null,a.opts.divArgs)});a.opts.menuItem||!a.opts.winDims||a.opts.winDims[0]||a.opts.winDims[1]||b.instantiatePlugin(null,a,null,a.opts.divArgs);for(c=0;c<a.instances.length;c++){var g=a.instances[c];if(g.isDynamic)for(d=0;d<b.displays.length;d++)b.displays[d].pluginInstances[a.name]||
(b.displays[d].pluginInstances[a.name]=g)}};for(c=0;c<b.plugins.length;c++)a(b.plugins[c])};b.initEmscripten=function(){var c={responseType:"arraybuffer",allowCache:!0};if(!{}.hasOwnProperty.call(window,"Astroem"))if("object"===typeof WebAssembly&&b.globalOpts.useWasm)b.globalOpts.astroemWasm=b.InstallDir(Module.wasmBinaryFile||"astroemw.wasm"),b.fetchURL(b.globalOpts.astroemWasm,null,c,function(a){Module.wasmBinary=a;b.globalOpts.astroemURL=b.InstallDir("astroemw.js");try{b.loadScript(b.globalOpts.astroemURL)}catch(d){b.error("can't load "+
b.globalOpts.astroemURL)}});else{b.globalOpts.astroemURL=b.InstallDir("astroem.js");try{b.loadScript(b.globalOpts.astroemURL)}catch(a){b.error("can't load "+b.globalOpts.astroemURL)}}};b.initFITS=function(){({}).hasOwnProperty.call(window,"Astroem")&&(b.vmalloc=Astroem.vmalloc,b.vfree=Astroem.vfree,b.vheap=Astroem.vheap,b.vmemcpy=Astroem.vmemcpy,b.vstrcpy=Astroem.vstrcpy,b.vfile=Astroem.vfile,b.vread=Astroem.vread,b.vunlink=Astroem.vunlink,b.vsize=Astroem.vsize,b.vmount=Astroem.vmount,b.arrfile=Astroem.arrfile,
b.listhdu=Astroem.listhdu,b.initwcs=Astroem.initwcs,b.freewcs=Astroem.freewcs,b.wcsinfo=Astroem.wcsinfo,b.wcssys=Astroem.wcssys,b.wcsunits=Astroem.wcsunits,b.pix2wcs=Astroem.pix2wcs,b.wcs2pix=Astroem.wcs2pix,b.reg2wcs=Astroem.reg2wcs,b.saostrtod=Astroem.saostrtod,b.saodtostr=Astroem.saodtostr,b.saodtype=Astroem.saodtype,b.zscale=Astroem.zscale,b.tanhdr=Astroem.tanhdr,b.reproject=Astroem.reproject,b.madd=Astroem.madd,b.imgtbl=Astroem.imgtbl,b.makehdr=Astroem.makehdr,b.shrinkhdr=Astroem.shrinkhdr,b.imsection=
Astroem.imsection,b.regcnts=Astroem.regcnts,b.fitsLibrary("cfitsio"))};b.initColormaps=function(){({}).hasOwnProperty.call(b,"Colormap")&&(b.checkNew(new b.Colormap("grey",[[0,0],[1,1]],[[0,0],[1,1]],[[0,0],[1,1]])),b.checkNew(new b.Colormap("red",[[0,0],[1,1]],[[0,0],[0,0]],[[0,0],[0,0]])),b.checkNew(new b.Colormap("green",[[0,0],[0,0]],[[0,0],[1,1]],[[0,0],[0,0]])),b.checkNew(new b.Colormap("blue",[[0,0],[0,0]],[[0,0],[0,0]],[[0,0],[1,1]])),b.checkNew(new b.Colormap("heat",[[0,0],[.34,1],[1,1]],
[[0,0],[1,1]],[[0,0],[.65,0],[.98,1],[1,1]])),b.checkNew(new b.Colormap("cool",[[0,0],[.29,0],[.76,.1],[1,1]],[[0,0],[.22,0],[.96,1],[1,1]],[[0,0],[.53,1],[1,1]])),b.checkNew(new b.Colormap("turbo",[[.18995,.07176,.23217],[.19483,.08339,.26149],[.19956,.09498,.29024],[.20415,.10652,.31844],[.2086,.11802,.34607],[.21291,.12947,.37314],[.21708,.14087,.39964],[.22111,.15223,.42558],[.225,.16354,.45096],[.22875,.17481,.47578],[.23236,.18603,.50004],[.23582,.1972,.52373],[.23915,.20833,.54686],[.24234,
.21941,.56942],[.24539,.23044,.59142],[.2483,.24143,.61286],[.25107,.25237,.63374],[.25369,.26327,.65406],[.25618,.27412,.67381],[.25853,.28492,.693],[.26074,.29568,.71162],[.2628,.30639,.72968],[.26473,.31706,.74718],[.26652,.32768,.76412],[.26816,.33825,.7805],[.26967,.34878,.79631],[.27103,.35926,.81156],[.27226,.3697,.82624],[.27334,.38008,.84037],[.27429,.39043,.85393],[.27509,.40072,.86692],[.27576,.41097,.87936],[.27628,.42118,.89123],[.27667,.43134,.90254],[.27691,.44145,.91328],[.27701,.45152,
.92347],[.27698,.46153,.93309],[.2768,.47151,.94214],[.27648,.48144,.95064],[.27603,.49132,.95857],[.27543,.50115,.96594],[.27469,.51094,.97275],[.27381,.52069,.97899],[.27273,.5304,.98461],[.27106,.54015,.9893],[.26878,.54995,.99303],[.26592,.55979,.99583],[.26252,.56967,.99773],[.25862,.57958,.99876],[.25425,.5895,.99896],[.24946,.59943,.99835],[.24427,.60937,.99697],[.23874,.61931,.99485],[.23288,.62923,.99202],[.22676,.63913,.98851],[.22039,.64901,.98436],[.21382,.65886,.97959],[.20708,.66866,
.97423],[.20021,.67842,.96833],[.19326,.68812,.9619],[.18625,.69775,.95498],[.17923,.70732,.94761],[.17223,.7168,.93981],[.16529,.7262,.93161],[.15844,.73551,.92305],[.15173,.74472,.91416],[.14519,.75381,.90496],[.13886,.76279,.8955],[.13278,.77165,.8858],[.12698,.78037,.8759],[.12151,.78896,.86581],[.11639,.7974,.85559],[.11167,.80569,.84525],[.10738,.81381,.83484],[.10357,.82177,.82437],[.10026,.82955,.81389],[.0975,.83714,.80342],[.09532,.84455,.79299],[.09377,.85175,.78264],[.09287,.85875,.7724],
[.09267,.86554,.7623],[.0932,.87211,.75237],[.09451,.87844,.74265],[.09662,.88454,.73316],[.09958,.8904,.72393],[.10342,.896,.715],[.10815,.90142,.70599],[.11374,.90673,.69651],[.12014,.91193,.6866],[.12733,.91701,.67627],[.13526,.92197,.66556],[.14391,.9268,.65448],[.15323,.93151,.64308],[.16319,.93609,.63137],[.17377,.94053,.61938],[.18491,.94484,.60713],[.19659,.94901,.59466],[.20877,.95304,.58199],[.22142,.95692,.56914],[.23449,.96065,.55614],[.24797,.96423,.54303],[.2618,.96765,.52981],[.27597,
.97092,.51653],[.29042,.97403,.50321],[.30513,.97697,.48987],[.32006,.97974,.47654],[.33517,.98234,.46325],[.35043,.98477,.45002],[.36581,.98702,.43688],[.38127,.98909,.42386],[.39678,.99098,.41098],[.41229,.99268,.39826],[.42778,.99419,.38575],[.44321,.99551,.37345],[.45854,.99663,.3614],[.47375,.99755,.34963],[.48879,.99828,.33816],[.50362,.99879,.32701],[.51822,.9991,.31622],[.53255,.99919,.30581],[.54658,.99907,.29581],[.56026,.99873,.28623],[.57357,.99817,.27712],[.58646,.99739,.26849],[.59891,
.99638,.26038],[.61088,.99514,.2528],[.62233,.99366,.24579],[.63323,.99195,.23937],[.64362,.98999,.23356],[.65394,.98775,.22835],[.66428,.98524,.2237],[.67462,.98246,.2196],[.68494,.97941,.21602],[.69525,.9761,.21294],[.70553,.97255,.21032],[.71577,.96875,.20815],[.72596,.9647,.2064],[.7361,.96043,.20504],[.74617,.95593,.20406],[.75617,.95121,.20343],[.76608,.94627,.20311],[.77591,.94113,.2031],[.78563,.93579,.20336],[.79524,.93025,.20386],[.80473,.92452,.20459],[.8141,.91861,.20552],[.82333,.91253,
.20663],[.83241,.90627,.20788],[.84133,.89986,.20926],[.8501,.89328,.21074],[.85868,.88655,.2123],[.86709,.87968,.21391],[.8753,.87267,.21555],[.88331,.86553,.21719],[.89112,.85826,.2188],[.8987,.85087,.22038],[.90605,.84337,.22188],[.91317,.83576,.22328],[.92004,.82806,.22456],[.92666,.82025,.2257],[.93301,.81236,.22667],[.93909,.80439,.22744],[.94489,.79634,.228],[.95039,.78823,.22831],[.9556,.78005,.22836],[.96049,.77181,.22811],[.96507,.76352,.22754],[.96931,.75519,.22663],[.97323,.74682,.22536],
[.97679,.73842,.22369],[.98,.73,.22161],[.98289,.7214,.21918],[.98549,.7125,.2165],[.98781,.7033,.21358],[.98986,.69382,.21043],[.99163,.68408,.20706],[.99314,.67408,.20348],[.99438,.66386,.19971],[.99535,.65341,.19577],[.99607,.64277,.19165],[.99654,.63193,.18738],[.99675,.62093,.18297],[.99672,.60977,.17842],[.99644,.59846,.17376],[.99593,.58703,.16899],[.99517,.57549,.16412],[.99419,.56386,.15918],[.99297,.55214,.15417],[.99153,.54036,.1491],[.98987,.52854,.14398],[.98799,.51667,.13883],[.9859,
.50479,.13367],[.9836,.49291,.12849],[.98108,.48104,.12332],[.97837,.4692,.11817],[.97545,.4574,.11305],[.97234,.44565,.10797],[.96904,.43399,.10294],[.96555,.42241,.09798],[.96187,.41093,.0931],[.95801,.39958,.08831],[.95398,.38836,.08362],[.94977,.37729,.07905],[.94538,.36638,.07461],[.94084,.35566,.07031],[.93612,.34513,.06616],[.93125,.33482,.06218],[.92623,.32473,.05837],[.92105,.31489,.05475],[.91572,.3053,.05134],[.91024,.29599,.04814],[.90463,.28696,.04516],[.89888,.27824,.04243],[.89298,
.26981,.03993],[.88691,.26152,.03753],[.88066,.25334,.03521],[.87422,.24526,.03297],[.8676,.2373,.03082],[.86079,.22945,.02875],[.8538,.2217,.02677],[.84662,.21407,.02487],[.83926,.20654,.02305],[.83172,.19912,.02131],[.82399,.19182,.01966],[.81608,.18462,.01809],[.80799,.17753,.0166],[.79971,.17055,.0152],[.79125,.16368,.01387],[.7826,.15693,.01264],[.77377,.15028,.01148],[.76476,.14374,.01041],[.75556,.13731,.00942],[.74617,.13098,.00851],[.73661,.12477,.00769],[.72686,.11867,.00695],[.71692,.11268,
.00629],[.7068,.1068,.00571],[.6965,.10102,.00522],[.68602,.09536,.00481],[.67535,.0898,.00449],[.66449,.08436,.00424],[.65345,.07902,.00408],[.64223,.0738,.00401],[.63082,.06868,.00401],[.61923,.06367,.0041],[.60746,.05878,.00427],[.5955,.05399,.00453],[.58336,.04931,.00486],[.57103,.04474,.00529],[.55852,.04028,.00579],[.54583,.03593,.00638],[.53295,.03169,.00705],[.51989,.02756,.0078],[.50664,.02354,.00863],[.49321,.01963,.00955],[.4796,.01583,.01055]])),b.checkNew(new b.Colormap("viridis",[[.267004,
.004874,.329415],[.26851,.009605,.335427],[.269944,.014625,.341379],[.271305,.019942,.347269],[.272594,.025563,.353093],[.273809,.031497,.358853],[.274952,.037752,.364543],[.276022,.044167,.370164],[.277018,.050344,.375715],[.277941,.056324,.381191],[.278791,.062145,.386592],[.279566,.067836,.391917],[.280267,.073417,.397163],[.280894,.078907,.402329],[.281446,.08432,.407414],[.281924,.089666,.412415],[.282327,.094955,.417331],[.282656,.100196,.42216],[.28291,.105393,.426902],[.283091,.110553,.431554],
[.283197,.11568,.436115],[.283229,.120777,.440584],[.283187,.125848,.44496],[.283072,.130895,.449241],[.282884,.13592,.453427],[.282623,.140926,.457517],[.28229,.145912,.46151],[.281887,.150881,.465405],[.281412,.155834,.469201],[.280868,.160771,.472899],[.280255,.165693,.476498],[.279574,.170599,.479997],[.278826,.17549,.483397],[.278012,.180367,.486697],[.277134,.185228,.489898],[.276194,.190074,.493001],[.275191,.194905,.496005],[.274128,.199721,.498911],[.273006,.20452,.501721],[.271828,.209303,
.504434],[.270595,.214069,.507052],[.269308,.218818,.509577],[.267968,.223549,.512008],[.26658,.228262,.514349],[.265145,.232956,.516599],[.263663,.237631,.518762],[.262138,.242286,.520837],[.260571,.246922,.522828],[.258965,.251537,.524736],[.257322,.25613,.526563],[.255645,.260703,.528312],[.253935,.265254,.529983],[.252194,.269783,.531579],[.250425,.27429,.533103],[.248629,.278775,.534556],[.246811,.283237,.535941],[.244972,.287675,.53726],[.243113,.292092,.538516],[.241237,.296485,.539709],[.239346,
.300855,.540844],[.237441,.305202,.541921],[.235526,.309527,.542944],[.233603,.313828,.543914],[.231674,.318106,.544834],[.229739,.322361,.545706],[.227802,.326594,.546532],[.225863,.330805,.547314],[.223925,.334994,.548053],[.221989,.339161,.548752],[.220057,.343307,.549413],[.21813,.347432,.550038],[.21621,.351535,.550627],[.214298,.355619,.551184],[.212395,.359683,.55171],[.210503,.363727,.552206],[.208623,.367752,.552675],[.206756,.371758,.553117],[.204903,.375746,.553533],[.203063,.379716,.553925],
[.201239,.38367,.554294],[.19943,.387607,.554642],[.197636,.391528,.554969],[.19586,.395433,.555276],[.1941,.399323,.555565],[.192357,.403199,.555836],[.190631,.407061,.556089],[.188923,.41091,.556326],[.187231,.414746,.556547],[.185556,.41857,.556753],[.183898,.422383,.556944],[.182256,.426184,.55712],[.180629,.429975,.557282],[.179019,.433756,.55743],[.177423,.437527,.557565],[.175841,.44129,.557685],[.174274,.445044,.557792],[.172719,.448791,.557885],[.171176,.45253,.557965],[.169646,.456262,.55803],
[.168126,.459988,.558082],[.166617,.463708,.558119],[.165117,.467423,.558141],[.163625,.471133,.558148],[.162142,.474838,.55814],[.160665,.47854,.558115],[.159194,.482237,.558073],[.157729,.485932,.558013],[.15627,.489624,.557936],[.154815,.493313,.55784],[.153364,.497,.557724],[.151918,.500685,.557587],[.150476,.504369,.55743],[.149039,.508051,.55725],[.147607,.511733,.557049],[.14618,.515413,.556823],[.144759,.519093,.556572],[.143343,.522773,.556295],[.141935,.526453,.555991],[.140536,.530132,
.555659],[.139147,.533812,.555298],[.13777,.537492,.554906],[.136408,.541173,.554483],[.135066,.544853,.554029],[.133743,.548535,.553541],[.132444,.552216,.553018],[.131172,.555899,.552459],[.129933,.559582,.551864],[.128729,.563265,.551229],[.127568,.566949,.550556],[.126453,.570633,.549841],[.125394,.574318,.549086],[.124395,.578002,.548287],[.123463,.581687,.547445],[.122606,.585371,.546557],[.121831,.589055,.545623],[.121148,.592739,.544641],[.120565,.596422,.543611],[.120092,.600104,.54253],
[.119738,.603785,.5414],[.119512,.607464,.540218],[.119423,.611141,.538982],[.119483,.614817,.537692],[.119699,.61849,.536347],[.120081,.622161,.534946],[.120638,.625828,.533488],[.12138,.629492,.531973],[.122312,.633153,.530398],[.123444,.636809,.528763],[.12478,.640461,.527068],[.126326,.644107,.525311],[.128087,.647749,.523491],[.130067,.651384,.521608],[.132268,.655014,.519661],[.134692,.658636,.517649],[.137339,.662252,.515571],[.14021,.665859,.513427],[.143303,.669459,.511215],[.146616,.67305,
.508936],[.150148,.676631,.506589],[.153894,.680203,.504172],[.157851,.683765,.501686],[.162016,.687316,.499129],[.166383,.690856,.496502],[.170948,.694384,.493803],[.175707,.6979,.491033],[.180653,.701402,.488189],[.185783,.704891,.485273],[.19109,.708366,.482284],[.196571,.711827,.479221],[.202219,.715272,.476084],[.20803,.718701,.472873],[.214,.722114,.469588],[.220124,.725509,.466226],[.226397,.728888,.462789],[.232815,.732247,.459277],[.239374,.735588,.455688],[.24607,.73891,.452024],[.252899,
.742211,.448284],[.259857,.745492,.444467],[.266941,.748751,.440573],[.274149,.751988,.436601],[.281477,.755203,.432552],[.288921,.758394,.428426],[.296479,.761561,.424223],[.304148,.764704,.419943],[.311925,.767822,.415586],[.319809,.770914,.411152],[.327796,.77398,.40664],[.335885,.777018,.402049],[.344074,.780029,.397381],[.35236,.783011,.392636],[.360741,.785964,.387814],[.369214,.788888,.382914],[.377779,.791781,.377939],[.386433,.794644,.372886],[.395174,.797475,.367757],[.404001,.800275,.362552],
[.412913,.803041,.357269],[.421908,.805774,.35191],[.430983,.808473,.346476],[.440137,.811138,.340967],[.449368,.813768,.335384],[.458674,.816363,.329727],[.468053,.818921,.323998],[.477504,.821444,.318195],[.487026,.823929,.312321],[.496615,.826376,.306377],[.506271,.828786,.300362],[.515992,.831158,.294279],[.525776,.833491,.288127],[.535621,.835785,.281908],[.545524,.838039,.275626],[.555484,.840254,.269281],[.565498,.84243,.262877],[.575563,.844566,.256415],[.585678,.846661,.249897],[.595839,
.848717,.243329],[.606045,.850733,.236712],[.616293,.852709,.230052],[.626579,.854645,.223353],[.636902,.856542,.21662],[.647257,.8584,.209861],[.657642,.860219,.203082],[.668054,.861999,.196293],[.678489,.863742,.189503],[.688944,.865448,.182725],[.699415,.867117,.175971],[.709898,.868751,.169257],[.720391,.87035,.162603],[.730889,.871916,.156029],[.741388,.873449,.149561],[.751884,.874951,.143228],[.762373,.876424,.137064],[.772852,.877868,.131109],[.783315,.879285,.125405],[.79376,.880678,.120005],
[.804182,.882046,.114965],[.814576,.883393,.110347],[.82494,.88472,.106217],[.83527,.886029,.102646],[.845561,.887322,.099702],[.85581,.888601,.097452],[.866013,.889868,.095953],[.876168,.891125,.09525],[.886271,.892374,.095374],[.89632,.893616,.096335],[.906311,.894855,.098125],[.916242,.896091,.100717],[.926106,.89733,.104071],[.935904,.89857,.108131],[.945636,.899815,.112838],[.9553,.901065,.118128],[.964894,.902323,.123941],[.974417,.90359,.130215],[.983868,.904867,.136897],[.993248,.906157,.143936]])),
b.checkNew(new b.Colormap("magma",[[.001462,4.66E-4,.013866],[.002258,.001295,.018331],[.003279,.002305,.023708],[.004512,.00349,.029965],[.00595,.004843,.03713],[.007588,.006356,.044973],[.009426,.008022,.052844],[.011465,.009828,.06075],[.013708,.011771,.068667],[.016156,.01384,.076603],[.018815,.016026,.084584],[.021692,.01832,.09261],[.024792,.020715,.100676],[.028123,.023201,.108787],[.031696,.025765,.116965],[.03552,.028397,.125209],[.039608,.03109,.133515],[.04383,.03383,.141886],[.048062,
.036607,.150327],[.05232,.039407,.158841],[.056615,.04216,.167446],[.060949,.044794,.176129],[.06533,.047318,.184892],[.069764,.049726,.193735],[.074257,.052017,.20266],[.078815,.054184,.211667],[.083446,.056225,.220755],[.088155,.058133,.229922],[.092949,.059904,.239164],[.097833,.061531,.248477],[.102815,.06301,.257854],[.107899,.064335,.267289],[.113094,.065492,.276784],[.118405,.066479,.286321],[.123833,.067295,.295879],[.12938,.067935,.305443],[.135053,.068391,.315],[.140858,.068654,.324538],
[.146785,.068738,.334011],[.152839,.068637,.343404],[.159018,.068354,.352688],[.165308,.067911,.361816],[.171713,.067305,.370771],[.178212,.066576,.379497],[.184801,.065732,.387973],[.19146,.064818,.396152],[.198177,.063862,.404009],[.204935,.062907,.411514],[.211718,.061992,.418647],[.218512,.061158,.425392],[.225302,.060445,.431742],[.232077,.059889,.437695],[.238826,.059517,.443256],[.245543,.059352,.448436],[.25222,.059415,.453248],[.258857,.059706,.45771],[.265447,.060237,.46184],[.271994,.060994,
.46566],[.278493,.061978,.46919],[.284951,.063168,.472451],[.291366,.064553,.475462],[.29774,.066117,.478243],[.304081,.067835,.480812],[.310382,.069702,.483186],[.316654,.07169,.48538],[.322899,.073782,.487408],[.329114,.075972,.489287],[.335308,.078236,.491024],[.341482,.080564,.492631],[.347636,.082946,.494121],[.353773,.085373,.495501],[.359898,.087831,.496778],[.366012,.090314,.49796],[.372116,.092816,.499053],[.378211,.095332,.500067],[.384299,.097855,.501002],[.390384,.100379,.501864],[.396467,
.102902,.502658],[.402548,.10542,.503386],[.408629,.10793,.504052],[.414709,.110431,.504662],[.420791,.11292,.505215],[.426877,.115395,.505714],[.432967,.117855,.50616],[.439062,.120298,.506555],[.445163,.122724,.506901],[.451271,.125132,.507198],[.457386,.127522,.507448],[.463508,.129893,.507652],[.46964,.132245,.507809],[.47578,.134577,.507921],[.481929,.136891,.507989],[.488088,.139186,.508011],[.494258,.141462,.507988],[.500438,.143719,.50792],[.506629,.145958,.507806],[.512831,.148179,.507648],
[.519045,.150383,.507443],[.52527,.152569,.507192],[.531507,.154739,.506895],[.537755,.156894,.506551],[.544015,.159033,.506159],[.550287,.161158,.505719],[.556571,.163269,.50523],[.562866,.165368,.504692],[.569172,.167454,.504105],[.57549,.16953,.503466],[.581819,.171596,.502777],[.588158,.173652,.502035],[.594508,.175701,.501241],[.600868,.177743,.500394],[.607238,.179779,.499492],[.613617,.181811,.498536],[.620005,.18384,.497524],[.626401,.185867,.496456],[.632805,.187893,.495332],[.639216,.189921,
.49415],[.645633,.191952,.49291],[.652056,.193986,.491611],[.658483,.196027,.490253],[.664915,.198075,.488836],[.671349,.200133,.487358],[.677786,.202203,.485819],[.684224,.204286,.484219],[.690661,.206384,.482558],[.697098,.208501,.480835],[.703532,.210638,.479049],[.709962,.212797,.477201],[.716387,.214982,.47529],[.722805,.217194,.473316],[.729216,.219437,.471279],[.735616,.221713,.46918],[.742004,.224025,.467018],[.748378,.226377,.464794],[.754737,.228772,.462509],[.761077,.231214,.460162],[.767398,
.233705,.457755],[.773695,.236249,.455289],[.779968,.238851,.452765],[.786212,.241514,.450184],[.792427,.244242,.447543],[.798608,.24704,.444848],[.804752,.249911,.442102],[.810855,.252861,.439305],[.816914,.255895,.436461],[.822926,.259016,.433573],[.828886,.262229,.430644],[.834791,.26554,.427671],[.840636,.268953,.424666],[.846416,.272473,.421631],[.852126,.276106,.418573],[.857763,.279857,.415496],[.86332,.283729,.412403],[.868793,.287728,.409303],[.874176,.291859,.406205],[.879464,.296125,.403118],
[.884651,.30053,.400047],[.889731,.305079,.397002],[.8947,.309773,.393995],[.899552,.314616,.391037],[.904281,.31961,.388137],[.908884,.324755,.385308],[.913354,.330052,.382563],[.917689,.3355,.379915],[.921884,.341098,.377376],[.925937,.346844,.374959],[.929845,.352734,.372677],[.933606,.358764,.370541],[.937221,.364929,.368567],[.940687,.371224,.366762],[.944006,.377643,.365136],[.94718,.384178,.363701],[.95021,.39082,.362468],[.953099,.397563,.361438],[.955849,.4044,.360619],[.958464,.411324,.360014],
[.960949,.418323,.35963],[.96331,.42539,.359469],[.965549,.432519,.359529],[.967671,.439703,.35981],[.96968,.446936,.360311],[.971582,.45421,.36103],[.973381,.46152,.361965],[.975082,.468861,.363111],[.97669,.476226,.364466],[.97821,.483612,.366025],[.979645,.491014,.367783],[.981,.498428,.369734],[.982279,.505851,.371874],[.983485,.51328,.374198],[.984622,.520713,.376698],[.985693,.528148,.379371],[.9867,.535582,.38221],[.987646,.543015,.38521],[.988533,.550446,.388365],[.989363,.557873,.391671],
[.990138,.565296,.395122],[.990871,.572706,.398714],[.991558,.580107,.402441],[.992196,.587502,.406299],[.992785,.594891,.410283],[.993326,.602275,.41439],[.993834,.609644,.418613],[.994309,.616999,.42295],[.994738,.62435,.427397],[.995122,.631696,.431951],[.99548,.639027,.436607],[.99581,.646344,.441361],[.996096,.653659,.446213],[.996341,.660969,.45116],[.99658,.668256,.456192],[.996775,.675541,.461314],[.996925,.682828,.466526],[.997077,.690088,.471811],[.997186,.697349,.477182],[.997254,.704611,
.482635],[.997325,.711848,.488154],[.997351,.719089,.493755],[.997351,.726324,.499428],[.997341,.733545,.505167],[.997285,.740772,.510983],[.997228,.747981,.516859],[.997138,.75519,.522806],[.997019,.762398,.528821],[.996898,.769591,.534892],[.996727,.776795,.541039],[.996571,.783977,.547233],[.996369,.791167,.553499],[.996162,.798348,.55982],[.995932,.805527,.566202],[.99568,.812706,.572645],[.995424,.819875,.57914],[.995131,.827052,.585701],[.994851,.834213,.592307],[.994524,.841387,.598983],[.994222,
.84854,.605696],[.993866,.855711,.612482],[.993545,.862859,.619299],[.99317,.870024,.626189],[.992831,.877168,.633109],[.99244,.88433,.640099],[.992089,.89147,.647116],[.991688,.898627,.654202],[.991332,.905763,.661309],[.99093,.912915,.668481],[.99057,.920049,.675675],[.990175,.927196,.682926],[.989815,.934329,.690198],[.989434,.94147,.697519],[.989077,.948604,.704863],[.988717,.955742,.712242],[.988367,.962878,.719649],[.988033,.970012,.727077],[.987691,.977154,.734536],[.987387,.984288,.742002],
[.987053,.991438,.749504]])),b.checkNew(new b.Colormap("inferno",[[.001462,4.66E-4,.013866],[.002267,.00127,.01857],[.003299,.002249,.024239],[.004547,.003392,.030909],[.006006,.004692,.038558],[.007676,.006136,.046836],[.009561,.007713,.055143],[.011663,.009417,.06346],[.013995,.011225,.071862],[.016561,.013136,.080282],[.019373,.015133,.088767],[.022447,.017199,.097327],[.025793,.019331,.10593],[.029432,.021503,.114621],[.033385,.023702,.123397],[.037668,.025921,.132232],[.042253,.028139,.141141],
[.046915,.030324,.150164],[.051644,.032474,.159254],[.056449,.034569,.168414],[.06134,.03659,.177642],[.066331,.038504,.186962],[.071429,.040294,.196354],[.076637,.041905,.205799],[.081962,.043328,.215289],[.087411,.044556,.224813],[.09299,.045583,.234358],[.098702,.046402,.243904],[.104551,.047008,.25343],[.110536,.047399,.262912],[.116656,.047574,.272321],[.122908,.047536,.281624],[.129285,.047293,.290788],[.135778,.046856,.299776],[.142378,.046242,.308553],[.149073,.045468,.317085],[.15585,.044559,
.325338],[.162689,.043554,.333277],[.169575,.042489,.340874],[.176493,.041402,.348111],[.183429,.040329,.354971],[.190367,.039309,.361447],[.197297,.0384,.367535],[.204209,.037632,.373238],[.211095,.03703,.378563],[.217949,.036615,.383522],[.224763,.036405,.388129],[.231538,.036405,.3924],[.238273,.036621,.396353],[.244967,.037055,.400007],[.25162,.037705,.403378],[.258234,.038571,.406485],[.26481,.039647,.409345],[.271347,.040922,.411976],[.27785,.042353,.414392],[.284321,.043933,.416608],[.290763,
.045644,.418637],[.297178,.04747,.420491],[.303568,.049396,.422182],[.309935,.051407,.423721],[.316282,.05349,.425116],[.32261,.055634,.426377],[.328921,.057827,.427511],[.335217,.06006,.428524],[.3415,.062325,.429425],[.347771,.064616,.430217],[.354032,.066925,.430906],[.360284,.069247,.431497],[.366529,.071579,.431994],[.372768,.073915,.4324],[.379001,.076253,.432719],[.385228,.078591,.432955],[.391453,.080927,.433109],[.397674,.083257,.433183],[.403894,.08558,.433179],[.410113,.087896,.433098],
[.416331,.090203,.432943],[.422549,.092501,.432714],[.428768,.09479,.432412],[.434987,.097069,.432039],[.441207,.099338,.431594],[.447428,.101597,.43108],[.453651,.103848,.430498],[.459875,.106089,.429846],[.4661,.108322,.429125],[.472328,.110547,.428334],[.478558,.112764,.427475],[.484789,.114974,.426548],[.491022,.117179,.425552],[.497257,.119379,.424488],[.503493,.121575,.423356],[.50973,.123769,.422156],[.515967,.12596,.420887],[.522206,.12815,.419549],[.528444,.130341,.418142],[.534683,.132534,
.416667],[.54092,.134729,.415123],[.547157,.136929,.413511],[.553392,.139134,.411829],[.559624,.141346,.410078],[.565854,.143567,.408258],[.572081,.145797,.406369],[.578304,.148039,.404411],[.584521,.150294,.402385],[.590734,.152563,.40029],[.59694,.154848,.398125],[.603139,.157151,.395891],[.60933,.159474,.393589],[.615513,.161817,.391219],[.621685,.164184,.388781],[.627847,.166575,.386276],[.633998,.168992,.383704],[.640135,.171438,.381065],[.64626,.173914,.378359],[.652369,.176421,.375586],[.658463,
.178962,.372748],[.66454,.181539,.369846],[.670599,.184153,.366879],[.676638,.186807,.363849],[.682656,.189501,.360757],[.688653,.192239,.357603],[.694627,.195021,.354388],[.700576,.197851,.351113],[.7065,.200728,.347777],[.712396,.203656,.344383],[.718264,.206636,.340931],[.724103,.20967,.337424],[.729909,.212759,.333861],[.735683,.215906,.330245],[.741423,.219112,.326576],[.747127,.222378,.322856],[.752794,.225706,.319085],[.758422,.229097,.315266],[.76401,.232554,.311399],[.769556,.236077,.307485],
[.775059,.239667,.303526],[.780517,.243327,.299523],[.785929,.247056,.295477],[.791293,.250856,.29139],[.796607,.254728,.287264],[.801871,.258674,.283099],[.807082,.262692,.278898],[.812239,.266786,.274661],[.817341,.270954,.27039],[.822386,.275197,.266085],[.827372,.279517,.26175],[.832299,.283913,.257383],[.837165,.288385,.252988],[.841969,.292933,.248564],[.846709,.297559,.244113],[.851384,.30226,.239636],[.855992,.307038,.235133],[.860533,.311892,.230606],[.865006,.316822,.226055],[.869409,.321827,
.221482],[.873741,.326906,.216886],[.878001,.33206,.212268],[.882188,.337287,.207628],[.886302,.342586,.202968],[.890341,.347957,.198286],[.894305,.353399,.193584],[.898192,.358911,.18886],[.902003,.364492,.184116],[.905735,.37014,.17935],[.90939,.375856,.174563],[.912966,.381636,.169755],[.916462,.387481,.164924],[.919879,.393389,.16007],[.923215,.399359,.155193],[.92647,.405389,.150292],[.929644,.411479,.145367],[.932737,.417627,.140417],[.935747,.423831,.13544],[.938675,.430091,.130438],[.941521,
.436405,.125409],[.944285,.442772,.120354],[.946965,.449191,.115272],[.949562,.45566,.110164],[.952075,.462178,.105031],[.954506,.468744,.099874],[.956852,.475356,.094695],[.959114,.482014,.089499],[.961293,.488716,.084289],[.963387,.495462,.079073],[.965397,.502249,.073859],[.967322,.509078,.068659],[.969163,.515946,.063488],[.970919,.522853,.058367],[.97259,.529798,.053324],[.974176,.53678,.048392],[.975677,.543798,.043618],[.977092,.55085,.03905],[.978422,.557937,.034931],[.979666,.565057,.031409],
[.980824,.572209,.028508],[.981895,.579392,.02625],[.982881,.586606,.024661],[.983779,.593849,.02377],[.984591,.601122,.023606],[.985315,.608422,.024202],[.985952,.61575,.025592],[.986502,.623105,.027814],[.986964,.630485,.030908],[.987337,.63789,.034916],[.987622,.64532,.039886],[.987819,.652773,.045581],[.987926,.66025,.05175],[.987945,.667748,.058329],[.987874,.675267,.065257],[.987714,.682807,.072489],[.987464,.690366,.07999],[.987124,.697944,.087731],[.986694,.70554,.095694],[.986175,.713153,
.103863],[.985566,.720782,.112229],[.984865,.728427,.120785],[.984075,.736087,.129527],[.983196,.743758,.138453],[.982228,.751442,.147565],[.981173,.759135,.156863],[.980032,.766837,.166353],[.978806,.774545,.176037],[.977497,.782258,.185923],[.976108,.789974,.196018],[.974638,.797692,.206332],[.973088,.805409,.216877],[.971468,.813122,.227658],[.969783,.820825,.238686],[.968041,.828515,.249972],[.966243,.836191,.261534],[.964394,.843848,.273391],[.962517,.851476,.285546],[.960626,.859069,.29801],
[.95872,.866624,.31082],[.956834,.874129,.323974],[.954997,.881569,.337475],[.953215,.888942,.351369],[.951546,.896226,.365627],[.950018,.903409,.380271],[.948683,.910473,.395289],[.947594,.917399,.410665],[.946809,.924168,.426373],[.946392,.930761,.442367],[.946403,.937159,.458592],[.946903,.943348,.47497],[.947937,.949318,.491426],[.949545,.955063,.50786],[.95174,.960587,.524203],[.954529,.965896,.540361],[.957896,.971003,.556275],[.961812,.975924,.571925],[.966249,.980678,.587206],[.971162,.985282,
.602154],[.976511,.989753,.61676],[.982257,.994109,.631017],[.988362,.998364,.644924]])),b.checkNew(new b.Colormap("plasma",[[.050383,.029803,.527975],[.063536,.028426,.533124],[.075353,.027206,.538007],[.086222,.026125,.542658],[.096379,.025165,.547103],[.10598,.024309,.551368],[.115124,.023556,.555468],[.123903,.022878,.559423],[.132381,.022258,.56325],[.140603,.021687,.566959],[.148607,.021154,.570562],[.156421,.020651,.574065],[.16407,.020171,.577478],[.171574,.019706,.580806],[.17895,.019252,
.584054],[.186213,.018803,.587228],[.193374,.018354,.59033],[.200445,.017902,.593364],[.207435,.017442,.596333],[.21435,.016973,.599239],[.221197,.016497,.602083],[.227983,.016007,.604867],[.234715,.015502,.607592],[.241396,.014979,.610259],[.248032,.014439,.612868],[.254627,.013882,.615419],[.261183,.013308,.617911],[.267703,.012716,.620346],[.274191,.012109,.622722],[.280648,.011488,.625038],[.287076,.010855,.627295],[.293478,.010213,.62949],[.299855,.009561,.631624],[.30621,.008902,.633694],[.312543,
.008239,.6357],[.318856,.007576,.63764],[.32515,.006915,.639512],[.331426,.006261,.641316],[.337683,.005618,.643049],[.343925,.004991,.64471],[.35015,.004382,.646298],[.356359,.003798,.64781],[.362553,.003243,.649245],[.368733,.002724,.650601],[.374897,.002245,.651876],[.381047,.001814,.653068],[.387183,.001434,.654177],[.393304,.001114,.655199],[.399411,8.59E-4,.656133],[.405503,6.78E-4,.656977],[.41158,5.77E-4,.65773],[.417642,5.64E-4,.65839],[.423689,6.46E-4,.658956],[.429719,8.31E-4,.659425],
[.435734,.001127,.659797],[.441732,.00154,.660069],[.447714,.00208,.66024],[.453677,.002755,.66031],[.459623,.003574,.660277],[.46555,.004545,.660139],[.471457,.005678,.659897],[.477344,.00698,.659549],[.48321,.00846,.659095],[.489055,.010127,.658534],[.494877,.01199,.657865],[.500678,.014055,.657088],[.506454,.016333,.656202],[.512206,.018833,.655209],[.517933,.021563,.654109],[.523633,.024532,.652901],[.529306,.027747,.651586],[.534952,.031217,.650165],[.54057,.03495,.64864],[.546157,.038954,.64701],
[.551715,.043136,.645277],[.557243,.047331,.643443],[.562738,.051545,.641509],[.568201,.055778,.639477],[.573632,.060028,.637349],[.579029,.064296,.635126],[.584391,.068579,.632812],[.589719,.072878,.630408],[.595011,.07719,.627917],[.600266,.081516,.625342],[.605485,.085854,.622686],[.610667,.090204,.619951],[.615812,.094564,.61714],[.620919,.098934,.614257],[.625987,.103312,.611305],[.631017,.107699,.608287],[.636008,.112092,.605205],[.640959,.116492,.602065],[.645872,.120898,.598867],[.650746,
.125309,.595617],[.65558,.129725,.592317],[.660374,.134144,.588971],[.665129,.138566,.585582],[.669845,.142992,.582154],[.674522,.147419,.578688],[.67916,.151848,.575189],[.683758,.156278,.57166],[.688318,.160709,.568103],[.69284,.165141,.564522],[.697324,.169573,.560919],[.701769,.174005,.557296],[.706178,.178437,.553657],[.710549,.182868,.550004],[.714883,.187299,.546338],[.719181,.191729,.542663],[.723444,.196158,.538981],[.72767,.200586,.535293],[.731862,.205013,.531601],[.736019,.209439,.527908],
[.740143,.213864,.524216],[.744232,.218288,.520524],[.748289,.222711,.516834],[.752312,.227133,.513149],[.756304,.231555,.509468],[.760264,.235976,.505794],[.764193,.240396,.502126],[.76809,.244817,.498465],[.771958,.249237,.494813],[.775796,.253658,.491171],[.779604,.258078,.487539],[.783383,.2625,.483918],[.787133,.266922,.480307],[.790855,.271345,.476706],[.794549,.27577,.473117],[.798216,.280197,.469538],[.801855,.284626,.465971],[.805467,.289057,.462415],[.809052,.293491,.45887],[.812612,.297928,
.455338],[.816144,.302368,.451816],[.819651,.306812,.448306],[.823132,.311261,.444806],[.826588,.315714,.441316],[.830018,.320172,.437836],[.833422,.324635,.434366],[.836801,.329105,.430905],[.840155,.33358,.427455],[.843484,.338062,.424013],[.846788,.342551,.420579],[.850066,.347048,.417153],[.853319,.351553,.413734],[.856547,.356066,.410322],[.85975,.360588,.406917],[.862927,.365119,.403519],[.866078,.36966,.400126],[.869203,.374212,.396738],[.872303,.378774,.393355],[.875376,.383347,.389976],[.878423,
.387932,.3866],[.881443,.392529,.383229],[.884436,.397139,.37986],[.887402,.401762,.376494],[.89034,.406398,.37313],[.89325,.411048,.369768],[.896131,.415712,.366407],[.898984,.420392,.363047],[.901807,.425087,.359688],[.904601,.429797,.356329],[.907365,.434524,.35297],[.910098,.439268,.34961],[.9128,.444029,.346251],[.915471,.448807,.34289],[.918109,.453603,.339529],[.920714,.458417,.336166],[.923287,.463251,.332801],[.925825,.468103,.329435],[.928329,.472975,.326067],[.930798,.477867,.322697],[.933232,
.48278,.319325],[.93563,.487712,.315952],[.93799,.492667,.312575],[.940313,.497642,.309197],[.942598,.502639,.305816],[.944844,.507658,.302433],[.947051,.512699,.299049],[.949217,.517763,.295662],[.951344,.52285,.292275],[.953428,.52796,.288883],[.95547,.533093,.28549],[.957469,.53825,.282096],[.959424,.543431,.278701],[.961336,.548636,.275305],[.963203,.553865,.271909],[.965024,.559118,.268513],[.966798,.564396,.265118],[.968526,.5697,.261721],[.970205,.575028,.258325],[.971835,.580382,.254931],
[.973416,.585761,.25154],[.974947,.591165,.248151],[.976428,.596595,.244767],[.977856,.602051,.241387],[.979233,.607532,.238013],[.980556,.613039,.234646],[.981826,.618572,.231287],[.983041,.624131,.227937],[.984199,.629718,.224595],[.985301,.63533,.221265],[.986345,.640969,.217948],[.987332,.646633,.214648],[.98826,.652325,.211364],[.989128,.658043,.2081],[.989935,.663787,.204859],[.990681,.669558,.201642],[.991365,.675355,.198453],[.991985,.681179,.195295],[.992541,.68703,.19217],[.993032,.692907,
.189084],[.993456,.69881,.186041],[.993814,.704741,.183043],[.994103,.710698,.180097],[.994324,.716681,.177208],[.994474,.722691,.174381],[.994553,.728728,.171622],[.994561,.734791,.168938],[.994495,.74088,.166335],[.994355,.746995,.163821],[.994141,.753137,.161404],[.993851,.759304,.159092],[.993482,.765499,.156891],[.993033,.77172,.154808],[.992505,.777967,.152855],[.991897,.784239,.151042],[.991209,.790537,.149377],[.990439,.796859,.14787],[.989587,.803205,.146529],[.988648,.809579,.145357],[.987621,
.815978,.144363],[.986509,.822401,.143557],[.985314,.828846,.142945],[.984031,.835315,.142528],[.982653,.841812,.142303],[.98119,.848329,.142279],[.979644,.854866,.142453],[.977995,.861432,.142808],[.976265,.868016,.143351],[.974443,.874622,.144061],[.97253,.88125,.144923],[.970533,.887896,.145919],[.968443,.894564,.147014],[.966271,.901249,.14818],[.964021,.90795,.14937],[.961681,.914672,.15052],[.959276,.921407,.151566],[.956808,.928152,.152409],[.954287,.934908,.152921],[.951726,.941671,.152925],
[.949151,.948435,.152178],[.946602,.95519,.150328],[.944152,.961916,.146861],[.941896,.96859,.140956],[.940015,.975158,.131326]])),b.checkNew(new b.Colormap("i8",[[0,0,0],[0,1,0],[0,0,1],[0,1,1],[1,0,0],[1,1,0],[1,0,1],[1,1,1]])),b.checkNew(new b.Colormap("aips0",[[.196,.196,.196],[.475,0,.608],[0,0,.785],[.373,.655,.925],[0,.596,0],[0,.965,0],[1,1,0],[1,.694,0],[1,0,0]])),b.checkNew(new b.Colormap("sls",[[0,0,0],[.043442,0,.052883],[.086883,0,.105767],[.130325,0,.15865],[.173767,0,.211533],[.217208,
0,.264417],[.26065,0,.3173],[.304092,0,.370183],[.347533,0,.423067],[.390975,0,.47595],[.434417,0,.528833],[.477858,0,.581717],[.5213,0,.6346],[.506742,0,.640217],[.492183,0,.645833],[.477625,0,.65145],[.463067,0,.657067],[.448508,0,.662683],[.43395,0,.6683],[.419392,0,.673917],[.404833,0,.679533],[.390275,0,.68515],[.375717,0,.690767],[.361158,0,.696383],[.3466,0,.702],[.317717,0,.712192],[.288833,0,.722383],[.25995,0,.732575],[.231067,0,.742767],[.202183,0,.752958],[.1733,0,.76315],[.144417,0,.773342],
[.115533,0,.783533],[.08665,0,.793725],[.057767,0,.803917],[.028883,0,.814108],[0,0,.8243],[0,.019817,.838942],[0,.039633,.853583],[0,.05945,.868225],[0,.079267,.882867],[0,.099083,.897508],[0,.1189,.91215],[0,.138717,.926792],[0,.158533,.941433],[0,.17835,.956075],[0,.198167,.970717],[0,.217983,.985358],[0,.2378,1],[0,.268533,1],[0,.299267,1],[0,.33,1],[0,.360733,1],[0,.391467,1],[0,.4222,1],[0,.452933,1],[0,.483667,1],[0,.5144,1],[0,.545133,1],[0,.575867,1],[0,.6066,1],[0,.631733,.9753],[0,.656867,
.9506],[0,.682,.9259],[0,.707133,.9012],[0,.732267,.8765],[0,.7574,.8518],[0,.782533,.8271],[0,.807667,.8024],[0,.8328,.7777],[0,.857933,.753],[0,.883067,.7283],[0,.9082,.7036],[0,.901908,.676675],[0,.895617,.64975],[0,.889325,.622825],[0,.883033,.5959],[0,.876742,.568975],[0,.87045,.54205],[0,.864158,.515125],[0,.857867,.4882],[0,.851575,.461275],[0,.845283,.43435],[0,.838992,.407425],[0,.8327,.3805],[0,.832308,.354858],[0,.831917,.329217],[0,.831525,.303575],[0,.831133,.277933],[0,.830742,.252292],
[0,.83035,.22665],[0,.829958,.201008],[0,.829567,.175367],[0,.829175,.149725],[0,.828783,.124083],[0,.828392,.098442],[0,.828,.0728],[.033167,.834167,.066733],[.066333,.840333,.060667],[.0995,.8465,.0546],[.132667,.852667,.048533],[.165833,.858833,.042467],[.199,.865,.0364],[.232167,.871167,.030333],[.265333,.877333,.024267],[.2985,.8835,.0182],[.331667,.889667,.012133],[.364833,.895833,.006067],[.398,.902,0],[.43095,.902,0],[.4639,.902,0],[.49685,.902,0],[.5298,.902,0],[.56275,.902,0],[.5957,.902,
0],[.62865,.902,0],[.6616,.902,0],[.69455,.902,0],[.7275,.902,0],[.76045,.902,0],[.7934,.902,0],[.810617,.897133,.003983],[.827833,.892267,.007967],[.84505,.8874,.01195],[.862267,.882533,.015933],[.879483,.877667,.019917],[.8967,.8728,.0239],[.913917,.867933,.027883],[.931133,.863067,.031867],[.94835,.8582,.03585],[.965567,.853333,.039833],[.982783,.848467,.043817],[1,.8436,.0478],[.995725,.824892,.0516],[.99145,.806183,.0554],[.987175,.787475,.0592],[.9829,.768767,.063],[.978625,.750058,.0668],[.97435,
.73135,.0706],[.970075,.712642,.0744],[.9658,.693933,.0782],[.961525,.675225,.082],[.95725,.656517,.0858],[.952975,.637808,.0896],[.9487,.6191,.0934],[.952975,.600408,.085617],[.95725,.581717,.077833],[.961525,.563025,.07005],[.9658,.544333,.062267],[.970075,.525642,.054483],[.97435,.50695,.0467],[.978625,.488258,.038917],[.9829,.469567,.031133],[.987175,.450875,.02335],[.99145,.432183,.015567],[.995725,.413492,.007783],[1,.3948,0],[.998342,.3619,0],[.996683,.329,0],[.995025,.2961,0],[.993367,.2632,
0],[.991708,.2303,0],[.99005,.1974,0],[.988392,.1645,0],[.986733,.1316,0],[.985075,.0987,0],[.983417,.0658,0],[.981758,.0329,0],[.9801,0,0],[.955925,0,0],[.93175,0,0],[.907575,0,0],[.8834,0,0],[.859225,0,0],[.83505,0,0],[.810875,0,0],[.7867,0,0],[.762525,0,0],[.73835,0,0],[.714175,0,0],[.69,0,0],[.715833,.083333,.083333],[.741667,.166667,.166667],[.7675,.25,.25],[.793333,.333333,.333333],[.819167,.416667,.416667],[.845,.5,.5],[.870833,.583333,.583333],[.896667,.666667,.666667],[.9225,.75,.75],[.948333,
.833333,.833333],[.974167,.916667,.916667],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1]])),b.checkNew(new b.Colormap("a",[[0,0],[.25,0],[.5,1],[1,1]],[[0,0],[.25,1],[.5,0],[.77,0],[1,1]],[[0,0],[.125,0],[.5,1],[.64,.5],[.77,0],[1,0]])),b.checkNew(new b.Colormap("b",[[0,0],[.25,0],[.5,1],[1,1]],[[0,0],[.5,0],[.75,1],[1,1]],[[0,0],[.25,1],[.5,0],[.75,0],[1,1]])),b.checkNew(new b.Colormap("bb",[[0,0],[.5,1],[1,1]],[[0,0],[.25,0],[.75,1],[1,1]],[[0,0],[.5,0],[1,1]])),b.checkNew(new b.Colormap("he",
[[0,0],[.015,.5],[.25,.5],[.5,.75],[1,1]],[[0,0],[.065,0],[.125,.5],[.25,.75],[.5,.81],[1,1]],[[0,0],[.015,.125],[.03,.375],[.065,.625],[.25,.25],[1,1]])),b.checkNew(new b.Colormap("hsv",function(){var b,a=0,d=[];for(b=0;200>b;b++,a++){var e=1-b/199;var f=360*e+270;var g=Math.abs(Math.sin(3.1416*e));for(e=Math.pow(1-e,1/3);360<=f;)f-=360;f/=60;var h=Math.floor(f);var k=f-h;f=e*(1-g);var m=e*(1-g*k);g=e*(1-g*(1-k));d[a]=[];switch(h){case 0:d[a].push(e);d[a].push(g);d[a].push(f);break;case 1:d[a].push(m);
d[a].push(e);d[a].push(f);break;case 2:d[a].push(f);d[a].push(e);d[a].push(g);break;case 3:d[a].push(f);d[a].push(m);d[a].push(e);break;case 4:d[a].push(g);d[a].push(f);d[a].push(e);break;case 5:d[a].push(e),d[a].push(f),d[a].push(m)}}return d}())),b.checkNew(new b.Colormap("rainbow",[[0,1],[.2,0],[.6,0],[.8,1],[1,1]],[[0,0],[.2,0],[.4,1],[.8,1],[1,0]],[[0,1],[.4,1],[.6,0],[1,0]])),b.checkNew(new b.Colormap("standard",[[0,0],[.333,.3],[.333,0],[.666,.3],[.666,.3],[1,1]],[[0,0],[.333,.3],[.333,.3],
[.666,1],[.666,0],[1,.3]],[[0,0],[.333,1],[.333,0],[.666,.3],[.666,0],[1,.3]])),b.checkNew(new b.Colormap("staircase",function(){var b,a=0,d=[];for(b=1;5>=b;b++,a++){var e=b/5;d[a]=[];d[a].push(.3*e);d[a].push(.3*e);d[a].push(e)}for(b=1;5>=b;b++,a++)e=b/5,d[a]=[],d[a].push(.3*e),d[a].push(e),d[a].push(.3*e);for(b=1;5>=b;b++,a++)e=b/5,d[a]=[],d[a].push(e),d[a].push(.3*e),d[a].push(.3*e);return d}())),b.checkNew(new b.Colormap("color",[[0,0,0],[.18431,.18431,.18431],[.37255,.37255,.37255],[.56078,.56078,
.56078],[.74902,.74902,.74902],[.93725,.93725,.93725],[0,.18431,.93725],[0,.37255,.74902],[0,.49804,.49804],[0,.74902,.3098],[0,.93725,0],[.3098,.62353,0],[.49804,.49804,0],[.62353,.3098,0],[.93725,0,0],[.74902,0,.3098]])))};b.initCommands=function(){({}).hasOwnProperty.call(b,"Command")&&(b.checkNew(new b.Command({name:"analysis",alias:"run",help:"list/run analysis for current image",get:function(){var b,a,d="",e=this.image;if(e&&e.analysisPackages)for(a=0;a<e.analysisPackages.length;a++){var f=
e.analysisPackages[a];for(b=0;b<f.length;b++){var g=f[b];d&&(d+=", ");var h=g.xclass?g.xclass+":"+g.name:g.name;d+=g.title+" ("+h+")"}a<e.analysisPackages.length-1&&(d+="\n")}return d},set:function(c){var a,d=this.image;d&&((a=d.lookupAnalysis(c[0]))?a.purl?(c=d.displayAnalysis("params",b.InstallDir(a.purl),{title:a.title+": "+d.fitsFile}),$(c).data("dispid",d.display.id).data("aname",a.name)):d.runAnalysis(a.name):b.error("unknown analysis command '"+c[0]+"'"))}})),b.checkNew(new b.Command({name:"colormap",
alias:"cmap",help:"set/get colormap for current image",get:function(){var b;if(b=this.image)return b=b.getColormap(),b.colormap+" "+b.contrast+" "+b.bias},set:function(b){var a=this.image;a&&a.setColormap.apply(a,$jscomp.arrayFromIterable(b))}})),b.checkNew(new b.Command({name:"colormaps",alias:"cmaps",help:"get list of available colormaps",get:function(){var c,a="";for(c=0;c<b.colormaps.length;c++)a&&(a+=", "),a+=b.colormaps[c].name;return a}})),b.checkNew(new b.Command({name:"global",help:"set/get a JS9.globalOpts parameter",
set:function(c){if(1==c.length){if(c=b.globalOpts[c[0]],b.notNull(c))switch(typeof c){case "boolean":return c?"true":"false";case "number":return String(c);case "string":return c;case "object":return JSON.stringify(c);default:return""}}else if(2<=c.length){var a=c[0];c=c[1];if("string"===typeof a&&"string"===typeof c)switch(typeof b.globalOpts[a]){case "boolean":b.globalOpts[a]=c.match(/true/i)?!0:!1;break;case "number":b.globalOpts[a]=parseFloat(c);break;case "string":b.globalOpts[a]=c;break;case "object":try{c=
JSON.parse(c)}catch(d){b.error("invalid JSON for global cmd: "+c)}b.globalOpts[a]=c}}}})),b.checkNew(new b.Command({name:"grid",help:"set/get coordinate grid for current image",get:function(){var b,a=this.image;a&&(b=a.displayCoordGrid());return b?"true":"false"},set:function(b){var a=this.image;if(a){var c=b[0].match(/true/i)?!0:!1;a.displayCoordGrid(c,b[1])}}})),b.checkNew(new b.Command({name:"help",help:"get list of available commands",get:function(){var c,a="<table class='JS9CmdHelp'>";for(c=
0;c<b.commands.length;c++){var d=b.commands[c];a+="<tr><td>"+d.name+"</td><td>"+d.help;d.alias&&(a+=" ("+d.alias,d.alias2&&(a+=", "+d.alias2),a+=")");a+="</td></tr>"}return a+'<tr><td colspan="2">&nbsp;</td></tr><tr><td colspan="2">Or execute JS9 public access routines (use spaceless args, please):</td></tr><tr><td colspan="2">&nbsp;</td></tr><tr><td colspan="2">SetColormap heat</td></tr><tr><td colspan="2">GetColormap</td></tr><tr><td colspan="2">{"colormap":"heat","contrast":3.75,"bias":0.736328125}</td></tr><tr><td colspan="2">AddRegions circle(23:23:27.9,+58:48:42.8,3") {"color":"cyan"}</td></tr></table>'}})),
b.checkNew(new b.Command({name:"helper",help:"set/get helper connection",get:function(){return b.helper.connectinfo()},set:function(c){b.helper.connect(c[0].trim())}})),b.checkNew(new b.Command({name:"image",help:"get name of current image or display specified image",get:function(){var b=this.image;if(b)return b.file},set:function(c){var a;for(a=0;a<b.images.length;a++){var d=b.images[a];if(0<=d.file.search(c[0])&&d.display===this.display){d.displayImage("display");break}}}})),b.checkNew(new b.Command({name:"images",
help:"get list of currently loaded images",get:function(){var c,a="";for(c=0;c<b.images.length;c++){var d=b.images[c];d.display===this.display&&(a&&(a+=", "),a+=d.file)}return a}})),b.checkNew(new b.Command({name:"load",help:"load image(s)",set:function(c){var a,d=c.length;for(a=0;a<d;a++){var e=null;var f=a+1;if(f<d&&c[f].startsWith("{"))try{e=JSON.parse(c[f])}catch(g){e=null}e?(b.Load(c[a],e,{display:this.display.id}),a++):b.Load(c[a],{display:this.display.id})}}})),b.checkNew(new b.Command({name:"pan",
help:"set/get pan location for current image",get:function(){var b;if(b=this.image)return b=b.getPan(),b.x+" "+b.x},set:function(b){var a=this.image;a&&a.setPan.apply(a,$jscomp.arrayFromIterable(b))}})),b.checkNew(new b.Command({name:"pix2wcs",help:"get image pixel value for specified wcs position",set:function(c){var a=this.image;if(a)return c=b.Pix2WCS(parseFloat(c[0]),parseFloat(c[1]),{display:a}),c.str}})),b.checkNew(new b.Command({name:"print",help:"print image window",get:function(){var b=this.image;
b&&b.print()}})),b.checkNew(new b.Command({name:"refresh",help:"refresh image using specified file (def: use last file)",set:function(c){var a=c.length;var d=this.image;if(0===a){var e={refresh:d};b.Load(d.file,e,{display:this.display.id})}else for(d=0;d<a;d++){e=null;var f=d+1;if(f<a&&c[f].startsWith("{"))try{e=JSON.parse(c[f])}catch(g){e=null}e?(e.refresh=!0,b.Load(c[d],e,{display:this.display.id}),d++):(e={refresh:!0},b.Load(c[d],e,{display:this.display.id}))}}})),b.checkNew(new b.Command({name:"regcnts",
help:"counts in regions for current image",get:function(){var b=this.image;b&&b.countsInRegions("$sregions","$bregions",{lightwin:!0})},set:function(b){var a=this.image;if(a)return a.countsInRegions.apply(a,$jscomp.arrayFromIterable(b))}})),b.checkNew(new b.Command({name:"regions",alias:"reg",alias2:"region",help:"add or list region(s)",get:function(){var b=this.image;if(b)return b.listRegions("all",{mode:0})||""},set:function(b){var a=this.image;a&&("delete"===b[0]||"remove"===b[0]?(b=b.slice(1).join(" "),
a.removeShapes("regions",b)):(b=b.join(" "),a.addShapes("regions",b)))}})),b.checkNew(new b.Command({name:"resize",help:"set/get display size for current image",get:function(){var b;if(b=this.image)return b=b.display,b.width+" "+b.height},set:function(b){var a;if((a=this.image)&&b.length){a=a.display;var c=parseInt(b[0],10);b=1<b.length?parseInt(b[1],10):c;a.resize(c,b)}}})),b.checkNew(new b.Command({name:"scale",help:"set/get scaling for current image",get:function(){var b;if(b=this.image)return b=
b.getScale(),b.scale+" "+b.scalemin+" "+b.scalemax},set:function(b){var a=this.image;a&&a.setScale.apply(a,$jscomp.arrayFromIterable(b))}})),b.checkNew(new b.Command({name:"scales",help:"get list of available scales",get:function(){return b.scales.join(", ")}})),b.checkNew(new b.Command({name:"section",help:"display section of current image",set:function(c){var a=this.image;if(1===c.length&&"full"===c[0])a.displaySection("full");else if(c=c.join(" ")){try{var d=JSON.parse(c)}catch(e){b.error("invalid JSON section")}a.displaySection(d)}}})),
b.checkNew(new b.Command({name:"status",help:"get status for specified (or current) image",get:function(c){var a,d="";for(a=0;a<b.images.length;a++){var e=b.images[a];if(0<=e.file.search(c[0])){var f=e;break}}f?a=1:(a=0,f=this.image);if(f){if(a>c.length)return f.status.load;for(;a<c.length;a++)switch(e=c[a].toLowerCase().trim(),e){case "load":d&&(d+="\n"),d+=f.status.load}}return d}})),b.checkNew(new b.Command({name:"url",help:"display a url",set:function(c){b.DisplayHelp(c[0])}})),b.checkNew(new b.Command({name:"wcssys",
help:"set/get wcs system for current image",get:function(){var b=this.image;if(b)return b.getWCSSys()},set:function(b){var a=this.image;a&&a.setWCSSys(b[0])}})),b.checkNew(new b.Command({name:"wcsu",help:"set/get wcs units used for current image",get:function(){var b=this.image;if(b)return b.getWCSUnits()},set:function(b){var a=this.image;a&&a.setWCSUnits(b[0])}})),b.checkNew(new b.Command({name:"wcssystems",help:"get list of available wcs systems",get:function(){return b.wcssyss.join(", ")}})),b.checkNew(new b.Command({name:"wcsunits",
help:"get list of available wcs units",get:function(){return b.wcsunitss.join(", ")}})),b.checkNew(new b.Command({name:"wcs2pix",help:"get wcs position for specified image pixel",set:function(c){var a=this.image;if(a)return c=b.WCS2Pix(parseFloat(c[0]),parseFloat(c[1]),{display:a}),c.str}})),b.checkNew(new b.Command({name:"zoom",help:"set/get zoom for current image",get:function(){var b=this.image;if(b)return b.getZoom()},set:function(b){var a=this.image;a&&a.setZoom(b[0])}})))};b.initAnalysis=function(){$(document).on("keypress",
".js9AnalysisForm, .js9Form, .js9Input",function(b){var a;if(13===(b.which||b.keyCode)&&(a=$(b.currentTarget).data("enterfunc"))){b.preventDefault();var c=$(b.currentTarget).find("[name='"+a+"']");c.length?c.click():(c=$(b.currentTarget).siblings("[name='"+a+"']"),c.length&&c.click());return!1}})};b.parsePublicArgs=function(b){var a=null;b=Array.from(b);var c=b[b.length-1];c&&"object"===typeof c&&{}.hasOwnProperty.call(c,"display")&&1===Object.keys(c).length&&(a=c.display,b.pop());return{argv:b,display:a}};
b.mkPublic=function(c,a){"string"===typeof a?b.Image.prototype[a]?(b[c]=function(c){for(var d=[],f=0;f<arguments.length;++f)d[f-0]=arguments[f];f=b.parsePublicArgs(d);d=f.argv;if(f=b.getImage(f.display))return d=f[a].apply(f,$jscomp.arrayFromIterable(d)),d===f||d===f.display?b.globalOpts.quietReturn?"":"OK":d},b.publics[c]=b[c]):b.error("unknown image func for mkPublic: "+a):"function"===typeof a?(b[c]=a,b.publics[c]=b[c]):b.error("unsupported type for mkPublic: "+typeof a)};b.mkPublic("CloseImage",
"closeImage");b.mkPublic("DisplayImage","displayImage");b.mkPublic("DisplayExtension","displayExtension");b.mkPublic("DisplaySlice","displaySlice");b.mkPublic("DisplaySection","displaySection");b.mkPublic("BlendImage","blendImage");b.mkPublic("MaskImage","maskImage");b.mkPublic("GetColormap","getColormap");b.mkPublic("SetColormap","setColormap");b.mkPublic("GetZoom","getZoom");b.mkPublic("SetZoom","setZoom");b.mkPublic("GetPan","getPan");b.mkPublic("SetPan","setPan");b.mkPublic("AlignPanZoom","alignPanZoom");
b.mkPublic("GetScale","getScale");b.mkPublic("SetScale","setScale");b.mkPublic("GetOpacity","getOpacity");b.mkPublic("SetOpacity","setOpacity");b.mkPublic("SetFlip","setFlip");b.mkPublic("GetFlip","getFlip");b.mkPublic("SetRotate","setRotate");b.mkPublic("GetRotate","getRotate");b.mkPublic("SetRot90","setRot90");b.mkPublic("GetRot90","getRot90");b.mkPublic("GetParam","getParam");b.mkPublic("SetParam","setParam");b.mkPublic("CopyParams","copyParams");b.mkPublic("GetValPos","updateValpos");b.mkPublic("ImageToDisplayPos",
"imageToDisplayPos");b.mkPublic("DisplayToImagePos","displayToImagePos");b.mkPublic("ImageToLogicalPos","imageToLogicalPos");b.mkPublic("LogicalToImagePos","logicalToImagePos");b.mkPublic("GetWCSUnits","getWCSUnits");b.mkPublic("SetWCSUnits","setWCSUnits");b.mkPublic("GetWCS","getWCS");b.mkPublic("SetWCS","setWCS");b.mkPublic("GetWCSSys","getWCSSys");b.mkPublic("SetWCSSys","setWCSSys");b.mkPublic("ShowShapeLayer","showShapeLayer");b.mkPublic("ActiveShapeLayer","activeShapeLayer");b.mkPublic("ToggleShapeLayers",
"toggleShapeLayers");b.mkPublic("AddShapes","addShapes");b.mkPublic("RemoveShapes","removeShapes");b.mkPublic("GetShapes","getShapes");b.mkPublic("ChangeShapes","changeShapes");b.mkPublic("CopyShapes","copyShapes");b.mkPublic("SelectShapes","selectShapes");b.mkPublic("UnselectShapes","unselectShapes");b.mkPublic("GroupShapes","groupShapes");b.mkPublic("UngroupShapes","ungroupShapes");b.mkPublic("DisplayCoordGrid","displayCoordGrid");b.mkPublic("Print","print");b.mkPublic("SavePNG","savePNG");b.mkPublic("SaveJPEG",
"saveJPEG");b.mkPublic("SaveFITS","saveFITS");b.mkPublic("UploadFITSFile","uploadFITSFile");b.mkPublic("CountsInRegions","countsInRegions");b.mkPublic("RadialProfile","radialProfile");b.mkPublic("Plot3D","plot3d");b.mkPublic("RunAnalysis","runAnalysis");b.mkPublic("GetAnalysis","getAnalysis");b.mkPublic("RawDataLayer","rawDataLayer");b.mkPublic("GaussBlurData","gaussBlurData");b.mkPublic("ImarithData","imarithData");b.mkPublic("RotateData","rotateData");b.mkPublic("ReprojectData","reprojectData");
b.mkPublic("ShiftData","shiftData");b.mkPublic("FilterRGBImage","filterRGBImage");b.mkPublic("MoveToDisplay","moveToDisplay");b.mkPublic("LookupImage",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=b.parsePublicArgs(a);return b.lookupImage(a.argv[0],a.display)});b.mkPublic("LookupDisplay",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=b.parsePublicArgs(a);return b.lookupDisplay(a.argv[0]||a.display,a.argv[1])});b.mkPublic("DisplayNextImage",function(c){for(var a=
[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];d=b.parsePublicArgs(a);if(a=b.lookupDisplay(d.display))return d=parseFloat(d.argv[0])||1,a.nextImage(d)});b.mkPublic("RenameDisplay",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e;d=b.parsePublicArgs(a);switch(d.argv.length){case 0:return;case 1:a=d.display;d=d.argv[0];break;default:a=d.argv[0],d=d.argv[1]}(e=b.lookupDisplay(a))&&e.id&&(a=e.id,e.oid||(e.oid=a),e.id=d,b.helper.send("renameDisplay",{odisplay:a,ndisplay:e.id}))});
b.mkPublic("CloseDisplay",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];d=b.parsePublicArgs(a);a=b.lookupDisplay(d.argv[0],!1);if(!a){a=b.lookupDisplay(d.display);var e=d.argv[0]}if(e=d.argv[1]||e)try{var f=new RegExp(e)}catch(g){b.error("invalid regexp for CloseDisplay: "+e)}for(e=b.images.length-1;0<=e;e--)d=b.images[e],d.display===a&&(f?(d.id.match(f)||d.file.match(f)||d.fitsFile.match(f))&&d.closeImage():d.closeImage())});b.mkPublic("AddColormap",function(c){for(var a=
[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=b.parsePublicArgs(a),f=function(a,c){var d;"object"!==typeof a&&b.error("invalid colormap object for JS9.AddColormap()");$.isArray(a)||(a=[a]);for(d=0;d<a.length;d++){var e=a[d];e.name||b.error("missing name for colormap in JS9.AddColormap()");e.vertices?b.AddColormap(e.name,e.vertices[0],e.vertices[1],e.vertices[2],c):e.colors?b.AddColormap(e.name,e.colors,c):b.error("unknown colormap type for JS9.AddColormap()")}};a=e.argv[0];var g=e.argv[1];
d=e.argv[2];var h=e.argv[3];var k=e.argv[4];if(a instanceof Blob)d=new FileReader,d.onload=function(a){try{m=JSON.parse(a.target.result)}catch(p){b.error("can't parse JSON colormap",p)}f(m,g)},d.readAsText(a);else if("object"===typeof a)f(a,g);else switch(e.argv.length){case 1:try{var m=JSON.parse(a)}catch(l){b.error("can't parse JSON colormap",l)}f(m);break;case 2:case 3:if("string"===typeof g)try{g=JSON.parse(g)}catch(l){b.error("can't parse JSON colormap",l)}b.checkNew(new b.Colormap(a,g));2===
e.argv.length?b.globalOpts.topColormaps.push(a):("object"!==typeof d||!1!==d.toplevel)&&b.globalOpts.topColormaps.push(a);break;case 4:case 5:if("string"===typeof g)try{g=JSON.parse(g)}catch(l){b.error("can't parse JSON colormap",l)}if("string"===typeof d)try{d=JSON.parse(d)}catch(l){b.error("can't parse JSON colormap",l)}if("string"===typeof h)try{h=JSON.parse(h)}catch(l){b.error("can't parse JSON colormap",l)}b.checkNew(new b.Colormap(a,g,d,h));4===e.argv.length?b.globalOpts.topColormaps.push(a):
k&&"object"===typeof k&&!1===k.toplevel||b.globalOpts.topColormaps.push(a);break;default:b.error("AddColormap() requires a colormap name and 1 or 3 args")}});b.mkPublic("LoadColormap",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];d=b.parsePublicArgs(a);a=d.argv[0];var e=d.argv[1];a||b.error("JS9.LoadColormap: no file specified for colormap load");"object"===typeof a?b.AddColormap(a,e):"string"===typeof a?(a=b.fixPath(a,e),b.fetchURL(null,a,null,function(a){b.AddColormap(a,
e)})):b.error("unknown file type for LoadColormap: "+typeof a)});b.mkPublic("SetRGBMode",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=b.parsePublicArgs(a),f=b.lookupDisplay(e.display),g=["red","green","blue"],h=["rid","gid","bid"];var k=e.argv[0];var m=e.argv[1];void 0===k&&(k=!f.rgb.active);if(m)for(a=0;3>a;a++)d=m[h[a]],"string"===typeof d&&(d=b.LookupImage(d)),d&&d.setColormap(g[a]);"true"===k?k=!0:"false"===k&&(k=!1);f.rgb.active=!!k;b.DisplayImage({display:e.display});
return f.rgb.active});b.mkPublic("GetRGBMode",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=b.parsePublicArgs(a);a=b.lookupDisplay(a.display);return{active:a.rgb.active,rid:a.rgb.rim?a.rgb.rim.id:null,gid:a.rgb.gim?a.rgb.gim.id:null,bid:a.rgb.bim?a.rgb.bim.id:null}});b.mkPublic("SetValPos",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];d=null;var e=b.parsePublicArgs(a);a=b.getImage(e.display);e=e.argv[0];a&&(d=a.params.valpos,a.params.valpos=e);
return d});b.mkPublic("SetImageInherit",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];d=null;var e=b.parsePublicArgs(a);a=b.getImage(e.display);e=e.argv[0];a&&(d=a.params.inherit,a.params.inherit=e);return d});b.mkPublic("GetImageInherit",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];d=null;a=b.parsePublicArgs(a);if(a=b.getImage(a.display))d=a.params.inherit;return d});b.mkPublic("Load",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=
arguments[d];var e;d="fits";var f=b.parsePublicArgs(a);var g=f.argv[0];a=f.argv[1];g||b.error("JS9.Load: no file specified for image load");f=f.display?f.display:0<b.displays.length?b.displays[0].id:b.DEFID;a=a||{};if("object"===typeof a)a=$.extend(!0,{},a);else if("string"===typeof a)try{a=JSON.parse(a)}catch(m){a={}}a.display=a.display||f;if(a.onload)var h=a.onload;else b.imageOpts.onload&&(h=b.imageOpts.onload,a.onload=h);delete b.fetchURL.status;if(g instanceof Blob){if(g.path||g.name)if(a.file=
b.cleanPath(g.path||g.name),h="object"===typeof a.refresh?a.refresh:b.lookupImage(a.file,a.display))if(b.isNull(a.refresh)&&(a.refresh=b.globalOpts.reloadRefresh),a.refresh)a.refresh=h;else{h.displayImage("display",a);h.refreshLayers();h.display.clearMessage();if(a.onload)try{b.xeqByName(a.onload,window,h)}catch(m){b.error("in image onload callback",m,!1)}b.waiting(!1);return}else delete a.refresh;else delete a.refresh;a.file||(a.file=b.ANON+b.uniqueID());if(g.type&&g.type.includes("image/"))switch(g.type){case "image/fits":break;
default:d="img"}else a.file.split(".").pop().match(/(png|jpg|jpeg)/i)&&(d="img");switch(d){case "fits":var k=$.extend(!0,{},b.fits.options,a);g.path&&a.localAccess&&(h=b.localAccess(g.path))&&(g=g.path,k.file=g,k.vfile=h);try{b.handleFITSFile(g,k,b.NewFitsImage)}catch(m){b.error("can't process FITS file",m)}break;case "img":try{b.handleImageFile(g,a,b.Load)}catch(m){b.error("can't process IMG file",m)}}}else if("object"===typeof g)b.checkNew(new b.Image(g,a,h));else if("string"!==typeof g&&b.error("unknown file type for Load: "+
typeof g),"U0lNUExFICA9"===g.slice(0,12)&&(g=window.atob(g)),"SIMPLE  ="===g.slice(0,9)){h=[];for(e=0;e<g.length;e++)h[e]=g.charCodeAt(e);e=new Blob([new Uint8Array(h)]);a.file||(a.file=b.ANON+b.uniqueID());e.name=a.file;k=$.extend(!0,{},b.fits.options,a);try{b.handleFITSFile(e,k,b.NewFitsImage)}catch(m){b.error("can't process FITS file",m)}}else{b.isNull(a.refresh)&&(a.refresh=b.globalOpts.reloadRefresh);if(a.refresh)if("object"===typeof a.refresh)h=a.refresh;else{if(h=g.split("/").reverse()[0],
h=b.lookupImage(h,a.display))a.refresh=h}else h=g.split("/").reverse()[0],h=b.lookupImage(h,a.display);if(h&&!a.refresh){h.displayImage("all",a);h.display.clearMessage();if(a.onload)try{b.xeqByName(a.onload,window,h)}catch(m){b.error("in image onload callback",m,!1)}b.waiting(!1)}else g=b.cleanPath(g),b.fits2fits(a.display,g,a)||(a.display&&(e=b.lookupDisplay(a.display)),b.waiting(!0,e),h&&a.refresh&&b.cleanupFITSFile(h.raw,!0),g=b.fixPath(g,a),e=g.replace(/\[.*\]/,""),(h=b.localAccess(g))?(k=$.extend(!0,
{},b.fits.options,a),k.file=g,k.vfile=h,window.setTimeout(function(){try{b.handleFITSFile(g,k,b.NewFitsImage)}catch(m){b.error("can't process FITS file",m)}},0)):b.fetchURL(g,e,a))}});b.mkPublic("LoadWindow",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e,f,g,h,k,m,l,p=b.lightOpts[b.LIGHTWIN];var r=b.parsePublicArgs(a);var n=function(a){a=$.inArray(a,b.displays);0<=a&&b.displays.splice(a,1)};var u=function(a,c,d){var f;c=c||{};c.clone&&(f=b.lookupDisplay(c.clone,!1));
d&&(k=d.match(/(.*width=)([0-9]+)(px,height=)([0-9]+)(px.*)/,"$1@@H@@$3"),m=parseInt(k[2],10),l=parseInt(k[4],10));var g="<hr class='hline0'>";!f||0<$("#"+c.clone+"Menubar").length&&!f.pluginInstances.JS9Menubar.isDynamic?g+="<div class='JS9Menubar' id='"+a+"Menubar'></div>":d&&(l-=40);g+="<div class='JS9' id='"+a+"'></div>";!f||0<$("#"+c.clone+"Colorbar").length&&0===$("#"+c.clone+"Statusbar").length&&!f.pluginInstances.JS9Colorbar.isDynamic?(e=f&&f.pluginInstances.JS9Colorbar?"data-showTicks='"+
f.pluginInstances.JS9Colorbar.showTicks+"'":"",g+="<div style='margin-top: 2px;'><div class='JS9Colorbar' id='"+a+"Colorbar' "+e+"></div></div>",f&&f.pluginInstances.JS9Colorbar&&!f.pluginInstances.JS9Colorbar.showTicks&&(l-=15)):d&&(l-=44);!f||0<$("#"+c.clone+"Statusbar").length&&!f.pluginInstances.JS9Statusbar.isDynamic?g+="<div class='JS9Statusbar' id='"+a+"Statusbar'></div>":d&&(l-=40);return d?(b.Dysel.retrievePlugins().length&&(m+=2,l+=2),{html:g,winopts:k[1]+String(m)+k[3]+String(l)+k[5]}):
g};var x=function(a,c){var d=new b.Display(z);d.winid=C;b.helper.send("addDisplay",{display:z});b.instantiatePlugins();c.display=z;a&&b.Load(a,c);return d};var t=function(a){var c;var d=0;var e=[];for(c=0;c<b.images.length;c++)d=b.images[c],d.display.id===z&&e.push(d);if(!e.length)return n(a),!0;if("move"===b.globalOpts.lightWinClose){if(b.isNull(b.globalOpts.lightWinMoveTo)||b.globalOpts.lightWinMoveTo===z)d=0;else for(d=c=0;c<b.displays.length;c++)if(b.displays[c].id===b.globalOpts.lightWinMoveTo){d++;
break}d||(b.globalOpts.lightWinClose="ask",delete b.globalOpts.lightWinMoveTo)}switch(b.globalOpts.lightWinClose){case "close":n(a);for(c=0;c<e.length;c++)try{e[c].closeImage()}catch(J){}return!0;case "move":n(a);for(c=0;c<e.length;c++)try{e[c].moveToDisplay(b.globalOpts.lightWinMoveTo)}catch(J){}return!0;default:return f="lightCloseID"+b.uniqueID(),b.allinone?(g="inline",h=b.allinone.lightCloseHTML):(g="ajax",h=b.InstallDir(b.lightOpts.lcloseURL)),$(b.lightOpts[b.LIGHTWIN].topid).arrive("#lightWinCloseForm",
{onceOnly:!0},function(){var a;var c=$("#lightWinCloseForm").find("#lightWinCloseSel");for(a=0;a<b.displays.length;a++)b.displays[a].id!==z&&c.append($("<option>",{value:b.displays[a].id,text:b.displays[a].id}))}),y=b.lightWin(f,g,h,"Closing a light window",p.lcloseWin),$(y).data("dispid",z),$(y).data("winid",C),!1}};d=r.argv[0];var v=r.argv[1];var w=r.argv[2];a=r.argv[3];r=r.argv[4];v=v||{};if("object"===typeof v)v=$.extend(!0,{},v);else if("string"===typeof v)try{v=JSON.parse(v)}catch(D){v={}}w=
w||"light";var q=w+"win";switch(w){case "light":if(v.id){var z=v.id;delete v.id}else z=q+b.uniqueID();var y="d"+z;if(a)r=r||p.imageWin;else{var A=u(z,v,p.imageWin);a=A.html;r=r||A.winopts}A=sprintf("JS9 Display"+b.IDFMT,z);var C=b.lightWin(y,"inline",a,A,r);var B=x(d,v);C.onclose=function(){return t(B)};return z;case "new":v.id?(z=v.id,delete v.id):z=q+b.uniqueID();r=r||"width="+b.globalOpts.newWindowWidth+", height="+b.globalOpts.newWindowHeight;x=document.getElementsByTagName("head")[0].innerHTML;
x=x.replace(/src=['"].*astroemw?\.js['"]/,"");x.match(/src=["'].*js9\.js/)||x.match(/src=["'].*js9\.min\.js/)||(x+='<script type="text/javascript" src="js9.min.js">\x3c/script>');u=a||u(z,v);a="<html><head>"+x+"</head><body";d&&(a+=sprintf(" onload='JS9.Preload(\"%s\",%s);'",d,JSON.stringify(v)));a+=">"+u+"</body></html>\n";window.electron&&(A="data:text/html,<html><body><script>window.addEventListener('message', (ev) => {document.documentElement.innerHTML=ev.data\x3c/script><p></body></html>");if(A=
window.open(A,z,r))return A.document?(A.document.open(),A.document.write(a),A.document.close()):A.postMessage?b.error("LoadWindow('new') is disabled on the Desktop for security reasons"):b.error("no method available for drawing image into window"),z;b.error("could not create window (check your pop-up blockers)")}});b.mkPublic("LoadProxy",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e,f,g=b.parsePublicArgs(a);var h=g.argv[0];var k=g.argv[1];b.globalOpts.loadProxy||b.error("proxy load not available for server");
b.globalOpts.workDir||b.error("proxy load requires a temp workDir for server");h||b.error("no url specified for proxy load");h=h.trim();h.match(/dropbox\.com/)?(h=h.replace("www.dropbox.com","dl.dropboxusercontent.com"),h=h.replace("?dl=0","")+"?raw=1"):h.match(/drive\.google\.com/)&&(h=h.replace(/\/file\/d\/(\w+)\/\w+\?usp=sharing/,"/uc?export=download&id=$1"));g.display&&(f=b.lookupDisplay(g.display));k=k||{};if("object"===typeof k)k=$.extend(!0,{},k);else if("string"===typeof k)try{k=JSON.parse(k)}catch(m){k=
{}}k.ofile?(a=k.ofile,delete k.ofile):a="";b.waiting(!0,f);b.Send("loadproxy",{cmd:"js9Xeq loadproxy "+h+" "+a},function(a){a="object"===typeof a?a:0<=a.search(b.analOpts.epattern)?{stderr:a}:{stdout:a};a.errcode=a.errcode||0;a.stderr?b.error(a.stderr):a.stdout?(a=a.stdout.split(/\s+/))&&a[0]&&(e=b.cleanPath(a[0]),k.proxyFile=e,"/"!==e.charAt(0)&&(e=b.InstallDir(e)),a[1]&&(a=b.cleanPath(a[1]),k.parentFile=a,k.proxyParent=a),k.fixpath=!1,k.proxyURL=h,b.Load(e,k,{display:g.display})):b.error("internal error: no return from load proxy command")})});
b.mkPublic("Preload",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e;d="";var f=null,g=null,h=a.length,k=b.globalOpts.alerts;var m=b.parsePublicArgs(a);var l=b.URLEXP,p=/\.ses$/,r=/\.cmap$/;var n=m.argv[0];b.globalOpts.loadProxy&&b.helper.baseurl&&(e=new RegExp("^"+b.helper.baseurl));m.display&&(g={display:m.display},--h);switch(h){case 0:n=(null===b.helper.connected||b.helper.connected)&&b.fits.name&&0<b.preloads.length?2:3;break;case 1:n="boolean"===typeof n?n&&0<b.preloads.length?
2:3:(null===b.helper.connected||b.helper.connected)&&b.fits.name?1:0;break;default:n=(null===b.helper.connected||b.helper.connected)&&b.fits.name?1:0}switch(n){case 0:for(n=0;n<h;n++)if(m=n+1,m<h&&"object"===typeof a[m])f=$.extend(!0,{},a[m]),b.preloads.push([a[n],f,g]),n++;else if(m<h&&a[m].startsWith("{")){try{f=JSON.parse(a[m])}catch(x){f=null}b.preloads.push([a[n],f,g]);n++}else b.preloads.push([a[n],null,g]);break;case 1:b.globalOpts.alerts=!1;for(n=0;n<h;n++){var u=e&&a[n].match(l)&&!a[n].match(e)?
b.LoadProxy:a[n].match(p)?b.LoadSession:a[n].match(r)?b.LoadColormap:b.Load;m=n+1;if(m<h&&"object"===typeof a[m]){u!==b.Load&&u!==b.LoadProxy||b.preloadwaiting.push({id:b.cleanPath(a[n]),loaded:!1});try{g?u(a[n],a[m],g):u(a[n],a[m])}catch(x){d=d+" "+a[n]}n++}else if(m<h&&a[m].startsWith("{")){try{f=JSON.parse(a[m])}catch(x){f=null}u!==b.Load&&u!==b.LoadProxy||b.preloadwaiting.push({id:b.cleanPath(a[n]),loaded:!1});try{g?u(a[n],f,g):u(a[n],f)}catch(x){d=d+" "+a[n]}n++}else{u!==b.Load&&u!==b.LoadProxy||
b.preloadwaiting.push({id:b.cleanPath(a[n]),loaded:!1});try{g?u(a[n],null,g):u(a[n],null)}catch(x){d=d+" "+a[n]}}}b.globalOpts.alerts=k;d&&b.error("could not preload image(s): "+d);break;case 2:b.globalOpts.alerts=!1;for(n=0;n<b.preloads.length;n++){u=e&&b.preloads[n][0].match(l)&&!b.preloads[n][0].match(e)?b.LoadProxy:b.preloads[n][0].match(p)?b.LoadSession:b.preloads[n][0].match(r)?b.LoadColormap:b.Load;u!==b.Load&&u!==b.LoadProxy||b.preloadwaiting.push({id:b.cleanPath(b.cleanPath(b.preloads[n][0])),
loaded:!1});try{b.preloads[n][2]?u(b.preloads[n][0],b.preloads[n][1],b.preloads[n][2]):u(b.preloads[n][0],b.preloads[n][1])}catch(x){d=d+" "+b.preloads[n][0]}}b.globalOpts.alerts=k;d&&b.error("could not preload image(s): "+d);b.preloads=[]}});b.mkPublic("RefreshImage",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=b.parsePublicArgs(a),f=b.getImage(e.display),g=function(b){f.refreshImage(b,h)};d=e.argv[0];var h=e.argv[1]||{};if(f)if(h.id=f.id,d instanceof Blob){h.rawid&&
h.rawid!==f.raw.id||b.cleanupFITSFile(f.raw,!0);try{b.handleFITSFile(d,b.fits.options,g)}catch(k){b.error("can't refresh FITS file",k)}}else f.refreshImage(d,h);else d instanceof Blob&&b.Load.apply(b,$jscomp.arrayFromIterable(a))});b.mkPublic("GetStatus",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=b.parsePublicArgs(a);d=b.getImage(a.argv[1]||a.display);var e=a.argv[0]||"load";return a.argv.length?b.fetchURL.status&&e.match(/^(pre)?load$/i)?b.fetchURL.status:d?d.getStatus(e):
"none":"Load CreateMosaic DisplaySection LoadCatalog LoadRegions ReprojectData RotateData RunAnalysis".split(" ")});b.mkPublic("GetLoadStatus",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];return b.GetStatus.apply(b,["load"].concat($jscomp.arrayFromIterable(a)))});b.mkPublic("CopyToClipboard",function(c,a){var d,e=$(document).scrollLeft(),f=$(document).scrollTop();b.clipboard=c;var g=document.createElement("textarea");g.style.position="fixed";g.style.top=0;g.style.left=0;
g.style.width="2em";g.style.height="2em";g.style.padding=0;g.style.border="none";g.style.outline="none";g.style.boxShadow="none";g.style.background="transparent";g.value=c;document.body.appendChild(g);g.select();try{if(d=document.execCommand("copy"))var h="OK";else h="MANUAL",b.BROWSER[2].match(/Mac/)?window.prompt("copy to clipboard: Cmd+C",c):window.prompt("copy to clipboard: Ctrl+C",c)}catch(k){h="ERROR"}document.body.removeChild(g);a&&a.display&&(a.display.displayConjq.focus(),window.scrollTo(e,
f));return h});b.mkPublic("CopyFromClipboard",function(){return b.clipboard||""});b.mkPublic("OpenFileMenu",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=b.parsePublicArgs(a);(a=b.lookupDisplay(a.display))&&$("#openLocalLoad-"+a.id).click()});b.mkPublic("OpenRegionsMenu",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=b.parsePublicArgs(a);(a=b.lookupDisplay(a.display))&&$("#openLocalLoadRegions-"+a.id).click()});b.mkPublic("OpenSessionMenu",function(c){for(var a=
[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=b.parsePublicArgs(a);(a=b.lookupDisplay(a.display))&&$("#openLocalLoadSession-"+a.id).click()});b.mkPublic("OpenCatalogsMenu",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=b.parsePublicArgs(a);(a=b.lookupDisplay(a.display))&&$("#openLocalLoadCatalog-"+a.id).click()});b.mkPublic("OpenColormapMenu",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=b.parsePublicArgs(a);(a=b.lookupDisplay(a.display))&&
$("#openLocalLoadColormap-"+a.id).click()});b.mkPublic("SaveColormap",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=b.parsePublicArgs(a);var f=function(b){var a=b;if("string"===typeof b)try{a=JSON.parse(b)}catch(p){}return a},g=function(a){var c,d,e=[];for(c=0;c<a.length;c++)if(d=b.lookupColormap(a[c]))d=$.extend(!0,{},d),delete d.type,e.push(d);return 1===e.length?e[0]:e};a=e.argv[0];d=e.argv[1];if({}.hasOwnProperty.call(window,"saveAs")){if(e=b.getImage(e.display)){a=
f(a);d=f(d);if(a)"string"===typeof a?(h=a,"string"===typeof d?k=g([d]):$.isArray(d)?k=g(d):(k=$.extend(!0,{},e.cmapObj),delete k.type)):$.isArray(a)&&(h="js9.cmap",k=g(a));else{var h="js9.cmap";var k=$.extend(!0,{},e.cmapObj);delete k.type}k=JSON.stringify(k);k=new Blob([k],{type:"text/plain"});b.saveAs(k,h)}}else b.error("no saveAs() available to save colormap");return h});b.mkPublic("NewFitsImage",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=b.parsePublicArgs(a);
a=e.argv[0];d=e.argv[1]||{};e=b.lookupDisplay(e.display||d.display||b.DEFID);if(d.refresh){if("object"===typeof d.refresh)var f=d.refresh;else e&&e.image&&(f=e.image);if(f)d.onload&&(d.onrefresh=d.onload,delete d.onload),f.refreshImage(a,d);else{if(d.onload)var g=d.onload;b.checkNew(new b.Image(a,d,g))}}else d.onload&&(g=d.onload),b.checkNew(new b.Image(a,d,g))});b.mkPublic("GetImage",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=b.parsePublicArgs(a);d=a.argv[0];"string"!==
typeof d&&(d=a.display);return b.getImage(d)});b.mkPublic("GetImageData",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];d=b.parsePublicArgs(a);a=b.getImage(d.display);d=d.argv[0];return a?a.getImageData(d):null});b.mkPublic("GetDisplayData",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];d=[];var e=b.parsePublicArgs(a);a=e.display||b.displays[0].id;var f=e.argv[0];for(e=0;e<b.images.length;e++){var g=b.images[e];g.display.id===a&&d.push(g.getImageData(f))}return d});
b.mkPublic("GetFITSHeader",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];d="";var e=b.parsePublicArgs(a);a=b.getImage(e.display);e=e.argv[0];a&&a.raw&&(d=b.raw2FITS(a.raw,{addcr:e}));return d});b.mkPublic("BlendDisplay",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];d=[];var e=b.parsePublicArgs(a);a=e.display||b.DEFID;var f=b.lookupDisplay(a);e=e.argv[0];f||b.error("no JS9 display found: "+a);if(void 0===e||"mode"===e)return f.blendMode;if("list"===
e){for(e=0;e<b.images.length;e++){var g=b.images[e];g.display.id===a&&g.blend.active&&d.push(g.id)}return d}if("reset"===e){for(e=0;e<b.images.length;e++)g=b.images[e],g.display.id===a&&g.blend.active&&g.blendImage(!1);e=!1}"true"===e?e=!0:"false"===e&&(e=!1);f.blendMode=!!e;f.image&&(f.image.xeqPlugins("image","ondisplayblend"),f.image.displayImage());return f.blendMode});b.mkPublic("LoadAuxFile",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=b.parsePublicArgs(a);d=
b.getImage(e.display);a=e.argv[0];e=e.argv[1];d?d.loadAuxFile(a,e):b.error("could not find image for aux file: "+a)});b.mkPublic("SubmitAnalysis",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e,f;var g=b.lightOpts[b.LIGHTWIN];var h=b.parsePublicArgs(a);var k=h.argv[0];a=h.argv[1];d=h.argv[2];a?g=b.lookupDisplay(h.display).id:(g=$(k).closest(g.top),a=g.data("aname"),g=g.data("dispid"));a?g&&(e=b.getImage(g)):f="internal error: could not find analysis task name";if(e){k=
$(k).closest("form");try{var m=k.serializeArray();m=m.concat($("#"+k.attr("id")+" input[type=checkbox]:not(:checked)").map(function(){return{name:this.name,value:"false"}}).get())}catch(l){m=null}e.runAnalysis(a,m,d)}else f="internal error: could not find image";f&&b.error(f);return!1});b.mkPublic("Send",function(c,a,d){b.helper.connected?b.helper.send(c,a,d):b.error("no JS9 helper available")});b.mkPublic("EventToDisplayPos",function(c){return b.eventToDisplayPos(c)});b.mkPublic("PixToWCS",function(c){for(var a=
[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];d=1;var e=b.parsePublicArgs(a);if(a=b.getImage(e.display)){var f=e.argv[0];if("object"===typeof f&&b.notNull(f.x)&&b.notNull(f.y)){var g=f.x;f=f.y}else g=e.argv[0],f=e.argv[1];b.isNumber(g)&&b.isNumber(f)||b.error("invalid input for PixToWCS");if(a.validWCS())return g=b.pix2wcs(a.raw.wcs,g,f).trim(),f=g.split(/ +/),"sexagesimal"===a.params.wcsunits&&"galactic"!==a.params.wcssys&&"ecliptic"!==a.params.wcssys&&(d=15),{ra:b.saostrtod(f[0])*d,dec:b.saostrtod(f[1]),
sys:f[2],str:g}}});b.Pix2WCS=b.PixToWCS;b.mkPublic("WCSToPix",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=b.parsePublicArgs(a);if(d=b.getImage(e.display)){var f=e.argv[0];"object"===typeof f&&b.notNull(f.ra)&&b.notNull(f.dec)?(a=f.ra,f=f.dec):(a=e.argv[0],f=e.argv[1]);b.isNumber(a)&&b.isNumber(f)||b.error("invalid input for WCSToPix");if(d.validWCS())return d=b.wcs2pix(d.raw.wcs,a,f).trim().split(/ +/),a=parseFloat(d[0]),f=parseFloat(d[1]),d=sprintf("%f %f",a,f),
{x:a,y:f,str:d}}return null});b.WCS2Pix=b.WCSToPix;b.mkPublic("NewShapeLayer",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=b.parsePublicArgs(a);d=b.getImage(e.display);a=e.argv[0];e=e.argv[1];return d?d.display.newShapeLayer(a,e):null});b.mkPublic("AddRegions",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=b.parsePublicArgs(a);d=b.getImage(e.display);a=e.argv[0];e=e.argv[1];return d?(a||b.error("no region specified for AddRegions"),d.addShapes("regions",
a,e)):null});b.mkPublic("RemoveRegions",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];d=b.parsePublicArgs(a);a=b.getImage(d.display);d=d.argv[0];return a?(a.removeShapes("regions",d),a.display.clearMessage("regions"),b.globalOpts.quietReturn?"":"OK"):null});b.mkPublic("CopyRegions",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=b.parsePublicArgs(a);a=b.getImage(e.display);d=e.argv[0];e=e.argv[1];return a?(a.copyRegions(d,e),b.globalOpts.quietReturn?
"":"OK"):null});b.mkPublic("GetRegions",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=b.parsePublicArgs(a);return(d=b.getImage(a.display))?(a.argv.unshift("regions"),d.getShapes.apply(d,$jscomp.arrayFromIterable(a.argv))):null});b.mkPublic("ListRegions",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=b.parsePublicArgs(a);return(d=b.getImage(e.display))?(a=e.argv[0]||"all",e=e.argv[1]||{mode:2},d.listRegions(a,e,e.layer)):null});b.mkPublic("ListGroups",
function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=b.parsePublicArgs(a);return(d=b.getImage(e.display))?(a=e.argv[0]||"all",e=e.argv[1]||{},d.listGroups(a,e,e.layer)):null});b.mkPublic("EditRegions",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=b.parsePublicArgs(a);if(a=b.getImage(a.display))if(d=a.layers.regions)(d=d.canvas.getActiveObject())&&"activeSelection"!==d.type?a.displayRegionsForm(d):a.displayRegionsForm(null,{multi:!0});return null});
b.mkPublic("ChangeRegions",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=b.parsePublicArgs(a);a=b.getImage(e.display);d=e.argv[0];e=e.argv[1];a&&a.changeShapes("regions",d,e);return null});b.mkPublic("SaveRegions",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=b.parsePublicArgs(a);d=b.getImage(a.display);var e=a.argv[0],f=a.argv[1],g=a.argv[2];if(d)if(1===a.argv.length&&"dialogbox"===e)d.displayRegionsForm(null,{type:"save"});else return d.saveRegions(e,
f,g);return null});b.mkPublic("SelectRegions",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=b.parsePublicArgs(a);d=b.getImage(e.display);a=e.argv[0];e=e.argv[1];return d?d.selectShapes("regions",a,e):null});b.mkPublic("UnselectRegions",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=b.parsePublicArgs(a);d=b.getImage(e.display);a=e.argv[0];e=e.argv[1];return d?d.unselectShapes("regions",a,e):null});b.mkPublic("GroupRegions",function(c){for(var a=
[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=b.parsePublicArgs(a);d=b.getImage(e.display);a=e.argv[0];e=e.argv[1];return d?d.groupShapes("regions",a,e):null});b.mkPublic("UngroupRegions",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=b.parsePublicArgs(a);d=b.getImage(e.display);a=e.argv[0];e=e.argv[1];return d?d.ungroupShapes("regions",a,e):null});b.mkPublic("ChangeRegionTags",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=b.parsePublicArgs(a);
a=b.getImage(e.display);d=e.argv[0];var f=e.argv[1];e=e.argv[2];return a?a.changeRegionTags(d,f,e):null});b.mkPublic("ToggleRegionTags",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=b.parsePublicArgs(a);a=b.getImage(e.display);d=e.argv[0];var f=e.argv[1];e=e.argv[2];return a?a.toggleRegionTags(d,f,e):null});b.mkPublic("UnremoveRegions",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=b.parsePublicArgs(a);return(a=b.getImage(a.display))?a.unremoveRegions():
null});b.mkPublic("LoadRegions",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];d=b.parsePublicArgs(a);var e=b.getImage(d.display),f=function(a,c){c&&void 0!==c.display&&delete c.display;e.addShapes("regions",a,c);e.setStatus("loadRegions","complete");if(g&&g.onload)try{b.xeqByName(g.onload,window,e)}catch(m){b.error("in regions onload callback",m,!1)}};a=d.argv[0];var g=d.argv[1];a||b.error("JS9.LoadRegions: no file specified for regions load");if(e){e.setStatus("loadRegions",
"processing");g=g||{};if("object"===typeof g)g=$.extend(!0,{},g);else if("string"===typeof g)try{g=JSON.parse(g)}catch(h){g={}}if("object"===typeof a){if(d=a.path||a.name)g.file=d.split("/").reverse()[0];d=new FileReader;d.onload=function(b){f(b.target.result,g)};d.readAsText(a)}else"string"===typeof a?(g.responseType="text",a=b.fixPath(a,g),g.file=a.split("/").reverse()[0],b.fetchURL(null,a,g,f)):b.error("unknown file type for LoadRegions: "+typeof a)}});b.mkPublic("InstallDir",function(c){return c?
b.cleanPath(b.INSTALLDIR+c):""});b.mkPublic("AddDivs",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e,f=b.parsePublicArgs(a);for(a=0;a<f.argv.length;a++)if(e=f.argv[a])if(0===$("#"+e).length)b.DEBUG&&b.log("warning: can't find div, skipping AddDivs(): %s",e);else{for(d=0;d<b.displays.length;d++){var g=b.displays[d];if(g.id===e){var h=!0;break}}h?b.DEBUG&&b.log("warning: div already added, skipping AddDivs(): %s",e):(b.checkNew(new b.Display(e)),b.helper.send("addDisplay",
{display:e}))}b.instantiatePlugins()});b.mkPublic("InstantiatePlugins",function(){b.instantiatePlugins()});b.mkPublic("ResizeDisplay",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];d=b.parsePublicArgs(a);"string"!==typeof d.argv[0]||b.isNumber(d.argv[0])||"full"===d.argv[0]||"reset"===d.argv[0]||"image"===d.argv[0]?a=b.lookupDisplay(d.display):(a=b.lookupDisplay(d.argv[0]||d.display),d.argv.splice(0,1));a||b.error("invalid display for resize");d=a.resize.apply(a,$jscomp.arrayFromIterable(d.argv));
return d===a?b.globalOpts.quietReturn?"":"OK":d});b.mkPublic("SelectDisplay",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=b.parsePublicArgs(a);(a=b.lookupDisplay(a.argv[0]||a.display))||b.error("invalid display for select");({}).hasOwnProperty.call(b,"Menubar")||b.error("Menubar is required for display selection");b.Menubar.onclick(a)});b.mkPublic("GatherDisplay",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];d=b.parsePublicArgs(a);switch(d.argv.length){case 0:a=
d.display;var e=null;break;case 1:"object"===typeof d.argv[0]||"string"===typeof d.argv[0]&&"{"===d.argv[0].charAt(0)?(a=d.display,e=d.argv[0]):a=d.argv[0]||d.display;break;default:a=d.argv[0]||d.display,e=d.argv[1]}(a=b.lookupDisplay(a))||b.error("invalid display for gather");a.gather(e)});b.mkPublic("SeparateDisplay",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];d=b.parsePublicArgs(a);switch(d.argv.length){case 0:a=d.display;var e=null;break;case 1:"object"===typeof d.argv[0]||
"string"===typeof d.argv[0]&&"{"===d.argv[0].charAt(0)?(a=d.display,e=d.argv[0]):a=d.argv[0]||d.display;break;default:a=d.argv[0]||d.display,e=d.argv[1]}(a=b.lookupDisplay(a))||b.error("invalid display for separate");a.separate(a,e)});b.mkPublic("CenterDisplay",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=b.parsePublicArgs(a);(a=b.lookupDisplay(a.argv[0]||a.display))||b.error("invalid display for center");a.center()});b.mkPublic("RemoveDisplay",function(c){for(var a=[],
d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=b.parsePublicArgs(a);var e=b.lookupDisplay(a.argv[0]||a.display);e||b.error("invalid display for remove");a=$.inArray(e,b.displays);if(0<=a){d=e.divjq.closest(".JS9GridContainer");var f=e.divjq.closest(".JS9GridItem");0<d.length&&0<f.length?1<d.find(".JS9GridItem").length?(b.CloseDisplay(e.id),f.remove(),b.displays.splice(a,1)):b.error("can't remove last display in grid: "+e.id):e.winid&&e.winid.close?(b.CloseDisplay(e.id),e.winid.close()):b.error("can only remove displays within a grid or lightwins")}else b.error("can't find display in display list: "+
e.id)});b.mkPublic("SaveSession",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];d={};var e=b.parsePublicArgs(a);a=e.argv[0];var f=e.argv[1];if("object"===typeof a)d=$.extend(!0,{},a);else if("string"===typeof a)try{d=JSON.parse(a)}catch(h){var g=a;if(f)if("object"===typeof f)d=$.extend(!0,{},f);else try{d=JSON.parse(f)}catch(k){d={}}}d.mode||(d.mode="display");a=b.lookupDisplay(e.display?e.display:d.display?d.display:0<b.displays.length?b.displays[0].id:b.DEFID);if(!a.image)return null;
g||(g="display"===d.mode?"js9-"+(new Date).toISOString().slice(0,10)+".ses":a.image.id+".ses");return a.image.saveSession(g,d)});b.mkPublic("LoadSession",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=b.parsePublicArgs(a);var e=a.argv[0];var f=a.argv[1];e||b.error("JS9.LoadSession: no file specified for load");f=f||{};if("object"===typeof f)f=$.extend(!0,{},f);else if("string"===typeof f)try{f=JSON.parse(f)}catch(h){f={}}var g=b.lookupDisplay(a.display?a.display:f.display?
f.display:0<b.displays.length?b.displays[0].id:b.DEFID);f.display=g.id;"object"===typeof e?(a=new FileReader,a.onload=function(a){a=JSON.parse(a.target.result);f.sessionPath=b.dirname(e.path||e.name||"");g.loadSession(a,f)},a.readAsText(e)):"string"===typeof e?(f.responseType="text",f.display=g.id,e=b.fixPath(e,f),b.fetchURL(null,e,f,function(a,c){a=JSON.parse(a);c.sessionPath=b.dirname(e);g.loadSession(a,c)})):b.error("unknown file type for LoadSession: "+typeof e)});b.mkPublic("SaveCatalog",function(c){for(var a=
[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=b.parsePublicArgs(a);a=b.getImage(e.display);d=e.argv[0];e=e.argv[1];if(a)return a.saveCatalog(d,e)});b.mkPublic("LoadCatalog",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e;a=b.parsePublicArgs(a);var f=a.argv[0];var g=a.argv[1];var h=a.argv[2];f instanceof Blob&&(h=g,g=f,f=null);g||b.error("JS9.LoadCatalog: no file specified for catalog load");if(e=b.getImage(a.display)){e.setStatus("loadCatalog","processing");
h=h||{};if("object"===typeof h)h=$.extend(!0,{},h);else if("string"===typeof h)try{h=JSON.parse(h)}catch(k){h={}}if(g instanceof Blob)a=new FileReader,a.onload=function(a){!f&&g.name&&(f=g.name.replace(/\.[^.]*$/,""));e.loadCatalog(f,a.target.result,h);e.setStatus("loadCatalog","complete");if(h&&h.onload)try{b.xeqByName(h.onload,window,e)}catch(m){b.error("in catalog onload callback",m,!1)}},a.readAsText(g);else if("string"===typeof g)if(g.match(/\t/)){if(e.loadCatalog(f,g,h),e.setStatus("loadCatalog",
"complete"),h&&h.onload)try{b.xeqByName(h.onload,window,e)}catch(k){b.error("in catalog onload callback",k,!1)}}else h.responseType="text",g=b.fixPath(g,h),b.fetchURL(null,g,h,function(a){e.loadCatalog(f,a,h);e.setStatus("loadCatalog","complete");if(h&&h.onload)try{b.xeqByName(h.onload,window,e)}catch(m){b.error("in catalog onload callback",m,!1)}});else b.error("unknown file type for LoadCatalog: "+typeof g)}});b.mkPublic("CreateMosaic",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=
arguments[d];var e=b.parsePublicArgs(a);a=b.lookupDisplay(e.display);d=e.argv[0];e=e.argv[1];if(a)return a.createMosaic(d,e)});b.mkPublic("DisplayPlugin",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=b.parsePublicArgs(a);d=b.lookupDisplay(e.display);a=e.argv[0];if(d&&e.argv[0]){var f=a.toLowerCase();for(e=0;e<b.plugins.length;e++){var g=b.plugins[e];var h=g.name;if(h===a||h.toLowerCase().substr(-f.length)===f){d.displayPlugin(g);return}}b.error("can't find plugin: "+
a)}});b.mkPublic("DisplayHelp",function(c){var a,d=b.lightOpts[b.LIGHTWIN].textWin;if(c){var e=c.split("/").reverse()[0];var f="help_"+b.uniqueID();(a=b.helpOpts[c])?(c=b.InstallDir(a.type+"/"+a.url),b.lightWin(f,"iframe",c,a.title||e,d)):b.lightWin(f,"iframe",c,e,d)}});b.mkPublic("LightWindow",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];var e=b.parsePublicArgs(a);a=e.argv[0]||"lightWindow"+b.uniqueID();d=e.argv[1]||"inline";var f=e.argv[2],g=e.argv[3]||"JS9 light window";
e=e.argv[4]||b.lightOpts[b.LIGHTWIN].textWin;f||b.error("no content specified for LightWindow");return b.lightWin(a,d,f,g,e)});b.mkPublic("WindowPrint",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=b.parsePublicArgs(a);var e={cmd:"print"};window.electron?(a.argv[0]&&(e.opts=a.argv[0]),window.setTimeout(function(){try{window.electron.sendMsg(e)}catch(f){b.error("could not print window",f)}},b.TIMEOUT)):b.error("WindowPrint is only available for the JS9 desktop app")});b.mkPublic("WindowToPDF",
function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=b.parsePublicArgs(a);var e={cmd:"pdf"};window.electron?(e.file=a.argv[0]||"js9.pdf",a.argv[1]&&(e.opts=a.argv[1]),window.setTimeout(function(){try{window.electron.sendMsg(e)}catch(f){b.error("could not create window pdf",f)}},b.TIMEOUT)):b.error("WindowToPDF is only available for the JS9 desktop app")});b.mkPublic("SaveScript",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=b.parsePublicArgs(a);var e=
{cmd:"script"};window.electron&&window.electron.app?(e.file=a.argv[0]||"",window.setTimeout(function(){try{window.electron.sendMsg(e)}catch(f){b.error("could not create messaging script",f)}},b.TIMEOUT)):b.error("SaveScript is only available for the JS9 desktop app")});b.mkPublic("SaveDir",function(c){for(var a=[],d=0;d<arguments.length;++d)a[d-0]=arguments[d];a=b.parsePublicArgs(a);var e={cmd:"savedir"};window.electron?(void 0!==a.argv[0]?(e.dirname=a.argv[0],a.argv[1]&&(e.opts=a.argv[1])):b.error("SaveDir requires a directory name"),
window.setTimeout(function(){try{window.electron.sendMsg(e)}catch(f){b.error("could not set save directory",f)}},b.TIMEOUT)):b.error("SaveDir is only available for the JS9 desktop app")});b.mkPublic("Quit",function(c){for(var a=0;a<arguments.length;++a);var d={cmd:"quit"};window.electron?window.setTimeout(function(){try{window.electron.sendMsg(d)}catch(e){b.error("could not quit app",e)}},b.TIMEOUT):b.error("Quit is only available for the JS9 desktop app")});b.init=function(){var c;window.HTMLCanvasElement&&
JSON||b.error("your browser does not support JS9 (no HTML5 canvas and/or JSON). Please try a modern version of Firefox, Chrome, Safari, Opera, or Edge.");({}).hasOwnProperty.call(window,"JS9Prefs")&&"object"===typeof JS9Prefs&&JS9Prefs.globalOpts&&JS9Prefs.globalOpts.installDir&&(b.INSTALLDIR=JS9Prefs.globalOpts.installDir);if(!b.INSTALLDIR){try{$('link[href$="js9.css"]').each(function(a,c){(a=$(c).attr("href"))&&"js9.css"===a.split("/").reverse()[0]&&(b.INSTALLDIR=a.replace(/js9\.css$/,""))})}catch(k){b.INSTALLDIR=
""}b.INSTALLDIR&&(b.INSTALLDIR=b.cleanPath(b.INSTALLDIR))}b.INSTALLDIR&&"/"!==b.INSTALLDIR.slice(-1)&&(b.INSTALLDIR+="/");b.TOROOT=b.INSTALLDIR.replace(/([^/.])+/g,"..");({}).hasOwnProperty.call(window,"JS9Inline")&&"object"===typeof JS9Inline&&(b.inline=$.extend(!0,{},JS9Inline));"dhtml"===b.LIGHTWIN&&($("<div>").attr("id","dhtmlwindowholder").appendTo($(document.body)).append("<span style='display:none'>.</span>"),dhtmlwindow.imagefiles=b.inline?[b.inline["images/min.gif"],b.inline["images/close.gif"],
b.inline["images/restore.gif"],b.inline["images/resize.gif"]]:b.allinone?[b.allinone.min,b.allinone.close,b.allinone.restore,b.allinone.resize]:[b.InstallDir("images/min.gif"),b.InstallDir("images/close.gif"),b.InstallDir("images/restore.gif"),b.InstallDir("images/resize.gif")],{}.hasOwnProperty.call(window,"Jupyter")&&$(b.lightOpts[b.LIGHTWIN].topid).arrive("input",function(a){b.jupyterFocus($(a).parent())}));b.globalOpts.plotLibrary=b.globalOpts.plotLibrary||"flot";"plotly"!==b.globalOpts.plotLibrary||
{}.hasOwnProperty.call(window,"Plotly")||(b.globalOpts.plotLibrary="flot");({}).hasOwnProperty.call(window,"JS9Prefs")&&"object"===typeof JS9Prefs?b.mergePrefs(JS9Prefs):b.PREFSFILE&&(b.loadPrefs(b.InstallDir(b.PREFSFILE),0),b.loadPrefs(b.PREFSFILE,0));({}).hasOwnProperty.call(b,"Regions")&&$.extend(!0,b.Regions.opts,b.regionOpts);delete b.regionOpts;({}).hasOwnProperty.call(b,"Catalogs")&&$.extend(!0,b.Catalogs.opts,b.catalogOpts);delete b.catalogOpts;({}).hasOwnProperty.call(b,"Crosshair")&&$.extend(!0,
b.Crosshair.opts,b.crosshairOpts);delete b.crosshairOpts;({}).hasOwnProperty.call(b,"Grid")&&$.extend(!0,b.Grid.opts,b.gridOpts);delete b.gridOpts;({}).hasOwnProperty.call(b,"Module")&&$.extend(!0,Module,b.emscriptenOpts);delete b.emscriptenOpts;if({}.hasOwnProperty.call(b,"Fabric")){$.extend(!0,b.Fabric.opts,b.fabricOpts);var a=$jscomp.makeIterator(Object.keys(b.Fabric.opts));for(c=a.next();!c.done;c=a.next())c=c.value,fabric.Object.prototype[c]=b.Fabric.opts[c]}delete b.fabricOpts;b.globalOpts.resize||
(b.globalOpts.resizeHandle=!1);void 0!==b.analOpts.prependJS9Dir&&(b.globalOpts.prependJS9Dir=b.analOpts.prependJS9Dir,delete b.analOpts.prependJS9Dir);void 0!==b.analOpts.dataDir&&(b.globalOpts.dataDir=b.analOpts.dataDir,delete b.analOpts.dataDir);void 0!==b.globalOpts.regionsToClipboard&&void 0===b.globalOpts.regToClipboard&&(b.globalOpts.regToClipboard=b.globalOpts.regionsToClipboard,delete b.globalOpts.regionsToClipboard);void 0!==b.globalOpts.regionDisplay&&void 0===b.globalOpts.regDisplay&&
(b.globalOpts.regDisplay=b.globalOpts.regionDisplay,delete b.globalOpts.regionDisplay);void 0!==b.globalOpts.regionConfigSize&&void 0===b.globalOpts.regConfigSize&&(b.globalOpts.regConfigSize=b.globalOpts.regionConfigSize,delete b.globalOpts.regionConfigSize);void 0!==b.globalOpts.regionTemplates&&void 0===b.globalOpts.regTemplates&&(b.globalOpts.regTemplates=b.globalOpts.regionTemplates,delete b.globalOpts.regionTemplates);b.BROWSER[3]&&(b.globalOpts.resizeHandle=!1);if({}.hasOwnProperty.call(window,
"localStorage")&&b.globalOpts.localStorage){try{var d=localStorage.getItem("globals")}catch(k){d=null}if(d){try{b.userOpts.displays=JSON.parse(d)}catch(k){}b.userOpts.displays&&$.extend(!0,b.globalOpts,b.userOpts.displays)}try{d=localStorage.getItem("images")}catch(k){d=null}if(d){try{b.userOpts.images=JSON.parse(d)}catch(k){}b.userOpts.images&&$.extend(!0,b.imageOpts,b.userOpts.images)}try{d=localStorage.getItem("fits")}catch(k){d=null}if(d)try{b.userOpts.fits=JSON.parse(d)}catch(k){}try{d=localStorage.getItem("regions")}catch(k){d=
null}if(d){try{b.userOpts.regions=JSON.parse(d)}catch(k){}b.userOpts.regions&&$.extend(!0,b.Regions.opts,b.userOpts.regions)}try{d=localStorage.getItem("grid")}catch(k){d=null}if(d){try{b.userOpts.images=JSON.parse(d)}catch(k){}b.userOpts.images&&$.extend(!0,b.Grid.opts,b.userOpts.images)}try{d=localStorage.getItem("catalog")}catch(k){d=null}if(d){try{b.userOpts.images=JSON.parse(d)}catch(k){}b.userOpts.images&&$.extend(!0,b.Catalogs.Opts,b.userOpts.images)}}b.DEBUG=b.DEBUG||b.globalOpts.debug||0;
$("div.JS9").each(function(a,c){b.checkNew(new b.Display($(c)))});if(window.Worker&&!b.allinone)try{b.worker=new b.WebWorker(b.InstallDir(b.WORKERFILE))}catch(k){}b.allinone?b.initFITS():b.initEmscripten();window.electron&&(b.globalOpts.helperType="nodejs");b.helper=new b.Helper;window.addEventListener("message",function(a){var c=a.origin||a.originalEvent.origin;a=a.data;"null"===c&&(c="unknown");if(b.globalOpts.postMessage){if("string"===typeof a)try{var d=JSON.parse(a)}catch(p){b.error("can't parse msg: "+
a,p)}else"object"===typeof a?d=a:b.error("invalid msg from postMessage");b.msgHandler(d,function(a,b,c,e){e=e||{};parent.postMessage({cmd:d.cmd,res:{name:e.name,rtype:e.rtype,rdata:a,stdout:a,stderr:b,errcode:c}},"*")})}else b.DEBUG&&(c="JS9 ignoring postMessage, origin: "+c,c="string"===typeof a?c+(" data: "+a):"object"===typeof a?c+(" obj: "+JSON.stringify(Object.keys(a))):c+(" typeof: "+typeof a),b.log(c))},!1);({}).hasOwnProperty.call(window,"ImageFilters")&&(b.ImageFilters=ImageFilters);b.initColormaps();
b.initCommands();b.initAnalysis();b.RegisterPlugin(b.MouseTouch.CLASS,b.MouseTouch.NAME,b.MouseTouch.init,{menuItem:"Mouse/Touch",onplugindisplay:b.MouseTouch.init,help:"help/mousetouch.html",winTitle:"Mouse/Touch Actions",winResize:!0,winDims:[b.MouseTouch.WIDTH,b.MouseTouch.HEIGHT]});b.RegisterPlugin(b.Regions.CLASS,b.Regions.NAME,b.Regions.init,{divArgs:["regions"],winDims:[0,0]});b.RegisterPlugin(b.Crosshair.CLASS,b.Crosshair.NAME,b.Crosshair.init,{onmousemove:b.Crosshair.display,onkeyboardaction:b.Crosshair.keyaction,
onkeyup:b.Crosshair.keyup,onimageload:b.Crosshair.create,winDims:[0,0]});b.RegisterPlugin(b.Grid.CLASS,b.Grid.NAME,b.Grid.init,{onsetpan:b.Grid.regrid,onsetzoom:b.Grid.regrid,onsetwcssys:b.Grid.regrid,onsetwcsunits:b.Grid.regrid,onimageload:b.Grid.regrid,onupdateprefs:b.Grid.regrid,winDims:[0,0]});b.RegisterPlugin(b.Dysel.CLASS,b.Dysel.NAME,b.Dysel.init,{onimageload:b.Dysel.imageload,onimageclose:b.Dysel.imageclose,winDims:[0,0]});b.RegisterPlugin(b.Titlebar.CLASS,b.Titlebar.NAME,b.Titlebar.init,
{onimageload:b.Titlebar.imageload,onimagedisplay:b.Titlebar.imagedisplay,onimageclose:b.Titlebar.imageclose,winDims:[0,0]});b.instantiatePlugins();b.plugins.sort(function(a,b){a=a.opts.menuItem;b=b.opts.menuItem;return a?!b||a<b?-1:a>b?1:0:1});if(b.globalOpts.processQueryParams&&(c=new URL(window.location),c.searchParams)){d={};a=null;c=$jscomp.makeIterator(c.searchParams);for(var e=c.next();!e.done;e=c.next()){var f=$jscomp.makeIterator(e.value);e=f.next().value;f=f.next().value;switch(e){case "url":case "file":var g=
f;break;case "display":var h={display:f};break;case "renamedisplay":a=f.split(/[:,]/);break;default:d[e]=f}}a&&(b.prerename=[].concat($jscomp.arrayFromIterable(a)));g&&(h?b.Preload(g,d,h):b.Preload(g,d))}$(document).scrollTop(0);b.inited=!0;$(document).trigger("JS9:init")};return b}();
$(document).ready(function(){$(document).on("JS9:ready",function(){JS9.readied||(JS9.readied=!0,JS9.notNull(JS9.prerename)&&JS9.prerename.length&&(JS9.RenameDisplay.apply(JS9,$jscomp.arrayFromIterable(JS9.prerename)),delete JS9.prerename),JS9.Preload(!0))});$(document).on("JS9:init",function(){JS9.helper.ready&&JS9.fits.ready&&$(document).trigger("JS9:ready",{status:"OK"})});$(document).on("astroem:ready",function(){JS9.initFITS();if(window.electron&&JS9.hostFS)try{JS9.vmount("/",JS9.hostFS)||delete JS9.hostFS}catch(b){delete JS9.hostFS}JS9.helper.ready&&
JS9.inited&&$(document).trigger("JS9:ready",{status:"OK"})});$(document).on("JS9:helperReady",function(){JS9.fits.ready&&JS9.inited&&!JS9.readied&&$(document).trigger("JS9:ready",{status:"OK"})});0===$('div[data-js9init="false"]').length&&JS9.init()});
